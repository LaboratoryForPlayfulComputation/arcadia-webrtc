var iface,pxt,__extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(Ct){!function(Z){function r(t,e){return Ct.worker.getWorker(Ct.webConfig.workerjs).opAsync(t,e)}Z.workerOpAsync=r;var a={};function $(t,e){t.push.apply(t,e)}function Q(t){if(!t)throw new Error("Assertion failure")}var tt,t,i=function(t,e,i,o,r){this.link=t,this.type=e,this.parentType=i,this.childType=o,this.isArrayType=r};function J(t){return t.link?J(t.link):t}function d(t,e){var i=J(t),o=J(e);if(Q(null==i.link&&null==o.link),i!=o){if(i.childType&&o.childType){var r=i.childType;i.childType=null,d(r,o.childType)}else i.childType&&!o.childType&&(o.childType=i.childType);if(i.parentType&&o.parentType){var n=i.parentType;i.parentType=null,d(n,o.parentType)}else!i.parentType||o.parentType||o.type||(o.parentType=i.parentType);var l=function(t,e){{if(null==t||"Array"===t&&b(e))return e;if(null==e||"Array"===e&&b(t))return t;if(t==e)return t;throw new Error("cannot mix "+t+" with "+e)}}(i.type,o.type);t.link=o,i.link=o,i.isArrayType=o.isArrayType,t.type=null,e.type=l}}function g(t,e){return void 0===e&&(e=!1),new i(null,t,null,null,e)}Z.Point=i,(t=tt=Z.BlockDeclarationType||(Z.BlockDeclarationType={}))[t.None=0]="None",t[t.Argument=1]="Argument",t[t.Assigned=2]="Assigned",t[t.Implicit=3]="Implicit";var m=g("number"),et=g("boolean"),it=g("string"),y=g("void");function v(t){if(!t)return g(t);switch(t.toLowerCase()){case"number":return m;case"boolean":return et;case"string":return it;case"void":return y;default:return g(t)}}function ot(t,e){if(Q(null!=e),"placeholder"==(i=e).type||i.type===pxtc.TS_OUTPUT_TYPE)return e.p||(e.p=g(null)),J(e.p);var i,o,r;if("variables_get"==e.type)return J(ht(t,e,e.getField("VAR").getText()).type);if("function_call_output"==e.type)return o=t,r=e.getField("function_name").getText(),k(o,r);if(!e.outputConnection)return v(y.type);var n=e.outputConnection.check_&&e.outputConnection.check_.length?e.outputConnection.check_[0]:"T";if("Array"===n){if(1<e.outputConnection.check_.length)return v(e.outputConnection.check_[1]);var l=void 0;if(e.inputList&&e.inputList.length)for(var a=0,s=e.inputList;a<s.length;a++){var c=s[a];if(c.connection&&c.connection.targetBlock()){var u=J(ot(t,c.connection.targetBlock()));if(u){if(u.parentType)return u.parentType;T(l=v(u.type+"[]"),u);break}}}return l&&(l.isArrayType=!0),l||g(null,!0)}if("T"===n){var p=t.stdCallTable[e.type],d="lists_index_get"===e.type;if(d||p&&p.comp.thisParameter){var h=void 0;if((h=d?e.inputList.find(function(t){return"LIST"===t.name}):e.inputList.find(function(t){return t.name===p.comp.thisParameter.definitionName})).connection&&h.connection.targetBlock()){var m=ot(t,h.connection.targetBlock());if(m.childType)return m.childType;var f=b(m.type)?g(m.type.substr(0,m.type.length-2)):g(null);return T(m,f),f}}return g(null)}return v(n)}function k(e,i){if(!e.userFunctionReturnValues[i]){var o=Blockly.Functions.getDefinition(i,e.workspace),r=g("void");if(Bt(o,!0))r=g("any");else{for(var t=[],n=0,l=o.getDescendants(!1);n<l.length;n++){var a=l[n];"function_return"===a.type&&(_(e,a,"RETURN_VALUE"),t.push(ot(e,nt(a,"RETURN_VALUE"))))}if(t.length)try{for(var s=g(null),c=0,u=t;c<u.length;c++){d(s,u[c])}r=s}catch(t){e.diagnostics.push({blockId:o.id,message:Ct.Util.lf("Function '{0}' has an invalid return type",i)}),r=g("any")}}e.userFunctionReturnValues[i]=r}return e.userFunctionReturnValues[i]}function b(t){return t&&-1!==t.indexOf("[]")}function _(t,e,i,o){var r,n,l=e.getInputTargetBlock(i);l?l.type!==pxtc.TS_OUTPUT_TYPE||l.p||(l.p=g(null)):(a[e.id]||(a[e.id]={}),a[e.id][i]||(a[e.id][i]=(r=t,n=e,{type:"placeholder",p:g(o||null),workspace:r.workspace,parentBlock_:n})))}function rt(t){return"pxt_controls_for"==t.type||"pxt_controls_for_of"==t.type?nt(t,"VAR"):t}function nt(t,e){var i=t.getInputTargetBlock(e);return i||a[t.id]&&a[t.id][e]}function c(){a={}}function h(t,e,i,o){_(t,e,i);try{d(ot(t,nt(e,i)),o)}catch(t){}}function p(t,c,e){function u(t){return t.name?t.connection&&t.connection.check_&&t.connection.check_.length?t.connection.check_[0]:"T":void 0}function p(t,e){var i=t.inputList.filter(function(t){return"T"===u(t)});if(i.length){var o=nt(t,i[0].name);if(o){var r=ot(c,o),n=r.type?v(ot(c,o).type+"[]"):v(null);return T(n,r),h(c,t,e,n),!0}}return!1}t&&t.filter(function(t){return t.isEnabled()}).forEach(function(l){try{switch(l.type){case"math_op2":h(c,l,"x",v(m.type)),h(c,l,"y",v(m.type));break;case"math_op3":h(c,l,"x",v(m.type));break;case"math_arithmetic":case"logic_compare":switch(l.getFieldValue("OP")){case"ADD":case"MINUS":case"MULTIPLY":case"DIVIDE":case"LT":case"LTE":case"GT":case"GTE":case"POWER":h(c,l,"A",v(m.type)),h(c,l,"B",v(m.type));break;case"AND":case"OR":_(c,l,"A",et.type),_(c,l,"B",et.type);break;case"EQ":case"NEQ":_(c,l,"A"),_(c,l,"B");var t=ot(c,nt(l,"A")),e=ot(c,nt(l,"B"));try{d(t,e)}catch(t){}}break;case"logic_operation":_(c,l,"A",et.type),_(c,l,"B",et.type);break;case"logic_negate":_(c,l,"BOOL",et.type);break;case"controls_if":for(var i=0;i<=l.elseifCount_;++i)_(c,l,"IF"+i,et.type);break;case"pxt_controls_for":case"controls_simple_for":h(c,l,"TO",v(m.type));break;case"pxt_controls_for_of":case"controls_for_of":T(ot(c,nt(l,"LIST")),ht(c,l,rt(l).getField("VAR").getText()).type);break;case"variables_set":case"variables_change":var o=ht(c,l,l.getField("VAR").getText()).type;_(c,l,"VALUE");var r=nt(l,"VALUE");if(r){var n=ot(c,r);try{d(o,n)}catch(t){}}break;case"controls_repeat_ext":h(c,l,"TIMES",v(m.type));break;case"device_while":_(c,l,"COND",et.type);break;case"lists_index_get":h(c,l,"LIST",v("Array")),h(c,l,"INDEX",v(m.type)),T(ot(c,nt(l,"LIST")),ot(c,l));break;case"lists_index_set":h(c,l,"LIST",v("Array")),_(c,l,"VALUE"),p(l,"LIST"),h(c,l,"INDEX",v(m.type));break;case"function_definition":k(c,l.getField("function_name").getText());break;case"function_call":case"function_call_output":l.getArguments().forEach(function(t){h(c,l,t.id,v(t.type))});break;case pxtc.TS_RETURN_STATEMENT_TYPE:_(c,l,"RETURN_VALUE");break;case pxtc.PAUSE_UNTIL_TYPE:h(c,l,"PREDICATE",et);break;default:if(l.type in c.stdCallTable){var a=c.stdCallTable[l.type];if("ENUM_GET"===a.attrs.shim||"KIND_GET"===a.attrs.shim)return;xt(a,Tt(l)).forEach(function(e,t){var i=a.isExtensionMethod&&0===t;if(e.definitionName&&!l.getFieldValue(e.definitionName)){var o=l.inputList.find(function(t){return t.name==e.definitionName});if(o&&o.connection&&o.connection.check_){if(i&&"Array"===u(o))if(p(l,e.definitionName))return;for(var r=0;r<o.connection.check_.length;r++)try{var n=o.connection.check_[r];h(c,l,e.definitionName,v(n));break}catch(t){}}}})}}}catch(t){var s=t.block||l;s.setWarningText(t+""),c.errors.push(s)}}),c.allVariables.forEach(function(t){null==lt(t.type).type&&d(t.type,v(t.type.isArrayType?"number[]":m.type))})}function T(t,e){var i=J(t),o=J(e);i.childType?d(i.childType,o):i.type||(i.childType=o),o.parentType?d(o.parentType,i):o.type||(o.parentType=i),b(i.type)&&(i.isArrayType=!0)}function lt(t,e){void 0===e&&(e=[]);var i=J(t);if(-1===e.indexOf(i)&&(e.push(i),!i.type||"Array"===i.type)){if(i.parentType){var o=lt(i.parentType,e);if(o.type&&"Array"!==o.type)return b(o.type)?i.type=o.type.substr(0,o.type.length-2):i.type=o.type,i}if(i.childType){var r=lt(i.childType,e);if(r.type)return i.type=r.type+"[]",i}}return i}function at(t){var e,i,o=t.getFieldValue("math_number_minmax"===t.type?"SLIDER":"NUM"),r=parseFloat(o);return e=r,i=t,isFinite(e)&&!isNaN(e)||function(t,e){var i=new Error(t);throw i.block=e,i}(lf("Number entered is either too large or too small"),i),r}function st(t,e,i){return Z.H.mkNumberLiteral(at(e))}var ct={ADD:"+",MINUS:"-",MULTIPLY:"*",DIVIDE:"/",LT:"<",LTE:"<=",GT:">",GTE:">=",AND:"&&",OR:"||",EQ:"==",NEQ:"!=",POWER:"**"};function ut(e,i,o,t){var r=mt(i.getField("function_name").getText(),e,!0),n=!i.getInputsInline(),l=i.getArguments().map(function(t){return{actualName:t.name,definitionName:t.id}}).map(function(t){return gt(e,i,t,o)}),a=Z.H.stdCall(r,l,n);return t?Z.mkStmt(a):a}function f(t){var e=t.getContent();return Z.Helpers.mkMultiComment(e.trim())}function pt(t){if(null==t.type&&(d(t,v(m.type)),t=J(t)),b(t.type)||t.isArrayType)return Z.mkText("[]");switch(t.type){case"boolean":return Z.H.mkBooleanLiteral(!1);case"number":return Z.H.mkNumberLiteral(0);case"string":return Z.H.mkStringLiteral("");default:return Z.mkText("null")}}function dt(e,i,o){var t,r,n,l,a,s,c,u,p,d,h,m,f,g,y,v,k,b,_,T,x,E,B,C,A,I,N,w,S,D,L,R,O,F,M,P,U,V,H,G,W,X,j,Y;if(Q(null!=i),e.stats[i.type]=(e.stats[i.type]||0)+1,_t(i,o),"placeholder"!=i.type&&i.isEnabled&&i.isEnabled())switch(i.type){case"math_number":case"math_integer":case"math_whole_number":case"math_number_minmax":t=st(0,i);break;case"math_op2":H=e,W=o,X=(G=i).getFieldValue("op"),j=dt(H,nt(G,"x"),W),Y=dt(H,nt(G,"y"),W),t=Z.H.mathCall(X,[j,Y]);break;case"math_op3":U=o,V=dt(e,nt(i,"x"),U),t=Z.H.mathCall("abs",[V]);break;case"math_arithmetic":case"logic_compare":case"logic_operation":t=function(t,e,i){var o=e.getFieldValue("OP"),r=nt(e,"A"),n=nt(e,"B"),l=[dt(t,r,i),dt(t,n,i)],a=ot(t,r).type;if(a==it.type){if("EQ"==o)return Z.H.mkSimpleCall("==",l);if("NEQ"==o)return Z.H.mkSimpleCall("!=",l)}else if(a==et.type)return Z.H.mkSimpleCall(ct[o],l);return Q(o in ct),Z.H.mkSimpleCall(ct[o],l)}(e,i,o);break;case"math_modulo":L=e,O=o,F=nt(R=i,"DIVIDEND"),M=nt(R,"DIVISOR"),P=[dt(L,F,O),dt(L,M,O)],t=Z.H.mkSimpleCall("%",P);break;case"logic_boolean":D=i,t=Z.H.mkBooleanLiteral("TRUE"==D.getFieldValue("BOOL"));break;case"logic_negate":w=o,S=dt(e,nt(i,"BOOL"),w),t=Z.mkPrefix("!",[Z.H.mkParenthesizedExpression(S)]);break;case"variables_get":t=function(t,e){var i=e.getField("VAR").getText(),o=ht(t,e,i);if(!o)return Z.mkText(i);o.firstReference||(o.firstReference=e);return Q(null!=o&&null!=o.type),Z.mkText(o.escapedName)}(e,i);break;case"text":N=i,t=Z.H.mkStringLiteral(N.getFieldValue("TEXT"));break;case"text_join":t=function(t,e,i){for(var o,r=0;;){var n=nt(e,"ADD"+r);if(r++,!n){if(r<e.inputList.length)continue;break}var l=dt(t,n,i);o=o?Z.H.mkSimpleCall("+",[o,l]):0===n.type.indexOf("text")?l:Z.H.mkSimpleCall("+",[Z.H.mkStringLiteral(""),l])}return o||Z.H.mkStringLiteral("")}(e,i,o);break;case"lists_create_with":B=e,A=o,I=(C=i).inputList.map(function(t){return t.connection&&t.connection.targetBlock()?dt(B,t.connection.targetBlock(),A):void 0}).filter(function(t){return!!t}),t=Z.H.mkArrayLiteral(I,!C.getInputsInline());break;case"lists_index_get":T=o,x=dt(b=e,nt(_=i,"LIST"),T),E=dt(b,nt(_,"INDEX"),T),t=Z.mkGroup([x,Z.mkText("["),E,Z.mkText("]")]);break;case"lists_index_set":d=e,m=o,f=nt(h=i,"LIST"),g=dt(d,f,m),y=dt(d,nt(h,"INDEX"),m),v=dt(d,nt(h,"VALUE"),m),k=Z.mkGroup([g,Z.mkText("["),y,Z.mkText("] = "),v]),t="lists_create_with"===f.type?bt(k):k;break;case"math_js_op":case"math_js_round":a=e,c=o,u=(s=i).getFieldValue("OP"),p=[dt(a,nt(s,"ARG0"),c)],s.getInput("ARG1")&&p.push(dt(a,nt(s,"ARG1"),c)),t=Z.H.mathCall(u,p);break;case pxtc.TS_OUTPUT_TYPE:l=i,t=Z.mkText(l.getFieldValue("EXPRESSION").trim());break;case"argument_reporter_boolean":case"argument_reporter_number":case"argument_reporter_string":case"argument_reporter_custom":r=e,n=mt(i.getFieldValue("VALUE"),r),t=Z.mkText(n);break;case"function_call_output":t=ut(e,i,o,!1);break;default:(K=e.stdCallTable[i.type])?t=K.imageLiteral?vt(e,i,K.imageLiteral,K.imageLiteralColumns,K.imageLiteralRows,K.namespace,K.f,xt(K,Tt(i)).map(function(t){return gt(e,i,t,o)})):yt(e,i,K,o):(Ct.reportError("blocks","unable to compile expression",{details:i.type}),t=pt(ot(e,i)))}else if("Array"===J(ot(e,i)).type){var K,q="lists_index_get"===i.parentBlock_.type;if(!q)q=(K=e.stdCallTable[i.parentBlock_.type])&&K.isExpression;var z=Z.mkText("[0]");t=q?z:bt(z)}else t=pt(ot(e,i));return t.id=i.id,t}function ht(t,e,i){return function t(e,i){return i&&i.declaredVars[e]?i.declaredVars[e]:i&&i.parent?t(e,i.parent):null}(i,t.idToScope[e.id])}function mt(t,e,i){if(void 0===i&&(i=!1),!t)return"_";if(i){if(e.renames.oldToNewFunctions[t])return e.renames.oldToNewFunctions[t]}else if(e.renames.oldToNew[t])return e.renames.oldToNew[t];var o=ts.pxtc.escapeIdentifier(t);if(e.renames.takenNames[o]){for(var r=2;e.renames.takenNames[o+r];)r++;o+=r}return i?(e.renames.oldToNewFunctions[t]=o,e.renames.takenNames[o]=!0):e.renames.oldToNew[t]=o,o}function ft(e,i,o){var t=e.stdCallTable[i.type];return t.imageLiteral?Z.mkStmt(vt(e,i,t.imageLiteral,t.imageLiteralColumns,t.imageLiteralRows,t.namespace,t.f,xt(t,Tt(i)).map(function(t){return gt(e,i,t,o)}))):t.hasHandler?function(e,i,t,o,r,n){var l,a=o.map(function(t){return gt(e,i,t,n)}),s=nt(i,"HANDLER"),c=kt(e,s);Ct.appTarget.compile&&Ct.appTarget.compile.emptyEventHandlerComments&&0===c.children.length&&c.children.unshift(Z.mkStmt(Z.mkText("// "+pxtc.HANDLER_COMMENT)));if(E(i)&&i.mutation.getMutationType()===Z.MutatorTypes.ObjectDestructuringMutator)l=i.mutation.compileMutation(e,n);else if(t.comp.handlerArgs.length){var u=(d=e,w(p=i,t).map(function(t){return ht(d,p,t[0]).escapedName}));l=Z.mkText("function ("+u.join(", ")+")")}var p,d;return x(e,r,t.f,a,c,l,t.isExtensionMethod)}(e,i,t,xt(t,Tt(i)).filter(function(t){return!!t.definitionName}),t.namespace,o):Z.mkStmt(yt(e,i,t,o))}function gt(t,e,i,o,r){void 0===r&&(r=!1);var n=e.getFieldValue(i.definitionName);if(null!=n){var l=e.getField(i.definitionName);if(l instanceof pxtblockly.FieldTextInput)return Z.H.mkStringLiteral(n);if(l instanceof pxtblockly.FieldTilemap){var a=Ct.react.getTilemapProject(),s=l.getValue();if(s.startsWith("tilemap`"))return Z.mkText(s);if(t.options.emitTilemapLiterals)try{var c=Ct.sprite.decodeTilemap(s,"typescript",a);if(c){var u=a.createNewTilemapFromData(c)[0];return Z.mkText("tilemap`"+u+"`")}}catch(t){}}var p=t.blocksInfo.apis.byQName[i.type];if(p&&p.attributes.emitAsConstant)for(var d=0,h=Object.keys(t.blocksInfo.apis.byQName);d<h.length;d++){var m=h[d],f=t.blocksInfo.apis.byQName[m];if(f&&f.attributes&&f.attributes.enumIdentity===n)return Z.mkText(m)}var g=Z.mkText(n);return g.canIndentInside="string"==typeof n&&0<=n.indexOf("\n"),g}_(t,e,i.definitionName);var y=nt(e,i.definitionName);return r&&"lists_create_with"===y.type?bt(dt(t,y,o)):i.shadowOptions&&i.shadowOptions.toString&&ot(t,y)!==it?Z.H.mkSimpleCall("+",[Z.H.mkStringLiteral(""),Z.H.mkParenthesizedExpression(dt(t,y,o))]):dt(t,y,o)}function yt(i,o,r,n){var t;if(E(o)&&o.mutation.getMutationType()===Z.MutatorTypes.RestParameterMutator)t=o.mutation.compileMutation(i,n).children;else{if("ENUM_GET"===r.attrs.shim){var e=r.attrs.enumName,l=o.getFieldValue("MEMBER").replace(/^\d+/,"");return Z.H.mkPropertyAccess(l,Z.mkText(e))}if("KIND_GET"===r.attrs.shim){var a=i.kinds.filter(function(t){return t.blockId===r.attrs.blockId})[0];return Z.H.mkPropertyAccess(o.getFieldValue("MEMBER"),Z.mkText(a.name))}t=xt(r,Tt(o)).map(function(t,e){return gt(i,o,t,n,r.isExtensionMethod&&0===e&&!r.isExpression)})}var s=r.namespace,c=r.f;if(r.attrs.blockAliasFor){var u=i.blocksInfo.apis.byQName[r.attrs.blockAliasFor];u&&(c=u.name,s=u.namespace)}var p=!o.getInputsInline();if(r.isIdentity)return t[0];if(r.property)return Z.H.mkPropertyAccess(c,t[0]);if("@get@"==c)return Z.H.mkPropertyAccess(t[1].op.replace(/.*\./,""),t[0]);if("@set@"==c)return Z.H.mkAssign(Z.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]);if("@change@"==c)return Z.H.mkSimpleCall("+=",[Z.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]]);if(r.isExtensionMethod){if(r.attrs.defaultInstance){var d=void 0;E(o)&&o.mutation.getMutationType()===Z.MutatorTypes.DefaultInstanceMutator&&(d=o.mutation.compileMutation(i,n)),d?t.unshift(d):t.unshift(Z.mkText(r.attrs.defaultInstance))}return Z.H.extensionCall(c,t,p)}return s?Z.H.namespaceCall(s,c,t,p):Z.H.stdCall(c,t,p)}function x(t,e,i,o,r,n,l){var a;return void 0===l&&(l=!1),r.noFinalNewline=!0,a=n?Z.mkGroup([n,r]):Z.mkGroup([Z.mkText("function ()"),r]),l?Z.mkStmt(Z.H.extensionCall(i,o.concat([a]),!1)):e?Z.mkStmt(Z.H.namespaceCall(e,i,o.concat([a]),!1)):Z.mkStmt(Z.H.mkCall(i,o.concat([a]),!1))}function E(t){return!!t.mutation}function vt(t,e,i,o,r,n,l,a){a=void 0===a?[]:a;var s="\n";r=r||5,o=(o||5)*i;var c=e.getFieldValue("LEDS");c=c.replace(/[ `\n]+/g,"");for(var u=0;u<r;++u){for(var p=0;p<o;++p)0<p&&(s+=" "),s+="#"===c[u*o+p]?"#":".";s+="\n"}var d=Z.H.mkStringLiteral(s);return d.canIndentInside=!0,Z.H.namespaceCall(n,l,[d].concat(a),!1)}function B(t,e){var i,o,r,n,l,a,s,c,u,p,d,h,m,f,g,y,v,k,b,_,T,x,E,B,C,A,I,N,w,S,D,L,R,O,F,M,P,U,V,H,G,W,X,j,Y,K,q,z,Q=[];switch(t.stats[e.type]=(t.stats[e.type]||0)+1,_t(e,Q),e.type){case"controls_if":i=function(t,e,i){for(var o=[],r=0;r<=e.elseifCount_;++r){var n=dt(t,nt(e,"IF"+r),i),l=kt(t,nt(e,"DO"+r)),a=Z.mkText("if (");0<r&&((a=Z.mkText("else if (")).glueToBlock=Z.GlueMode.WithSpace),$(o,[a,n,Z.mkText(")"),l])}if(e.elseCount_){var s=Z.mkText("else");s.glueToBlock=Z.GlueMode.WithSpace,$(o,[s,kt(t,nt(e,"ELSE"))])}return o}(t,e,Q);break;case"pxt_controls_for":case"controls_for":case"controls_simple_for":H=t,W=Q,X=nt(G=e,"TO"),j=nt(G,"DO"),Y=nt(G,"BY"),K=nt(G,"FROM"),q=!Y||Y.type.match(/^math_number/)&&1==at(Y),z=ht(H,G,rt(G).getField("VAR").getText()),i=[Z.mkText("for (let "+z.escapedName+" = "),K?dt(H,K,W):Z.mkText("0"),Z.mkText("; "),Z.mkInfix(Z.mkText(z.escapedName),"<=",dt(H,X,W)),Z.mkText("; "),q?Z.mkText(z.escapedName+"++"):Z.mkInfix(Z.mkText(z.escapedName),"+=",dt(H,Y,W)),Z.mkText(")"),kt(H,j)];break;case"pxt_controls_for_of":case"controls_for_of":O=t,M=Q,P=nt(F=e,"LIST"),U=nt(F,"DO"),V=ht(O,F,rt(F).getField("VAR").getText()),i=[Z.mkText("for (let "+V.escapedName+" of "),dt(O,P,M),Z.mkText(")"),kt(O,U)];break;case"variables_set":i=[function(e,t,i){var o=nt(t,"VALUE"),r=ht(e,t,t.getField("VAR").getText()),n=e.idToScope[t.id].declaredVars[r.name]===r&&!r.firstReference&&!r.alreadyDeclared;n&&Et(t,function(t){"variables_get"===t.type&&ht(e,t,t.getField("VAR").getText())===r&&(n=!1)},!0);var l=dt(e,o,i),a=r.escapedName+" = ";if(r.isAssigned=!0,n){r.alreadyDeclared=tt.Assigned;var s=lt(r.type);if(a="let "+r.escapedName+" = ",s){var c=lt(ot(e,o));s.type!==c.type&&(a="let "+r.escapedName+": "+s.type+" = ")}}else r.firstReference||(r.firstReference=t);return Z.mkStmt(Z.mkText(a),l)}(t,e,Q)];break;case"variables_change":i=[(I=t,N=e,w=Q,S=nt(N,"VALUE"),D=ht(I,N,N.getField("VAR").getText()),L=dt(I,S,w),R=Z.mkText(D.escapedName),Z.mkStmt(Z.mkInfix(R,"+=",L)))];break;case"controls_repeat_ext":i=function(t,e,i){for(var o=dt(t,nt(e,"TIMES"),i),r=kt(t,nt(e,"DO")),n="index",l=2;ht(t,e,n);l++)n="index"+l;return[Z.mkText("for (let "+n+" = 0; "),Z.mkInfix(Z.mkText(n),"<",o),Z.mkText("; "+n+"++)"),r]}(t,e,Q);break;case"device_while":B=Q,C=dt(x=t,nt(E=e,"COND"),B),A=kt(x,nt(E,"DO")),i=[Z.mkText("while ("),C,Z.mkText(")"),A];break;case"procedures_defnoreturn":k=t,_=mt((b=e).getFieldValue("NAME"),k,!0),T=nt(b,"STACK"),i=[Z.mkText("function "+_+"() "),kt(k,T)];break;case"function_definition":h=t,f=mt((m=e).getField("function_name").getText(),h,!0),g=nt(m,"STACK"),y=m.getArguments().map(function(t){return mt(t.name,h)+": "+t.type}),v=Bt(m,!1),i=[Z.mkText("function "+f+" ("+y.join(", ")+")"+(v?": any":"")),kt(h,g)];break;case"procedures_callnoreturn":i=[(u=t,p=e,d=mt(p.getFieldValue("NAME"),u,!0),Z.mkStmt(Z.mkText(d+"()")))];break;case"function_call":i=[ut(t,e,Q,!0)];break;case pxtc.TS_RETURN_STATEMENT_TYPE:i=[(l=t,a=e,s=Q,c=nt(a,"RETURN_VALUE"),c&&"placeholder"!=c.type?Z.mkStmt(Z.mkText("return "),dt(l,c,s)):Z.mkStmt(Z.mkText("return")))];break;case ts.pxtc.ON_START_TYPE:i=(o=t,r=e,n=kt(o,nt(r,"HANDLER")),Ct.appTarget.compile&&Ct.appTarget.compile.onStartText&&n&&n.children&&n.children.unshift(Z.mkStmt(Z.mkText("// "+pxtc.ON_START_COMMENT+"\n"))),n).children;break;case pxtc.TS_STATEMENT_TYPE:i=e.getLines().map(function(t){return Z.mkText(t+"\n")});break;case pxtc.PAUSE_UNTIL_TYPE:i=function(t,e,i){var o=Ct.appTarget.runtime&&Ct.appTarget.runtime.pauseUntilBlock;Ct.Util.assert(!!o,"target has block enabled");var r=o.namespace,n=o.callName||"pauseUntil",l=gt(t,e,{definitionName:"PREDICATE",actualName:"PREDICATE"},i),a=[Z.mkGroup([Z.mkText("() => "),l])];return r?[Z.mkStmt(Z.H.namespaceCall(r,n,a,!1))]:[Z.mkStmt(Z.H.mkCall(n,a,!1,!1))]}(t,e,Q);break;case pxtc.TS_DEBUGGER_TYPE:i=function(t,e){if("1"==e.getFieldValue("ON_OFF"))return[Z.mkText("debugger;\n")];return[]}(0,e);break;case pxtc.TS_BREAK_TYPE:i=[Z.mkText("break;\n")];break;case pxtc.TS_CONTINUE_TYPE:i=[Z.mkText("continue;\n")];break;default:i=t.stdCallTable[e.type]?[ft(t,e,Q)]:[Z.mkStmt(dt(t,e,Q))]}var J=i[i.length-1];return J&&!J.id&&(J.id=e.id),Q.length&&function(t,e){for(var i=[],o=0,r=t;o<r.length;o++)for(var n=r[o],l=0,a=n.split("\n");l<a.length;l++){var s=a[l];i.push(Z.mkText("// "+s)),i.push(Z.mkNewLine())}for(var c=0,u=i.reverse();c<u.length;c++){var p=u[c];e.unshift(p)}}(Q,i),i.forEach(function(t){!(t.type===Z.NT.Block||t.type===Z.NT.Prefix&&Ct.Util.startsWith(t.op,"//"))||e.type==pxtc.ON_START_TYPE&&t.id||(t.id=e.id)}),i}function kt(e,t){for(var i=[],o=t;t;)t.isEnabled()&&$(i,B(e,t)),t=t.getNextBlock();return o&&e.blockDeclarations[o.id]&&e.blockDeclarations[o.id].filter(function(t){return!t.alreadyDeclared}).forEach(function(t){i.unshift(N(t,e.blocksInfo)),t.alreadyDeclared=tt.Implicit}),Z.mkBlock(i)}function bt(t){var e=Z.mkStmt(Z.mkText(";"));return e.glueToBlock=Z.GlueMode.NoSpace,Z.mkGroup([e,t])}function n(t,i,e){void 0===e&&(e={});var o={workspace:t,options:e,stdCallTable:{},userFunctionReturnValues:{},diagnostics:[],errors:[],renames:{oldToNew:{},takenNames:{},oldToNewFunctions:{}},stats:{},enums:[],kinds:[],idToScope:{},blockDeclarations:{},allVariables:[],blocksInfo:null};return(o.blocksInfo=i)&&(Object.keys(i.apis.byQName).forEach(function(t){var e=i.apis.byQName[t];!e.pkg||6!==e.kind&&3!==e.kind&&5!==e.kind&&4!==e.kind||(o.renames.takenNames[e.qName]=!0)}),i.enumsByName&&Object.keys(i.enumsByName).forEach(function(t){return o.enums.push(i.enumsByName[t])}),i.kindsByName&&Object.keys(i.kindsByName).forEach(function(t){return o.kinds.push(i.kindsByName[t])}),i.blocks.forEach(function(t){if(o.stdCallTable[t.attributes.blockId])Ct.reportError("blocks","function already defined",{details:t.attributes.blockId,qualifiedName:t.qName,packageName:t.pkg});else{o.renames.takenNames[t.namespace]=!0;var e=Ct.blocks.compileInfo(t),i=!!e.thisParameter;o.stdCallTable[t.attributes.blockId]={namespace:t.namespace,f:t.name,comp:e,attrs:t.attributes,isExtensionMethod:i,isExpression:t.retType&&"void"!==t.retType,imageLiteral:t.attributes.imageLiteral,imageLiteralColumns:t.attributes.imageLiteralColumns,imageLiteralRows:t.attributes.imageLiteralRows,hasHandler:Ct.blocks.hasHandler(t),property:!t.parameters,isIdentity:"TD_ID"==t.attributes.shim}}}),t.getTopBlocks(!1).filter(R).forEach(function(t){mt("procedures_defnoreturn"===t.type?t.getFieldValue("NAME"):t.getField("function_name").getText(),o,!0)})),o}function C(t,e){if(t.type===ts.pxtc.ON_START_TYPE)return 0;var i=e.stdCallTable[t.type],o=A(e,t),r=1+ts.pxtc.Util.codalHash16(o);return i&&i.attrs.afterOnStart?r:-r}function l(i,o,e){try{var t=o.getAllBlocks(),r=o.getTopBlocks(!0);r=r.sort(function(t,e){return C(t,i)-C(e,i)}),function(r,t,e){t.forEach(function(t){return t.setEnabled(!0)});var o={};function n(t,e){var i=o[t];i?I(e,!1):(I(e,!0),o[t]=e)}e.forEach(function(t){var e=r.stdCallTable[t.type];if(t.type==ts.pxtc.ON_START_TYPE)n(ts.pxtc.ON_START_TYPE,t);else{if(R(t)||e&&e.attrs.blockAllowMultiple&&!e.attrs.handlerStatement)return;if(e&&e.hasHandler&&!e.attrs.handlerStatement){var i=e.attrs.blockHandlerKey||A(r,t);n(i,t)}else for(var o=t;o;)I(t,!1),o=o.getNextBlock()}})}(i,t,r),t=t.filter(function(t){return t.isEnabled()}),function(t,i){var o,p=1;t.forEach(function(t){if(t.type===ts.pxtc.ON_START_TYPE){var e=t.getInputTargetBlock("HANDLER");e&&d(e,o={firstStatement:e,declaredVars:{},referencedVars:[],children:[],assignedVars:[]},i)}}),o||(o={firstStatement:null,declaredVars:{},referencedVars:[],children:[],assignedVars:[]});return t.forEach(function(t){t.type!==ts.pxtc.ON_START_TYPE&&d(t,o,i)}),Object.keys(o.declaredVars).forEach(function(t){var e=o.declaredVars[t];delete o.declaredVars[t],(function t(e,i){var o;if(-1!==e.referencedVars.indexOf(i))return e;for(var r=0,n=e.children;r<n.length;r++){var l=n[r];if(S(l,i)){if(D(l,i))return e;if(o)return e;o=l}}return o?t(o,i):void 0}(o,e.id)||o).declaredVars[t]=e}),function e(i,o){var t=Object.keys(i.declaredVars);if(t.length){var r=t.map(function(t){return i.declaredVars[t]});i.firstStatement&&(o.blockDeclarations[i.firstStatement.id]=r.concat(o.blockDeclarations[i.firstStatement.id]||[])),r.forEach(function(t){return o.allVariables.push(t)})}i.children.forEach(function(t){return e(t,o)})}(o,i),function e(o,r){for(var t=0,i=Object.keys(o.declaredVars);t<i.length;t++){var n=i[t],l=o.declaredVars[n];l.escapedName||(l.escapedName=a(n))}function a(t){if(!t)return"_";var e=ts.pxtc.escapeIdentifier(t);if(r.renames.takenNames[e]||s(e,o)){for(var i=2;r.renames.takenNames[e+i]||s(e+i,o);)i++;e+=i}return e}function s(t,e){if(e){for(var i=0,o=Object.keys(e.declaredVars);i<o.length;i++){var r=o[i],n=e.declaredVars[r];if(n.name!==n.escapedName&&n.escapedName===t)return!0}return s(t,e.parent)}return!1}o.children.forEach(function(t){return e(t,r)})}(o,i);function d(t,i,o){if(o.idToScope[t.id]=i,"variables_get"===t.type){var e=t.getField("VAR").getText(),r=h(e,i);i.referencedVars.push(r.id)}else if("variables_set"===t.type||"variables_change"===t.type){var n=t.getField("VAR").getText(),r=h(n,i);i.assignedVars.push(r.id),i.referencedVars.push(r.id)}else if(t.type===pxtc.TS_STATEMENT_TYPE){var l=t.declaredVariables;if(l){var a=l.split(",");a.forEach(function(t){var e=h(t,i);e.alreadyDeclared=tt.Argument})}}if(t.inputList.some(function(t){return t.type===Blockly.NEXT_STATEMENT})){var s=function(t,e){switch(t.type){case"pxt_controls_for":case"controls_simple_for":return[[rt(t).getField("VAR").getText(),m]];case"pxt_controls_for_of":case"controls_for_of":return[[rt(t).getField("VAR").getText(),g(null)]]}if(E(t)){var i=t.mutation.getDeclaredVariables();if(i)return Object.keys(i).map(function(t){return[t,g(i[t])]})}var o=e.stdCallTable[t.type];if(o&&o.comp.handlerArgs.length)return w(t,o);return[]}(t,o).map(function(t){return{name:t[0],type:t[1],id:p++}}),c=i;s.length&&(c={parent:i,firstStatement:t,declaredVars:{},referencedVars:[],assignedVars:[],children:[]},s.forEach(function(t){t.alreadyDeclared=tt.Assigned,c.declaredVars[t.name]=t}),o.idToScope[t.id]=c),i!==c&&i.children.push(c),Et(t,function(t){d(t,c,o)}),u=function(t){var e={parent:c,firstStatement:t,declaredVars:{},referencedVars:[],assignedVars:[],children:[]};c.children.push(e),d(t,e,o)},t.inputList.filter(function(t){return t.type===Blockly.NEXT_STATEMENT}).forEach(function(t){t.connection&&t.connection.targetBlock()&&u(t.connection.targetBlock())})}else Et(t,function(t){d(t,i,o)});var u;t.nextConnection&&t.nextConnection.targetBlock()&&d(t.nextConnection.targetBlock(),i,o)}function h(t,e){return e.declaredVars[t]?e.declaredVars[t]:e.parent?h(t,e.parent):(e.declaredVars[t]={name:t,type:g(null),id:p++},e.declaredVars[t])}}(r=r.filter(function(t){return t.isEnabled()}),i),p(t,i);var n=[],l=function(t,e){if(!t.length||t.some(function(t){return!t.rendered}))return{orphans:e,idToComments:{}};for(var i=t.map(function(t){var e=t.getBoundingRectangle(),i=t.getHeightWidth();return{id:t.id,x:e.left,y:e.top,width:i.width,height:i.height}}),o={orphans:[],idToComments:{}},r=0,n=e;r<n.length;r++){for(var l=n[r],a=l.getBoundingRectangle(),s=l.getHeightWidth(),c=a.left,u=a.top,p=void 0,d=0,h=i;d<h.length;d++){var m=h[d];L(c,u,s.width,s.height,m)?p=m:!p&&L(c-20,u-20,s.width+40,s.height+40,m)&&(p=m)}p?(o.idToComments[p.id]||(o.idToComments[p.id]=[]),o.idToComments[p.id].push(l)):o.orphans.push(l)}return o}(r,o.getTopComments(!0));l.orphans.forEach(function(t){return $(n,f(t).children)}),r.forEach(function(t){if(l.idToComments[t.id]&&l.idToComments[t.id].forEach(function(t){$(n,f(t).children)}),t.type==ts.pxtc.ON_START_TYPE)$(n,B(i,t));else{var e=Z.mkBlock(B(i,t));e.type==Z.NT.Block?$(n,e.children):n.push(e)}});var u=[];i.enums.forEach(function(a){var t=o.getVariablesOfType(a.name);if(t&&t.length){var e=t.map(function(t){var e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]});e.sort(function(t,e){return t[1]-e[1]});var s=[],c=-1;e.forEach(function(t,e){var i,o=t[0],r=t[1];if(a.isBitMask){var n=Math.log2(r);0<=n&&Math.floor(n)===n&&(i=Z.H.mkAssign(Z.mkText(o),Z.H.mkSimpleCall("<<",[Z.H.mkNumberLiteral(1),Z.H.mkNumberLiteral(n)])))}else if(a.isHash){var l=ts.pxtc.Util.codalHash16(o.toLowerCase());i=Z.H.mkAssign(Z.mkText(o),Z.H.mkNumberLiteral(l))}i||(i=r===c+1?Z.mkText(o):Z.H.mkAssign(Z.mkText(o),Z.H.mkNumberLiteral(r))),s.push(i),c=r});var i=Z.mkCommaSep(s,!0);i.glueToBlock=Z.GlueMode.NoSpace,u.push(Z.mkGroup([Z.mkText("enum "+a.name),Z.mkBlock([i])]))}}),i.kinds.forEach(function(e){var t=o.getVariablesOfType("KIND_"+e.name);if(t&&t.length){var i=t.map(function(t){return t.name}).filter(function(t){return-1===e.initialMembers.indexOf(t)});i.length&&u.push(Z.mkGroup([Z.mkText("namespace "+e.name),Z.mkBlock(i.map(function(t){return Z.mkStmt(Z.mkText("export const "+t+" = "+e.name+"."+e.createFunctionName+"()"))}))]))}});var a=i.allVariables.filter(function(t){return!t.alreadyDeclared}).map(function(t){return N(t,e)});return i.allVariables.filter(function(t){return t.alreadyDeclared===tt.Implicit&&!t.isAssigned}).forEach(function(t){var e=lt(t.type);"string"===e.type||"number"===e.type||"boolean"===e.type||b(e.type)||i.diagnostics.push({blockId:t.firstReference&&t.firstReference.id,message:lf("Variable '{0}' is never assigned",t.name)})}),[u.concat(a.concat(n)),i.diagnostics]}catch(t){var s=t.block;if(!s)throw t;s.setWarningText(t+""),i.errors.push(s)}finally{c()}return[null,null]}function A(t,e){return e.type==ts.pxtc.ON_START_TYPE?JSON.stringify({name:ts.pxtc.ON_START_TYPE}):e.type==ts.pxtc.FUNCTION_DEFINITION_TYPE?JSON.stringify({type:"function",name:e.getFieldValue("function_name")}):JSON.stringify(function t(e){var i=[];var o=[];for(var r=0,n=e.inputList;r<n.length;r++){for(var l=n[r],a=0,s=l.fieldRow;a<s.length;a++){var c=s[a];c.name&&i.push(c.getText())}l.type===Blockly.INPUT_VALUE&&(l.connection.targetBlock()?o.push(t(l.connection.targetBlock())):o.push(null))}return{type:e.type,fields:i,inputs:o}}(e)).replace(/"id"\s*:\s*"[^"]+"/g,"")}function I(t,e){t.setEnabled(e);for(var i=0,o=t.getDescendants(!1);i<o.length;i++){o[i].setEnabled(e)}}function s(t,e,i){var o=Z.flattenNode(e);return r("format",{format:{input:o.output,pos:1}}).then(function(){return{source:o.output,sourceMap:o.sourceMap,stats:t.stats,diagnostics:i||[]}})}function _t(t,e){t.comment&&("string"==typeof t.comment?e.push(t.comment):e.push(t.comment.getText()))}function N(t,e){var i,o=lt(t.type),r="";if("null"==(i="Array"===o.type?Z.mkText("[]"):pt(o)).op||"[]"==i.op){var n=o.type;"Array"!==n&&"null[]"!==n||(n="number[]");var l=e.apis.byQName[n];l&&l.attributes.autoCreate?i=Z.mkText(l.attributes.autoCreate+"()"):r=": "+n}return Z.mkStmt(Z.mkText("let "+t.escapedName+r+" = "),i)}function Tt(t){if(t.mutationToDom){var e=t.mutationToDom();if(e.hasAttribute("_expanded")){var i=parseInt(e.getAttribute("_expanded"));return isNaN(i)?0:Math.max(i,0)}}return 0}function xt(t,e){var i=t.comp,o=[];return i.thisParameter&&o.push(i.thisParameter),i.parameters.forEach(function(t){t.isOptional&&0<e?(o.push(t),--e):t.isOptional||o.push(t)}),o}function w(t,e){var i=[];if(e.attrs.draggableParameters)for(var o=0;o<e.comp.handlerArgs.length;o++){var r=void 0,n=nt(t,"HANDLER_DRAG_PARAM_"+(l=e.comp.handlerArgs[o]).name);if(null===(r="reporter"===e.attrs.draggableParameters?n&&n.getFieldValue("VALUE"):n&&n.getField("VAR").getText()))break;i.push([r,g(l.type)])}else for(o=0;o<e.comp.handlerArgs.length;o++){var l=e.comp.handlerArgs[o],a=t.getField("HANDLER_"+l.name);if(null===(r=a&&a.getText()))break;i.push([r,g(l.type)])}return i}function S(t,e){if(-1!==t.referencedVars.indexOf(e))return!0;for(var i=0,o=t.children;i<o.length;i++){if(S(o[i],e))return!0}return!1}function D(t,e){if(-1!==t.assignedVars.indexOf(e))return!0;for(var i=0,o=t.children;i<o.length;i++){if(D(o[i],e))return!0}return!1}function Et(t,e,i){void 0===i&&(i=!1),t.inputList.filter(function(t){return t.type===Blockly.INPUT_VALUE}).forEach(function(t){t.connection&&t.connection.targetBlock()&&(e(t.connection.targetBlock()),i&&Et(t.connection.targetBlock(),e,i))})}function L(t,e,i,o,r){var n=a(t,r.x,r.x+r.width)||a(r.x,t,t+i),l=a(e,r.y,r.y+r.height)||a(r.y,e,e+o);return n&&l;function a(t,e,i){return e<=t&&t<=i}}function R(t){return"procedures_defnoreturn"===t.type||"function_definition"===t.type}function u(t){return t.getField("function_name").getText()}function Bt(t,a){var s=u(t),c={};return function t(e){var i;i=a?e.getDescendants(!1).filter(function(t){return"function_return"==t.type}).map(function(t){return nt(t,"RETURN_VALUE")}).filter(function(t){return t&&"function_call_output"===t.type}):e.getDescendants(!1).filter(function(t){return"function_call_output"==t.type});for(var o=0,r=i;o<r.length;o++){var n=r[o],l=u(n);if(l===s)return!0;if(!c[l]&&(c[l]=!0,t(Blockly.Functions.getDefinition(l,n.workspace))))return!0}return!1}(t)}Z.compileExpression=dt,Z.escapeVarName=mt,Z.mkEnv=n,Z.compileBlockAsync=function(t,e){var i=t.workspace,o=n(i,e);p(i&&i.getAllBlocks(),o);var r=B(o,t);return c(),s(o,r)},Z.callKey=A,Z.findBlockIdByPosition=function(t,e){if(e){for(var i,o,r=0;r<t.length;++r){var n=t[r];n.startPos<=e.start&&n.endPos>=e.start+e.length&&(!i||o>n.endPos-n.startPos)&&(o=(i=n).endPos-n.startPos)}return i?i.id:void 0}},Z.findBlockIdByLine=function(t,e){if(e){for(var i,o,r=0;r<t.length;++r){var n=t[r];n.startLine<=e.start&&n.endLine>e.start+e.length&&(!i||o>n.endLine-n.startLine)&&(o=(i=n).endLine-n.startLine)}return i?i.id:void 0}},Z.compileAsync=function(t,e,i){void 0===i&&(i={});var o=n(t,e,i),r=l(o,t,e);return s(o,r[0],r[1])}}(Ct.blocks||(Ct.blocks={}))}(pxt||(pxt={})),function(n){!function(t){var r={};function e(t,e,i){null==r[t]&&(r[t]={field:e,validator:i})}t.initFieldEditors=function(){e("text",pxtblockly.FieldTextInput),e("note",pxtblockly.FieldNote),e("gridpicker",pxtblockly.FieldGridPicker),e("textdropdown",pxtblockly.FieldTextDropdown),e("numberdropdown",pxtblockly.FieldNumberDropdown),e("imagedropdown",pxtblockly.FieldImageDropdown),e("colorwheel",pxtblockly.FieldColorWheel),e("toggle",pxtblockly.FieldToggle),e("toggleonoff",pxtblockly.FieldToggleOnOff),e("toggleyesno",pxtblockly.FieldToggleYesNo),e("toggleupdown",pxtblockly.FieldToggleUpDown),e("toggledownup",pxtblockly.FieldToggleDownUp),e("togglehighlow",pxtblockly.FieldToggleHighLow),e("togglewinlose",pxtblockly.FieldToggleWinLose),e("colornumber",pxtblockly.FieldColorNumber),e("images",pxtblockly.FieldImages),e("sprite",pxtblockly.FieldSpriteEditor),e("animation",pxtblockly.FieldAnimationEditor),e("tilemap",pxtblockly.FieldTilemap),e("tileset",pxtblockly.FieldTileset),e("speed",pxtblockly.FieldSpeed),e("turnratio",pxtblockly.FieldTurnRatio),e("protractor",pxtblockly.FieldProtractor),e("position",pxtblockly.FieldPosition),e("melody",pxtblockly.FieldCustomMelody)},t.registerFieldEditor=e,t.createFieldEditor=function(t,e,i){if(null==r[t])return console.error("Field editor "+t+" not registered"),null;i||(i={}),n.Util.assert(null==i.lightMode,"lightMode is a reserved parameter for custom fields"),i.lightMode=n.options.light;var o=r[t];return new o.field(e,i,o.validator)}}(n.blocks||(n.blocks={}))}(pxt||(pxt={})),function(I){!function(E){E.needsDecompiledDiff=function(t,e){if(!t||!e)return!1;var i={};if(t.replace(/id="([^"]+)"/g,function(t,e){return i[e]=!0,""}),!Object.keys(i).length)return!1;var o=0,r=0;return e.replace(/id="([^"]+)"/g,function(t,e){return o++,i[e]&&r++,""}),0<o&&0==r},E.diffXml=function(t,e,i){return a(I.blocks.loadWorkspaceXml(t,!0),I.blocks.loadWorkspaceXml(e,!0),i)};var B="#d0d0d0";function a(t,e,i){try{return Blockly.Events.disable(),function(l,e,o){I.tickEvent("blocks.diff",{started:1}),o=o||{};var a=C();if(!l)return{ws:void 0,message:lf("All blocks are new."),added:0,deleted:0,modified:1};if(!e)return{ws:void 0,message:lf("The current blocks seem corrupted."),added:0,deleted:0,modified:1};var r=I.Util.toDictionary(l.getTopBlocks(!1),function(t){return A(t,!0)});e.getTopBlocks(!1).forEach(function(t){var e=A(t,!0),i=l.getBlockById(t.id)||r[e];if(i){var o=A(i,!0);e==o&&(a("fast unmodified top ",t.id),t.dispose(!1),i.dispose(!1))}});var t=l.getAllBlocks().filter(function(t){return t.isEnabled()}),i=l.getTopBlocks(!1).filter(function(t){return t.isEnabled()}),n=e.getAllBlocks().filter(function(t){return t.isEnabled()});if(a("blocks",n.map(function(t){return t.toDevString()})),a(n),0==t.length&&0==n.length)return I.tickEvent("blocks.diff",{moves:1}),{ws:void 0,message:lf("Some blocks were moved or changed."),added:0,deleted:0,modified:1};var s=i.filter(function(t){return!e.getBlockById(t.id)}),c=t.filter(function(t){return!e.getBlockById(t.id)}),u=n.filter(function(t){return!l.getBlockById(t.id)}),p=I.blocks.initRenderingWorkspace(),d=I.blocks.saveWorkspaceXml(e,!0);I.blocks.domToWorkspaceNoEvents(Blockly.Xml.textToDom(d),p),p.getAllBlocks().filter(function(t){return!t.isEnabled()}).forEach(function(t){a("disabled ",t.toDevString()),t.dispose(!1)});var h=I.Util.toDictionary(p.getAllBlocks(),function(t){return t.id});a("todo blocks",h),x("start"),o.hideDeletedTopBlocks||(s.forEach(function(t){a("deleted top "+t.toDevString()),T(t);var e=_(t);T(e),e.setDisabled(!0)}),x("deleted top"));u.map(function(t){return p.getBlockById(t.id)}).filter(function(t){return!!t}).forEach(function(t){a("added "+t.toDevString()),T(t)}),x("added");var m={};if(!o.hideDeletedBlocks){var f=c.filter(function(t){return!(h[t.id]||b(t)||t.outputConnection&&t.outputConnection.isConnected())});f.forEach(function(t){var e=_(t);m[t.id]=e.id,a("deleted block "+t.toDevString()+"->"+e.toDevString())}),f.forEach(function(t){return function(t){a("stitching "+t.toDevString()+"->"+m[t.id]);var e=p.getBlockById(m[t.id]);e.setDisabled(!0),k(e),T(e);var i=t.getPreviousBlock();if(i){var o=p.getBlockById(m[i.id])||p.getBlockById(i.id);if(a("previous "+t.id+"->"+e.toDevString()+": "+o.toDevString()),o)if(o.nextConnection)e.previousConnection.connect(o.nextConnection);else{var r=o.inputList.slice().reverse().find(function(t){return t.connection&&t.connection.type==Blockly.NEXT_STATEMENT});r&&e.previousConnection.connect(r.connection)}}var n=t.getNextBlock();if(n){var l=p.getBlockById(m[n.id])||p.getBlockById(n.id);l&&(a("next "+t.id+"->"+e.toDevString()+": "+l.toDevString()),e.nextConnection.connect(l.previousConnection))}}(t)})}var g=0;if(I.Util.values(h).filter(function(t){return function(t){var e=l.getBlockById(t.id);if(!e)return!1;var i=t.getPreviousBlock();if(i&&!h[i.id])return!1;var o=t.getNextBlock();if(o&&!h[o.id])return!1;var r=e.getPreviousBlock();if(!r&&!i)return!1;if(!!r!=!!i||r.id!=i.id)return!0;var n=e.getNextBlock();return!(!n&&!o||!!n==!!o&&n.id==o.id)}(t)}).forEach(function(t){a("moved "+t.toDevString()),delete h[t.id],k(t),g++}),x("moved"),I.Util.values(h).filter(function(t){return function(t){var e=l.getBlockById(t.id);if(!e)return!1;var i=A(e),o=A(t);return i!=o&&(a("old "+e.toDevString(),i),a("new "+t.toDevString(),o),!0)}(t)}).forEach(function(t){a("changed "+t.toDevString()),delete h[t.id],k(t),g++}),x("changed"),p.getTopBlocks(!1).forEach(function(t){t.getDescendants(!1).find(function(t){return b(t)})||(a("unmodified top "+t.toDevString()),delete h[t.id],t.dispose(!1))}),x("cleaned"),I.Util.values(h).filter(function(t){return!!p.getBlockById(t.id)}).forEach(function(t){!function e(t){var i;t.setColour(B),(i=t).rendered=!1,i.inputList.forEach(function(t){return t.fieldRow.forEach(function(t){t.init(),t.borderRect_&&(t.borderRect_.setAttribute("fill",i.getColour()),t.borderRect_.setAttribute("stroke",i.getColourTertiary()))})}),o.statementsOnly&&(t.inputList||[]).map(function(t){return t.type==Blockly.INPUT_VALUE&&t.connection&&t.connection.targetBlock()}).filter(function(t){return!!t}).forEach(function(t){return e(t)})}(t)}),x("unmodified"),!p.getAllBlocks().length)return I.tickEvent("blocks.diff",{missed:1}),{ws:p,message:lf("Some blocks were changed."),deleted:c.length,added:u.length,modified:g};p.resize(),Blockly.svgResize(p);var y=I.blocks.renderWorkspace(o.renderOptions||{emPixels:20,layout:E.BlockLayout.Flow,aspectRatio:.5,useViewWidth:!0}),v={ws:p,svg:y,deleted:c.length,added:u.length,modified:g};return I.tickEvent("blocks.diff",{deleted:v.deleted,added:v.added,modified:v.modified}),v;function k(t){t.__pxt_used=!0}function b(t){return!!t.__pxt_used}function _(t){var e=Blockly.Xml.blockToDom(t,!1),i=Blockly.Xml.domToBlock(e,p);return i.nextConnection&&i.nextConnection.targetConnection&&i.nextConnection.disconnect(),i.previousConnection&&i.previousConnection.targetConnection&&i.previousConnection.disconnect(),i}function T(t){t.getDescendants(!1).forEach(function(t){delete h[t.id],k(t)})}function x(t){a(t+":",I.Util.values(h).map(function(t){return t.toDevString()}))}}(t,e,i)}catch(t){return I.reportException(t),{ws:void 0,message:lf("Oops, we could not diff those blocks."),error:t,deleted:0,added:0,modified:0}}finally{Blockly.Events.enable()}}function C(){return I.options.debug||window&&/diffdbg=1/.test(window.location.href)?console.log:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]}}function A(t,e){var i=Blockly.Xml.blockToDom(t,!0);return o(i),function t(e,i){if(!e)return;i(e);for(var o=0,r=I.Util.toArray(e.children);o<r.length;o++){var n=r[o];t(n,i)}}(i,function(t){o(t),e||("next"==t.localName?t.remove():"statement"==t.localName?t.remove():"shadow"==t.localName&&t.remove())}),Blockly.Xml.domToText(i)}function o(t){t.removeAttribute("id"),t.removeAttribute("x"),t.removeAttribute("y"),t.removeAttribute("deletable"),t.removeAttribute("editable"),t.removeAttribute("movable")}E.mergeXml=function(t,e,i){return t==e?i:i==e?t:void 0},E.decompiledDiffAsync=function(t,c,e,u,i){void 0===i&&(i={});var p=C(),o=c.outfiles["main.blocks"],d=u.outfiles["main.blocks"];p(o),p(d);var r=I.diff.compute(t,e,{ignoreWhitespace:!0,full:!0});p(r);var h={},m=0,f=0;r.forEach(function(t,e){var i=t[0],o=t.substr(2),r=o.length;switch(i){case"-":m+=r+1;break;case"+":f+=r+1;break;default:var n=/^\s+/.exec(o);if(n){var l=n[0].length;m+=l,f+=l,r-=l}var a=I.blocks.findBlockIdByPosition(u.blockSourceMap,{start:f,length:r});if(a&&!h[a]){var s=I.blocks.findBlockIdByPosition(c.blockSourceMap,{start:m,length:r});s&&(p(t),p("id "+m+":"+o.length+">"+s+" ==> "+f+":"+o.length+">"+a),h[a]=s,d=d.replace(a,s))}m+=r+1,f+=r+1}});var n=I.blocks.loadWorkspaceXml(o,!0),l=I.blocks.loadWorkspaceXml(d,!0);return i.statementsOnly=!0,a(n,l,i)}}(I.blocks||(I.blocks={}))}(pxt||(pxt={})),function(f){!function(p){function u(t,e){for(var i=[],o=0;o<t.childNodes.length;o++){var r=t.childNodes.item(o);r.tagName===e&&i.push(r)}return i}function d(t,e){return h(t,"block","type",e).concat(h(t,"shadow","type",e))}function h(t,e,i,o){return f.Util.toArray(t.getElementsByTagName(e)).filter(function(t){return t.getAttribute(i)===o})}function c(t,e,i,o){var r=h(t,e,i,o);return r.length?r[0]:void 0}function m(n,l,a){var t,e=a.getAttribute("type"),i=Blockly.Blocks[e],o=p.blockSymbol(e);if(o&&i){var s=p.compileInfo(o);null===(t=o.parameters)||void 0===t||t.forEach(function(t,e){var i=n.apis.byQName[t.type];if(i&&6==i.kind){var o=c(a,"field","name",s.actualNameToParam[t.name].definitionName);if(o){var r=l[i.name+"."+o.textContent];r&&(o.textContent=r)}}})}}p.domToWorkspaceNoEvents=function(t,e){f.tickEvent("blocks.domtow");try{Blockly.Events.disable();var i=Blockly.Xml.domToWorkspace(t,e);return(o=e).getAllBlocks().filter(function(t){return!!t.comment&&t.comment instanceof Blockly.Comment}).forEach(function(t){var e=t.comment.getText();if(/@highlight/.test(e)){var i=e.replace(/@highlight/g,"").trim();t.setCommentText(i||null),o.highlightBlock(t.id)}}),i}finally{Blockly.Events.enable()}var o},p.clearWithoutEvents=function(t){if(f.tickEvent("blocks.clear"),t)try{Blockly.Events.disable(),t.clear(),t.clearUndo()}finally{Blockly.Events.enable()}},p.saveWorkspaceXml=function(t,e){var i=Blockly.Xml.workspaceToDom(t,!e);return Blockly.Xml.domToText(i)},p.saveBlocksXml=function(t,e){return t.getTopBlocks(!1).map(function(t){return Blockly.Xml.domToText(Blockly.Xml.blockToDom(t,!e))})},p.getDirectChildren=u,p.getBlocksWithType=d,p.getChildrenWithAttr=h,p.getFirstChildWithAttr=c,p.loadBlocksXml=function(t,e){var i=Blockly.Xml.textToDom(e),o=Blockly.Xml.domToBlock(i,t);if(t.getMetrics){var r=t.getMetrics(),n=o.getHeightWidth();o.moveBy(r.viewLeft+r.viewWidth/2-n.width/2,r.viewTop+r.viewHeight/2-n.height/2)}},p.loadWorkspaceXml=function(t,e){void 0===e&&(e=!1);var i=new Blockly.Workspace;try{var o=Blockly.Xml.textToDom(t);return f.blocks.domToWorkspaceNoEvents(o,i),i}catch(t){return e||f.reportException(t),null}},p.importXml=function(t,e,i,o){void 0===o&&(o=!1);try{f.blocks.initializeAndInject(i);var r=(new DOMParser).parseFromString(e,"application/xml"),n=f.patching.computePatches(t);n&&(n.filter(function(t){return"blockId"==t.type}).forEach(function(i){return Object.keys(i.map).forEach(function(e){d(r,e).forEach(function(t){t.setAttribute("type",i.map[e]),f.debug("patched block "+e+" -> "+i.map[e])})})}),n.filter(function(t){return"blockValue"==t.type}).forEach(function(o){return Object.keys(o.map).forEach(function(e){var t=e.split("."),i=t[0];t[1],d(r,i).reduce(function(t,e){return t.concat(u(e,"value"))},[]).forEach(function(t){t.setAttribute("name",o.map[e]),f.debug("patched block value "+e+" -> "+o.map[e])})})}),n.filter(function(t){return"userenum"==t.type}).forEach(function(i){return Object.keys(i.map).forEach(function(e){h(r,"variable","type",e).forEach(function(t){t.setAttribute("type",i.map[e]),f.debug("patched enum variable type "+e+" -> "+i.map[e])})})}));var l={};Object.keys(i.apis.byQName).forEach(function(t){var e=i.apis.byQName[t];7==e.kind&&(l[e.namespace+"."+(e.attributes.blockImportId||e.attributes.block||e.attributes.blockId||e.name)]=e.namespace+"."+e.name)});for(var a=r.getElementsByTagName("block"),s=0;s<a.length;++s)m(i,l,a[s]);return function(e,t){var i=d(e,ts.pxtc.ON_START_TYPE),o=i.length?i[0]:void 0;if(o)o.removeAttribute("deletable");else{for(var r=[],n=t.blocksById,l=e.firstElementChild,a=void 0;l;){var s=l.nextElementSibling,c=l.getAttribute("type");if(!l.getAttribute("disabled")&&!l.getElementsByTagName("statement").length&&(f.blocks.buildinBlockStatements[c]||n[c]&&"void"==n[c].retType&&!p.hasArrowFunction(n[c])))if(a){var u=e.ownerDocument.createElement("next");u.appendChild(l),a.appendChild(u),l.removeAttribute("x"),l.removeAttribute("y"),a=l}else(a=e.ownerDocument.createElement("statement")).setAttribute("name","HANDLER"),o||((o=e.ownerDocument.createElement("block")).setAttribute("type",ts.pxtc.ON_START_TYPE),r.push(o)),o.appendChild(a),a.appendChild(l),l.removeAttribute("x"),l.removeAttribute("y"),a=l;l=s}r.forEach(function(t){return e.appendChild(t)})}}(r.documentElement,i),c=r.documentElement,f.U.toArray(c.querySelectorAll("block[type=procedures_defnoreturn]")).forEach(function(t){t.setAttribute("type","function_definition"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")}),f.U.toArray(c.querySelectorAll("block[type=procedures_callnoreturn]")).forEach(function(t){t.setAttribute("type","function_call"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")}),f.blocks.extensionBlocklyPatch&&f.blocks.extensionBlocklyPatch(t,r.documentElement),(new XMLSerializer).serializeToString(r)}catch(t){return o||f.reportException(t),e}var c}}(f.blocks||(f.blocks={}))}(pxt||(pxt={})),function(v){var t;(function(t){t.patchBlocksFromOldWorkspace=function(t,e,i){var r,n,l,a,s,o,c,u,p,d=v.blocks.loadWorkspaceXml(i,!0);return r=t,l=d,(n=e).getTopBlocks(!1).filter(function(t){return t.isEnabled()}).forEach(function(t){var e=t.xy_;if(e&&0!=e.x&&0!=e.y){a||(a=v.blocks.mkEnv(n,r),s={},l.getTopBlocks(!1).forEach(function(t){var e=v.blocks.callKey(a,t),i=s[e]||[];i.push(t),s[e]=i}));var i=v.blocks.callKey(a,t),o=(s[i]||[]).shift();o&&(o.xy_=e.clone())}}),o=e,c=d,u=Blockly.Xml.workspaceToDom(o,!0),p=Blockly.Xml.workspaceToDom(c,!0),v.Util.toArray(u.childNodes).filter(function(t){return t.nodeType==Node.ELEMENT_NODE&&"block"==t.localName&&"true"==t.getAttribute("disabled")}).forEach(function(t){return p.appendChild(p.ownerDocument.importNode(t,!0))}),Blockly.Xml.domToText(p)},t.splitSvg=function(d,t,h){void 0===h&&(h=18);var e=t.getTopComments(!0),i=t.getTopBlocks(!0);if(e.length+i.length<2)return d;var m=document.createElement("div");function r(t,e,i,o,r){var n=d.cloneNode(!0),l=n.querySelector("g.blocklyWorkspace > g."+t),a=n.querySelector("g.blocklyWorkspace > g."+e),s=v.Util.toArray(l.querySelectorAll("g.blocklyWorkspace > g."+t+" > g[data-id]")),c=s.splice(i,1)[0];if(c){s.filter(function(t){return t!=c}).forEach(function(t){t.parentNode.removeChild(t)}),l.removeAttribute("transform"),a.parentNode.removeChild(a),c.setAttribute("transform","translate("+r.x+", "+r.y+")");var u=o.width/h+"em",p=o.height/h+"em";n.setAttribute("viewBox","0 0 "+o.width+" "+o.height),n.style.width=u,n.style.height=p,n.setAttribute("width",u),n.setAttribute("height",p),m.appendChild(n)}else v.log("missing block, did block failed to load?")}return m.className="blocks-svg-list "+t.getInjectionDiv().className,e.forEach(function(t,e){return r("blocklyBubbleCanvas","blocklyBlockCanvas",e,t.getHeightWidth(),{x:0,y:0})}),i.forEach(function(t,e){var i=t.getHeightWidth(),o={x:0,y:0};t.getStartHat()&&(i.height+=h,o.y+=h),r("blocklyBlockCanvas","blocklyBubbleCanvas",e,i,o)}),m},t.verticalAlign=function(t,i){var o=0;t.getTopComments(!0).forEach(function(t){t.moveBy(0,o),o+=t.getHeightWidth().height,o+=i}),t.getTopBlocks(!0).forEach(function(t,e){t.getStartHat()&&(o+=i),t.moveBy(0,o),o+=t.getHeightWidth().height,o+=i})},t.setCollapsedAll=function(t,e){t.getTopBlocks(!1).filter(function(t){return t.isEnabled()}).forEach(function(t){return t.setCollapsed(e)})};var b=20,_=20;function o(t,e,i){var o;return i&&(o={target:v.appTarget.id,versions:v.appTarget.versions,xml:v.blocks.saveBlocksXml(t).map(function(t){return v.Util.htmlEscape(t)})}),r(t).then(function(t){return t?d(t.width,t.height,0|e||4,t.xml,i?JSON.stringify(o,null,2):null):Promise.resolve(void 0)}).catch(function(t){v.reportException(t)})}t.flow=function(t,e){if(e){if(e.useViewWidth){var i=t.getMetrics();if(i.viewHeight>i.viewWidth)return a(t.getTopComments(!0),t.getTopBlocks(!0),void 0,i.viewWidth),void t.scroll(b,_)}a(t.getTopComments(!0),t.getTopBlocks(!0),e.ratio)}else a(t.getTopComments(!0),t.getTopBlocks(!0));t.scroll(b,_)},t.screenshotEnabled=function(){return!v.BrowserUtils.isIE()&&!v.BrowserUtils.isUwpEdge()},t.screenshotAsync=function(t,e,i){return o(t,e,i)},t.toPngAsync=o;var u=1e6;function d(n,l,a,s,c){return new Promise(function(i,t){var o=document.createElement("canvas"),e=o.getContext("2d"),r=new Image;o.width=n*a,o.height=l*a,r.onload=function(){c&&(e.fillStyle="#fff",e.fillRect(0,0,o.width,o.height)),e.drawImage(r,0,0,n,l,0,0,o.width,o.height);for(var t=o.toDataURL("image/png");t.length>u;)o.width=o.width/2>>0,o.height=o.height/2>>0,v.log("screenshot size "+t.length+"b, shrinking to "+o.width+"x"+o.height),e.drawImage(r,0,0,n,l,0,0,o.width,o.height),t=o.toDataURL("image/png");c?v.lzmaCompressAsync(c).then(function(t){var e=v.Util.encodeBlobAsync(o,t);i(e.toDataURL("image/png"))}).done():i(t)},r.onerror=function(t){v.reportError("blocks","blocks screenshot failed"),i(void 0)},r.src=s})}var h,m,f="http://www.w3.org/1999/xlink";function r(t){if(!t)return Promise.resolve(void 0);var e=t.getBlocksBoundingBox(),i=t.getParentSvg().cloneNode(!0);n(i);var o=e.right-e.left,r=e.bottom-e.top;return l(i,e.left,e.top,o,r)}function g(t){return e((new XMLSerializer).serializeToString(t))}function e(t){return t.replace(new RegExp("&nbsp;","g"),"&#160;")}function n(t){v.BrowserUtils.removeClass(t,"blocklySvg"),v.BrowserUtils.addClass(t,"blocklyPreview pxt-renderer"),v.U.toArray(t.querySelectorAll(".blocklyMainBackground,.blocklyScrollbarBackground")).forEach(function(t){t&&t.parentNode.removeChild(t)}),v.U.toArray(t.querySelectorAll(".blocklyConnectionIndicator,.blocklyInputConnectionIndicator")).forEach(function(t){t&&t.parentNode.removeChild(t)}),t.removeAttribute("width"),t.removeAttribute("height"),v.U.toArray(t.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(function(t){return t.removeAttribute("transform")});var i=new DOMParser;return v.U.toArray(t.querySelectorAll(".blocklyCommentTextarea")).forEach(function(t){var e=i.parseFromString("<!doctype html><body>"+v.docs.html2Quote(t.value),"text/html");t.textContent=e.body.textContent}),t}function l(t,e,i,n,l){if(!t.childNodes[0])return Promise.resolve(void 0);t.removeAttribute("width"),t.removeAttribute("height"),t.removeAttribute("transform");var o=g(t).replace(/^\s*<svg[^>]+>/i,"").replace(/<\/svg>\s*$/i,""),r='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="'+f+'" width="'+n+'" height="'+l+'" viewBox="'+e+" "+i+" "+n+" "+l+'" class="pxt-renderer">'+o+"</svg>",a=(new DOMParser).parseFromString(r,"image/svg+xml"),s=a.createElementNS("http://www.w3.org/1999/xhtml","style"),c=v.Util.isUserLanguageRtl(),u=document.getElementById("style-"+(c?"rtl":"")+"blockly.css").href,p=v.Util.toArray(document.head.getElementsByTagName("link")).filter(function(t){return v.Util.endsWith(t.getAttribute("href"),"semantic.css")})[0].href;return Promise.all([v.BrowserUtils.loadAjaxAsync(u),v.BrowserUtils.loadAjaxAsync(p)]).then(function(t){var e,i,o=v.Util.toArray(document.head.querySelectorAll("style")).filter(function(t){return/\.blocklySvg/.test(t.innerText)})[0];t.unshift((null===(e=document.getElementById("blockly-common-style"))||void 0===e?void 0:e.innerText)||""),t.unshift((null===(i=document.getElementById("blockly-renderer-style-pxt"))||void 0===i?void 0:i.innerText)||"");var r=(o?o.innerText:"")+"\n\n"+t.map(function(t){return t+"\n\n"});return s.appendChild(a.createCDATASection(r)),a.documentElement.insertBefore(s,a.documentElement.firstElementChild),function(t){h||(h={});var e=t.getElementsByTagName("image"),i=v.Util.toArray(e).filter(function(t){var e=t.getAttributeNS(f,"href");return e&&!/^data:/.test(e)}).map(function(t){return t}).map(function(e){var n=e.getAttributeNS(f,"href"),l=h[n];return(l?Promise.resolve(h[n]):v.BrowserUtils.loadImageAsync(e.getAttributeNS(f,"href")).then(function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),o=t.width,r=t.height;return e.width=o,e.height=r,i.drawImage(t,0,0,o,r,0,0,e.width,e.height),h[n]=l=e.toDataURL("image/png"),l}).catch(function(t){v.debug("svg render: failed to load "+n)})).then(function(t){e.setAttributeNS(f,"href",t)})});return Promise.all(i).then(function(){})}(a).then(function(){return function(t){if(m||(m={}),!v.BrowserUtils.isEdge())return Promise.resolve();var e=t.getElementsByTagName("image"),i=v.Util.toArray(e).filter(function(t){return/^data:image\/svg\+xml/.test(t.getAttributeNS(f,"href"))}).map(function(t){return t}).map(function(e){var i=e.getAttributeNS(f,"href"),t=parseInt(e.getAttribute("width").replace(/[^0-9]/g,"")),o=parseInt(e.getAttribute("height").replace(/[^0-9]/g,"")),r=m[i];return(r?Promise.resolve(r):d(t,o,4,i)).then(function(t){m[i]=t,e.setAttributeNS(f,"href",t)})});return Promise.all(i).then(function(){})}(a)}).then(function(){return{width:n,height:l,svg:g(a).replace('<style xmlns="http://www.w3.org/1999/xhtml">',"<style>"),xml:y(a),css:r}})})}function y(t){var e=(new XMLSerializer).serializeToString(t);return"data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(unescape(encodeURIComponent(e)))}function a(t,e,i,o){void 0===i&&(i=1.62);var a,s=[],c={};t.forEach(function(t){var e=t.data;null!=e?c[e]=t:s.push(T(t))}),e.forEach(function(t){var e=t.data;if(e){for(var i=e.split(";"),o=[],r=0;r<i.length;r++){var n=c[i[r]];n&&(o.push(T(n)),delete c[i[r]])}if(o.length)return void s.push({value:t,width:-1,height:-1,children:o})}var l=T(t);!a&&t.isEnabled()&&t.type===pxtc.ON_START_TYPE?a=l:s.push(l)}),a&&s.unshift(a),Object.keys(c).sort(function(t,e){return t.length===e.length?e<t?-1:1:t.length>e.length?-1:1}).forEach(function(t){c[t]&&(a?(a.children||(a.children=[]),a.children.push(T(c[t]))):s.unshift(T(c[t])))});for(var r,n=0,l=0;l<s.length;l++){if((y=s[l]).children){var u=y.value.getHeightWidth();y.x=0,y.y=0;for(var p=u.width+13,d=0,h=0;h<y.children.length;h++)(v=y.children[h]).x=p,v.y=d,d+=v.height+13,y.width=Math.max(y.width,p+v.width);y.height=Math.max(d-13,u.height)}n+=(y.height+13)*(y.width+13)}r=b<o?o-b:Math.sqrt(n)*i;var m=b,f=_,g=0;for(l=0;l<s.length;l++){var y;if((y=s[l]).children)for(k(y,m+y.x,f+y.y),h=0;h<y.children.length;h++){var v;k(v=y.children[h],m+v.x,f+v.y)}else k(y,m,f);m+=y.width+45,g=Math.max(g,f+y.height+45),r<m&&(m=b,f=g)}function k(t,e,i){var o=t.value.getBoundingRectangle();t.value.moveBy(e-o.left,i-o.top)}}function T(t){var e=t.getHeightWidth();return{value:t,height:e.height,width:e.width}}t.toSvgAsync=r,t.serializeNode=g,t.serializeSvgString=e,t.cleanUpBlocklySvg=n,t.blocklyToSvgAsync=l,t.documentToSvg=y})((t=v.blocks||(v.blocks={})).layout||(t.layout={}))}(pxt||(pxt={})),function(V){!function(O){var v={string:{field:"TEXT",block:"text",defaultValue:""},number:{field:"NUM",block:"math_number",defaultValue:"0"},boolean:{field:"BOOL",block:"logic_boolean",defaultValue:"false"},Array:{field:"VAR",block:"variables_get",defaultValue:"list"}};function k(t){var e=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(t);return e?e[1]?e[1]:e[2]:void 0}O.optionalDummyInputPrefix="0_optional_dummy",O.optionalInputWithFieldPrefix="0_optional_field",O.isArrayType=k,O.isTupleType=function(t){var e=/^\[(.+)\]$/.exec(t);return e?e[1].split(/,\s*/):void 0};var e,m,o=/^(string|number|boolean)$/;function c(){return e||(e={},Object.keys(Blockly.Blocks).forEach(function(t){return e[t]={block:Blockly.Blocks[t]}})),e}O.builtinBlocks=c,O.buildinBlockStatements={controls_if:!0,controls_for:!0,pxt_controls_for:!0,controls_simple_for:!0,controls_repeat_ext:!0,pxt_controls_for_of:!0,controls_for_of:!0,variables_set:!0,variables_change:!0,device_while:!0};var u={};function r(t,e,i,o){var r;if(o=o||e.defaultValue,!(i=i||e.shadowBlockId)&&e.range&&(i="math_number_minmax"),r=o&&'"'==o.slice(0,1)?JSON.parse(o):o,"number"==e.type&&"value"==i)return(f=document.createElement("field")).setAttribute("name",e.definitionName),f.appendChild(document.createTextNode("0")),f;var n="variables_get"==i,l="text"==i,a=document.createElement("value");a.setAttribute("name",e.definitionName);var s=k(e.type),c=document.createElement(n||s?"block":"shadow");a.appendChild(c);var u,p=v[s||e.type];if(c.setAttribute("type",i||(s?"lists_create_with":p&&p.block||e.type)),c.setAttribute("colour",Blockly.Colours.textField),s){if(p&&!i){var d=void 0;switch(s){case"number":d=["0","1"];break;case"string":d=["a","b","c"];break;case"boolean":d=["FALSE","FALSE","FALSE"]}return b(c,p.block,p.field,d),a}if(i&&r)return b(c,r),a}if(!p||i&&p.block!==i&&"math_number_minmax"!==i){if(r){if((f=document.createElement("field")).textContent=r,n)f.setAttribute("name","VAR"),c.appendChild(f);else if(l)f.setAttribute("name","TEXT"),c.appendChild(f);else if(i){var h=t.blocksById[i];if(h&&h.attributes._def&&h.attributes._def.parameters.length){var m=h.attributes._def.parameters[0];f.setAttribute("name",m.name),c.appendChild(f)}}else f.setAttribute("name",e.definitionName),c.appendChild(f)}}else{var f=document.createElement("field");c.appendChild(f);var g,y=void 0;switch(i){case"variables_get":y="VAR";break;case"math_number_minmax":y="SLIDER";break;default:y=p.field}f.setAttribute("name",y),g="boolean"==e.type?document.createTextNode((r||p.defaultValue).toUpperCase()):document.createTextNode(r||p.defaultValue),f.appendChild(g)}return e.range&&((u=document.createElement("mutation")).setAttribute("min",e.range.min.toString()),u.setAttribute("max",e.range.max.toString()),u.setAttribute("label",e.actualName.charAt(0).toUpperCase()+e.actualName.slice(1)),e.fieldOptions&&(e.fieldOptions.step&&u.setAttribute("step",e.fieldOptions.step),e.fieldOptions.color&&u.setAttribute("color",e.fieldOptions.color),e.fieldOptions.precision&&u.setAttribute("precision",e.fieldOptions.precision))),e.fieldOptions&&(u||(u=document.createElement("mutation")),u.setAttribute("customfield",JSON.stringify(e.fieldOptions))),u&&c.appendChild(u),a}function b(t,e,i,o){var r=o?o.length:2,n=document.createElement("mutation");n.setAttribute("items",""+r),t.appendChild(n);for(var l=0;l<r;l++){var a=document.createElement("value");a.setAttribute("name","ADD"+l);var s=document.createElement("shadow");if(s.setAttribute("type",e),i){var c=document.createElement("field");c.setAttribute("name",i),o&&c.appendChild(document.createTextNode(o[l])),s.appendChild(c)}a.appendChild(s),t.appendChild(a)}}function f(t,e,i,o){var r=n(t,V.toolbox.convertColor(e),i,o);return r.setAttribute("web-class","blocklyFlyoutHeading"),r}function n(t,e,i,o){var r=Blockly.utils.xml.createElement("label");return r.setAttribute("text",t),e&&r.setAttribute("web-icon-color",V.toolbox.convertColor(e)),i&&(1===i.length?(r.setAttribute("web-icon",i),o&&r.setAttribute("web-icon-class",o)):r.setAttribute("web-icon-class","blocklyFlyoutIcon"+t)),r}function l(e,a,t){var s=document.createElement("block");if(s.setAttribute("type",a.attributes.blockId),a.attributes.blockGap?s.setAttribute("gap",a.attributes.blockGap):V.appTarget.appTheme&&V.appTarget.appTheme.defaultBlockGap&&s.setAttribute("gap",V.appTarget.appTheme.defaultBlockGap.toString()),t.thisParameter){var i=t.thisParameter;s.appendChild(r(e,i,i.shadowBlockId||"variables_get",i.defaultValue||i.definitionName))}return a.parameters&&(t.parameters.filter(function(t){return!t.isOptional&&(o.test(t.type)||o.test(k(t.type))||t.shadowBlockId||t.defaultValue)}).forEach(function(t){s.appendChild(r(e,t))}),a.attributes.draggableParameters?t.handlerArgs.forEach(function(t){var e="reporter"===a.attributes.draggableParameters,i=document.createElement("value");i.setAttribute("name","HANDLER_DRAG_PARAM_"+t.name);var o=e?V.blocks.reporterTypeForArgType(t.type):"variables_get_reporter",r=document.createElement("shadow");if(r.setAttribute("type",o),e&&"argument_reporter_custom"===o){var n=document.createElement("mutation");n.setAttribute("typename",t.type),r.appendChild(n)}var l=document.createElement("field");l.setAttribute("name",e?"VALUE":"VAR"),l.textContent=V.Util.htmlEscape(t.name),r.appendChild(l),i.appendChild(r),s.appendChild(i)}):t.handlerArgs.forEach(function(t){var e=document.createElement("field");e.setAttribute("name","HANDLER_"+t.name),e.textContent=t.name,s.appendChild(e)})),s}function i(o){return m=o,Blockly.pxtBlocklyUtils.whitelistDraggableBlockTypes(o.blocks.filter(function(t){return t.attributes.duplicateShadowOnDrag}).map(function(t){return t.attributes.blockId})),o.blocks.map(function(t){if(t.attributes.blockBuiltin)V.Util.assert(!!c()[t.attributes.blockId]),c()[t.attributes.blockId].symbol=t;else{var e=O.compileInfo(t),i=l(o,t,e);!function(t,e,i,o){var r=e.attributes.blockId;if(c()[r])return V.reportError("blocks","trying to override builtin block",{details:r});var n=JSON.stringify(e);if(u[r]&&u[r].hash==n)return;if(Blockly.Blocks[e.attributes.blockId])return console.error("duplicate block definition: "+r);var l={hash:n,fn:e,block:{codeCard:(a=e,s=o,{name:a.namespace+"."+a.name,shortName:a.name,description:a.attributes.jsDoc,url:a.attributes.help?"reference/"+a.attributes.help.replace(/^\//,""):void 0,blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml">'+p(s)+"</xml>"}),init:function(){!function(n,w,S,D){var t=(S.attributes.blockNamespace||S.namespace).split(".")[0],L=1==S.kind||2==S.kind,e=w.apis.byQName[t],R=S.attributes.blockNamespace&&e&&e.attributes.color||S.attributes.color||e&&e.attributes.color||V.toolbox.getNamespaceColor(t)||255;if(S.attributes.help){var i=S.attributes.help.replace(/^\//,"");/^github:/.test(i)?n.setHelpUrl(i):"none"!==i&&n.setHelpUrl("/reference/"+i)}else if(S.pkg&&!V.appTarget.bundledpkgs[S.pkg]){var o=S.qName.toLowerCase().split(".");o[0]==S.pkg&&o.shift(),n.setHelpUrl("/pkg/"+S.pkg+"#"+encodeURIComponent(o.join("-")))}n.setColour(R);var r=Blockly.OUTPUT_SHAPE_ROUND;"boolean"==S.retType&&(r=Blockly.OUTPUT_SHAPE_HEXAGONAL);n.setOutputShape(r),S.attributes.undeletable&&n.setDeletable(!1);m(S.attributes._def);var l=!1;if(S.attributes.mutate)O.addMutation(n,S,S.attributes.mutate);else if(S.attributes.defaultInstance)O.addMutation(n,S,O.MutatorTypes.DefaultInstanceMutator);else if(S.attributes._expandedDef&&"disabled"!==S.attributes.expandableArgumentMode){var a="toggle"===S.attributes.expandableArgumentMode;O.initExpandableBlock(w,n,S.attributes._expandedDef,D,a,function(){return m(S.attributes._expandedDef,!0)})}else if(D.handlerArgs.length)if(l=!0,S.attributes.optionalVariableArgs)O.initVariableArgsBlock(n,D.handlerArgs);else if(S.attributes.draggableParameters)D.handlerArgs.filter(function(t){return!t.inBlockDef}).forEach(function(t){var e=n.appendValueInput("HANDLER_DRAG_PARAM_"+t.name);"reporter"==S.attributes.draggableParameters?e.setCheck(F(t.type,w)):e.setCheck("Variable")});else{var s=n.appendDummyInput();D.handlerArgs.filter(function(t){return!t.inBlockDef}).forEach(function(t){s.appendField(new Blockly.FieldVariable(t.name),"HANDLER_"+t.name)})}if(O.appendMutation(n,{mutationToDom:function(i){return n.inputList.forEach(function(t){t.fieldRow.forEach(function(t){if(t.isFieldCustom_&&t.saveOptions){var e=t.saveOptions();e&&i.setAttribute("customfield",JSON.stringify(e))}})}),i},domToMutation:function(i){n.inputList.forEach(function(t){t.fieldRow.forEach(function(t){if(t.isFieldCustom_&&t.restoreOptions){var e=JSON.parse(i.getAttribute("customfield"));e&&t.restoreOptions(e)}})})}}),S.attributes.imageLiteral){var c=(S.attributes.imageLiteralColumns||5)*S.attributes.imageLiteral,u=S.attributes.imageLiteralRows||5,p=S.attributes.imageLiteralScale,d=n.appendDummyInput();d.appendField(new pxtblockly.FieldMatrix("",{columns:c,rows:u,scale:p}),"LEDS")}"external"===S.attributes.inlineInputMode?n.setInputsInline(!1):"inline"===S.attributes.inlineInputMode?n.setInputsInline(!0):n.setInputsInline(!S.parameters||S.parameters.length<4&&!S.attributes.imageLiteral);((S.parameters?S.parameters.filter(function(t){return"() => void"==t.type||"Action"==t.type})[0]:void 0)||l)&&(n.appendStatementInput("HANDLER").setCheck(null),n.setInputsInline(!0));y(n,S.retType,w);var h=g(S);function m(t,o){void 0===o&&(o=!1);var r=0,I=!o&&!!D.thisParameter,e=function(t){var e=[],i=[];return t.parts.forEach(function(t){switch(t.kind){case"break":o();break;case"param":i.push(t),o();break;case"image":case"label":i.push(t)}}),o(),e;function o(){i.length&&(e.push(i),i=[])}}(t),N=new V.ImageConverter;"ENUM_GET"!==S.attributes.shim&&"KIND_GET"!==S.attributes.shim||!(1<D.parameters.length||D.thisParameter)?(e.forEach(function(t){var E,B,e,C=[],A=!1;if(t.forEach(function(t){if("param"!==t.kind){var e=function(t){if("image"===t.kind)return function(t){var e=M[t];if(!e)return void V.log("missing jres icon "+t);return new Blockly.FieldImage(e,40,40,"",null,V.Util.isUserLanguageRtl())}(t.uri);var e=function(t){{if(" "===t)return"";if(1<t.length){var e=" "==t.charAt(0),i=" "==t.charAt(t.length-1);if(e||i)return t.substring(e?1:0,i?t.length-1:t.length)}}return t}(t.text);if(!e)return;return t.cssClass?new Blockly.FieldLabel(e,t.cssClass):t.style.length?new pxtblockly.FieldStyledLabel(e,{bold:-1!==t.style.indexOf("bold"),italics:-1!==t.style.indexOf("italics"),blocksInfo:void 0}):new Blockly.FieldLabel(e,void 0)}(t);e&&C.push({field:e})}else{if("ENUM_GET"===S.attributes.shim)return V.U.assert(!!S.attributes.enumName,"Trying to create an ENUM_GET block without a valid enum name"),void C.push({name:"MEMBER",field:new pxtblockly.FieldUserEnum(w.enumsByName[S.attributes.enumName])});if("KIND_GET"===S.attributes.shim)return void C.push({name:"MEMBER",field:new pxtblockly.FieldKind(w.kindsByName[S.attributes.kindNamespace||S.attributes.blockNamespace||S.namespace])});var i=function(e,t,i){void 0===i&&(i=!1);{if(e.ref){var o,r="this"===e.name?t.thisParameter:t.actualNameToParam[e.name];if(!r)if(t.handlerArgs.forEach(function(t){t.name===e.name&&(o=t)}),o)return o;return r}return i?t.thisParameter:t.definitionNameToParam[e.name]}}(t,D,I);if(I=!1,!i)return void console.error("block "+S.attributes.blockId+": unknown parameter "+t.name+(t.ref?" ("+t.ref+")":""));if(!i.definitionName)return E="HANDLER_DRAG_PARAM_"+i.name,void(B="reporter"===S.attributes.draggableParameters?F(i.type,w):"Variable");var o=V.U.lookup(w.apis.byQName,i.type);A=!0;var r=i.definitionName,n=i.actualName,l=o&&6==o.kind,a=o&&!!o.attributes.fixedInstances&&!i.shadowBlockId,s=!!S.attributes.constantShim,c="@combined@"==i.type,u=i.fieldEditor,p=r.charAt(0).toUpperCase()+r.slice(1),d=i.type;if(l||a||s||c){var h=void 0;l?(T=w.apis,x=i.type,h=V.Util.values(T.byQName).filter(function(t){return t.namespace===x&&!t.attributes.blockHidden})):a?h=U(w.apis,o.qName):c?h=S.combinedProperties.map(function(t){return V.U.lookup(w.apis.byQName,t)}):(b=w.apis,_=S.qName,h=V.Util.values(b.byQName).filter(function(t){return t.attributes.blockIdentity===_})),0==h.length&&console.error("no instances of "+o.qName+" found");var m=h.map(function(t){var e=t.attributes.block||t.attributes.blockId||t.name,i=t.attributes.blockCombine;return t.attributes.jresURL&&!t.attributes.iconURL&&V.U.startsWith(t.attributes.jresURL,"data:image/x-mkcd-f")&&(t.attributes.iconURL=N.convert(t.attributes.jresURL)),i&&(e=e.replace(/@set/,"")),[t.attributes.iconURL||t.attributes.blockImage?{src:t.attributes.iconURL||V.Util.pathJoin(V.webConfig.commitCdnUrl,"blocks/"+t.namespace.toLowerCase()+"/"+t.name.toLowerCase()+".png"),alt:e,width:36,height:36,value:t.name}:e,t.namespace+"."+t.name]});if(i.defaultValue){var f=-1;if(m.some(function(t,e){return t[1]===i.defaultValue&&(f=e,!0)}),-1<f){var g=m.splice(f,1)[0];m.unshift(g)}}if(u){var y=S.attributes.paramDefl[n]||"",v={data:m,colour:R,label:p,type:d,blocksInfo:w};V.Util.jsonMergeFrom(v,S.attributes.paramFieldEditorOptions&&S.attributes.paramFieldEditorOptions[n]||{}),C.push(P(O.createFieldEditor(u,y,v),r))}else C.push(P(new Blockly.FieldDropdown(m),r))}else if(u){var y=S.attributes.paramDefl[i.actualName]||"",k={colour:R,label:p,type:d,blocksInfo:w};V.Util.jsonMergeFrom(k,S.attributes.paramFieldEditorOptions&&S.attributes.paramFieldEditorOptions[i.actualName]||{}),C.push(P(O.createFieldEditor(u,y,k),i.definitionName))}else E=r,L&&"this"===t.name?B=i.type:"number"==i.type&&i.shadowBlockId&&"value"==i.shadowBlockId?(E=void 0,C.push(P(new Blockly.FieldTextInput("0",Blockly.FieldTextInput.numberValidator),r))):B="string"==i.type&&i.shadowOptions&&i.shadowOptions.toString?null:F(i.type,w)}var b,_,T,x}),E)(e=n.appendValueInput(E)).setAlign(Blockly.ALIGN_LEFT);else if(o){var i=A?O.optionalInputWithFieldPrefix:O.optionalDummyInputPrefix;e=n.appendDummyInput(i+r++)}else e=n.appendDummyInput();B&&e.setCheck(B),C.forEach(function(t){return e.appendField(t.field,t.name)})}),N.logTime()):console.warn("Enum blocks may only have 1 parameter but "+S.attributes.blockId+" has "+D.parameters.length)}n.setPreviousStatement(!(h&&!S.attributes.handlerStatement)&&"void"==S.retType),n.setNextStatement(!(h&&!S.attributes.handlerStatement)&&"void"==S.retType),n.setTooltip(/^__/.test(S.namespace)?"":S.attributes.jsDoc)}(this,t,e,i)}}};var a,s;V.Util.isTranslationMode()&&V.blocks.promptTranslateBlock&&(l.block.customContextMenu=function(t){e.attributes.translationId&&t.push({enabled:!0,text:lf("Translate this block"),callback:function(){V.blocks.promptTranslateBlock(r,[e.attributes.translationId])}})});u[r]=l,Blockly.Blocks[r]=l.block}(o,t,e,i)}return t})}function p(t){return t.outerHTML.replace(/^<\?[^>]*>/,"")}function g(t){return!!(t.parameters?t.parameters.filter(function(t){return"Action"===t.type||/^\([^\)]*\)\s*=>/.test(t.type)})[0]:void 0)}O.blockSymbol=function(t){var e=u[t];return e?e.fn:void 0},O.createShadowValue=r,O.createFlyoutHeadingLabel=f,O.createFlyoutGroupLabel=function(t,e,i,o){var r=n(t,void 0,e);return r.setAttribute("web-class","blocklyFlyoutGroup"),r.setAttribute("web-line","1.5"),i&&r.setAttribute("web-line-width",i),o&&(r.setAttribute("web-help-button","true"),r.setAttribute("callbackKey",o)),r},O.createFlyoutButton=function(t,e){var i=Blockly.utils.xml.createElement("button");return i.setAttribute("text",e),i.setAttribute("callbackKey",t),i},O.createToolboxBlock=l,O.injectBlocks=i,O.hasArrowFunction=g,O.cleanBlocks=function(){for(var t in V.debug("removing all custom blocks"),u)s(u[t].fn)},O.initializeAndInject=function(t){a(),i(t)};var t=!(O.initialize=function(t){a(),function(t){M={};var i=t.apis.jres;i&&Object.keys(i).forEach(function(t){var e=i[t];e&&e.icon&&(M[t]=e.icon)})}(t)});function a(){var g,s;t||(t=!0,goog.provide("Blockly.Blocks.device"),goog.require("Blockly.Blocks"),Blockly.FieldCheckbox.CHECK_CHAR="■",Blockly.Constants.ADD_START_HATS=!!V.appTarget.appTheme.blockHats,O.initFieldEditors(),(g=Blockly.Msg).DUPLICATE_BLOCK=lf("{id:block}Duplicate"),g.DUPLICATE_COMMENT=lf("Duplicate Comment"),g.REMOVE_COMMENT=lf("Remove Comment"),g.ADD_COMMENT=lf("Add Comment"),g.EXTERNAL_INPUTS=lf("External Inputs"),g.INLINE_INPUTS=lf("Inline Inputs"),g.EXPAND_BLOCK=lf("Expand Block"),g.COLLAPSE_BLOCK=lf("Collapse Block"),g.ENABLE_BLOCK=lf("Enable Block"),g.DISABLE_BLOCK=lf("Disable Block"),g.DELETE_BLOCK=lf("Delete Block"),g.DELETE_X_BLOCKS=lf("Delete Blocks"),g.DELETE_ALL_BLOCKS=lf("Delete All Blocks"),g.HELP=lf("Help"),Blockly.BlockSvg.prototype.showHelp=function(){var t=goog.isFunction(this.helpUrl)?this.helpUrl():this.helpUrl;t&&(V.blocks.openHelpUrl||window.open)(t)},Blockly.WorkspaceSvg.prototype.configureContextMenu=function(t,e){var i=this;if(!this.options.readOnly&&!this.isFlyout){t.length=0;var o=this.getTopBlocks(!0),r=Blockly.utils.genUid(),n=this.getTopComments();this.options.comments&&!V.BrowserUtils.isIE()&&t.push(Blockly.ContextMenu.workspaceCommentOption(this,e));for(var l=Blockly.WorkspaceSvg.buildDeleteList_(o),a=0,s=0;s<l.length;s++)l[s].isShadow()||a++;var c=10,u={text:1==a?g.DELETE_BLOCK:g.DELETE_ALL_BLOCKS,enabled:0<a,callback:function(){V.tickEvent("blocks.context.delete",void 0,{interactiveConsent:!0}),a<2?f():Blockly.confirm(lf("Delete all {0} blocks?",a),function(t){t&&f()})}};t.push(u);var p={text:lf("Format Code"),enabled:!0,callback:function(){V.tickEvent("blocks.context.format",void 0,{interactiveConsent:!0}),V.blocks.layout.flow(i,{useViewWidth:!0})}};if(t.push(p),V.appTarget.appTheme.blocksCollapsing){var d={text:lf("Collapse Blocks"),enabled:o.length&&o.find(function(t){return t.isEnabled()&&!t.isCollapsed()}),callback:function(){V.tickEvent("blocks.context.collapse",void 0,{interactiveConsent:!0}),V.blocks.layout.setCollapsedAll(i,!0)}};t.push(d);var h={text:lf("Expand Blocks"),enabled:o.length&&o.find(function(t){return t.isEnabled()&&t.isCollapsed()}),callback:function(){V.tickEvent("blocks.context.expand",void 0,{interactiveConsent:!0}),V.blocks.layout.setCollapsedAll(i,!1)}};t.push(h)}if(V.blocks.layout.screenshotEnabled()){var m={text:lf("Snapshot"),enabled:0<o.length||0<n.length,callback:function(){var t;V.tickEvent("blocks.context.screenshot",void 0,{interactiveConsent:!0}),V.blocks.layout.screenshotAsync(i,null,null===(t=V.appTarget.appTheme)||void 0===t?void 0:t.embedBlocksInSnapshot).done(function(t){V.BrowserUtils.isSafari()&&(t=t.replace(/^data:image\/[^;]/,"data:application/octet-stream")),V.BrowserUtils.browserDownloadDataUri(t,(V.appTarget.nickname||V.appTarget.id)+"-"+lf("screenshot")+".png")})}};t.push(m)}O.onShowContextMenu&&O.onShowContextMenu(this,t)}function f(){Blockly.Events.setGroup(r);var t=l.shift();t&&(t.workspace?(t.dispose(!1,!0),setTimeout(f,c)):f()),Blockly.Events.setGroup(!1)}},Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN.onchange=function(){},function(){var t=V.blocks.getBlockDefinition(ts.pxtc.ON_START_TYPE);if(Blockly.Blocks[ts.pxtc.ON_START_TYPE]={init:function(){this.jsonInit({message0:t.block.message0,args0:[{type:"input_dummy"},{type:"input_statement",name:"HANDLER"}],colour:(V.appTarget.runtime?V.appTarget.runtime.onStartColor:"")||V.toolbox.getNamespaceColor("loops")}),h(this,ts.pxtc.ON_START_TYPE,t.name,t.tooltip,t.url,String((V.appTarget.runtime?V.appTarget.runtime.onStartColor:"")||V.toolbox.getNamespaceColor("loops")),void 0,void 0,!!V.appTarget.runtime&&V.appTarget.runtime.onStartUnDeletable)}},Blockly.Blocks[pxtc.TS_STATEMENT_TYPE]={init:function(){var e,r,t=this,n=this;n.setColour("#717171"),n.setPreviousStatement(!0),n.setNextStatement(!0),n.setInputsInline(!1),n.domToMutation=function(t){var e=parseInt(t.getAttribute("numlines"));n.declaredVariables=t.getAttribute("declaredvars"),r=[];for(var i=0;i<e;i++){var o=t.getAttribute("line"+i);r.push(o)}n.setPythonEnabled(!1)},n.mutationToDom=function(){var i=document.createElement("mutation");return r&&(r.forEach(function(t,e){return i.setAttribute("line"+e,t)}),i.setAttribute("numlines",r.length.toString())),n.declaredVariables&&i.setAttribute("declaredvars",t.declaredVariables),i},n.setPythonEnabled=function(t){if(e!==t){for(;n.inputList.length;)n.removeInput(n.inputList[0].name);(e=t)?(n.appendDummyInput().appendField(V.Util.lf("<python code>"),"LINE0"),n.setTooltip(lf("A Python statement that could not be converted to blocks"))):(r.forEach(function(t,e){n.appendDummyInput().appendField(t,"LINE"+e)}),n.setTooltip(lf("A JavaScript statement that could not be converted to blocks")))}},n.getLines=function(){return r},n.setEditable(!1),h(this,pxtc.TS_STATEMENT_TYPE,lf("JavaScript statement"),lf("A JavaScript statement that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},Blockly.Blocks[pxtc.TS_OUTPUT_TYPE]={init:function(){var e=this;e.setColour("#717171"),e.setPreviousStatement(!1),e.setNextStatement(!1),e.setOutput(!0),e.setEditable(!1),e.appendDummyInput().appendField(new pxtblockly.FieldTsExpression(""),"EXPRESSION"),e.setPythonEnabled=function(t){e.getField("EXPRESSION").setPythonEnabled(t),t?e.setTooltip(lf("A Python expression that could not be converted to blocks")):e.setTooltip(lf("A JavaScript expression that could not be converted to blocks"))},h(e,pxtc.TS_OUTPUT_TYPE,lf("JavaScript expression"),lf("A JavaScript expression that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},V.appTarget.runtime&&V.appTarget.runtime.pauseUntilBlock){var e=V.appTarget.runtime.pauseUntilBlock,i=V.blocks.getBlockDefinition(ts.pxtc.PAUSE_UNTIL_TYPE);Blockly.Blocks[pxtc.PAUSE_UNTIL_TYPE]={init:function(){var t=e.color||V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:i.block.message0,args0:[{type:"input_value",name:"PREDICATE",check:"Boolean"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),h(this,ts.pxtc.PAUSE_UNTIL_TYPE,i.name,i.tooltip,i.url,t,void 0,void 0,!1)}}}var o="pxt_controls_for_of",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"VAR",variable:r.block.variable,check:"Variable"},{type:"input_value",name:"LIST",check:["Array","String"]}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(r.block.appendField);var t=this;h(this,o,r.name,function(){return V.U.rlf(r.tooltip,t.getInputTargetBlock("VAR")?t.getInputTargetBlock("VAR").getField("VAR").getText():"")},r.url,String(V.toolbox.getNamespaceColor("loops")))}};var n="controls_for_of",l=V.blocks.getBlockDefinition(n);Blockly.Blocks[n]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"field_variable",name:"VAR",variable:l.block.variable},{type:"input_value",name:"LIST",check:"Array"}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(l.block.appendField);var t=this;h(this,n,l.name,function(){return V.U.rlf(l.tooltip,t.getField("VAR").getText())},l.url,String(V.toolbox.getNamespaceColor("loops")))}};var a="lists_index_get",s=V.blocks.getBlockDefinition(a);Blockly.Blocks.lists_index_get={init:function(){this.jsonInit({message0:s.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"}],colour:V.toolbox.blockColors.arrays,outputShape:Blockly.OUTPUT_SHAPE_ROUND,inputsInline:!0}),this.setPreviousStatement(!1),this.setNextStatement(!1),this.setOutput(!0),d(this,a)}};var c="lists_index_set",u=V.blocks.getBlockDefinition(c);Blockly.Blocks[c]={init:function(){this.jsonInit({message0:u.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"},{type:"input_value",name:"VALUE",check:null}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.arrays,inputsInline:!0}),d(this,c)}}}(),function(){var t="math_op2",e=V.blocks.getBlockDefinition(t),i=e.tooltip;Blockly.Blocks[t]={init:function(){this.jsonInit({message0:lf("%1 of %2 and %3"),args0:[{type:"field_dropdown",name:"op",options:[[lf("{id:op}min"),"min"],[lf("{id:op}max"),"max"]]},{type:"input_value",name:"x",check:"Number"},{type:"input_value",name:"y",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:V.toolbox.getNamespaceColor("math")});h(this,t,e.name,function(t){return i[t.getFieldValue("op")]},e.url,V.toolbox.getNamespaceColor(e.category))}};var o="math_op3",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"x",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:V.toolbox.getNamespaceColor("math")}),d(this,o)}},["math_number","math_integer","math_whole_number","math_number_minmax"].forEach(function(t){var e=V.blocks.getBlockDefinition(t);T(t,e.name,e.tooltip,e.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField)});var n=Blockly.Msg,l="math_arithmetic",a=V.blocks.getBlockDefinition(l),s=a.tooltip;n.MATH_ADDITION_SYMBOL=a.block.MATH_ADDITION_SYMBOL,n.MATH_SUBTRACTION_SYMBOL=a.block.MATH_SUBTRACTION_SYMBOL,n.MATH_MULTIPLICATION_SYMBOL=a.block.MATH_MULTIPLICATION_SYMBOL,n.MATH_DIVISION_SYMBOL=a.block.MATH_DIVISION_SYMBOL,n.MATH_POWER_SYMBOL=a.block.MATH_POWER_SYMBOL,T(l,a.name,function(t){return s[t.getFieldValue("OP")]},a.url,V.toolbox.getNamespaceColor(a.category));var c="math_modulo",u=V.blocks.getBlockDefinition(c);n.MATH_MODULO_TITLE=u.block.MATH_MODULO_TITLE,_(c),O.initMathOpBlock(),O.initMathRoundBlock()}(),function(){Blockly.FieldVariable.prototype.getVariableTypes_=function(){return[""]};var t=lf("{id:var}item");Blockly.Variables.flyoutCategory=function(t){var e=[];if(!V.appTarget.appTheme.hideFlyoutHeadings){var i=f(lf("Variables"),V.toolbox.getNamespaceColor("variables"),V.toolbox.getNamespaceIcon("variables"));e.push(i)}var o=document.createElement("button");o.setAttribute("text",lf("Make a Variable...")),o.setAttribute("callbackKey","CREATE_VARIABLE"),t.registerButtonCallback("CREATE_VARIABLE",function(t){Blockly.Variables.createVariable(t.getTargetWorkspace())}),e.push(o);var r=Blockly.Variables.flyoutCategoryBlocks(t);return e=e.concat(r)},Blockly.Variables.flyoutCategoryBlocks=function(t){var e=t.getVariablesOfType(""),i=[];if(0<e.length){var o=e[e.length-1];e.sort(Blockly.VariableModel.compareByName);for(var r=0;r<e.length;r++){var n=e[r];if(Blockly.Blocks.variables_get){var l='<xml><block type="variables_get" gap="8">'+Blockly.Variables.generateVariableFieldXmlString(n)+"</block></xml>",a=Blockly.Xml.textToDom(l).firstChild;i.push(a)}}if(i[i.length-1].setAttribute("gap","24"),Blockly.Blocks.variables_set){var s=Blockly.Blocks.variables_change?8:24,l='<xml><block type="variables_set" gap="'+s+'">'+Blockly.Variables.generateVariableFieldXmlString(o)+"</block></xml>",a=Blockly.Xml.textToDom(l).firstChild,c=goog.dom.createDom("value");c.setAttribute("name","VALUE");var u=goog.dom.createDom("shadow");u.setAttribute("type","math_number"),c.appendChild(u);var p=goog.dom.createDom("field");p.setAttribute("name","NUM"),p.appendChild(document.createTextNode("0")),u.appendChild(p),a.appendChild(c),i.push(a)}if(Blockly.Blocks.variables_change){var s=Blockly.Blocks.variables_get?20:8,l='<xml><block type="variables_change" gap="'+s+'">'+Blockly.Variables.generateVariableFieldXmlString(o)+'<value name="DELTA"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block></xml>',a=Blockly.Xml.textToDom(l).firstChild,c=goog.dom.createDom("value");c.setAttribute("name","VALUE");var u=goog.dom.createDom("shadow");u.setAttribute("type","math_number"),c.appendChild(u);var p=goog.dom.createDom("field");p.setAttribute("name","NUM"),p.appendChild(document.createTextNode("1")),u.appendChild(p),a.appendChild(c),i.push(a)}}return i};var e=Blockly.Msg,i="variables_get",o=V.blocks.getBlockDefinition(i);e.VARIABLES_GET_CREATE_SET=o.block.VARIABLES_GET_CREATE_SET,_(i),_("variables_get_reporter"),e.RENAME_VARIABLE=lf("Rename variable..."),e.DELETE_VARIABLE=lf('Delete the "%1" variable'),e.DELETE_VARIABLE_CONFIRMATION=lf('Delete %1 uses of the "%2" variable?'),e.NEW_VARIABLE_DROPDOWN=lf("New variable...");var r="variables_set",n=V.blocks.getBlockDefinition(r);e.VARIABLES_SET=n.block.VARIABLES_SET,e.VARIABLES_DEFAULT_NAME=t,e.VARIABLES_SET_CREATE_GET=lf("Create 'get %1'"),_(r);var l="variables_change",a=V.blocks.getBlockDefinition(l);Blockly.Blocks[l]={init:function(){this.jsonInit({message0:a.block.message0,args0:[{type:"field_variable",name:"VAR",variable:t},{type:"input_value",name:"VALUE",check:"Number"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("variables")}),d(this,l)}},e.NEW_VARIABLE_TITLE=lf("New variable name:"),e.RENAME_VARIABLE_TITLE=lf("Rename all '%1' variables to:")}(),function(){var t=Blockly.Msg;t.FUNCTION_CREATE_NEW=lf("Make a Function..."),t.FUNCTION_WARNING_DUPLICATE_ARG=lf("Functions cannot use the same argument name more than once."),t.FUNCTION_WARNING_ARG_NAME_IS_FUNCTION_NAME=lf("Argument names must not be the same as the function name."),t.FUNCTION_WARNING_EMPTY_NAME=lf("Function and argument names cannot be empty."),t.FUNCTIONS_DEFAULT_FUNCTION_NAME=lf("doSomething"),t.FUNCTIONS_DEFAULT_BOOLEAN_ARG_NAME=lf("bool"),t.FUNCTIONS_DEFAULT_STRING_ARG_NAME=lf("text"),t.FUNCTIONS_DEFAULT_NUMBER_ARG_NAME=lf("num"),t.FUNCTIONS_DEFAULT_CUSTOM_ARG_NAME=lf("arg"),t.PROCEDURES_HUE=V.toolbox.getNamespaceColor("functions"),t.REPORTERS_HUE=V.toolbox.getNamespaceColor("variables");var e="procedures_defnoreturn",i=V.blocks.getBlockDefinition(e);t.PROCEDURES_DEFNORETURN_TITLE=i.block.PROCEDURES_DEFNORETURN_TITLE,t.PROCEDURE_ALREADY_EXISTS=i.block.PROCEDURE_ALREADY_EXISTS,Blockly.Blocks.procedures_defnoreturn.init=function(){var t=new Blockly.FieldTextInput("",Blockly.Procedures.rename);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(t,"NAME").appendField("","PARAMS"),this.setColour(V.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.argumentVarModels_=[],this.setStartHat(!0),this.setStatements_(!0),this.statementConnection_=null},_(e);var o="procedures_callnoreturn",r=V.blocks.getBlockDefinition(o);t.PROCEDURES_CALLRETURN_TOOLTIP=i.tooltip.toString(),Blockly.Blocks.procedures_callnoreturn={init:function(){var t=new pxtblockly.FieldProcedure("");this.appendDummyInput("TOPROW").appendField(r.block.PROCEDURES_CALLNORETURN_TITLE).appendField(t,"NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setColour(V.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.quarkConnections_={},this.quarkIds_=null},getProcedureCall:function(){return this.getFieldValue("NAME")},renameProcedure:function(t,e){Blockly.Names.equals(t,this.getProcedureCall())&&this.setFieldValue(e,"NAME")},onchange:function(t){if(this.workspace&&!this.workspace.isFlyout&&!this.isInsertionMarker())if(t.type==Blockly.Events.CREATE&&-1!=t.ids.indexOf(this.id)){var e=this.getProcedureCall(),i=Blockly.Procedures.getDefinition(e,this.workspace);if(!i||i.type==this.defType_&&JSON.stringify(i.arguments_)==JSON.stringify(this.arguments_)||(i=null),!i){Blockly.Events.setGroup(t.group);var o=Blockly.utils.xml.createElement("xml"),r=Blockly.utils.xml.createElement("block");r.setAttribute("type",this.defType_);var n=this.getRelativeToSurfaceXY(),l=n.x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),a=n.y+2*Blockly.SNAP_RADIUS;r.setAttribute("x",l),r.setAttribute("y",a);var s=Blockly.utils.xml.createElement("field");s.setAttribute("name","NAME"),s.appendChild(document.createTextNode(this.getProcedureCall())),r.appendChild(s),o.appendChild(r),V.blocks.domToWorkspaceNoEvents(o,this.workspace),Blockly.Events.setGroup(!1)}}else if(t.type==Blockly.Events.DELETE){var c=this.getProcedureCall(),i=Blockly.Procedures.getDefinition(c,this.workspace);i||(Blockly.Events.setGroup(t.group),this.dispose(!0,!1),Blockly.Events.setGroup(!1))}},mutationToDom:function(){var t=document.createElement("mutation");return t.setAttribute("name",this.getProcedureCall()),t},domToMutation:function(t){var e=t.getAttribute("name");this.renameProcedure(this.getProcedureCall(),e)},customContextMenu:function(t){var e={enabled:!0};e.text=Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF;var i=this.getProcedureCall(),o=this.workspace;e.callback=function(){var t=Blockly.Procedures.getDefinition(i,o);t&&t.select()},t.push(e)},defType_:"procedures_defnoreturn"},_(o);var l="function_definition",n=V.blocks.getBlockDefinition(l);t.FUNCTIONS_EDIT_OPTION=n.block.FUNCTIONS_EDIT_OPTION,_(l);var a="function_call",s=V.blocks.getBlockDefinition(a);t.FUNCTIONS_CALL_TITLE=s.block.FUNCTIONS_CALL_TITLE,_(a),_("function_call_output");var c="function_return";Blockly.Blocks[c]={init:function(){O.initReturnStatement(this)},onchange:function(t){var e=this;if(e.workspace&&!e.workspace.isFlyout){var i=t.type===Blockly.Events.BLOCK_CREATE&&-1!=t.ids.indexOf(e.id),o=t.type===Blockly.Events.END_DRAG&&-1!=t.allNestedIds.indexOf(e.id);if(i||o){var r=e.getRootBlock(),n=r.type===c;if(n||null!=r.previousConnection)return;r.type!==l&&(Blockly.Events.setGroup(t.group),e.previousConnection.disconnect(),Blockly.Events.setGroup(!1))}}}},_(c),Blockly.Procedures.flyoutCategory=function(u){var l=[];if(!V.appTarget.appTheme.hideFlyoutHeadings){var t=f(lf("Functions"),V.toolbox.getNamespaceColor("functions"),V.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");l.push(t)}var i=lf("Make a Function..."),o=lf("New function name:"),e=Blockly.utils.xml.createElement("button");e.setAttribute("text",i),e.setAttribute("callbackKey","CREATE_FUNCTION");u.registerButtonCallback("CREATE_FUNCTION",function(t){var e=function(t){Blockly.prompt(o,t,function(t){V.tickEvent("blocks.makeafunction"),t&&(t=t.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,""))==i&&(t=null),t&&(u.getVariable(t)?Blockly.alert(Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",t.toLowerCase()),function(){e(t)}):Blockly.Procedures.isLegalName_(t,u)?function(t){var e=u.getTopBlocks(!0)[0],i=10,o=10;if(e){var r=e.getRelativeToSurfaceXY();i=r.x+Blockly.SNAP_RADIUS*(e.RTL?-1:1),o=r.y+2*Blockly.SNAP_RADIUS}var n=Blockly.utils.xml.createElement("xml"),l=Blockly.utils.xml.createElement("block");l.setAttribute("type","procedures_defnoreturn"),l.setAttribute("x",String(i)),l.setAttribute("y",String(o));var a=Blockly.utils.xml.createElement("field");a.setAttribute("name","NAME"),a.appendChild(document.createTextNode(t)),l.appendChild(a),n.appendChild(l);var s=V.blocks.domToWorkspaceNoEvents(n,u);Blockly.hideChaff();var c=u.getBlockById(s[0]);c.select(),u.centerOnBlock(c.id)}(t):Blockly.alert(Blockly.Msg.PROCEDURE_ALREADY_EXISTS.replace("%1",t.toLowerCase()),function(){e(t)}))})};e("doSomething")}),l.push(e);var r=Blockly.Procedures.allProcedures(u);return function(t,e){for(var i=0;i<t.length;i++){var o=t[i][0],r=(t[i][1],Blockly.utils.xml.createElement("block"));r.setAttribute("type",e),r.setAttribute("gap","16"),r.setAttribute("colour",V.toolbox.getNamespaceColor("functions"));var n=goog.dom.createDom("field",null,o);n.setAttribute("name","NAME"),r.appendChild(n),l.push(r)}}(r[0],"procedures_callnoreturn"),l};var u=Blockly.Functions.flyoutCategory;Blockly.Functions.flyoutCategory=function(t){var e=u(t);if(1<e.length){var i=E();e.splice(1,0,i)}var r=Blockly.Functions.getAllFunctionDefinitionBlocks(t).filter(function(t){return t.getDescendants(!1).some(function(t){return"function_return"===t.type&&t.getInputTargetBlock("RETURN_VALUE")})}).map(function(t){return t.getField("function_name").getText()}),o=f(lf("Functions"),V.toolbox.getNamespaceColor("functions"),V.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");e.unshift(o);for(var n=[],l=function(t){if(n.push(t),"function_call"===t.getAttribute("type")){var e=t.children.item(0);if(e){var i=e.getAttribute("name");if(r.some(function(t){return t===i})){var o=t.cloneNode(!0);o.setAttribute("type","function_call_output"),n.push(o)}}}},a=0,s=e;a<s.length;a++){var c=s[a];l(c)}return n};var p={number:V.blocks.defaultIconForArgType("number"),boolean:V.blocks.defaultIconForArgType("boolean"),string:V.blocks.defaultIconForArgType("string")},d={},h=V.appTarget.runtime&&V.appTarget.runtime.functionsOptions;h&&h.extraFunctionEditorTypes&&h.extraFunctionEditorTypes.forEach(function(t){p[t.typeName]=t.icon||V.blocks.defaultIconForArgType(),t.defaultName&&(d[t.typeName]=t.defaultName)});Blockly.PXTBlockly.FunctionUtils.argumentIcons=p,Blockly.PXTBlockly.FunctionUtils.argumentDefaultNames=d,Blockly.Blocks.argument_reporter_custom&&(Blockly.Blocks.argument_reporter_custom.domToMutation=function(t){var e=t.getAttribute("typename");this.typeName_=e,y(this,e,m)})}(),function(){var t=Blockly.Msg,e="lists_create_with",i=V.blocks.getBlockDefinition(e);t.LISTS_CREATE_EMPTY_TITLE=i.block.LISTS_CREATE_EMPTY_TITLE,t.LISTS_CREATE_WITH_INPUT_WITH=i.block.LISTS_CREATE_WITH_INPUT_WITH,t.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD=i.block.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD,t.LISTS_CREATE_WITH_ITEM_TITLE=i.block.LISTS_CREATE_WITH_ITEM_TITLE,_(e);var o="lists_length",r=V.blocks.getBlockDefinition(o);t.LISTS_LENGTH_TITLE=r.block.LISTS_LENGTH_TITLE,Blockly.Blocks[o].init=function(){this.jsonInit({message0:t.LISTS_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["Array"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},_(o)}(),function(){var t=Blockly.Msg,e="controls_repeat_ext",i=V.blocks.getBlockDefinition(e);t.CONTROLS_REPEAT_TITLE=i.block.CONTROLS_REPEAT_TITLE,t.CONTROLS_REPEAT_INPUT_DO=i.block.CONTROLS_REPEAT_INPUT_DO,_(e);var o="device_while",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"COND",check:"Boolean"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops")}),this.appendStatementInput("DO").appendField(r.block.appendField),d(this,o)}};var n="pxt_controls_for",l=V.blocks.getBlockDefinition(n);Blockly.Blocks[n]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"input_value",name:"VAR",variable:l.block.variable,check:"Variable"},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(l.block.appendField);var t=this;h(this,n,l.name,function(){return V.U.rlf(l.tooltip,t.getInputTargetBlock("VAR")?t.getInputTargetBlock("VAR").getField("VAR").getText():"")},l.url,String(V.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){var i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&i.setValue(e)},customContextMenu:function(t){if(!this.isCollapsed()){var e={enabled:!0};e.text=lf("Create 'get {0}'",name);var i=goog.dom.createDom("field",null,name);i.setAttribute("name","VAR");var o=goog.dom.createDom("block",null,i);o.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,o),t.push(e)}}};var a="controls_simple_for",s=V.blocks.getBlockDefinition(a);Blockly.Blocks[a]={init:function(){this.jsonInit({message0:s.block.message0,args0:[{type:"field_variable",name:"VAR",variable:s.block.variable},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(s.block.appendField);var t=this;h(this,a,s.name,function(){return V.U.rlf(s.tooltip,t.getField("VAR").getText())},s.url,String(V.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){var i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&i.setValue(e)},customContextMenu:function(t){if(!this.isCollapsed()){var e={enabled:!0},i=this.getField("VAR").getText();e.text=lf("Create 'get {0}'",i);var o=goog.dom.createDom("field",null,i);o.setAttribute("name","VAR");var r=goog.dom.createDom("block",null,o);r.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,r),t.push(e)}}};var c=V.blocks.getBlockDefinition(ts.pxtc.TS_BREAK_TYPE);Blockly.Blocks[pxtc.TS_BREAK_TYPE]={init:function(){var t=V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:c.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),h(this,ts.pxtc.TS_BREAK_TYPE,c.name,c.tooltip,c.url,t,void 0,void 0,!1)}};var u=V.blocks.getBlockDefinition(ts.pxtc.TS_CONTINUE_TYPE);Blockly.Blocks[pxtc.TS_CONTINUE_TYPE]={init:function(){var t=V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:u.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),h(this,ts.pxtc.TS_CONTINUE_TYPE,u.name,u.tooltip,u.url,t,void 0,void 0,!1)}};var p="#cccccc";Blockly.Blocks[pxtc.COLLAPSED_BLOCK]={init:function(){this.jsonInit({message0:"...",inputsInline:!0,previousStatement:null,nextStatement:null,colour:p}),h(this,ts.pxtc.COLLAPSED_BLOCK,"...",lf("a few blocks"),void 0,p,void 0,void 0,!1)}}}(),function(){var t=Blockly.Msg,e="controls_if",i=V.blocks.getBlockDefinition(e),o=i.tooltip;t.CONTROLS_IF_MSG_IF=i.block.CONTROLS_IF_MSG_IF,t.CONTROLS_IF_MSG_THEN=i.block.CONTROLS_IF_MSG_THEN,t.CONTROLS_IF_MSG_ELSE=i.block.CONTROLS_IF_MSG_ELSE,t.CONTROLS_IF_MSG_ELSEIF=i.block.CONTROLS_IF_MSG_ELSEIF,t.CONTROLS_IF_TOOLTIP_1=o.CONTROLS_IF_TOOLTIP_1,t.CONTROLS_IF_TOOLTIP_2=o.CONTROLS_IF_TOOLTIP_2,t.CONTROLS_IF_TOOLTIP_3=o.CONTROLS_IF_TOOLTIP_3,t.CONTROLS_IF_TOOLTIP_4=o.CONTROLS_IF_TOOLTIP_4,_(e);var r="logic_compare",n=V.blocks.getBlockDefinition(r).tooltip;t.LOGIC_COMPARE_TOOLTIP_EQ=n.LOGIC_COMPARE_TOOLTIP_EQ,t.LOGIC_COMPARE_TOOLTIP_NEQ=n.LOGIC_COMPARE_TOOLTIP_NEQ,t.LOGIC_COMPARE_TOOLTIP_LT=n.LOGIC_COMPARE_TOOLTIP_LT,t.LOGIC_COMPARE_TOOLTIP_LTE=n.LOGIC_COMPARE_TOOLTIP_LTE,t.LOGIC_COMPARE_TOOLTIP_GT=n.LOGIC_COMPARE_TOOLTIP_GT,t.LOGIC_COMPARE_TOOLTIP_GTE=n.LOGIC_COMPARE_TOOLTIP_GTE,_(r);var l="logic_operation",a=V.blocks.getBlockDefinition(l),s=a.tooltip;t.LOGIC_OPERATION_AND=a.block.LOGIC_OPERATION_AND,t.LOGIC_OPERATION_OR=a.block.LOGIC_OPERATION_OR,t.LOGIC_OPERATION_TOOLTIP_AND=s.LOGIC_OPERATION_TOOLTIP_AND,t.LOGIC_OPERATION_TOOLTIP_OR=s.LOGIC_OPERATION_TOOLTIP_OR,_(l);var c="logic_negate",u=V.blocks.getBlockDefinition(c);t.LOGIC_NEGATE_TITLE=u.block.LOGIC_NEGATE_TITLE,_(c);var p="logic_boolean",d=V.blocks.getBlockDefinition(p);t.LOGIC_BOOLEAN_TRUE=d.block.LOGIC_BOOLEAN_TRUE,t.LOGIC_BOOLEAN_FALSE=d.block.LOGIC_BOOLEAN_FALSE,_(p)}(),function(){var t=V.blocks.getBlockDefinition("text");T("text",t.name,t.tooltip,t.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField);var e=Blockly.Msg,i="text_length",o=V.blocks.getBlockDefinition(i);e.TEXT_LENGTH_TITLE=o.block.TEXT_LENGTH_TITLE,Blockly.Blocks[i].init=function(){this.jsonInit({message0:e.TEXT_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["String"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},_(i);var r="text_join",n=V.blocks.getBlockDefinition(r);e.TEXT_JOIN_TITLE_CREATEWITH=n.block.TEXT_JOIN_TITLE_CREATEWITH,_(r)}(),function(){var c=Blockly.BlockDragger.prototype.dragBlock;Blockly.BlockDragger.prototype.dragBlock=function(t,e){var i,o,r=document.getElementsByClassName("blocklyToolboxDiv")[0],n=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],l=document.getElementById("blocklyTrashIcon");if(n&&l){var a=(i=n.getBoundingClientRect(),o=t.clientX,Math.abs(o-(i.left+i.width/2)));if(a<200){var s=a/200;l.style.opacity=""+(1-s),l.style.display="block",r&&(n.style.opacity=""+s,a<50&&V.BrowserUtils.addClass(r,"blocklyToolboxDeleting"))}else l.style.display="none",n.style.opacity="1",r&&V.BrowserUtils.removeClass(r,"blocklyToolboxDeleting")}return c.call(this,t,e)};var n=Blockly.BlockDragger.prototype.endBlockDrag;Blockly.BlockDragger.prototype.endBlockDrag=function(t,e){n.call(this,t,e);var i=document.getElementsByClassName("blocklyToolboxDiv")[0],o=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],r=document.getElementById("blocklyTrashIcon");r&&o&&(r.style.display="none",o.style.opacity="1",i&&V.BrowserUtils.removeClass(i,"blocklyToolboxDeleting"))}}(),Blockly.Blocks[pxtc.TS_DEBUGGER_TYPE]={init:function(){var t=this;t.setColour(V.toolbox.getNamespaceColor("debug")),t.setPreviousStatement(!0),t.setNextStatement(!0),t.setInputsInline(!1),t.appendDummyInput("ON_OFF").appendField(new Blockly.FieldLabel(lf("breakpoint"),void 0),"DEBUGGER").appendField(new pxtblockly.FieldBreakpoint("1",{type:"number"}),"ON_OFF"),h(this,pxtc.TS_DEBUGGER_TYPE,lf("Debugger statement"),lf("A debugger statement invokes any available debugging functionality"),"/javascript/debugger",V.toolbox.getNamespaceColor("debug"))}},Blockly.Msg.WORKSPACE_COMMENT_DEFAULT_TEXT="",s=function(t){if(t.disabled)return lf("This block is disabled and will not run. Attach this block to an event to enable it.");for(var e=t.tooltip;goog.isFunction(e);)e=e(t);return e},Blockly.Tooltip.show_=function(){var n=Blockly.Tooltip;if(n.poisonedElement_=n.element_,Blockly.Tooltip.DIV){goog.dom.removeChildren(Blockly.Tooltip.DIV);var t=n.element_.codeCard;if(t){var e=V.docs.codeCard.render({header:s(n.element_)});Blockly.Tooltip.DIV.appendChild(e),a()}else{for(var i=s(n.element_),o=(i=Blockly.utils._string.wrap(i,Blockly.Tooltip.LIMIT)).split("\n"),r=0;r<o.length;r++){var l=document.createElement("div");l.appendChild(document.createTextNode(o[r])),Blockly.Tooltip.DIV.appendChild(l)}a()}}function a(){var t=n.element_.RTL,e=goog.dom.getViewportSize(),i=Blockly.Tooltip.DIV;i.style.direction=t?"rtl":"ltr",i.style.display="block",Blockly.Tooltip.visible=!0;var o=n.lastX_;t?o-=Blockly.Tooltip.OFFSET_X+i.offsetWidth:o+=Blockly.Tooltip.OFFSET_X;var r=n.lastY_+Blockly.Tooltip.OFFSET_Y;r+i.offsetHeight>e.height+window.scrollY&&(r-=i.offsetHeight+2*Blockly.Tooltip.OFFSET_Y),t?o=Math.max(Blockly.Tooltip.MARGINS-window.scrollX,o):o+i.offsetWidth>e.width+window.scrollX-2*Blockly.Tooltip.MARGINS&&(o=e.width-i.offsetWidth-2*Blockly.Tooltip.MARGINS),i.style.top=r+"px",i.style.left=o+"px"}},Blockly.Block.prototype.setEnabled=function(t){if(this.disabled==t){var e=Blockly.Events.recordUndo;Blockly.Events.recordUndo=!1,Blockly.Events.fire(new Blockly.Events.BlockChange(this,"disabled",null,this.disabled,!t)),Blockly.Events.recordUndo=e,this.disabled=!t}})}function F(t,e){for(var i=t.split(/\s*\|\s*/),o=[],r=0,n=i;r<n.length;r++){var l=n[r];switch(l){case"number":o.push("Number");break;case"string":o.push("String");break;case"boolean":o.push("Boolean");break;case"T":case"any":return null;case"void":return;default:if(k(l)){if(1<i.length)return null;o.push("Array")}var a=e.apis.byQName[l];a&&a.extendsTypes&&0<a.extendsTypes.length?o.push.apply(o,a.extendsTypes):o.push(l)}}return o}function y(t,e,i){var o=F(e,i);(o||null===o)&&t.setOutput(!0,o)}function d(t,e){var i=V.blocks.getBlockDefinition(e);h(t,e,i.name,i.tooltip,i.url,V.toolbox.getNamespaceColor(i.category))}function _(t){var e=V.blocks.getBlockDefinition(t);T(t,e.name,e.tooltip,e.url,V.toolbox.getNamespaceColor(e.category))}function h(i,o,t,e,r,n,l,a,s){!e||"string"!=typeof e&&"function"!=typeof e||i.setTooltip(e),r&&i.setHelpUrl(r),n&&i.setColour(n,l,a),s&&i.setDeletable(!1);var c=document.getElementById("blocklyToolboxDefinition"),u=c?O.getFirstChildWithAttr(c,"block","type",o):void 0;i.codeCard={header:t,name:t,software:1,description:goog.isFunction(e)?e(i):e,blocksXml:u?'<xml xmlns="http://www.w3.org/1999/xhtml">'+(p(u)||'<block type="'+o+'"></block>')+"</xml>":void 0,url:r},V.Util.isTranslationMode()&&V.blocks.promptTranslateBlock&&(i.customContextMenu=function(t){var e=V.blocks.getBlockDefinition(i.type);e&&e.translationIds&&t.push({enabled:!0,text:lf("Translate this block"),callback:function(){V.blocks.promptTranslateBlock(o,e.translationIds)}})})}function T(t,e,i,o,r,n,l){var a=Blockly.Blocks[t],s=a.init;s&&(a.init=function(){s.call(this);h(this,t,e,i,o,r,n,l)})}function s(t){delete Blockly.Blocks[t.attributes.blockId],delete u[t.attributes.blockId]}function x(t,e,i,o){var r=document.createElement(o?"shadow":"block");r.setAttribute("type",V.Util.htmlEscape(t));var n=document.createElement("field");return n.setAttribute("name",V.Util.htmlEscape(e)),n.textContent=V.Util.htmlEscape(i),r.appendChild(n),r}function E(){var t=document.createElement("block");t.setAttribute("type","function_return");var e=document.createElement("value");e.setAttribute("name","RETURN_VALUE"),t.appendChild(e);var i=x("math_number","NUM","0",!0);return e.appendChild(i),t}O.installHelpResources=T,O.onShowContextMenu=void 0,O.mkPredicateBlock=function(t){var e=document.createElement("block");e.setAttribute("type",t);var i=document.createElement("value");i.setAttribute("name","PREDICATE"),e.appendChild(i);var o=x("logic_boolean","BOOL","TRUE",!0);return i.appendChild(o),e},O.mkFieldBlock=x,O.mkReturnStatementBlock=E;var M={};function P(t,e){return{field:t,name:e}}function U(e,i){return V.Util.values(e.byQName).filter(function(t){return 4===t.kind&&t.attributes.fixedInstance&&function(t,e,i){if(e==i)return!0;var o=t.byQName[e];return!(!o||!o.extendsTypes)&&0<=o.extendsTypes.indexOf(i)}(e,t.retType,i)})}O.getFixedInstanceDropdownValues=U,O.generateIcons=function(t){var e=new V.ImageConverter;t.forEach(function(t){t.attributes.jresURL&&!t.attributes.iconURL&&V.U.startsWith(t.attributes.jresURL,"data:image/x-mkcd-f")&&(t.attributes.iconURL=e.convert(t.attributes.jresURL))})},O.setVarFieldValue=function(t,e,i){var o=t.getField(e),r=t.workspace.getAllVariables(),n=!1;if(r&&r.length)for(var l=0;l<r.length;l++){var a;(a=r[l]).name===i&&(o.setValue(a.getId()),n=!0)}n||(o.initModel(),(a=o.getVariable()).name=i,o.setValue(a.getId()))}}(V.blocks||(V.blocks={}))}(pxt||(pxt={})),function(a){!function(l){var s,t;(t=s=l.MutatorTypes||(l.MutatorTypes={})).ObjectDestructuringMutator="objectdestructuring",t.RestParameterMutator="restparameter",t.DefaultInstanceMutator="defaultinstance",l.addMutation=function(t,e,i){var o;switch(i){case s.ObjectDestructuringMutator:if(!e.parameters||e.parameters.length<1)console.error("Destructuring mutations require at least one parameter");else{for(var r=!1,n=0,l=e.parameters;n<l.length;n++){var a=l[n];if(-1!==a.type.indexOf("=>")){if(!a.properties||0===a.properties.length)return void console.error("Destructuring mutations only supported for functions with an event parameter that has multiple properties");r=!0}}if(!r)return void console.error("Destructuring mutations must have an event parameter")}o=new c(t,e);break;case s.RestParameterMutator:o=new u(t,e);break;case s.DefaultInstanceMutator:o=new p(t,e);break;default:return void console.warn("Ignoring unknown mutation type: "+i)}t.mutationToDom=o.mutationToDom.bind(o),t.domToMutation=o.domToMutation.bind(o),t.compose=o.compose.bind(o),t.decompose=o.decompose.bind(o),t.mutation=o},l.mutateToolboxBlock=function(t,e,i){var o=document.createElement("mutation");switch(e){case s.ObjectDestructuringMutator:o.setAttribute(c.propertiesAttributeName,i);break;case s.RestParameterMutator:o.setAttribute(u.countAttributeName,i);break;case s.DefaultInstanceMutator:o.setAttribute(p.attributeName,i);default:return void console.warn("Ignoring unknown mutation type: "+e)}t.appendChild(o)};var r=function(){function l(t,e){this.info=e,this.block=t,this.topBlockType=this.block.type+"_mutator";var i=this.getSubBlockNames();this.initializeMutatorTopBlock(),this.initializeMutatorSubBlocks(i);var o=i.map(function(t){return t.type});this.block.setMutator(new Blockly.Mutator(o))}return l.prototype.compose=function(t){var e=t.getDescendants(!1).map(function(t){return{type:t.type,name:t.inputList[0].name}});e.shift(),this.updateBlock(e)},l.prototype.decompose=function(o){var t=o.newBlock(this.topBlockType);t.initSvg();for(var e=function(t){if(t.name===l.mutatorStatmentInput){var i=t.connection;return r.getVisibleBlockTypes().forEach(function(t){var e=o.newBlock(t);e.initSvg(),i.connect(e.previousConnection),i=e.nextConnection}),"break"}},r=this,i=0,n=t.inputList;i<n.length;i++){if("break"===e(n[i]))break}return t},l.prototype.compileMutation=function(t,e){},l.prototype.getDeclaredVariables=function(){},l.prototype.isDeclaredByMutation=function(t){return!1},l.prototype.initializeMutatorSubBlock=function(t,e,i){t.appendDummyInput(e).appendField(e),t.setColour(i),t.setNextStatement(!0),t.setPreviousStatement(!0)},l.prototype.initializeMutatorTopBlock=function(){var t=this.info.attributes.mutateText,e=this.block.getColour();Blockly.Blocks[this.topBlockType]=Blockly.Blocks[this.topBlockType]||{init:function(){this.appendDummyInput().appendField(t),this.setColour(e),this.appendStatementInput(l.mutatorStatmentInput)}}},l.prototype.initializeMutatorSubBlocks=function(t){var e=this.block.getColour(),i=this.initializeMutatorSubBlock.bind(this);t.forEach(function(t){Blockly.Blocks[t.type]=Blockly.Blocks[t.type]||{init:function(){i(this,t.name,e)}}})},l.mutatorStatmentInput="PROPERTIES",l.mutatedVariableInputName="properties",l}(),c=function(o){function n(t,e){var i=o.call(this,t,e)||this;return i.currentlyVisible=[],i.parameterRenames={},i.prefix=i.info.attributes.mutatePrefix,i.block.appendDummyInput(r.mutatedVariableInputName),i.block.appendStatementInput("HANDLER").setCheck("null"),i}return __extends(n,o),n.prototype.getMutationType=function(){return s.ObjectDestructuringMutator},n.prototype.compileMutation=function(r,t){var n=this;if(this.info.attributes.mutatePropertyEnum||this.parameters.length){var e="function ({ "+this.parameters.map(function(t){var e=n.block.getField(t),i=e&&e.getText(),o=l.escapeVarName(t,r);return i!==t?(n.parameterRenames[t]=i,t+": "+l.escapeVarName(i,r)):o}).join(", ")+" })";return this.info.attributes.mutatePropertyEnum?l.mkText(" ["+this.parameters.map(function(t){return n.info.attributes.mutatePropertyEnum+"."+t}).join(", ")+"],"+e):l.mkText(e)}},n.prototype.getDeclaredVariables=function(){var e=this,i={};return this.parameters.forEach(function(t){i[e.getVarFieldValue(t)]=e.parameterTypes[t]}),i},n.prototype.isDeclaredByMutation=function(e){var i=this;return this.parameters.some(function(t){return i.getVarFieldValue(t)===e})},n.prototype.mutationToDom=function(){var i=this,t=document.createElement("mutation"),e=this.parameters.map(function(t){var e=i.getVarFieldValue(t);return e!==t&&(i.parameterRenames[t]=a.Util.htmlEscape(e)),a.Util.htmlEscape(t)}).join(",");for(var o in t.setAttribute(n.propertiesAttributeName,e),this.parameterRenames)o===this.parameterRenames[o]&&delete this.parameterRenames[o];return t.setAttribute(n.renameAttributeName,JSON.stringify(this.parameterRenames)),t},n.prototype.domToMutation=function(t){var i=this,e=t.getAttribute(n.propertiesAttributeName);if(e){var o=e.split(","),r=[];if(void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),o.forEach(function(t){var e=t.split(":");i.info.parameters[i.paramIndex].properties.some(function(t){return t.name===e[0]})&&r.push({property:e[0],newName:e[1]})}),this.parameterRenames=void 0,t.hasAttribute(n.renameAttributeName))try{this.parameterRenames=JSON.parse(t.getAttribute(n.renameAttributeName))}catch(t){console.warn("Ignoring invalid rename map in saved block mutation")}this.parameterRenames=this.parameterRenames||{},this.parameters=[],r.forEach(function(t){i.parameters.push(t.property),t.newName&&t.newName!==t.property&&(i.parameterRenames[t.property]=t.newName)}),this.updateVisibleProperties(),r.filter(function(t){return!!t.newName}).forEach(function(t){return i.setVarFieldValue(t.property,t.newName)})}},n.prototype.getVarFieldValue=function(t){var e=this.block.getField(t);return e&&e.getText()},n.prototype.setVarFieldValue=function(t,e){this.block.getField(t);this.block.getField(t)&&l.setVarFieldValue(this.block,t,e)},n.prototype.updateBlock=function(t){var e=this;this.parameters=[],t.forEach(function(t){-1===e.parameters.indexOf(t.name)&&e.parameters.push(t.name)}),this.updateVisibleProperties()},n.prototype.getSubBlockNames=function(){var e=this;return this.parameters=[],this.parameterTypes={},void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),this.info.parameters[this.paramIndex].properties.map(function(t){return e.parameterTypes[t.name]=t.type,{type:e.propertyId(t.name),name:t.name}})},n.prototype.getVisibleBlockTypes=function(){var e=this;return this.currentlyVisible.map(function(t){return e.propertyId(t)})},n.prototype.updateVisibleProperties=function(){var i=this;if(!a.Util.listsEqual(this.currentlyVisible,this.parameters)){var o=this.block.inputList.find(function(t){return t.name===r.mutatedVariableInputName});this.prefix&&0===this.currentlyVisible.length&&o.appendField(this.prefix,n.prefixLabel),this.currentlyVisible.forEach(function(t){if(-1===i.parameters.indexOf(t)){var e=i.getVarFieldValue(t);e!==t&&(i.parameterRenames[t]=e),o.removeField(t)}}),this.parameters.forEach(function(t){if(-1===i.currentlyVisible.indexOf(t)){var e=i.parameterRenames[t]||t;o.appendField(new Blockly.FieldVariable(e),t)}}),this.prefix&&0===this.parameters.length&&o.removeField(n.prefixLabel),this.currentlyVisible=this.parameters}},n.prototype.propertyId=function(t){return this.block.type+"_"+t},n.prototype.getParameterIndex=function(){for(var t=0;t<this.info.parameters.length;t++)if(-1!==this.info.parameters[t].type.indexOf("=>"))return t},n.propertiesAttributeName="callbackproperties",n.renameAttributeName="renamemap",n.prefixLabel="0prefix_label_",n}(r),u=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.count=0,t}return __extends(r,e),r.prototype.getMutationType=function(){return s.RestParameterMutator},r.prototype.compileMutation=function(e,i){var o=[];return this.forEachInput(function(t){return o.push(l.compileExpression(e,t,i))}),l.mkGroup(o)},r.prototype.mutationToDom=function(){var t=document.createElement("mutation");return t.setAttribute(r.countAttributeName,this.count.toString()),t},r.prototype.domToMutation=function(t){var e=t.getAttribute(r.countAttributeName);if(e){try{this.count=parseInt(e)}catch(t){return}for(var i=0;i<this.count;i++)this.addNumberField(!1,i)}},r.prototype.updateBlock=function(t){if(t){var e=Math.abs(this.count-t.length);if(this.count<t.length)for(var i=0;i<e;i++)this.addNumberField(!0,this.count);else if(this.count>t.length)for(i=0;i<e;i++)this.removeNumberField()}},r.prototype.getSubBlockNames=function(){return[{name:"Value",type:r.entryTypeName}]},r.prototype.getVisibleBlockTypes=function(){var t=[];return this.forEachInput(function(){return t.push(r.entryTypeName)}),t},r.prototype.addNumberField=function(t,e){var i=this.block.appendValueInput(r.valueInputPrefix+e).setCheck("Number");if(t){var o=this.block.workspace.newBlock("math_number");o.initSvg(),o.setShadow(!0),i.connection.connect(o.outputConnection),this.block.workspace.render(),this.count++}},r.prototype.removeNumberField=function(){0<this.count&&this.block.removeInput(r.valueInputPrefix+(this.count-1)),this.count--},r.prototype.forEachInput=function(t){for(var e=0;e<this.count;e++)t(this.block.getInputTargetBlock(r.valueInputPrefix+e),e)},r.countAttributeName="count",r.entryTypeName="entry",r.valueInputPrefix="value_input_",r}(r),p=function(e){function o(){var t=null!==e&&e.apply(this,arguments)||this;return t.showing=!1,t}return __extends(o,e),o.prototype.getMutationType=function(){return s.DefaultInstanceMutator},o.prototype.compileMutation=function(t,e){if(this.showing){var i=this.block.getInputTargetBlock(o.instanceInputName);if(i)return l.compileExpression(t,i,e)}},o.prototype.mutationToDom=function(){var t=document.createElement("mutation");return t.setAttribute(o.attributeName,this.showing?"true":"false"),t},o.prototype.domToMutation=function(t){var e=t.getAttribute(o.attributeName);e?this.updateShape("true"===e):this.updateShape(!1)},o.prototype.updateBlock=function(t){this.updateShape(!(!t||!t.length))},o.prototype.getSubBlockNames=function(){return[{name:"Instance",type:o.instanceSubBlockType}]},o.prototype.getVisibleBlockTypes=function(){var t=[];return this.showing&&t.push(o.instanceSubBlockType),t},o.prototype.updateShape=function(t){this.showing!==t&&(t&&!this.block.getInputTargetBlock(o.instanceInputName)?this.block.appendValueInput(o.instanceInputName):this.block.removeInput(o.instanceInputName),this.showing=t)},o.attributeName="showing",o.instanceInputName="__instance__",o.instanceSubBlockType="instance",o}(r)}(a.blocks||(a.blocks={}))}(pxt||(pxt={})),function(c){!function(t){var r,o,n,e;function l(){return r||((o=document.createElement("div")).style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),r=Blockly.inject(o,{move:{scrollbars:!1},readOnly:!0,sounds:!1,media:c.webConfig.commitCdnUrl+"blockly/media/",rtl:c.Util.isUserLanguageRtl(),renderer:"pxt"})),c.blocks.clearWithoutEvents(r),r}function a(){r&&r.dispose(),r=void 0}function s(t){switch(void 0===t&&(t={emPixels:18,layout:n.Align}),t.splitSvg?n.Align:t.layout||n.Flow){case n.Align:c.blocks.layout.verticalAlign(r,t.emPixels||18);break;case n.Flow:c.blocks.layout.flow(r,{ratio:t.aspectRatio,useViewWidth:t.useViewWidth});break;case n.Clean:r.cleanUp_&&r.cleanUp_()}var e=r.getMetrics(),i=o.querySelectorAll("svg")[0].cloneNode(!0);return c.blocks.layout.cleanUpBlocklySvg(i),c.U.toArray(i.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(function(t){return t.setAttribute("transform","translate("+-e.contentLeft+", "+-e.contentTop+") scale(1)")}),i.setAttribute("viewBox","0 0 "+e.contentWidth+" "+e.contentHeight),t.emPixels&&(i.style.width=e.contentWidth/t.emPixels+"em",i.style.height=e.contentHeight/t.emPixels+"em"),t.splitSvg?c.blocks.layout.splitSvg(i,r,t.emPixels):i}(e=n=t.BlockLayout||(t.BlockLayout={}))[e.None=0]="None",e[e.Align=1]="Align",e[e.Clean=3]="Clean",e[e.Flow=4]="Flow",t.initRenderingWorkspace=l,t.cleanRenderingWorkspace=a,t.renderWorkspace=s,t.render=function(t,e){void 0===e&&(e={emPixels:18,layout:n.Align}),l();try{var i=t||'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',o=Blockly.Xml.textToDom(i);return c.blocks.domToWorkspaceNoEvents(o,r),s(e)}catch(t){return c.reportException(t),void a()}},t.blocksMetrics=function(t){var e=t.getTopBlocks(!1);if(!e.length)return{width:0,height:0};var i=void 0;return e.forEach(function(t){var e=t.getBoundingRectangle();i?(i.l=Math.min(i.l,e.left),i.r=Math.max(i.r,e.right),i.t=Math.min(i.t,e.top),i.b=Math.min(i.b,e.bottom)):i={l:e.left,r:e.right,t:e.top,b:e.bottom}}),{width:i.r-i.l,height:i.b-i.t}}}(c.blocks||(c.blocks={}))}(pxt||(pxt={})),function(t){!function(t){function o(t,e){var i=[];for(var o in t.children){var r=t.children[o];if("block"===r.tagName)if(e){var n=r.getAttribute("type");n&&n===e&&i.push(r)}else i.push(r);else{var l=a(r);l&&(i=i.concat(l))}}return i}function a(t,e){var i=o(t,e);return i.length?i[0]:null}t.findRootBlocks=o,t.findRootBlock=a}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(_){var t;((t=_.docs||(_.docs={})).codeCard||(t.codeCard={})).render=function(t,e){void 0===e&&(e={});var i=t.url?/^[^:]+:\/\//.test(t.url)?t.url:"/"+t.url.replace(/^\.?\/?/,""):t.youTubeId?"https://youtu.be/"+t.youTubeId:void 0,o=!!i,r=function(t,e,i,o){void 0===i&&(i="div"),void 0===o&&(o="");var r=document.createElement(i);return e&&(r.className=e),t&&t.appendChild(r),o&&r.appendChild(document.createTextNode(o+"")),r},n=r(null,"ui "+(t.style||"card")+" "+(t.color||"")+(o?" link":""),o?"a":"div");if(n.setAttribute("role","option"),n.setAttribute("aria-selected","true"),o){var l=n;l.href=i,/^https?:\/\//.test(i)&&(l.target="_blank")}if(!e.hideHeader&&t.header){var a=r(n,"ui content "+(t.responsive?" tall desktop only":""));t.header&&r(a,"description","span",t.header)}var s=(e.shortName?t.shortName:"")||t.name,c=r(n,"ui image"+(t.responsive?" tall landscape only":""));if(t.label){var u=document.createElement("label");u.className="ui "+(t.labelClass?t.labelClass:"orange right ribbon")+" label",u.textContent=t.label,c.appendChild(u)}if(t.blocksXml){var p=_.blocks.render(t.blocksXml);if(p){var d=r(c,"");d.setAttribute("style","width:100%; min-height:10em"),d.appendChild(p)}else console.error("failed to render blocks"),_.debug(t.blocksXml)}if(t.typeScript){var h=document.createElement("pre");h.appendChild(document.createTextNode(t.typeScript)),c.appendChild(h)}if(t.imageUrl||(t.youTubeId?(t.youTubeId,1):void 0)){var m=document.createElement("div");m.className="ui imagewrapper";var f=document.createElement("div");f.className="ui cardimage",f.style.backgroundImage='url("'+t.imageUrl+'")',f.title=s,f.setAttribute("role","presentation"),m.appendChild(f),c.appendChild(m)}if("file"==t.cardType){var g=r(n,"ui fileimage");c.appendChild(g)}if(s||t.description){var y=r(n,"ui content");if(s&&(n.setAttribute("aria-label",s),r(y,"header","div",s)),t.description){var v=r(y,"ui description"),k=t.description.split(".")[0]+".";v.appendChild(document.createTextNode(k))}}if(t.time){var b=r(n,"meta");t.time&&r(b,"date","span").appendChild(document.createTextNode(_.Util.timeSince(t.time)))}return t.extracontent&&r(n,"extra content","div").appendChild(document.createTextNode(t.extracontent)),n}}(pxt||(pxt={})),function(A){!function(B){function C(t,e){var i=t,o=i.mutationToDom,r=i.domToMutation;i.mutationToDom=function(){var t=o?o():document.createElement("mutation");return e.mutationToDom(t)},i.domToMutation=function(t){r&&r(t),e.domToMutation(t)}}B.appendMutation=C,B.initVariableArgsBlock=function(l,a){var s=0,c=0,u=l.appendDummyInput(),n=function(){var t;if(s!==c){if(c<s)for(var e=s-c,i=0;i<e;i++){var o=a[c+i];u.insertFieldAt(u.fieldRow.length-1,new Blockly.FieldVariable(o.name),"HANDLER_"+o.name);var r=l;(null===(t=r)||void 0===t?void 0:t.initSvg)&&r.initSvg()}else{var n=c-s;for(i=0;i<n;i++)o=a[c-i-1],u.removeField("HANDLER_"+o.name)}s>=a.length?u.removeField("_HANDLER_ADD"):c>=a.length&&p(),c=s}};function p(){u.appendField(new Blockly.FieldImage(l.ADD_IMAGE_DATAURI,24,24,lf("Add argument"),function(){s=Math.min(s+1,a.length),n()},!1),"_HANDLER_ADD")}Blockly.Extensions.apply("inline-svgs",l,!1),p(),C(l,{mutationToDom:function(t){t.setAttribute("numArgs",s.toString());for(var e=0;e<s;e++){var i=l.getField("HANDLER_"+a[e].name),o=i&&i.getText();t.setAttribute("arg"+e,o)}return t},domToMutation:function(t){var e=parseInt(t.getAttribute("numargs"));s=Math.min(isNaN(e)?0:e,a.length),n();for(var i=0;i<s;i++){var o=t.getAttribute("arg"+i),r="HANDLER_"+a[i].name;l.getField(r)&&B.setVarFieldValue(l,r,o)}}})},B.initExpandableBlock=function(d,h,m,f,t,e){var o="0_add_button",r="0_rem_button",g="_expanded",y="_input_init",v=m.parameters.map(function(t){return t.name}),k=m.parameters.length,i=t?k:1,b=new p(h);b.setEventsEnabled(!1),b.setValue(g,0),b.setValue(y,!1),b.setEventsEnabled(!0);var n=!1,l=!1;function a(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1);var o=x(t);if(i||e||o!==b.getNumber(g)){b.setValue(g,o);var r=o;if(b.getBoolean(y)||!(0<r)||(T(),h.rendered)){for(var n=0,l=0;l<h.inputList.length;l++){var a=h.inputList[l];if(A.Util.startsWith(a.name,B.optionalDummyInputPrefix))E(a,n<r||r===k);else if(A.Util.startsWith(a.name,B.optionalInputWithFieldPrefix)||-1!==v.indexOf(a.name)){var s=n<r;if(E(a,s),s&&a.connection&&!a.connection.isConnected()&&!h.isInsertionMarker()){var c=f.definitionNameToParam[m.parameters[n].name],u=B.createShadowValue(d,c);"value"===u.tagName.toLowerCase()&&(u=u.firstElementChild),Blockly.Events.disable();var p=Blockly.Xml.domToBlock(u,h.workspace);p&&a.connection.connect(p.outputConnection),Blockly.Events.enable()}++n}}_(),e||h.render()}}}function s(t,e,i,o){h.appendDummyInput(t).appendField(new Blockly.FieldImage(e,24,24,i,function(){return a(o)},!1))}function _(){var t=b.getNumber(g),e=t!==k,i=0!==t;e||(n=!1,h.removeInput(o,!0)),i||(l=!1,h.removeInput(r,!0)),i&&!l&&(n?(h.removeInput(o,!0),u(),c()):u()),e&&!n&&c()}function c(){n=!0,s(o,h.ADD_IMAGE_DATAURI,lf("Reveal optional arguments"),i)}function u(){l=!0,s(r,h.REMOVE_IMAGE_DATAURI,lf("Hide optional arguments"),-1*i)}function T(){b.setValue(y,!0),e(),_()}function x(t){return Math.min(Math.max(b.getNumber(g)+t,0),k)}function E(t,e){h.rendered&&t.setVisible(e).forEach(function(t){t.render()})}Blockly.Extensions.apply("inline-svgs",h,!1),c(),C(h,{mutationToDom:function(t){return t.setAttribute(g,b.getString(g)),t.setAttribute(y,b.getString(y)),t},domToMutation:function(t){if(b.setEventsEnabled(!1),t.hasAttribute(y)&&"true"==t.getAttribute(y)&&!b.getBoolean(y)&&(b.setValue(y,!0),T()),t.hasAttribute(g)){var e=parseInt(t.getAttribute(g));if(!isNaN(e)){var i=e-(b.getNumber(g)||0);b.getBoolean(y)?h.rendered||h.isInsertionMarker()?a(i,!0,h.isInsertionMarker()):b.setValue(g,x(i)):a(i,!0)}}b.setEventsEnabled(!0)}}),setTimeout(function(){h.rendered&&!h.workspace.isDragging()&&(a(0,void 0,!0),_())},1)},B.initReturnStatement=function(o){var r=A.blocks.getBlockDefinition("function_return"),n="0_add_button",l="0_rem_button";Blockly.Extensions.apply("inline-svgs",o,!1);var a,s=!0;function c(){var t=o.getInput("RETURN_VALUE");if(s){if(!t){for(;o.getInput("");)o.removeInput("");o.jsonInit({message0:r.block.message_with_value,args0:[{type:"input_value",name:"RETURN_VALUE",check:null}],previousStatement:null,colour:A.toolbox.getNamespaceColor("functions")})}if(o.getInput(n)&&o.removeInput(n),o.getInput(l)||d(l,o.REMOVE_IMAGE_DATAURI,lf("Remove return value")),a){var e=o.workspace.getBlockById(a);e&&e.outputConnection&&!e.outputConnection.targetBlock()&&o.getInput("RETURN_VALUE").connection.connect(e.outputConnection),a=void 0}}else{if(t){var i=t.connection.targetBlock();i&&(i.isShadow()&&i.setShadow(!1),t.connection.disconnect(),a=i.id),o.removeInput("RETURN_VALUE"),o.jsonInit({message0:r.block.message_no_value,args0:[],previousStatement:null,colour:A.toolbox.getNamespaceColor("functions")})}o.getInput(l)&&o.removeInput(l),o.getInput(n)||d(n,o.ADD_IMAGE_DATAURI,lf("Add return value"))}o.setInputsInline(!0)}function u(){return Blockly.Xml.domToText(o.mutationToDom())}function p(t,e){t!==e&&Blockly.Events.fire(new Blockly.Events.BlockChange(o,"mutation",null,t,e))}function d(t,e,i){o.appendDummyInput(t).appendField(new Blockly.FieldImage(e,24,24,i,function(){var t=u();s=!s;var e=u();p(t,e),c(),p(e,u())},!1))}c(),o.domToMutation=function(t){t.hasAttribute("last_connected_id")&&(a=t.getAttribute("last_connected_id")),s="true"!==t.getAttribute("no_return_value"),c()},o.mutationToDom=function(){var t,e,i=document.createElement("mutation");return t=i,e=!!o.getInput("RETURN_VALUE"),t.setAttribute("no_return_value",e?"false":"true"),a&&i.setAttribute("last_connected_id",a),i}};var p=function(){function t(t,e){this.block=t,this.fireEvents=!0,this.state=e||{}}return t.prototype.setValue=function(t,e){var i=this;if(this.fireEvents&&this.block.mutationToDom){var o=this.block.mutationToDom();this.state[t]=e.toString();var r=this.block.mutationToDom();Object.keys(this.state).forEach(function(t){o.getAttribute(t)!==i.state[t]&&r.setAttribute(t,i.state[t])});var n=Blockly.Xml.domToText(o),l=Blockly.Xml.domToText(r);n!=l&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.block,"mutation",null,n,l))}else this.state[t]=e.toString()},t.prototype.getNumber=function(t){return parseInt(this.state[t])},t.prototype.getBoolean=function(t){return"false"!=this.state[t]},t.prototype.getString=function(t){return this.state[t]},t.prototype.setEventsEnabled=function(t){this.fireEvents=t},t}()}(A.blocks||(A.blocks={}))}(pxt||(pxt={})),function(s){var i,o,r;i=s.blocks||(s.blocks={}),r=s.blocks.MATH_FUNCTIONS.unary.concat(s.blocks.MATH_FUNCTIONS.binary).concat(s.blocks.MATH_FUNCTIONS.infix),i.initMathOpBlock=function(){var t="math_js_op",e=s.blocks.getBlockDefinition(t);function l(t,e){var i=t.appendValueInput("ARG"+(e?1:0));i.setCheck("Number"),e&&(i.connection.setShadowDom(function(){if(!o){(o=document.createElement("shadow")).setAttribute("type","math_number");var t=document.createElement("field");t.setAttribute("name","NUM"),t.textContent="0",o.appendChild(t)}return o}()),i.connection.respawnShadow_())}function a(t,e){var i=!!t.getInput("ARG1");e?(i&&t.moveInputBefore("op_dropdown","ARG1"),t.moveInputBefore("ARG0","op_dropdown")):(i&&t.moveInputBefore("ARG0","ARG1"),t.moveInputBefore("op_dropdown","ARG0"))}Blockly.Blocks[t]={init:function(){var n=this;n.setPreviousStatement(!1),n.setNextStatement(!1),n.setOutput(!0,"Number"),n.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),n.setInputsInline(!0),n.appendDummyInput("op_dropdown").appendField(new Blockly.FieldDropdown(r.map(function(t){return[e.block[t],t]}),function(t){return e=n,o=i=t,-1!==s.blocks.MATH_FUNCTIONS.unary.indexOf(o)?e.removeInput("ARG1",!0):e.getInput("ARG1")||l(e,!0),void a(e,(r=i,-1!==s.blocks.MATH_FUNCTIONS.infix.indexOf(r)));var e,i,o,r}),"OP"),l(n,!1),i.appendMutation(n,{mutationToDom:function(t){for(var e,i=0;i<n.inputList.length;i++){var o=n.inputList[i];if("op_dropdown"===o.name){e=!1;break}if("ARG0"===o.name){e=!0;break}}return t.setAttribute("op-type",(n.getInput("ARG1")?e?"infix":"binary":"unary").toString()),t},domToMutation:function(t){if(t.hasAttribute("op-type")){var e=t.getAttribute("op-type");"unary"!=e&&l(n,!0),a(n,"infix"===e)}}})}},i.installHelpResources(t,e.name,function(t){return e.tooltip[t.getFieldValue("OP")]},e.url,s.toolbox.getNamespaceColor(e.category))}}(pxt||(pxt={})),function(i){var o,r;o=i.blocks||(i.blocks={}),r=i.blocks.ROUNDING_FUNCTIONS,o.initMathRoundBlock=function(){var t="math_js_round",e=i.blocks.getBlockDefinition(t);Blockly.Blocks[t]={init:function(){var t=this;t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0,"Number"),t.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),t.setInputsInline(!0),t.appendDummyInput("round_dropdown").appendField(new Blockly.FieldDropdown(r.map(function(t){return[e.block[t],t]}),function(t){}),"OP"),t.appendValueInput("ARG0").setCheck("Number")}},o.installHelpResources(t,e.name,function(t){return e.tooltip[t.getFieldValue("OP")]},e.url,i.toolbox.getNamespaceColor(e.category))}}(pxt||(pxt={})),function(o){var n=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.onMouseEnter=function(){if(!o.animateRef){var t=50<o.state.interval?o.state.interval:50,e=0;o.animateRef=setInterval(function(){o.preview&&o.frames[e]&&o.preview.src(o.frames[e]),e=(e+1)%o.frames.length},t)}},o.onMouseLeave=function(){o.animateRef&&clearInterval(o.animateRef),o.animateRef=void 0,o.preview&&o.frames[0]&&o.preview.src(o.frames[0])},o.lightMode=e.lightMode,o.params=function(t){var e={initWidth:16,initHeight:16};if(!t)return e;t.filter&&(e.filter=t.filter);return e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,o.initState(),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.initState(),this.redrawPreview(),this.sourceBlock_.getSvgRoot().addEventListener("mouseenter",this.onMouseEnter),this.sourceBlock_.getSvgRoot().addEventListener("mouseleave",this.onMouseLeave),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_),this.state.interval=this.getParentInterval())},t.prototype.showEditor_=function(){var i=this;this.params.blocksInfo=this.blocksInfo,this.initState();var t=this.getParentInterval();isNaN(t)||(this.state.interval=t);var o=pxt.react.getFieldEditorView("animation-editor",this.state,this.params);this.undoRedoState&&o.restorePersistentData(this.undoRedoState),o.onHide(function(){var t=o.getResult();if(t){var e=i.getValue();i.state=t,isNaN(i.state.interval)||i.setParentInterval(i.state.interval),i.redrawPreview(),i.undoRedoState=o.getPersistentData(),i.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(i.sourceBlock_,"field",i.name,e,i.getValue()))}}),o.show()},t.prototype.render_=function(){r.prototype.render_.call(this),this.size_.height=42,this.size_.width=80},t.prototype.getValue=function(){return this.state?"["+this.state.frames.map(function(t){return pxt.sprite.bitmapToImageLiteral(pxt.sprite.Bitmap.fromData(t),"typescript")}).join(",")+"]":"[]"},t.prototype.doValueUpdate_=function(t){if(null!=t){this.value_=t;var e=t.replace(/[\[\]]/gm,"").split(",").map(function(t){return pxt.sprite.imageLiteralToBitmap(t).data()}).filter(function(t){return t.height&&t.width});e&&e.length&&(this.initState(),this.state.frames=e),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t)}},t.prototype.redrawPreview=function(){var e=this;if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=(new n.Rect).at(35,1).size(40,40).corner(4).setClass("blocklyAnimationField");this.fieldGroup_.appendChild(t.el);var i=new n.Text("").at(5,26).fill(this.sourceBlock_.getColourSecondary()).setClass("semanticIcon");this.fieldGroup_.appendChild(i.el),this.state&&(this.frames=this.state.frames.map(function(t){return o.bitmapToImageURI(pxt.sprite.Bitmap.fromData(t),32,e.lightMode)}),this.preview=(new n.Image).src(this.frames[0]).at(39,5).size(32,32),this.fieldGroup_.appendChild(this.preview.el))}},t.prototype.getParentIntervalBlock=function(){var t=this.sourceBlock_;if(t.parentBlock_)for(var e=0,i=t.parentBlock_.inputList;e<i.length;e++){var o=i[e];if("frameInterval"===o.name)return o.connection.targetBlock()}},t.prototype.setParentInterval=function(t){var e=this.getParentIntervalBlock();if(e){var i=l(e);i&&e.setFieldValue(String(t),i)}},t.prototype.getParentInterval=function(){var t=this.getParentIntervalBlock();if(t){var e=l(t);if(e)return Number(t.getFieldValue(e))}return 100},t.prototype.initState=function(){this.state||(this.params?this.state={frames:[new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight).data()],interval:100}:this.state={frames:[],interval:100})},t}(Blockly.Field);function l(t){return"math_number_minmax"===t.type?"SLIDER":"math_number"===(e=t.type)||"math_integer"===e||"math_whole_number"===e?"NUM":"timePicker"===t.type?"ms":null;var e}o.FieldAnimationEditor=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,void 0,void 0,void 0,i)||this;return o.isFieldCustom_=!0,o.CURSOR="pointer",o.params=e,o.setValue(t),o.addArgType("toggle"),o.type_=e.type,o}return __extends(t,r),t.prototype.init=function(){if(!this.fieldGroup_){this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes()));var t=this.getSize();this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOnBreakpoint":"blocklyToggleOffBreakpoint"),transform:"translate(8, "+t.height/2+")"},this.fieldGroup_),this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"50,5 100,5 125,30 125,80 100,105 50,105 25,80 25,30"},this.checkElement_);var e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)}},t.prototype.updateSize_=function(){this.size_.width=30},t.prototype.getValue=function(){return this.toVal(this.state_)},t.prototype.setValue=function(t){var e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_))},t.prototype.switchToggle=function(t){this.checkElement_&&(this.updateSize_(),t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOffBreakpoint")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOffBreakpoint")),this.checkElement_.setAttribute("transform","translate(-7, -1) scale(0.3)"))},t.prototype.updateDisplay_=function(t){r.prototype.updateDisplay_.call(this,t),this.textElement_&&pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText")},t.prototype.render_=function(){this.visible_&&this.textElement_&&(goog.dom.removeChildren(this.textElement_),this.updateSize_())},t.prototype.showEditor_=function(){var t=!this.state_;null!==t&&this.setValue(this.toVal(t))},t.prototype.toVal=function(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")},t.prototype.fromVal=function(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t},t}(Blockly.FieldNumber);t.FieldBreakpoint=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"0","255","1","10","Color",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.min&&(o.min_=parseFloat(o.params.min)),o.params.max&&(o.max_=parseFloat(o.params.max)),o.params.label&&(o.labelText_=o.params.label),o.params.channel&&(o.channel_=o.params.channel),o}return __extends(t,r),t.prototype.setBackground_=function(t){var e=this.createColourStops_().join(",");goog.style.setStyle(t,"background","-moz-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-webkit-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-o-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-ms-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","linear-gradient(left, "+e+")"),this.params.sliderWidth&&goog.style.setStyle(t,"width",this.params.sliderWidth+"px")},t.prototype.setReadout_=function(t,e){var i=this.colorWheel(parseInt(e),this.channel_),o=document.createElement("span");o.className="blocklyColorReadout",o.style.backgroundColor=""+i,pxsim.U.clear(t),t.appendChild(o)},t.prototype.createColourStops_=function(){for(var t=[],e=0;e<=255;e+=20)t.push(this.colorWheel(e,this.channel_));return t},t.prototype.colorWheel=function(t,e){return"hsvfast"==e?this.hsvFast(t,255,255):(t=255-t)<85?this.hex(3*t,255,255-3*t):t<170?(t-=85,this.hex(255,255-3*t,3*t)):(t-=170,this.hex(255-3*t,3*t,255))},t.prototype.hsvFast=function(t,e,i){var o=t%255>>0;o<0&&(o+=255);var r,n,l,a=i*(255-e)/255>>0,s=i-a,c=(o=192*o/255>>0)/64>>0,u=o%64>>0,p=(u*s/63.75>>0)+a,d=((63-u)*s/63.75>>0)+a;return c?1==c?(r=a,n=d,l=p):(r=p,n=a,l=d):(r=d,n=p,l=a),this.hex(r,n,l)},t.prototype.hex=function(t,e,i){return"#"+this.componentToHex(255&t)+this.componentToHex(255&e)+this.componentToHex(255&i)},t.prototype.componentToHex=function(t){var e=t.toString(16);return 1==e.length?"0"+e:e},t}(Blockly.FieldSlider);t.FieldColorWheel=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(l){function t(t,e,i){var o=l.call(this,t,i)||this;if(o.isFieldCustom_=!0,o.valueMode_="rgb",e.colours)o.setColours(JSON.parse(e.colours));else if(pxt.appTarget.runtime&&pxt.appTarget.runtime.palette){var r=pxt.Util.clone(pxt.appTarget.runtime.palette);r[0]="#dedede";var n=void 0;pxt.appTarget.runtime.paletteNames&&((n=pxt.Util.clone(pxt.appTarget.runtime.paletteNames))[0]=lf("transparent")),o.setColours(r,n)}return o.setValue(o.getColours_()[0]),e.columns&&o.setColumns(parseInt(e.columns)),e.className&&(o.className_=e.className),e.valueMode&&(o.valueMode_=e.valueMode),o}return __extends(t,l),t.prototype.applyColour=function(){var t,e,i,o,r,n;this.borderRect_?this.borderRect_.style.fill=this.value_:this.sourceBlock_&&(null===(i=null===(e=null===(t=this.sourceBlock_)||void 0===t?void 0:t.pathObject)||void 0===e?void 0:e.svgPath)||void 0===i||i.setAttribute("fill",this.value_),null===(n=null===(r=null===(o=this.sourceBlock_)||void 0===o?void 0:o.pathObject)||void 0===r?void 0:r.svgPath)||void 0===n||n.setAttribute("stroke","#fff"))},t.prototype.doClassValidation_=function(t){return"string"!=typeof t?null:i(t,this.getColours_())},t.prototype.getValue=function(t){if(t)return this.value_;switch(this.valueMode_){case"hex":return'"'+this.value_+'"';case"rgb":return-1<this.value_.indexOf("#")?"0x"+this.value_.replace(/^#/,""):this.value_;case"index":if(!this.value_)return"-1";for(var e=this.getColours_(),i=0;i<e.length;i++)if(this.value_.toUpperCase()===e[i].toUpperCase())return i+""}return this.value_},t.prototype.doValueUpdate_=function(t){this.value_=i(t,this.getColours_()),this.applyColour()},t.prototype.showEditor_=function(){l.prototype.showEditor_.call(this),this.className_&&this.picker_&&pxt.BrowserUtils.addClass(this.picker_,this.className_)},t.prototype.getColours_=function(){return this.colours_},t}(Blockly.FieldColour);function i(t,e){if(t){var i=/Colors\.([a-zA-Z]+)/.exec(t),o=/(0x|#)([0-9a-fA-F]+)/.exec(t);if(i)switch(i[1].toLocaleLowerCase()){case"red":return"#FF0000";case"orange":return"#FF7F00";case"yellow":return"#FFFF00";case"green":return"#00FF00";case"blue":return"#0000FF";case"indigo":return"#4B0082";case"violet":return"#8A2BE2";case"purple":return"#A033E5";case"pink":return"#FF007F";case"white":return"#FFFFFF";case"black":return"#000000";default:return t}else if(o){var r=o[2];if(3===r.length){for(var n="#",l=0;l<r.length;l++){var a=r.charAt(l);n+=a+a}return n}if(6===r.length)return"#"+r}if(e){var s=parseInt(t);return isNaN(s)||null==e[s]?e[0]:e[s]}}return t}t.FieldColorNumber=e}(pxtblockly||(pxtblockly={})),function(l){var t=function(n){function f(t,e,i){var o=n.call(this,e.data)||this;o.isFieldCustom_=!0,o.buttonClick_=function(t){var e=t.target.getAttribute("data-value");null!==e&&(this.setValue(e),this.closeModal_&&(this.close(),this.closeModal_=!1))},o.buttonClickAndClose_=function(t){this.closeModal_=!0,this.buttonClick_(t)},o.columns_=parseInt(e.columns)||4,o.maxRows_=parseInt(e.maxRows)||0,o.width_=parseInt(e.width)||200,o.backgroundColour_=l.parseColour(e.colour),o.borderColour_=pxt.toolbox.fadeColor(o.backgroundColour_,.4,!1);var r={xOffset:parseInt(e.tooltipsXOffset)||15,yOffset:parseInt(e.tooltipsYOffset)||-10};return o.tooltipConfig_=r,o.hasSearchBar_=!!e.hasSearchBar||!1,o.hideRect_=!!e.hideRect||!1,o}return __extends(f,n),f.prototype.dispose=function(){n.prototype.dispose.call(this),this.disposeTooltip(),this.disposeIntersectionObserver()},f.prototype.createTooltip_=function(){this.gridTooltip_||(this.gridTooltip_=document.createElement("div"),this.gridTooltip_.className="goog-tooltip blocklyGridPickerTooltip",this.gridTooltip_.style.position="absolute",this.gridTooltip_.style.display="none",this.gridTooltip_.style.visibility="hidden",document.body.appendChild(this.gridTooltip_))},f.prototype.populateTableContainer=function(t,e,i){pxsim.U.removeChildren(e),0==t.length&&(this.firstItem_=void 0);for(var o=0;o<t.length/this.columns_;o++){var r=this.populateRow(o,t,e);e.appendChild(r)}},f.prototype.populateRow=function(t,u,p){var d=this,e=this.columns_,h=document.createElement("div");h.className="blocklyGridPickerRow";for(var i=function(t){var o=u[t][0],r=u[t][1],n=document.createElement("div");n.className="goog-menuitem goog-option",n.setAttribute("id",":"+t),n.setAttribute("role","menuitem"),n.style.userSelect="none",n.title=o.alt||o,n.setAttribute("data-value",r);var e=document.createElement("div");e.setAttribute("class","goog-menuitem-content"),e.title=o.alt||o,e.setAttribute("data-value",r);var l="object"==typeof o,i=m.backgroundColour_;if(r==m.getValue()&&(n.setAttribute("aria-selected","true"),pxt.BrowserUtils.addClass(n,"goog-option-selected"),i=m.sourceBlock_.getColourTertiary(),m.selectedItemDom=n,l&&!m.shouldShowTooltips()&&m.updateSelectedBar_(o,r)),n.style.backgroundColor=i,n.style.borderColor=m.borderColour_,l){var a=new Image(o.width,o.height);a.setAttribute("draggable","false"),"IntersectionObserver"in window?(a.src=f.DEFAULT_IMG,a.setAttribute("data-src",o.src),m.observer.observe(a)):a.src=o.src,a.alt=o.alt||"",a.setAttribute("data-value",r),e.appendChild(a)}else e.textContent=o;if(m.shouldShowTooltips()){Blockly.bindEvent_(n,"click",m,m.buttonClickAndClose_);var s=m.sourceBlock_.RTL?-m.tooltipConfig_.xOffset:m.tooltipConfig_.xOffset,c=m.tooltipConfig_.yOffset;Blockly.bindEvent_(n,"mousemove",m,function(t){if(l){d.gridTooltip_.style.top=t.clientY+c+"px",d.gridTooltip_.style.left=t.clientX+s+"px";var e=document.elementFromPoint(t.clientX,t.clientY),i=e.title||e.alt;d.gridTooltip_.textContent=i,d.gridTooltip_.style.visibility=i?"visible":"hidden",d.gridTooltip_.style.display=i?"":"none"}pxt.BrowserUtils.addClass(n,"goog-menuitem-highlight"),p.setAttribute("aria-activedescendant",n.id)}),Blockly.bindEvent_(n,"mouseout",m,function(t){l&&(d.gridTooltip_.style.visibility="hidden",d.gridTooltip_.style.display="none"),pxt.BrowserUtils.removeClass(n,"goog-menuitem-highlight"),p.removeAttribute("aria-activedescendant")})}else l?(m.selectedBar_.style.display="",Blockly.bindEvent_(n,"click",m,function(t){if(d.closeModal_)d.buttonClick_(t);else{for(var e=p.getElementsByClassName("goog-menuitem-highlight"),i=0;i<e.length;i++)pxt.BrowserUtils.removeClass(e[i],"goog-menuitem-highlight");pxt.BrowserUtils.addClass(n,"goog-menuitem-highlight"),d.updateSelectedBar_(o,r)}})):(Blockly.bindEvent_(n,"click",m,m.buttonClickAndClose_),Blockly.bindEvent_(n,"mouseup",m,m.buttonClickAndClose_));n.appendChild(e),h.appendChild(n),0==t&&(m.firstItem_=n)},m=this,o=e*t;o<Math.min(e*t+e,u.length);o++)i(o);return h},f.prototype.shouldShowRect_=function(){return!this.hideRect_&&!this.sourceBlock_.isShadow()},f.prototype.doClassValidation_=function(t){return t},f.prototype.close=function(){this.disposeTooltip(),Blockly.WidgetDiv.hideIfOwner(this),Blockly.Events.setGroup(!1)},f.prototype.getFirstItem=function(){return this.firstItem_},f.prototype.highlightFirstItem=function(t){var e=t.childNodes;if(e.length&&e[0].childNodes){for(var i=0;i<e.length;++i)for(var o=e[i].childNodes.length,r=0;r<o;++r){var n=e[i].childNodes[r];pxt.BrowserUtils.removeClass(n,"goog-menuitem-highlight"),pxt.BrowserUtils.removeClass(n,"goog-option-selected")}e[0].childNodes[0].className+=" goog-menuitem-highlight"}},f.prototype.highlightAndScrollSelected=function(t,e){this.selectedItemDom&&goog.style.scrollIntoContainerView(this.selectedItemDom,e,!0)},f.prototype.showEditor_=function(){var t=this;Blockly.WidgetDiv.show(this,this.sourceBlock_.RTL,function(){t.onClose_()}),this.setupIntersectionObserver_(),this.createTooltip_();var e=document.createElement("div");this.positionMenu_(e)},f.prototype.positionMenu_=function(t){var e=Blockly.utils.getViewportBBox(),i=this.getAnchorDimensions_(),o=this.createWidget_(t),r=o.paddingContainer,n=o.scrollContainer,l={width:r.offsetWidth,height:r.offsetHeight},a=goog.dom.getViewportSize();this.width_>a.width&&(this.width_=a.width),t.style.width=this.width_+"px";var s=0;if(this.hasSearchBar_&&(s+=50),this.selectedBar_&&(s+=50),this.maxRows_){var c=t.children[0].offsetHeight*(this.maxRows_+.3);a.height<c+s&&(c=a.height-s),l.height>c&&(n.style.overflowY="auto",goog.style.setHeight(n,c),l.height=c)}l.height+=s,this.sourceBlock_.RTL&&Blockly.utils.uiMenu.adjustBBoxesForRTL(e,i,l),Blockly.WidgetDiv.positionWithAnchor(e,i,l,this.sourceBlock_.RTL),this.highlightAndScrollSelected(t,n)},f.prototype.shouldShowTooltips=function(){return!pxt.BrowserUtils.isMobile()},f.prototype.getAnchorDimensions_=function(){var t=this.getScaledBBox();return this.sourceBlock_.RTL?t.right+=Blockly.FieldDropdown.CHECKMARK_OVERHANG:t.left-=Blockly.FieldDropdown.CHECKMARK_OVERHANG,t},f.prototype.createWidget_=function(t){var e=Blockly.WidgetDiv.DIV,i=this.getOptions();t.setAttribute("role","menu"),t.setAttribute("aria-haspopup","true");var o=document.createElement("div"),r=document.createElement("div");if(r.style.border="solid 1px "+this.borderColour_,t.style.backgroundColor=this.backgroundColour_,o.style.backgroundColor=this.backgroundColour_,r.style.backgroundColor=this.backgroundColour_,t.className="blocklyGridPickerMenu",o.className="blocklyGridPickerScroller",r.className="blocklyGridPickerPadder",r.appendChild(o),o.appendChild(t),e.appendChild(r),this.hasSearchBar_){var n=this.createSearchBar_(t,o,i);r.insertBefore(n,r.childNodes[0])}return this.shouldShowTooltips()||(this.selectedBar_=this.createSelectedBar_(),r.appendChild(this.selectedBar_)),this.populateTableContainer(i,t,o),{paddingContainer:r,scrollContainer:o}},f.prototype.createSearchBar_=function(r,i,n){var l=this,t=document.createElement("div");t.setAttribute("class","ui fluid icon input");var e=document.createElement("i");e.setAttribute("class","search icon");var a=document.createElement("input");return a.setAttribute("type","search"),a.setAttribute("id","search-bar"),a.setAttribute("class","blocklyGridPickerSearchBar"),a.setAttribute("placeholder",pxt.Util.lf("Search")),a.addEventListener("click",function(){a.focus(),a.setSelectionRange(0,a.value.length)}),a.addEventListener("keyup",pxt.Util.debounce(function(){var t=a.value,o=new RegExp(t,"i"),e=n.filter(function(t){var e=t[0].alt,i=t[1];return e?o.test(e):o.test(i)});l.populateTableContainer.bind(l)(e,r,i),t?l.highlightFirstItem(r):l.highlightAndScrollSelected(r,i),l.gridTooltip_.style.visibility="hidden",l.gridTooltip_.style.display="none"},300,!1)),a.addEventListener("keyup",function(t){if(13==t.which){var e=r.childNodes[0];if(e){var i=e.childNodes[0];i&&(l.closeModal_=!0,i.click())}}}),t.appendChild(a),t.appendChild(e),t},f.prototype.createSelectedBar_=function(){var t=this,e=document.createElement("div");e.setAttribute("class","blocklyGridPickerSelectedBar"),e.style.display="none";var i=document.createElement("div"),o=document.createElement("div");o.className="blocklyGridPickerSelectedImage",i.appendChild(o),this.selectedImg_=document.createElement("img"),this.selectedImg_.setAttribute("width","30px"),this.selectedImg_.setAttribute("height","30px"),this.selectedImg_.setAttribute("draggable","false"),this.selectedImg_.style.display="none",this.selectedImg_.src=f.DEFAULT_IMG,o.appendChild(this.selectedImg_),this.selectedBarText_=document.createElement("span"),this.selectedBarText_.className="blocklyGridPickerTooltip",i.appendChild(this.selectedBarText_);var r=document.createElement("div"),n=document.createElement("div");n.className="ui buttons mini",r.appendChild(n);var l=document.createElement("button");l.className="ui button icon green";var a=document.createElement("i");a.className="icon check",l.appendChild(a),Blockly.bindEvent_(l,"click",this,function(){t.setValue(t.selectedBarValue_),t.close()});var s=document.createElement("button");s.className="ui button icon red";var c=document.createElement("i");return c.className="icon cancel",s.appendChild(c),Blockly.bindEvent_(s,"click",this,function(){t.close()}),n.appendChild(l),n.appendChild(s),e.appendChild(i),e.appendChild(r),e},f.prototype.updateSelectedBar_=function(t,e){t.src&&(this.selectedImg_.src=t.src,this.selectedImg_.style.display=""),this.selectedImg_.alt=t.alt||t,this.selectedBarText_.textContent=t.alt||t,this.selectedBarValue_=e},f.prototype.setupIntersectionObserver_=function(){var o=this;if("IntersectionObserver"in window){this.disposeIntersectionObserver();this.observer=new IntersectionObserver(function(t){t.forEach(function(t){var e,i;0<t.intersectionRatio&&(o.observer.unobserve(t.target),e=t.target,(i=e.getAttribute("data-src"))&&(e.src=i,e.removeAttribute("data-src")))})},{rootMargin:"20px 0px",threshold:.01})}},f.prototype.disposeIntersectionObserver=function(){this.observer&&(this.observer=null)},f.prototype.disposeTooltip=function(){this.gridTooltip_&&(pxsim.U.remove(this.gridTooltip_),this.gridTooltip_=null)},f.prototype.onClose_=function(){this.disposeTooltip()},f.DEFAULT_IMG="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f}(Blockly.FieldDropdown);l.FieldGridPicker=t}(pxtblockly||(pxtblockly={})),function(n){var t=function(r){function t(t,e,i){var o=r.call(this,e.data)||this;return o.isFieldCustom_=!0,o.buttonClick_=function(t){var e=t.target.getAttribute("data-value");e&&(this.setValue(e),Blockly.DropDownDiv.hide())},o.columns_=parseInt(e.columns),o.maxRows_=parseInt(e.maxRows)||0,o.width_=parseInt(e.width)||300,o.backgroundColour_=n.parseColour(e.colour),o.borderColour_=pxt.toolbox.fadeColor(o.backgroundColour_,.4,!1),o}return __extends(t,r),t.prototype.showEditor_=function(){var t,e;if(!Blockly.DropDownDiv.hideIfOwner(this)){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var i=Blockly.DropDownDiv.getContentDiv(),o=document.createElement("div");o.setAttribute("role","menu"),o.setAttribute("aria-haspopup","true");for(var r=this.getOptions(),n=0,l=0;l<r.length;l++){var a=r[l][0],s=r[l][1];if("placeholder"!=a.type){var c=document.createElement("button");c.setAttribute("id",":"+l),c.setAttribute("role","menuitem"),c.setAttribute("class","blocklyDropDownButton"),c.title=a.alt;var u=a.height;this.columns_?(u=this.width_/this.columns_-8,c.style.width=u+"px",c.style.height=u+"px"):(c.style.width=a.width+"px",c.style.height=a.height+"px"),n<u&&(n=u);var p=this.backgroundColour_;s==this.getValue()&&(p=this.sourceBlock_.getColourTertiary(),c.setAttribute("aria-selected","true")),c.style.backgroundColor=p,c.style.borderColor=this.borderColour_,Blockly.bindEvent_(c,"click",this,this.buttonClick_),Blockly.bindEvent_(c,"mouseover",c,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),o.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(c,"mouseout",c,function(){this.setAttribute("class","blocklyDropDownButton"),o.removeAttribute("aria-activedescendant")});var d=document.createElement("img");d.src=a.src,c.setAttribute("data-value",s),d.setAttribute("data-value",s),c.appendChild(d),o.appendChild(c)}else{var h=document.createElement("span");h.setAttribute("class","blocklyDropDownPlaceholder"),h.style.width=a.width+"px",h.style.height=a.height+"px",o.appendChild(h)}}o.style.width=this.width_+"px",i.appendChild(o),this.maxRows_&&(i.style.maxHeight=(this.maxRows_+.4)*(n+8)+"px"),pxt.BrowserUtils.isFirefox()&&(i.style.paddingRight="20px"),Blockly.DropDownDiv.setColour(this.backgroundColour_,this.borderColour_),Blockly.DropDownDiv.showPositionedByField(this,this.onHide_.bind(this));var m=this.sourceBlock_;this.savedPrimary_=null===(t=m)||void 0===t?void 0:t.getColour(),(null===(e=m)||void 0===e?void 0:e.isShadow())?m.setColour(m.getColourTertiary()):this.borderRect_&&this.borderRect_.setAttribute("fill",m.getColourTertiary())}},t.prototype.onHide_=function(){var t,e=Blockly.DropDownDiv.getContentDiv();e.removeAttribute("role"),e.removeAttribute("aria-haspopup"),e.removeAttribute("aria-activedescendant"),e.style.width="",e.style.paddingRight="",e.style.maxHeight="",(null===(t=this.sourceBlock_)||void 0===t?void 0:t.isShadow())?this.sourceBlock_.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)},t}(Blockly.FieldDropdown);n.FieldImageDropdown=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o.shouldSort_=e.sort,o.addLabel_=!!e.addLabel,o}return __extends(t,r),t.prototype.showEditor_=function(){var t,e;if(!Blockly.DropDownDiv.hideIfOwner(this)){var i=this.sourceBlock_;Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var o=Blockly.DropDownDiv.getContentDiv(),r=document.createElement("div");r.setAttribute("role","menu"),r.setAttribute("aria-haspopup","true");var n=this.getOptions();this.shouldSort_&&n.sort();for(var l=0;l<n.length;l++){var a=n[l][0],s=n[l][1];if("placeholder"!=a.type){var c=document.createElement("button");c.setAttribute("id",":"+l),c.setAttribute("role","menuitem"),c.setAttribute("class","blocklyDropDownButton"),c.title=a.alt,this.columns_?c.style.width=this.width_/this.columns_-8+"px":(c.style.width=a.width+"px",c.style.height=a.height+"px");var u=i.getColour();s==this.getValue()&&(u=i.getColourTertiary(),c.setAttribute("aria-selected","true")),c.style.backgroundColor=u,c.style.borderColor=i.getColourTertiary(),Blockly.bindEvent_(c,"click",this,this.buttonClick_),Blockly.bindEvent_(c,"mouseover",c,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),r.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(c,"mouseout",c,function(){this.setAttribute("class","blocklyDropDownButton"),r.removeAttribute("aria-activedescendant")});var p=document.createElement("img");if(p.src=a.src,c.setAttribute("data-value",s),p.setAttribute("data-value",s),c.appendChild(p),this.addLabel_){var d=this.createTextNode_(a.alt);d.setAttribute("data-value",s),c.appendChild(d)}r.appendChild(c)}else{var h=document.createElement("span");h.setAttribute("class","blocklyDropDownPlaceholder"),h.style.width=a.width+"px",h.style.height=a.height+"px",r.appendChild(h)}}r.style.width=this.width_+"px",o.appendChild(r),Blockly.DropDownDiv.setColour(i.getColour(),i.getColourTertiary()),Blockly.DropDownDiv.showPositionedByField(this,this.onHideCallback.bind(this)),this.savedPrimary_=null===(t=i)||void 0===t?void 0:t.getColour(),(null===(e=i)||void 0===e?void 0:e.isShadow())?i.setColour(i.style.colourTertiary):this.borderRect_&&this.borderRect_.setAttribute("fill",i.style.colourTertiary)}},t.prototype.onHideCallback=function(){var t,e=this.sourceBlock_;(null===(t=e)||void 0===t?void 0:t.isShadow())?e.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)},t.prototype.createTextNode_=function(t){var e=document.createElement("span");return e.setAttribute("class","blocklyDropdownTextLabel"),e.textContent=t,e},t}(t.FieldImageDropdown);t.FieldImages=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t){var i,e=o.call(this,(i=t,function(){var e=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){var t=this.sourceBlock_.workspace.getVariablesOfType(r(i.name));t.forEach(function(t){e.push([t.name,t.name])})}else i.initialMembers.forEach(function(t){return e.push([t,t])});return e.push([lf("Add a new {0}...",i.memberName),"CREATE"]),e}))||this;return e.opts=t,e}return __extends(t,o),t.prototype.initView=function(){o.prototype.initView.call(this),this.initVariables()},t.prototype.onItemSelected_=function(t,e){var i=this;"CREATE"===e.getValue()?function n(l,a,s,c){Blockly.prompt(s,null,function(t){if(t){var e=!1;if(pxtc.isIdentifierStart(t.charCodeAt(0),2)){e=!0;for(var i=1;i<t.length;i++)pxtc.isIdentifierPart(t.charCodeAt(i),2)||(e=!1)}if(!e)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),function(){return n(l,a,s,c)});for(var o=u(l,a.name),i=0;i<o.length;i++){var r=o[i];if(r===t)return void Blockly.alert(lf("A {0} named '{1}' already exists.",a.memberName,t),function(){return n(l,a,s,c)})}t===a.createFunctionName&&Blockly.alert(lf("'{0}' is a reserved name.",a.createFunctionName),function(){return n(l,a,s,c)}),c(p(l,a,t))}},{placeholder:a.promptHint})}(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),function(t){return t&&i.setValue(t)}):o.prototype.onItemSelected_.call(this,t,e)},t.prototype.doClassValidation_=function(e){var t;return(null===(t=this.opts)||void 0===t?void 0:t.initialMembers)&&!this.opts.initialMembers.find(function(t){return t==e})&&this.getOptions(),o.prototype.doClassValidation_.call(this,e)},t.prototype.initVariables=function(){var e=this;if(this.sourceBlock_&&this.sourceBlock_.workspace){var i=this.sourceBlock_.workspace,o=u(i,this.opts.name);this.opts.initialMembers.forEach(function(t){-1===o.indexOf(t)&&p(i,e.opts,t)}),"CREATE"===this.getValue()&&this.opts.initialMembers.length&&this.setValue(this.opts.initialMembers[0])}},t}(Blockly.FieldDropdown);function u(t,e){var i=t.getVariablesOfType(r(e));return i&&i.length?i.map(function(t){return t.name}):[]}function p(t,e,i){return Blockly.Variables.getOrCreateVariablePackage(t,null,i,r(e.name)),i}function r(t){return"KIND_"+t}t.FieldKind=e}(pxtblockly||(pxtblockly={}));var LabelMode,pxtblockly,rowRegex=/^.*[\.#].*$/;!function(t){t[t.None=0]="None",t[t.Number=1]="Number",t[t.Letter=2]="Letter"}(LabelMode||(LabelMode={})),function(t){var e=function(r){function a(t,e,i){var l=r.call(this,t,i)||this;if(l.isFieldCustom_=!0,l.SERIALIZABLE=!0,l.onColor="#FFFFFF",l.scale=1,l.matrixWidth=5,l.matrixHeight=5,l.yAxisLabel=LabelMode.None,l.xAxisLabel=LabelMode.None,l.cellState=[],l.cells=[],l.dontHandleMouseEvent_=function(t){t.stopPropagation(),t.preventDefault()},l.clearLedDragHandler=function(t){var e=l.sourceBlock_.getSvgRoot();pxsim.pointerEvents.down.forEach(function(t){return e.removeEventListener(t,l.dontHandleMouseEvent_)}),e.removeEventListener(pxsim.pointerEvents.move,l.dontHandleMouseEvent_),document.removeEventListener(pxsim.pointerEvents.up,l.clearLedDragHandler),document.removeEventListener(pxsim.pointerEvents.leave,l.clearLedDragHandler),Blockly.Touch.clearTouchIdentifier(),l.elt.removeEventListener(pxsim.pointerEvents.move,l.handleRootMouseMoveListener),t.stopPropagation(),t.preventDefault()},l.toggleRect=function(t,e){l.cellState[t][e]=l.currentDragState_,l.updateValue()},l.handleRootMouseMoveListener=function(t){var e,i;t.changedTouches&&1==t.changedTouches.length?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY);var o=document.elementFromPoint(e,i);if(o){var r=o.getAttribute("data-x"),n=o.getAttribute("data-y");null!=r&&null!=n&&l.toggleRect(parseInt(r),parseInt(n))}},l.params=e,void 0!==l.params.rows){var o=parseInt(l.params.rows);isNaN(o)||(l.matrixHeight=o)}if(void 0!==l.params.columns){o=parseInt(l.params.columns);isNaN(o)||(l.matrixWidth=o)}return void 0!==l.params.onColor&&(l.onColor=l.params.onColor),void 0!==l.params.offColor&&(l.offColor=l.params.offColor),void 0!==l.params.scale?l.scale=Math.max(.6,Math.min(2,Number(l.params.scale))):15<Math.max(l.matrixWidth,l.matrixHeight)?l.scale=.85:10<Math.max(l.matrixWidth,l.matrixHeight)&&(l.scale=.9),l}return __extends(a,r),a.prototype.showEditor_=function(){},a.prototype.initMatrix=function(){if(!this.sourceBlock_.isInsertionMarker()){this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" id="field-matrix" />');for(var t=0;t<this.matrixWidth;t++){this.cellState.push([]),this.cells.push([]);for(var e=0;e<this.matrixHeight;e++)this.cellState[t].push(!1)}this.restoreStateFromString();for(t=0;t<this.matrixWidth;t++)for(e=0;e<this.matrixHeight;e++)this.createCell(t,e);if(this.updateValue(),this.xAxisLabel!==LabelMode.None){var i=this.scale*this.matrixHeight*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+2*a.CELL_VERTICAL_MARGIN+a.BOTTOM_MARGIN,o=pxsim.svg.child(this.elt,"g",{transform:"translate(0 "+i+")"});for(t=0;t<this.matrixWidth;t++){var r=this.getYAxisWidth()+this.scale*t*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_WIDTH/2+a.CELL_HORIZONTAL_MARGIN/2;pxsim.svg.child(o,"text",{x:r,class:"blocklyText"}).textContent=this.getLabel(t,this.xAxisLabel)}}if(this.yAxisLabel!==LabelMode.None){var n=pxsim.svg.child(this.elt,"g",{});for(t=0;t<this.matrixHeight;t++){i=this.scale*t*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_WIDTH/2+2*a.CELL_VERTICAL_MARGIN;pxsim.svg.child(n,"text",{x:0,y:i,class:"blocklyText"}).textContent=this.getLabel(t,this.yAxisLabel)}}this.fieldGroup_.replaceChild(this.elt,this.fieldGroup_.firstChild)}},a.prototype.getLabel=function(t,e){switch(e){case LabelMode.Letter:return String.fromCharCode(t+65);default:return(t+1).toString()}},a.prototype.createCell=function(i,o){var r=this,t=this.scale*i*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_HORIZONTAL_MARGIN+this.getYAxisWidth(),e=this.scale*o*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_VERTICAL_MARGIN,n=pxsim.svg.child(this.elt,"g",{transform:"translate("+t+" "+e+")"}),l=pxsim.svg.child(n,"rect",{class:"blocklyLed"+(this.cellState[i][o]?"On":"Off"),cursor:"pointer",width:this.scale*a.CELL_WIDTH,height:this.scale*a.CELL_WIDTH,fill:this.getColor(i,o),"data-x":i,"data-y":o,rx:Math.max(2,this.scale*a.CELL_CORNER_RADIUS)});this.cells[i][o]=l,this.sourceBlock_.workspace.isFlyout||pxsim.pointerEvents.down.forEach(function(t){return l.addEventListener(t,function(t){var e=r.sourceBlock_.getSvgRoot();r.currentDragState_=!r.cellState[i][o],Blockly.hideChaff(),r.sourceBlock_.select(),r.toggleRect(i,o),pxsim.pointerEvents.down.forEach(function(t){return e.addEventListener(t,r.dontHandleMouseEvent_)}),e.addEventListener(pxsim.pointerEvents.move,r.dontHandleMouseEvent_),document.addEventListener(pxsim.pointerEvents.up,r.clearLedDragHandler),document.addEventListener(pxsim.pointerEvents.leave,r.clearLedDragHandler),r.elt.addEventListener(pxsim.pointerEvents.move,r.handleRootMouseMoveListener),t.stopPropagation(),t.preventDefault()},!1)})},a.prototype.getColor=function(t,e){return this.cellState[t][e]?this.onColor:this.offColor||a.DEFAULT_OFF_COLOR},a.prototype.getOpacity=function(t,e){return this.cellState[t][e]?"1.0":"0.2"},a.prototype.updateCell=function(t,e){var i=this.cells[t][e];i.setAttribute("fill",this.getColor(t,e)),i.setAttribute("fill-opacity",this.getOpacity(t,e)),i.setAttribute("class","blocklyLed"+(this.cellState[t][e]?"On":"Off"))},a.prototype.setValue=function(t,e){if(void 0===e&&(e=!0),r.prototype.setValue.call(this,String(t)),this.elt){e&&this.restoreStateFromString();for(var i=0;i<this.matrixWidth;i++)for(var o=0;o<this.matrixHeight;o++)this.updateCell(i,o)}},a.prototype.render_=function(){this.visible_?(this.elt||this.initMatrix(),this.size_.height=this.scale*Number(this.matrixHeight)*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+2*a.CELL_VERTICAL_MARGIN+a.BOTTOM_MARGIN+this.getXAxisHeight(),this.size_.width=this.scale*Number(this.matrixWidth)*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+this.getYAxisWidth()):this.size_.width=0},a.prototype.getValue=function(){var t=function(t){var e=(t=(t||"").trim()).charAt(0);if(e===t.charAt(t.length-1)&&-1!==i.indexOf(e))return t.substr(1,t.length-2).trim();return t}(this.value_);return"`\n"+a.TAB+t+"\n"+a.TAB+"`"},a.prototype.restoreStateFromString=function(){var t,e,i=this.value_;if(i)for(var o=i.split("\n").filter(function(t){return rowRegex.test(t)}),r=0;r<o.length&&r<this.matrixHeight;r++)for(var n=0,l=o[r],a=0;a<l.length&&n<this.matrixWidth;a++)"."===(e=l[a])||"_"===e||"0"===e?(this.cellState[n][r]=!1,n++):("#"===(t=l[a])||"*"===t||"1"===t)&&(this.cellState[n][r]=!0,n++)},a.prototype.updateValue=function(){for(var t="",e=0;e<this.matrixHeight;e++){for(var i=0;i<this.matrixWidth;i++)t+=(this.cellState[i][e]?"#":".")+" ";t+="\n"+a.TAB}this.setValue(t,!1)},a.prototype.getYAxisWidth=function(){return this.yAxisLabel===LabelMode.None?0:a.Y_AXIS_WIDTH},a.prototype.getXAxisHeight=function(){return this.xAxisLabel===LabelMode.None?0:a.X_AXIS_HEIGHT},a.CELL_WIDTH=25,a.CELL_HORIZONTAL_MARGIN=7,a.CELL_VERTICAL_MARGIN=5,a.CELL_CORNER_RADIUS=5,a.BOTTOM_MARGIN=9,a.Y_AXIS_WIDTH=9,a.X_AXIS_HEIGHT=10,a.TAB="        ",a.DEFAULT_OFF_COLOR="#000000",a}(Blockly.Field);t.FieldMatrix=e;var i=["'",'"',"`"]}(pxtblockly||(pxtblockly={})),function(n){var l=pxt.svgUtil;n.HEADER_HEIGHT=50,n.TOTAL_WIDTH=300;var t=function(r){function a(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.soundingKeys=0,o.numRow=8,o.numCol=8,o.tempo=120,o.isPlaying=!1,o.timeouts=[],o.params=e,o.createMelodyIfDoesntExist(),o}return __extends(a,r),a.prototype.init=function(){r.prototype.init.call(this),this.onInit()},a.prototype.showEditor_=function(){var t=this;Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.setColour(this.getDropdownBackgroundColour(),this.getDropdownBorderColour());var e=Blockly.DropDownDiv.getContentDiv();pxt.BrowserUtils.addClass(e,"melody-content-div"),pxt.BrowserUtils.addClass(e.parentElement,"melody-editor-dropdown"),this.gallery=new pxtmelody.MelodyGallery,this.renderEditor(e),this.prevString=this.getValue(),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!1,!0)),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,function(){t.onEditorClose(),pxt.BrowserUtils.removeClass(e,"melody-content-div"),pxt.BrowserUtils.removeClass(e.parentElement,"melody-editor-dropdown"),Blockly.Events.fire(new Blockly.Events.Ui(t.sourceBlock_,"melody-editor",!0,!1))})},a.prototype.getValue=function(){return this.stringRep=this.getTypeScriptValue(),this.stringRep},a.prototype.doValueUpdate_=function(t){null==t||""==t||'""'==t||this.stringRep&&this.stringRep===t||(this.stringRep=t,this.parseTypeScriptValue(t),r.prototype.doValueUpdate_.call(this,this.getValue()))},a.prototype.getText_=function(){return this.invalidString?pxt.Util.lf("Invalid Input"):this.getValue()},a.prototype.onInit=function(){this.render_(),this.createMelodyIfDoesntExist(),this.invalidString||(this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null)),this.visible_||(this.fieldGroup_.style.display="none"),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.updateFieldLabel())},a.prototype.render_=function(){r.prototype.render_.call(this),this.invalidString||(this.size_.width=a.MUSIC_ICON_WIDTH+(a.COLOR_BLOCK_WIDTH+a.COLOR_BLOCK_SPACING)*this.numCol),this.sourceBlock_.setColour("#ffffff")},a.prototype.renderEditor=function(t){var e=this,i=this.getDropdownBackgroundColour(),o=this.getDropdownBorderColour();this.topDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.topDiv,"melody-top-bar-div"),this.root=new l.SVG(this.topDiv).id("melody-editor-header-controls"),this.toggle=new s(this.root,{leftText:lf("Editor"),rightText:lf("Gallery"),baseColor:i}),this.toggle.onStateChange(function(t){t?e.hideGallery():e.showGallery()}),this.toggle.layout(),this.toggle.translate((n.TOTAL_WIDTH-this.toggle.width())/2,0),t.appendChild(this.topDiv),t.appendChild(this.gallery.getElement()),this.editorDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.editorDiv,"melody-editor-div"),this.editorDiv.style.setProperty("background-color",o),this.gridDiv=this.createGridDisplay(),this.editorDiv.appendChild(this.gridDiv),this.bottomDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.bottomDiv,"melody-bottom-bar-div"),this.doneButton=document.createElement("button"),pxt.BrowserUtils.addClass(this.doneButton,"melody-confirm-button"),this.doneButton.innerText=lf("Done"),this.doneButton.addEventListener("click",function(){return e.onDone()}),this.doneButton.style.setProperty("background-color",i),this.playButton=document.createElement("button"),this.playButton.id="melody-play-button",this.playButton.addEventListener("click",function(){return e.togglePlay()}),this.playIcon=document.createElement("i"),this.playIcon.id="melody-play-icon",pxt.BrowserUtils.addClass(this.playIcon,"play icon"),this.playButton.appendChild(this.playIcon),this.tempoInput=document.createElement("input"),pxt.BrowserUtils.addClass(this.tempoInput,"ui input"),this.tempoInput.type="number",this.tempoInput.title=lf("tempo"),this.tempoInput.id="melody-tempo-input",this.tempoInput.addEventListener("input",function(){return e.setTempo(+e.tempoInput.value)}),this.syncTempoField(!0),this.bottomDiv.appendChild(this.tempoInput),this.bottomDiv.appendChild(this.playButton),this.bottomDiv.appendChild(this.doneButton),this.editorDiv.appendChild(this.bottomDiv),t.appendChild(this.editorDiv)},a.prototype.onEditorClose=function(){this.stopMelody(),this.gallery&&this.gallery.stopMelody(),this.clearDomReferences(),this.sourceBlock_&&Blockly.Events.isEnabled()&&this.getValue()!==this.prevString&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.prevString,this.getValue())),this.prevString=void 0},a.prototype.onDone=function(){Blockly.DropDownDiv.hideIfOwner(this),this.onEditorClose()},a.prototype.clearDomReferences=function(){this.topDiv=null,this.editorDiv=null,this.gridDiv=null,this.bottomDiv=null,this.doneButton=null,this.playButton=null,this.playIcon=null,this.tempoInput=null,this.elt=null,this.cells=null,this.toggle=null,this.root=null,this.gallery.clearDomReferences()},a.prototype.getTypeScriptValue=function(){return this.invalidString?this.invalidString:this.melody?'"'+this.melody.getStringRepresentation()+'"':""},a.prototype.parseTypeScriptValue=function(t){var e=this,i=t;try{t=(t=t.slice(1,-1)).trim(),this.createMelodyIfDoesntExist();var o=t.split(" ");o.forEach(function(t){if(!e.isValidNote(t))throw new Error(lf("Invalid note '{0}'. Notes can be C D E F G A B C5",t))}),this.melody.resetMelody();for(var r=0;r<o.length;r++)if("-"!=o[r]){var n=pxtmelody.noteToRow(o[r]);this.melody.updateMelody(n,r)}this.updateFieldLabel()}catch(t){pxt.log(t),this.invalidString=i}},a.prototype.isValidNote=function(t){switch(t){case"C":case"D":case"E":case"F":case"G":case"A":case"B":case"C5":case"-":return!0}return!1},a.prototype.getPreviewWidth=function(){return this.updateSize_(),this.size_.width},a.prototype.getPreviewHeight=function(){return this.constants_.FIELD_BORDER_RECT_HEIGHT},a.prototype.getDropdownBackgroundColour=function(){return this.sourceBlock_.parentBlock_.getColour()},a.prototype.getDropdownBorderColour=function(){return this.sourceBlock_.parentBlock_.getColourTertiary()},a.prototype.updateFieldLabel=function(){if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=c("").appendClass("melody-editor-field-icon").at(6,15);this.fieldGroup_.appendChild(t.el);for(var e=this.melody.getStringRepresentation().trim().split(" "),i=0;i<e.length;i++){var o=pxtmelody.getColorClass(pxtmelody.noteToRow(e[i])),r=(new l.Rect).at((a.COLOR_BLOCK_WIDTH+a.COLOR_BLOCK_SPACING)*i+a.COLOR_BLOCK_X,a.COLOR_BLOCK_Y).size(a.COLOR_BLOCK_WIDTH,a.COLOR_BLOCK_HEIGHT).stroke("#898989",1).corners(3,2);pxt.BrowserUtils.addClass(r.el,o),this.fieldGroup_.appendChild(r.el)}}},a.prototype.setTempo=function(t){(isNaN(t)||t<=0)&&this.tempoInput?this.tempoInput.value=this.tempo+"":this.tempo!=t&&(this.tempo=t,this.melody&&this.melody.setTempo(this.tempo),this.tempoInput&&(this.tempoInput.value=this.tempo+""),this.syncTempoField(!1))},a.prototype.syncTempoField=function(t){var e=this.sourceBlock_;if(e.parentBlock_)for(var i=0,o=e.parentBlock_.inputList;i<o.length;i++){var r=o[i];if("tempo"===r.name){var n=r.connection.targetBlock();n&&(t?n.getFieldValue("SLIDER")?(this.tempoInput.value=n.getFieldValue("SLIDER"),this.tempo=+this.tempoInput.value):this.tempoInput.value=this.tempo+"":("math_number_minmax"===n.type?n.setFieldValue(this.tempoInput.value,"SLIDER"):n.setFieldValue(this.tempoInput.value,"NUM"),this.tempoInput.focus()));break}}},a.prototype.getDuration=function(){return 6e4/this.tempo},a.prototype.createMelodyIfDoesntExist=function(){return!this.melody&&(this.melody=new pxtmelody.MelodyArray,!0)},a.prototype.onNoteSelect=function(t,e){this.invalidString=null,this.melody.updateMelody(t,e),this.melody.getValue(t,e)&&!this.isPlaying&&this.playNote(t,e),this.updateGrid(),this.updateFieldLabel()},a.prototype.updateGrid=function(){for(var t=0;t<this.numRow;t++)for(var e=pxtmelody.getColorClass(t),i=0;i<this.numCol;i++){var o=this.cells[t][i];this.melody.getValue(t,i)?(pxt.BrowserUtils.removeClass(o,"melody-default"),pxt.BrowserUtils.addClass(o,e)):(pxt.BrowserUtils.addClass(o,"melody-default"),pxt.BrowserUtils.removeClass(o,e))}},a.prototype.playNote=function(t,e){var i=this,o=++this.soundingKeys;this.isPlaying?(this.timeouts.push(setTimeout(function(){i.playToneCore(t)},e*this.getDuration())),this.timeouts.push(setTimeout(function(){pxt.AudioContextManager.stop()},(e+1)*this.getDuration()))):(this.playToneCore(t),this.timeouts.push(setTimeout(function(){i.soundingKeys==o&&pxt.AudioContextManager.stop()},this.getDuration())))},a.prototype.queueToneForColumn=function(e,t,i){var o=this,r=setTimeout(function(){++o.soundingKeys,pxt.AudioContextManager.stop();for(var t=0;t<o.numRow;t++)o.melody.getValue(t,e)&&o.playToneCore(t);o.highlightColumn(e,!0),o.timeouts=o.timeouts.filter(function(t){return t!==r})},t),n=setTimeout(function(){o.timeouts=o.timeouts.filter(function(t){return t!==n}),o.highlightColumn(e,!1)},t+i);this.timeouts.push(r),this.timeouts.push(n)},a.prototype.playToneCore=function(t){var e=0;switch(t){case 0:e=523;break;case 1:e=494;break;case 2:e=440;break;case 3:e=392;break;case 4:e=349;break;case 5:e=330;break;case 6:e=294;break;case 7:e=262}pxt.AudioContextManager.tone(e)},a.prototype.highlightColumn=function(e,i){this.cells.map(function(t){return t[e]}).forEach(function(t){i?pxt.BrowserUtils.addClass(t,"playing"):pxt.BrowserUtils.removeClass(t,"playing")})},a.prototype.createGridDisplay=function(){a.VIEWBOX_WIDTH=(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)*this.numCol+a.CELL_VERTICAL_MARGIN,pxt.BrowserUtils.isEdge()&&(a.VIEWBOX_WIDTH+=37),a.VIEWBOX_HEIGHT=(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)*this.numRow+a.CELL_HORIZONTAL_MARGIN,this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" class="melody-grid-div" viewBox="0 0 '+a.VIEWBOX_WIDTH+" "+a.VIEWBOX_HEIGHT+'"/>'),this.cells=[];for(var t=0;t<this.numRow;t++)this.cells.push([]);for(t=0;t<this.numRow;t++)for(var e=0;e<this.numCol;e++)this.createCell(t,e);return this.elt},a.prototype.createCell=function(e,i){var o=this,t=e*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_HORIZONTAL_MARGIN,r=i*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_VERTICAL_MARGIN,n=pxsim.svg.child(this.elt,"g",{transform:"translate("+r+" "+t+")"}),l=pxsim.svg.child(n,"rect",{cursor:"pointer",width:a.CELL_WIDTH,height:a.CELL_WIDTH,stroke:"white","data-x":e,"data-y":i,rx:a.CELL_CORNER_RADIUS});this.melody.getValue(e,i)?pxt.BrowserUtils.addClass(l,pxtmelody.getColorClass(e)):pxt.BrowserUtils.addClass(l,"melody-default"),this.sourceBlock_.workspace.isFlyout||(pxsim.pointerEvents.down.forEach(function(t){return l.addEventListener(t,function(t){o.onNoteSelect(e,i),t.stopPropagation(),t.preventDefault()},!1)}),this.cells[e][i]=l)},a.prototype.togglePlay=function(){this.isPlaying?this.stopMelody():(this.isPlaying=!0,this.playMelody()),this.updatePlayButton()},a.prototype.updatePlayButton=function(){this.isPlaying?(pxt.BrowserUtils.removeClass(this.playIcon,"play icon"),pxt.BrowserUtils.addClass(this.playIcon,"stop icon")):(pxt.BrowserUtils.removeClass(this.playIcon,"stop icon"),pxt.BrowserUtils.addClass(this.playIcon,"play icon"))},a.prototype.playMelody=function(){var t=this;if(this.isPlaying){for(var e=0;e<this.numCol;e++)this.queueToneForColumn(e,e*this.getDuration(),this.getDuration());this.timeouts.push(setTimeout(function(){return t.playMelody()},this.numCol*this.getDuration()))}else this.stopMelody()},a.prototype.stopMelody=function(){if(this.isPlaying){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop(),this.isPlaying=!1,this.cells.forEach(function(t){return t.forEach(function(t){return pxt.BrowserUtils.removeClass(t,"playing")})})}},a.prototype.showGallery=function(){var e=this;this.stopMelody(),this.updatePlayButton(),this.gallery.show(function(t){t&&(e.melody.parseNotes(t),e.gallery.hide(),e.toggle.toggle(),e.updateFieldLabel(),e.updateGrid())})},a.prototype.hideGallery=function(){this.gallery.hide()},a.CELL_WIDTH=25,a.CELL_HORIZONTAL_MARGIN=7,a.CELL_VERTICAL_MARGIN=5,a.CELL_CORNER_RADIUS=5,a.COLOR_BLOCK_WIDTH=10,a.COLOR_BLOCK_HEIGHT=20,a.COLOR_BLOCK_X=20,a.COLOR_BLOCK_Y=5,a.COLOR_BLOCK_SPACING=2,a.MUSIC_ICON_WIDTH=20,a}(Blockly.Field);n.FieldCustomMelody=t;var s=function(){function t(t,e){this.props=function(t){t.baseColor||(t.baseColor="#e95153");t.backgroundColor||(t.backgroundColor="rgba(52,73,94,.2)");t.borderColor||(t.borderColor="rgba(52,73,94,.4)");t.selectedTextColor||(t.selectedTextColor=t.baseColor);t.unselectedTextColor||(t.unselectedTextColor="hsla(0,0%,100%,.9)");t.switchColor||(t.switchColor="#ffffff");return t}(e),this.root=t.group(),this.buildDom(),this.isLeft=!0}return t.prototype.buildDom=function(){var t=this;this.root.style().content("\n            .toggle-left {\n                transform: translateX(0px);\n                animation: mvleft 0.2s 0s ease;\n            }\n\n            .toggle-right {\n                transform: translateX(100px);\n                animation: mvright 0.2s 0s ease;\n            }\n\n            @keyframes mvright {\n                0% {\n                    transform: translateX(0px);\n                }\n                100% {\n                    transform: translateX(100px);\n                }\n            }\n\n            @keyframes mvleft {\n                0% {\n                    transform: translateX(100px);\n                }\n                100% {\n                    transform: translateX(0px);\n                }\n            }\n            "),this.root.def().create("clipPath","sprite-editor-toggle-border").clipPathUnits(!0).draw("rect").at(0,0).corners(.02,.1).size(1,1),this.root.draw("rect").size(200,40).fill(this.props.baseColor).stroke(this.props.borderColor,4).corners(4,4).clipPath("url(#sprite-editor-toggle-border)"),this.root.draw("rect").at(2,2).size(196,36).fill(this.props.backgroundColor).corners(4,4),this.switch=this.root.draw("rect").at(2,2).size(98,36).fill(this.props.switchColor).corners(4,4),this.leftElement=this.root.group(),this.leftText=c(this.props.leftText).appendClass("sprite-editor-text").fill(this.props.selectedTextColor),this.leftElement.appendChild(this.leftText),this.rightElement=this.root.group(),this.rightText=c(this.props.rightText).appendClass("sprite-editor-text").fill(this.props.unselectedTextColor),this.rightElement.appendChild(this.rightText),this.root.onClick(function(){return t.toggle()})},t.prototype.toggle=function(t){void 0===t&&(t=!1),this.isLeft?(this.switch.removeClass("toggle-left"),this.switch.appendClass("toggle-right"),this.leftText.fill(this.props.unselectedTextColor),this.rightText.fill(this.props.selectedTextColor)):(this.switch.removeClass("toggle-right"),this.switch.appendClass("toggle-left"),this.leftText.fill(this.props.selectedTextColor),this.rightText.fill(this.props.unselectedTextColor)),this.isLeft=!this.isLeft,!t&&this.changeHandler&&this.changeHandler(this.isLeft)},t.prototype.onStateChange=function(t){this.changeHandler=t},t.prototype.layout=function(){this.leftText.moveTo(51,20),this.rightText.moveTo(149,20)},t.prototype.translate=function(t,e){this.root.translate(t,e)},t.prototype.height=function(){return 40},t.prototype.width=function(){return 200},t}();function c(t){return new l.Text(t).anchor("middle").setAttribute("dominant-baseline","middle").setAttribute("dy",pxt.BrowserUtils.isIE()||pxt.BrowserUtils.isEdge()?"0.3em":"0.1em")}}(pxtblockly||(pxtblockly={})),function(s){var n,t;(t=n||(n={}))[t.C=262]="C",t[t.CSharp=277]="CSharp",t[t.D=294]="D",t[t.Eb=311]="Eb",t[t.E=330]="E",t[t.F=349]="F",t[t.FSharp=370]="FSharp",t[t.G=392]="G",t[t.GSharp=415]="GSharp",t[t.A=440]="A",t[t.Bb=466]="Bb",t[t.B=494]="B",t[t.C3=131]="C3",t[t.CSharp3=139]="CSharp3",t[t.D3=147]="D3",t[t.Eb3=156]="Eb3",t[t.E3=165]="E3",t[t.F3=175]="F3",t[t.FSharp3=185]="FSharp3",t[t.G3=196]="G3",t[t.GSharp3=208]="GSharp3",t[t.A3=220]="A3",t[t.Bb3=233]="Bb3",t[t.B3=247]="B3",t[t.C4=262]="C4",t[t.CSharp4=277]="CSharp4",t[t.D4=294]="D4",t[t.Eb4=311]="Eb4",t[t.E4=330]="E4",t[t.F4=349]="F4",t[t.FSharp4=370]="FSharp4",t[t.G4=392]="G4",t[t.GSharp4=415]="GSharp4",t[t.A4=440]="A4",t[t.Bb4=466]="Bb4",t[t.B4=494]="B4",t[t.C5=523]="C5",t[t.CSharp5=555]="CSharp5",t[t.D5=587]="D5",t[t.Eb5=622]="Eb5",t[t.E5=659]="E5",t[t.F5=698]="F5",t[t.FSharp5=740]="FSharp5",t[t.G5=784]="G5",t[t.GSharp5=831]="GSharp5",t[t.A5=880]="A5",t[t.Bb5=932]="Bb5",t[t.B5=988]="B5",t[t.C6=1047]="C6",t[t.CSharp6=1109]="CSharp6",t[t.D6=1175]="D6",t[t.Eb6=1245]="Eb6",t[t.E6=1319]="E6",t[t.F6=1397]="F6",t[t.FSharp6=1480]="FSharp6",t[t.G6=1568]="G6",t[t.GSharp6=1568]="GSharp6",t[t.A6=1760]="A6",t[t.Bb6=1865]="Bb6",t[t.B6=1976]="B6",t[t.C7=2093]="C7";var e=function(a){function m(t,e,i){var o=a.call(this,null,0,null,null,i)||this;o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.isTextValid_=!0,o.nKeys_=36,o.minNote_=28,o.maxNote_=63,o.eps=2,o.setSpellcheck(!1),o.prepareNotes(),o.isExpanded=!1,o.currentPage=0,o.totalPlayCount=0,e.editorColour&&(o.primaryColour=s.parseColour(e.editorColour),o.borderColour=Blockly.utils.colour.darken(o.primaryColour,.2));var r=parseInt(e.eps);!Number.isNaN(r)&&0<=r&&(o.eps=r);var n=parseInt(e.minNote)||o.minNote_,l=parseInt(e.maxNote)||o.maxNote_;return 28<=n&&l<=75&&n<l&&(o.minNote_=n,o.maxNote_=l,o.nKeys_=o.maxNote_-o.minNote_+1),o.setValue(t),o}return __extends(m,a),m.prototype.doClassValidation_=function(t){var e=/^Note\.(.+)$/.exec(t),i=e&&1<e.length?e[1]:null;if(null===(t=n[i]?n[i]:String(parseFloat(t||"0"))))return null;var o=parseFloat(t||"0");if(isNaN(o)||o<0)return null;var r=Math.floor(o)!=o;return""+o.toFixed(r?2:0)},m.prototype.getValue=function(){return this.value_+""},m.prototype.doValueUpdate_=function(t){isNaN(Number(t))||Number(t)<0||(this.sourceBlock_&&Blockly.Events.isEnabled()&&this.value_!=t&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t,this.refreshText())},m.prototype.getText=function(){if(this.isExpanded)return""+this.value_;for(var t=+this.value_,e=0;e<this.nKeys_;e++)if(Math.abs(this.getKeyFreq(e)-t)<this.eps)return this.getKeyName(e);var i=t.toString();return isNaN(t)||(i+=" Hz"),i},m.prototype.refreshText=function(){this.forceRerender()},m.prototype.onHtmlInputChange_=function(t){a.prototype.onHtmlInputChange_.call(this,t),Blockly.DropDownDiv.hideWithoutAnimation(),this.htmlInput_.focus()},m.prototype.onFinishEditing_=function(t){this.refreshText()},m.prototype.onHide=function(){this.isExpanded=!1,this.refreshText()},m.prototype.showEditor_=function(t){var e=this;this.isExpanded=!0,this.updateColor(),Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var i=pxt.BrowserUtils.isMobile()||pxt.BrowserUtils.isIOS();m.superClass_.showEditor_.call(this,t,i,i),this.refreshText(),Blockly.Events.setGroup(!0),this.piano=[],this.currentSelectedKey=void 0;var o=this.nKeys_-this.nKeys_/m.notesPerOctave*m.blackKeysPerOctave,r=m.notesPerOctave-m.blackKeysPerOctave,n=m.keyWidth*o,l=m.keyHeight+m.labelHeight,a=window.innerWidth<n;a&&(n=r*m.keyWidth,l=m.keyHeight+m.labelHeight+m.prevNextHeight);var s=f("blocklyPianoDiv","width: "+n+"px;\n                height: "+l+"px;");Blockly.DropDownDiv.getContentDiv().appendChild(s),this.noteLabel=f("blocklyNoteLabel","top: "+m.keyHeight+"px;\n                width: "+n+"px;\n                background-color: "+this.primaryColour+";\n                border-color: "+this.primaryColour+";"),s.appendChild(this.noteLabel),this.noteLabel.textContent="-";for(var c=0,u=0;u<this.nKeys_;u++){var p=Math.floor(u/m.notesPerOctave),d=this.getPosition(u);a&&m.notesPerOctave<=u&&(d-=r*p*m.keyWidth);var h=this.getKeyDiv(u,d);this.piano.push(h),s.appendChild(h),Math.abs(this.getKeyFreq(u)-Number(this.getValue()))<this.eps&&(pxt.BrowserUtils.addClass(h,"selected"),this.currentSelectedKey=h,c=p)}a&&(this.setPage(c),s.appendChild(this.getNextPrevDiv(!0,n)),s.appendChild(this.getNextPrevDiv(!1,n))),Blockly.DropDownDiv.setColour(this.primaryColour,this.borderColour),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,function(){return e.onHide()})},m.prototype.playKey=function(t,e){var i=this,o=++this.totalPlayCount;this.currentSelectedKey!==t&&(this.currentSelectedKey&&pxt.BrowserUtils.removeClass(this.currentSelectedKey,"selected"),pxt.BrowserUtils.addClass(t,"selected"),this.setValue(e)),this.currentSelectedKey=t,this.htmlInput_.value=this.getText(),pxt.AudioContextManager.tone(e),setTimeout(function(){i.totalPlayCount==o&&pxt.AudioContextManager.stop()},300)},m.prototype.dispose=function(){Blockly.DropDownDiv.hideIfOwner(this),a.prototype.dispose.call(this)},m.prototype.updateColor=function(){if(this.sourceBlock_.parentBlock_&&(this.sourceBlock_.isShadow()||1===(e=this.sourceBlock_).inputList.length&&1===e.inputList[0].fieldRow.length)){var t=this.sourceBlock_.parentBlock_;this.primaryColour=t.getColour(),this.borderColour=t.getColourTertiary()}else{t=this.sourceBlock_;this.primaryColour=t.getColourTertiary(),this.borderColour=t.getColourTertiary()}var e},m.prototype.setPage=function(t){var e=this.nKeys_/m.notesPerOctave;t=Math.max(Math.min(t,e-1),0),this.noteLabel.textContent="Octave #"+(t+1);for(var i=t*m.notesPerOctave,o=0;o<this.piano.length;++o){var r=i<=o&&o<i+m.notesPerOctave;this.piano[o].style.display=r?"block":"none"}this.currentPage=t},m.prototype.getNextPrevDiv=function(e,t){var i=this,o=f("blocklyNotePrevNext","top: "+(m.keyHeight+m.labelHeight)+"px;\n                left: "+(e?0:t/2)+"px;\n                width: "+Math.ceil(t/2)+"px;\n                "+(e?"border-left-color":"border-right-color")+": "+this.primaryColour+";\n                background-color: "+this.primaryColour+";\n                border-bottom-color: "+this.primaryColour+";");return pxt.BrowserUtils.pointerEvents.down.forEach(function(t){Blockly.bindEventWithChecks_(o,t,i,function(){return i.setPage(e?i.currentPage-1:i.currentPage+1)},!0)}),o.textContent=e?"<":">",o},m.prototype.getKeyDiv=function(e,t){var i=this,o=f("blocklyNote "+(this.isWhite(e)?"":"black"),"width: "+this.getKeyWidth(e)+"px;\n                height: "+this.getKeyHeight(e)+"px;\n                left: "+t+"px;\n                border-color: "+this.primaryColour+";");return pxt.BrowserUtils.pointerEvents.down.forEach(function(t){Blockly.bindEventWithChecks_(o,t,i,function(){return i.playKey(o,i.getKeyFreq(e))},!0)}),Blockly.bindEventWithChecks_(o,"mouseover",this,function(){return i.noteLabel.textContent=i.getKeyName(e)},!0),o},m.prototype.isWhite=function(t){switch(t%12){case 1:case 3:case 6:case 8:case 10:return!1;default:return!0}},m.prototype.getKeyWidth=function(t){return this.isWhite(t)?m.keyWidth:m.keyWidth/2},m.prototype.getKeyHeight=function(t){return this.isWhite(t)?m.keyHeight:m.keyHeight/2},m.prototype.getKeyFreq=function(t){return this.getKeyNoteData(t).freq},m.prototype.getKeyName=function(t){var e=this.getKeyNoteData(t),i=e.prefixedName;return this.nKeys_<=m.notesPerOctave?i=e.name:28<=this.minNote_&&this.maxNote_<=63&&(i=e.altPrefixedName||i),i},m.prototype.getKeyNoteData=function(t){return m.Notes[t+this.minNote_]},m.prototype.getPosition=function(t){var e=(t-Math.floor((t+1)/m.notesPerOctave*m.blackKeysPerOctave))*m.keyWidth;return this.isWhite(t)?e:e-m.keyWidth/4},m.prototype.prepareNotes=function(){m.Notes||(m.Notes={28:{name:lf("{id:note}C"),prefixedName:lf("Low C"),freq:131},29:{name:lf("C#"),prefixedName:lf("Low C#"),freq:139},30:{name:lf("{id:note}D"),prefixedName:lf("Low D"),freq:147},31:{name:lf("D#"),prefixedName:lf("Low D#"),freq:156},32:{name:lf("{id:note}E"),prefixedName:lf("Low E"),freq:165},33:{name:lf("{id:note}F"),prefixedName:lf("Low F"),freq:175},34:{name:lf("F#"),prefixedName:lf("Low F#"),freq:185},35:{name:lf("{id:note}G"),prefixedName:lf("Low G"),freq:196},36:{name:lf("G#"),prefixedName:lf("Low G#"),freq:208},37:{name:lf("{id:note}A"),prefixedName:lf("Low A"),freq:220},38:{name:lf("A#"),prefixedName:lf("Low A#"),freq:233},39:{name:lf("{id:note}B"),prefixedName:lf("Low B"),freq:247},40:{name:lf("{id:note}C"),prefixedName:lf("Middle C"),freq:262},41:{name:lf("C#"),prefixedName:lf("Middle C#"),freq:277},42:{name:lf("{id:note}D"),prefixedName:lf("Middle D"),freq:294},43:{name:lf("D#"),prefixedName:lf("Middle D#"),freq:311},44:{name:lf("{id:note}E"),prefixedName:lf("Middle E"),freq:330},45:{name:lf("{id:note}F"),prefixedName:lf("Middle F"),freq:349},46:{name:lf("F#"),prefixedName:lf("Middle F#"),freq:370},47:{name:lf("{id:note}G"),prefixedName:lf("Middle G"),freq:392},48:{name:lf("G#"),prefixedName:lf("Middle G#"),freq:415},49:{name:lf("{id:note}A"),prefixedName:lf("Middle A"),freq:440},50:{name:lf("A#"),prefixedName:lf("Middle A#"),freq:466},51:{name:lf("{id:note}B"),prefixedName:lf("Middle B"),freq:494},52:{name:lf("{id:note}C"),prefixedName:lf("Tenor C"),altPrefixedName:lf("High C"),freq:523},53:{name:lf("C#"),prefixedName:lf("Tenor C#"),altPrefixedName:lf("High C#"),freq:554},54:{name:lf("{id:note}D"),prefixedName:lf("Tenor D"),altPrefixedName:lf("High D"),freq:587},55:{name:lf("D#"),prefixedName:lf("Tenor D#"),altPrefixedName:lf("High D#"),freq:622},56:{name:lf("{id:note}E"),prefixedName:lf("Tenor E"),altPrefixedName:lf("High E"),freq:659},57:{name:lf("{id:note}F"),prefixedName:lf("Tenor F"),altPrefixedName:lf("High F"),freq:698},58:{name:lf("F#"),prefixedName:lf("Tenor F#"),altPrefixedName:lf("High F#"),freq:740},59:{name:lf("{id:note}G"),prefixedName:lf("Tenor G"),altPrefixedName:lf("High G"),freq:784},60:{name:lf("G#"),prefixedName:lf("Tenor G#"),altPrefixedName:lf("High G#"),freq:831},61:{name:lf("{id:note}A"),prefixedName:lf("Tenor A"),altPrefixedName:lf("High A"),freq:880},62:{name:lf("A#"),prefixedName:lf("Tenor A#"),altPrefixedName:lf("High A#"),freq:932},63:{name:lf("{id:note}B"),prefixedName:lf("Tenor B"),altPrefixedName:lf("High B"),freq:988},64:{name:lf("{id:note}C"),prefixedName:lf("High C"),freq:1046},65:{name:lf("C#"),prefixedName:lf("High C#"),freq:1109},66:{name:lf("{id:note}D"),prefixedName:lf("High D"),freq:1175},67:{name:lf("D#"),prefixedName:lf("High D#"),freq:1245},68:{name:lf("{id:note}E"),prefixedName:lf("High E"),freq:1319},69:{name:lf("{id:note}F"),prefixedName:lf("High F"),freq:1397},70:{name:lf("F#"),prefixedName:lf("High F#"),freq:1478},71:{name:lf("{id:note}G"),prefixedName:lf("High G"),freq:1568},72:{name:lf("G#"),prefixedName:lf("High G#"),freq:1661},73:{name:lf("{id:note}A"),prefixedName:lf("High A"),freq:1760},74:{name:lf("A#"),prefixedName:lf("High A#"),freq:1865},75:{name:lf("{id:note}B"),prefixedName:lf("High B"),freq:1976}})},m.keyWidth=22,m.keyHeight=90,m.labelHeight=24,m.prevNextHeight=20,m.notesPerOctave=12,m.blackKeysPerOctave=5,m}(Blockly.FieldNumber);function f(t,e){var i=document.createElement("div");return pxt.BrowserUtils.addClass(i,t),i.setAttribute("style",e.replace(/\s+/g," ")),i}s.FieldNote=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e.data,e.min,e.max,e.precision,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getOptions=function(){var t;return this.menuGenerator_&&(t=JSON.parse(this.menuGenerator_).map(function(t){return"object"==typeof t?t:[String(t),String(t)]})),t},t}(Blockly.FieldNumberDropdown);t.FieldNumberDropdown=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,"0","100","1","100","Value",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.screenHeight||(o.params.screenHeight=120),o.params.screenWidth||(o.params.screenWidth=160),o.params.xInputName||(o.params.xInputName="x"),o.params.yInputName||(o.params.yInputName="y"),o.params.min&&(o.min_=parseInt(o.params.min)),o.params.max&&(o.max_=parseInt(o.params.max)),o}return __extends(t,r),t.prototype.showEditor_=function(){this.getFieldByName(this.params.xInputName)===this&&(this.max_=this.params.screenWidth,this.labelText_=this.params.xInputName),this.getFieldByName(this.params.yInputName)===this&&(this.max_=this.params.screenHeight,this.labelText_=this.params.yInputName),r.prototype.showEditor_.call(this),this.renderScreenPicker()},t.prototype.doValueUpdate_=function(t){r.prototype.doValueUpdate_.call(this,t),this.resetCrosshair&&this.resetCrosshair()},t.prototype.renderScreenPicker=function(){var l=this,t=Blockly.DropDownDiv.getContentDiv();this.selectorDiv_=document.createElement("div"),this.selectorDiv_.className="blocklyCanvasOverlayOuter",t.appendChild(this.selectorDiv_);var a=document.createElement("div");a.className="blocklyCanvasOverlayDiv",this.selectorDiv_.appendChild(a);var o=document.createElement("div");o.className="cross-x",a.appendChild(o);var r=document.createElement("div");r.className="cross-y",a.appendChild(r);var n=document.createElement("div");n.className="label",a.appendChild(n);var s=1.5*this.params.screenWidth,c=1.5*this.params.screenHeight;a.style.height=c+"px",a.style.width=s+"px";var e=t.getElementsByClassName("goog-slider-horizontal")[0];if(e){e.style.width=s+"px";var i=parseFloat(this.getValue());!isNaN(i)&&i>this.getMin()&&(this.setValue(i-1+""),this.setValue(i+""))}var u=function(t,e){t=Math.round(Math.max(0,Math.min(s,t))),e=Math.round(Math.max(0,Math.min(c,e))),o.style.top=e+"px",r.style.left=t+"px",t=Math.round(Math.max(0,Math.min(l.params.screenWidth,t/s*l.params.screenWidth))),e=Math.round(Math.max(0,Math.min(l.params.screenHeight,e/c*l.params.screenHeight))),n.textContent=l.params.xInputName+"="+t+" "+l.params.yInputName+"="+e;var i=n.getBoundingClientRect();t>l.params.screenWidth/2?n.style.left=t*(s/l.params.screenWidth)-i.width-8+"px":n.style.left=t*(s/l.params.screenWidth)+4+"px",e>l.params.screenHeight/2?n.style.top=e*(c/l.params.screenHeight)-i.height-6+"px":n.style.top=e*(c/l.params.screenHeight)+"px"};this.resetCrosshair=function(){var t=l.getXY(),e=t.currentX,i=t.currentY;u(e/l.params.screenWidth*s,i/l.params.screenHeight*c)},this.resetCrosshair(),Blockly.bindEvent_(this.selectorDiv_,"mousemove",this,function(t){var e=a.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top;u(i,o)}),Blockly.bindEvent_(this.selectorDiv_,"mouseleave",this,this.resetCrosshair),Blockly.bindEvent_(this.selectorDiv_,"click",this,function(t){var e=a.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top,r=Math.round(i/s*l.params.screenWidth),n=Math.round(o/c*l.params.screenHeight);l.close(),l.setXY(r,n)})},t.prototype.resizeHandler=function(){this.close()},t.prototype.setXY=function(t,e){var i=this.getFieldByName(this.params.xInputName);i&&"number"==typeof i.getValue()&&i.setValue(String(t));var o=this.getFieldByName(this.params.yInputName);o&&"number"==typeof o.getValue()&&o.setValue(String(e))},t.prototype.getFieldByName=function(t){var e=this.sourceBlock_.parentBlock_;if(e)for(var i=0;i<e.inputList.length;i++){var o=e.inputList[i];if(o.name===t)return this.getTargetField(o)}},t.prototype.getXY=function(){var t,e,i=this.getFieldByName(this.params.xInputName);i&&(t=i.getValue());var o=this.getFieldByName(this.params.yInputName);return o&&(e=o.getValue()),{currentX:parseInt(t),currentY:parseInt(e)}},t.prototype.getTargetField=function(t){var e=t.connection.targetBlock();if(!e)return null;var i=e.inputList[0];return i?i.fieldRow[0]:null},t.prototype.widgetDispose_=function(){Blockly.FieldNumber.superClass_.widgetDispose_.call(this),this.close(!0)},t.prototype.close=function(t){t||(Blockly.WidgetDiv.hideIfOwner(this),Blockly.DropDownDiv.hideIfOwner(this)),window.removeEventListener("resize",this.resizeHandler),this.resetCrosshair=void 0,this.selectorDiv_&&(goog.dom.removeNode(this.selectorDiv_),this.selectorDiv_=void 0)},t}(Blockly.FieldSlider);t.FieldPosition=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t,e){var i=o.call(this,[["Temp","Temp"]],e)||this;return i.setValue(t||""),i}return __extends(t,o),t.prototype.getOptions=function(){return this.dropdownCreate()},t.prototype.init=function(){this.fieldGroup_||o.prototype.init.call(this)},t.prototype.setSourceBlock=function(t){goog.asserts.assert(!t.isShadow(),"Procedure fields are not allowed to exist on shadow blocks."),o.prototype.setSourceBlock.call(this,t)},t.prototype.dropdownCreate=function(){var t=[];if(this.sourceBlock_&&this.sourceBlock_.workspace)for(var e=this.sourceBlock_.workspace.getAllBlocks(),i=0;i<e.length;i++)if(e[i].getProcedureDef){var o=e[i].getProcedureDef();t.push(o[0])}var r=this.getValue();r&&-1==t.indexOf(r)&&t.push(r),t.sort(goog.string.caseInsensitiveCompare),t.length||t.push("Temp");var n=[];for(i=0;i<t.length;i++)n[i]=[t[i],t[i]];return n},t.prototype.onItemSelected=function(t,e){var i=e.getValue();this.sourceBlock_&&(i=this.callValidator(i)),null!==i&&this.setValue(i)},t}(Blockly.FieldDropdown);t.FieldProcedure=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"0","180","1","15",lf("Angle"),i)||this;return o.isFieldCustom_=!0,o.params=e,o}return __extends(t,r),t.prototype.createLabelDom_=function(t){var e=document.createElement("div");this.circleSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.circleSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.circleSVG);pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.circleSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"});var i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]},t.prototype.setReadout_=function(t,e){this.updateAngle(parseFloat(e)),this.reporter.textContent=e+"°"},t.prototype.updateAngle=function(t){var e=(180-(t=Math.max(0,Math.min(180,t))))/180*Math.PI*90;this.circleBar.setAttribute("stroke-dashoffset",""+e)},t}(Blockly.FieldSlider);t.FieldProtractor=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"-100","100","1","10","Speed",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.min&&(o.min_=parseFloat(o.params.min)),o.params.max&&(o.max_=parseFloat(o.params.max)),o.params.label&&(o.labelText_=o.params.label),o.params.format||(o.params.format="{0}%"),o}return __extends(t,r),t.prototype.createLabelDom_=function(t){var e=document.createElement("div");this.speedSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.speedSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.speedSVG);pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.speedSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: "+Math.max(14,50-5*(this.params.format.length-4))+"px",class:"sim-text inverted number"});var i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]},t.prototype.setReadout_=function(t,e){this.updateSpeed(parseFloat(e)),this.reporter.textContent=ts.pxtc.U.rlf(this.params.format,e)},t.prototype.updateSpeed=function(t){var e=this.sign(t);t=Math.abs(t)/100*50+50,-1==e&&(t=50-t);var i=(100-t)/100*(180*Math.PI);this.circleBar.setAttribute("stroke-dashoffset",""+i)},t.prototype.sign=function(t){return t?t<0?-1:1:0},t}(Blockly.FieldSlider);t.FieldSpeed=e}(pxtblockly||(pxtblockly={})),function(o){var n=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.lightMode=e.lightMode,o.params=function(t){var e={initColor:1,initWidth:16,initHeight:16,disableResize:!1};if(!t)return e;if(t.sizes){for(var i=t.sizes.split(";"),o=[],r=0;r<i.length;r++){var n=i[r].split(",");if(2===n.length){var l=parseInt(n[0]),a=parseInt(n[1]);if(!isNaN(l)&&!isNaN(a)){var s=pxt.appTarget.runtime&&pxt.appTarget.runtime.screenSize;l<0&&s&&(l=s.width),a<0&&s&&(a=s.height),o.push([l,a])}}}0<o.length&&(e.initWidth=o[0][0],e.initHeight=o[0][1])}t.filter&&(e.filter=t.filter);t.disableResize&&(e.disableResize="true"===t.disableResize.toLowerCase()||"1"===t.disableResize);return e.initColor=c(t.initColor,e.initColor),e.initWidth=c(t.initWidth,e.initWidth),e.initHeight=c(t.initHeight,e.initHeight),e;function c(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,o.state||(o.state=new pxt.sprite.Bitmap(o.params.initWidth,o.params.initHeight)),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.state||(this.state=new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight)),this.redrawPreview(),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))},t.prototype.showEditor_=function(){var i=this;this.params.blocksInfo=this.blocksInfo;var o=pxt.react.getFieldEditorView("image-editor",this.state,this.params);this.undoRedoState&&o.restorePersistentData(this.undoRedoState),o.onHide(function(){var t=o.getResult();if(t){var e=i.getValue();i.state=t,i.redrawPreview(),i.undoRedoState=o.getPersistentData(),i.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(i.sourceBlock_,"field",i.name,e,i.getValue()))}}),o.show()},t.prototype.render_=function(){r.prototype.render_.call(this),this.size_.height=42,this.size_.width=50},t.prototype.getValue=function(){return pxt.sprite.bitmapToImageLiteral(this.state,"typescript")},t.prototype.doValueUpdate_=function(t){null!=t&&(this.value_=t,this.parseBitmap(t),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t))},t.prototype.redrawPreview=function(){if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=(new n.Rect).at(5,1).size(40,40).setClass("blocklySpriteField").stroke("#898989",1).corner(4);if(this.fieldGroup_.appendChild(t.el),this.state){var e=o.bitmapToImageURI(this.state,32,this.lightMode),i=(new n.Image).src(e).at(9,5).size(32,32);this.fieldGroup_.appendChild(i.el)}}},t.prototype.parseBitmap=function(t){var e=pxt.sprite.imageLiteralToBitmap(t);e&&e.width&&e.height&&(this.state=e)},t}(Blockly.Field);o.FieldSpriteEditor=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,function(t){if(t){if(t.bold&&t.italics)return"blocklyBoldItalicizedText";if(t.bold)return"blocklyBoldText";if(t.italics)return"blocklyItalicizedText"}return}(e))||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldLabel);t.FieldStyledLabel=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e.values,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldTextDropdown);t.FieldTextDropdown=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldTextInput);t.FieldTextInput=e}(pxtblockly||(pxtblockly={})),function(c){var o=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.lightMode=e.lightMode,o.params=function(t){var e={initWidth:16,initHeight:16,tileWidth:16};if(!t)return e;t.filter&&(e.filter=t.filter);if(t.tileWidth)if("number"==typeof t.tileWidth)switch(t.tileWidth){case 8:e.tileWidth=8;break;case 16:e.tileWidth=16;break;case 32:e.tileWidth=32}else{var i=t.tileWidth.trim().toLowerCase();switch(i){case"8":case"eight":e.tileWidth=8;break;case"16":case"sixteen":e.tileWidth=16;break;case"32":case"thirtytwo":e.tileWidth=32}}return e.initWidth=o(t.initWidth,e.initWidth),e.initHeight=o(t.initHeight,e.initHeight),e;function o(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,t&&!o.state&&o.doValueUpdate_(t),o.initState(),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.initState(),this.redrawPreview(),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))},t.prototype.showEditor_=function(){var d=this;if(!this.isGreyBlock){this.params.blocksInfo=this.blocksInfo,this.state.projectReferences=c.getAllReferencedTiles(this.sourceBlock_.workspace,this.sourceBlock_.id).map(function(t){return t.id});for(var h=pxt.react.getTilemapProject(),t=h.getProjectTiles(this.state.tileset.tileWidth,!0),e=function(e){i.state.tileset.tiles.some(function(t){return t.id===e.id})||i.state.tileset.tiles.push(e)},i=this,o=0,r=t.tiles;o<r.length;o++){e(r[o])}for(var n=function(e){e.weight=t.tiles.findIndex(function(t){return t.id===e.id})},l=0,a=this.state.tileset.tiles;l<a.length;l++){n(a[l])}var m=pxt.react.getFieldEditorView("tilemap-editor",this.state,this.params);this.undoRedoState&&m.restorePersistentData(this.undoRedoState),m.onHide(function(){var o=m.getResult();if(o){var t=d.getValue();d.state=o,d.state.projectReferences=null;var e=h.revision();if(h.pushUndo(),o.deletedTiles)for(var i=0,r=o.deletedTiles;i<r.length;i++){var n=r[i];h.deleteTile(n)}if(o.editedTiles)for(var l=function(e){var t=o.tileset.tiles.findIndex(function(t){return t.id===e}),i=o.tileset.tiles[t];if(!i||i.id.startsWith("*"))return"continue";o.tileset.tiles[t]=h.updateTile(i.id,i.bitmap)},a=0,s=o.editedTiles;a<s.length;a++){l(s[a])}for(var c=0;c<o.tileset.tiles.length;c++){var u=o.tileset.tiles[c];if(u.id.startsWith("*")){var p=h.createNewTile(u.bitmap);o.tileset.tiles[c]=p}else u.data||(o.tileset.tiles[c]=h.resolveTile(u.id))}pxt.sprite.trimTilemapTileset(o),d.tilemapId&&h.updateTilemap(d.tilemapId,o),d.redrawPreview(),d.undoRedoState=m.getPersistentData(),t!==d.getValue()&&h.forceUpdate(),d.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new f(d.sourceBlock_,"field",d.name,t,d.getValue(),e,h.revision()))}}),m.show()}},t.prototype.render_=function(){r.prototype.render_.call(this),this.isGreyBlock||(this.size_.height=42,this.size_.width=50)},t.prototype.getValue=function(){if(this.isGreyBlock)return pxt.Util.htmlUnescape(this.value_);if(this.tilemapId)return"tilemap`"+this.tilemapId+"`";try{return pxt.sprite.encodeTilemap(this.state,"typescript")}catch(t){return this.getInitText()}},t.prototype.getTileset=function(){return this.state.tileset},t.prototype.getInitText=function(){return this.initText},t.prototype.doValueUpdate_=function(t){null!=t&&(this.value_=t,this.parseBitmap(t),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t))},t.prototype.redrawPreview=function(){if(this.fieldGroup_){if(pxsim.U.clear(this.fieldGroup_),this.isGreyBlock)return this.createTextElement_(),void this.updateEditable();var t=(new o.Rect).at(5,1).size(40,40).setClass("blocklyTilemapField").corner(4);if(this.fieldGroup_.appendChild(t.el),this.state){var e=c.tilemapToImageURI(this.state,32,this.lightMode,this.blocksInfo),i=(new o.Image).src(e).at(9,5).size(32,32);this.fieldGroup_.appendChild(i.el)}}},t.prototype.refreshTileset=function(){var t=pxt.react.getTilemapProject();if(this.tilemapId)this.state=t.getTilemap(this.tilemapId);else if(this.state)for(var e=0;e<this.state.tileset.tiles.length;e++)this.state.tileset.tiles[e]=t.resolveTile(this.state.tileset.tiles[e].id)},t.prototype.parseBitmap=function(t){if(this.blocksInfo){t&&(t=t.replace(/&#96;/g,"`"));var e=/^\s*tilemap\s*`([^`]*)`\s*$/.exec(t);if(e){var i=e[1].trim();if(this.state=pxt.react.getTilemapProject().getTilemap(i),this.state)return void(this.tilemapId=i)}var o,r,n,l,a=pxt.sprite.decodeTilemap(t,"typescript",pxt.react.getTilemapProject())||(o=this.params.tileWidth,r=this.params.initWidth,n=this.params.initHeight,new pxt.sprite.TilemapData(new pxt.sprite.Tilemap(r,n),{tileWidth:o,tiles:[]},new pxt.sprite.Bitmap(r,n).data()));(l=a)&&l.tilemap&&l.tilemap.width&&l.tilemap.height&&l.layers&&l.layers.width===l.tilemap.width&&l.layers.height===l.tilemap.height&&l.tileset?(this.initText=t,this.state=a,this.isGreyBlock=!1):t.trim()&&(this.isGreyBlock=!0,this.value_=t)}},t.prototype.initState=function(){this.state||(this.state=pxt.react.getTilemapProject().blankTilemap(this.params.tileWidth,this.params.initWidth,this.params.initHeight))},t.prototype.getDisplayText_=function(){var t=pxt.Util.htmlUnescape(this.value_);return t.substr(0,t.indexOf("("))+"(...)"},t.prototype.updateEditable=function(){if(this.isGreyBlock&&this.fieldGroup_){var t=this.fieldGroup_;Blockly.utils.dom.removeClass(t,"blocklyNonEditableText"),Blockly.utils.dom.removeClass(t,"blocklyEditableText"),t.style.cursor=""}else r.prototype.updateEditable.call(this)},t}(Blockly.Field);c.FieldTilemap=t;var f=function(s){function l(t,e,i,o,r,n,l){var a=s.call(this,t,e,i,o,r)||this;return a.oldRevision=n,a.newRevision=l,a}return __extends(l,s),l.prototype.isNull=function(){return this.oldRevision===this.newRevision&&s.prototype.isNull.call(this)},l.prototype.run=function(t){t?pxt.react.getTilemapProject().redo():pxt.react.getTilemapProject().undo(),s.prototype.run.call(this,t);for(var e=this.getEventWorkspace_(),i=0,o=c.getAllBlocksWithTilemaps(e);i<o.length;i++){var r=o[i];r.ref.refreshTileset(),r.ref.redrawPreview()}var n=new l(e.getBlockById(this.blockId),"tilemap-revision","revision",null,pxt.react.getTilemapProject().revision(),0,0);n.recordUndo=!1,Blockly.Events.fire(n)},l}(Blockly.Events.BlockChange)}(pxtblockly||(pxtblockly={})),function(d){var h=32,t=function(r){function p(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o.menuGenerator_=function(){var t,e;return(null===(t=o.sourceBlock_)||void 0===t?void 0:t.workspace)&&d.needsTilemapUpgrade(null===(e=o.sourceBlock_)||void 0===e?void 0:e.workspace)?[[{src:m(16),width:h,height:h,alt:o.getValue()},o.getValue()]]:p.getReferencedTiles(o.sourceBlock_.workspace)},o.blocksInfo=e.blocksInfo,o}return __extends(p,r),p.getReferencedTiles=function(t){var e=pxt.react.getTilemapProject();if(e.revision()!==p.cachedRevision||t.id!=p.cachedWorkspaceId){p.cachedRevision=e.revision(),p.cachedWorkspaceId=t.id;for(var i=d.getAllReferencedTiles(t),o=0,r=[16,8,32];o<r.length;o++){var n=r[o],l=e.getProjectTiles(n,16===n);if(l)for(var a=function(e){i.find(function(t){return t.id===e.id})||i.push(e)},s=0,c=l.tiles;s<c.length;s++){a(c[s])}}var u={};i.sort(function(t,e){return t.id===e.id?0:t.bitmap.width!==e.bitmap.width?t.bitmap.width-e.bitmap.width:t.isProjectTile!==e.isProjectTile?t.isProjectTile?-1:1:(u[t.id]||(u[t.id]=f(t.id)))-(u[e.id]||(u[e.id]=f(e.id)))});p.referencedTiles=i.map(function(t){return[{src:(e=t,f(e.id)<=2?m(e.bitmap.width):d.bitmapToImageURI(pxt.sprite.Bitmap.fromData(e.bitmap),h,!1)),width:h,height:h,alt:t.id},t.id];var e})}return p.referencedTiles},p.prototype.init=function(){r.prototype.init.call(this),this.sourceBlock_&&this.sourceBlock_.isInFlyout&&this.setValue(this.getOptions()[0][1])},p.prototype.getValue=function(){var t=r.prototype.getValue.call(this);return"string"==typeof t&&-1===t.indexOf(".")&&-1===t.indexOf("`")?"img`"+t+"`":t},p.prototype.getText=function(){var t=this.getValue();return"string"==typeof t&&-1!==t.indexOf("`")?t:r.prototype.getText.call(this)},p.prototype.render_=function(){if(this.value_&&this.selectedOption_&&this.selectedOption_[1]!==this.value_){var t=pxt.react.getTilemapProject().resolveTile(this.value_);p.cachedRevision=-1,t&&(this.selectedOption_=[{src:d.bitmapToImageURI(pxt.sprite.Bitmap.fromData(t.bitmap),h,!1),width:h,height:h,alt:t.id},this.value_])}r.prototype.render_.call(this)},p.prototype.getOptions=function(){return"function"!=typeof this.menuGenerator_?(this.transparent=(t=pxt.react.getTilemapProject().getTransparency(16),[{src:m(16),width:h,height:h,alt:pxt.U.lf("transparency")},t.id]),[this.transparent]):this.menuGenerator_.call(this);var t},p}(d.FieldImages);function m(t){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=t,e.height=t,i.fillStyle="#aeaeae",i.fillRect(0,0,t,t),i.fillStyle="#dedede";for(var o=0;o<t;o+=4)for(var r=0;r<t;r+=4)o+r>>2&1&&i.fillRect(o,r,4,4);return e.toDataURL()}function f(t){switch(t){case"myTiles.transparency16":return 1;case"myTiles.transparency8":case"myTiles.transparency32":return 2;default:if(t.startsWith("myTiles.tile")){var e=parseInt(t.slice(12));if(!Number.isNaN(e))return e+2}return 9999999999}}d.FieldTileset=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,void 0,void 0,void 0,i)||this;return o.isFieldCustom_=!0,o.CURSOR="pointer",o.params=e,o.setValue(t),o.addArgType("toggle"),o.type_=e.type,o}return __extends(t,r),t.prototype.init=function(){if(!this.fieldGroup_){this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes())),!this.sourceBlock_.isShadow()&&this.sourceBlock_.inputList&&1<this.sourceBlock_.inputList.length&&(this.borderRect_=Blockly.utils.dom.createSvgElement("rect",{rx:Blockly.BlockSvg.CORNER_RADIUS,ry:Blockly.BlockSvg.CORNER_RADIUS,x:0,y:0,width:this.size_.width,height:this.size_.height,fill:this.sourceBlock_.getColour(),stroke:this.sourceBlock_.getColourTertiary()},null),this.fieldGroup_.insertBefore(this.borderRect_,this.textElement_));var t=this.getSize();switch(this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOn":"blocklyToggleOff"),transform:"translate(8, "+t.height/2+")"},this.fieldGroup_),this.getOutputShape()){case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"-7,-14 -21,0 -7,14 7,14 21,0 7,-14",cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_ROUND:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleCircle",x:-6,y:-14,height:28,width:28,rx:14,ry:14,cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleRect",x:-6,y:-14,height:28,width:28,rx:3,ry:3,cursor:"pointer"},this.checkElement_)}var e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.updateEditable();var i=this.sourceBlock_.getSvgRoot();i.appendChild(this.fieldGroup_),i.querySelector(".blocklyBlockBackground").setAttribute("fill",this.sourceBlock_.getColourTertiary()),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)}},t.prototype.getDisplayText_=function(){return this.state_?this.getTrueText():this.getFalseText()},t.prototype.getTrueText=function(){return lf("True")},t.prototype.getFalseText=function(){return lf("False")},t.prototype.updateSize_=function(){switch(this.getOutputShape()){case Blockly.OUTPUT_SHAPE_ROUND:this.size_.width=2*this.getInnerWidth()-7;break;case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.size_.width=2*this.getInnerWidth()+8-Math.floor(this.getInnerWidth()/2);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.size_.width=9+2*this.getInnerWidth()}},t.prototype.getInnerWidth=function(){return 10*this.getMaxLength()},t.prototype.getMaxLength=function(){return Math.max(this.getTrueText().length,this.getFalseText().length)},t.prototype.getOutputShape=function(){return this.sourceBlock_.isShadow()?this.sourceBlock_.getOutputShape():Blockly.OUTPUT_SHAPE_SQUARE},t.prototype.doClassValidation_=function(t){return"boolean"==typeof this.fromVal(t)?t:"false"},t.prototype.applyColour=function(){var t=this.sourceBlock_.getColourTertiary();this.borderRect_?this.borderRect_.setAttribute("stroke",t):this.sourceBlock_.pathObject.svgPath.setAttribute("fill",t)},t.prototype.getValue=function(){return this.toVal(this.state_)},t.prototype.doValueUpdate_=function(t){var e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_),this.isDirty_=!0)},t.prototype.switchToggle=function(t){if(this.checkElement_){this.updateSize_();var e=this.getSize(),i=this.getInnerWidth();t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOff")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOff"));var o=this.getOutputShape(),r=0,n=0,l=0,a=0;switch(o){case Blockly.OUTPUT_SHAPE_HEXAGONAL:var s=(n=(r=i)/2)/2;l=-n+s;var c=a=-s,u=n;this.toggleThumb_.setAttribute("points",c+",-14 "+(c-14)+",0 "+c+",14 "+u+",14 "+(u+14)+",0 "+u+",-14");break;case Blockly.OUTPUT_SHAPE_ROUND:case Blockly.OUTPUT_SHAPE_SQUARE:n=(r=5+i)/2,this.toggleThumb_.setAttribute("width",""+r),this.toggleThumb_.setAttribute("x","-"+n),l=a=o==Blockly.OUTPUT_SHAPE_SQUARE?2:-6}this.checkElement_.setAttribute("transform","translate("+(t?a+i+n:n+l)+", "+e.height/2+")")}},t.prototype.render_=function(){if(this.visible_&&this.textElement_){goog.dom.removeChildren(this.textElement_);var t=document.createTextNode(this.getDisplayText_());this.textElement_.appendChild(t),pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText"),this.updateSize_();var e=this.size_.width,i=(this.state_?e+e/8:e/2)-e/2;this.textElement_.setAttribute("x",""+i)}this.borderRect_&&(this.borderRect_.setAttribute("width",""+this.size_.width),this.borderRect_.setAttribute("height",""+this.size_.height))},t.prototype.showEditor_=function(){var t=!this.state_;null!==t&&this.setValue(this.toVal(t))},t.prototype.toVal=function(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")},t.prototype.fromVal=function(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t},t}(Blockly.FieldNumber);t.FieldToggle=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("HIGH")},t.prototype.getFalseText=function(){return lf("LOW")},t}(t.FieldToggle);t.FieldToggleHighLow=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("ON")},t.prototype.getFalseText=function(){return lf("OFF")},t}(t.FieldToggle);t.FieldToggleOnOff=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("UP")},t.prototype.getFalseText=function(){return lf("DOWN")},t}(t.FieldToggle);t.FieldToggleUpDown=e;var i=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("DOWN")},t.prototype.getFalseText=function(){return lf("UP")},t}(t.FieldToggle);t.FieldToggleDownUp=i}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("WIN")},t.prototype.getFalseText=function(){return lf("LOSE")},t}(t.FieldToggle);t.FieldToggleWinLose=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("Yes")},t.prototype.getFalseText=function(){return lf("No")},t}(t.FieldToggle);t.FieldToggleYesNo=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isFieldCustom_=!0,t.pythonMode=!1,t}return __extends(t,e),t.prototype.updateEditable=function(){var t=this.fieldGroup_;this.EDITABLE&&t&&(this.sourceBlock_.isEditable()?(pxt.BrowserUtils.addClass(t,"blocklyEditableText"),pxt.BrowserUtils.removeClass(t,"blocklyGreyExpressionBlockText"),this.fieldGroup_.style.cursor=this.CURSOR):(pxt.BrowserUtils.addClass(t,"blocklyGreyExpressionBlockText"),pxt.BrowserUtils.removeClass(t,"blocklyEditableText"),this.fieldGroup_.style.cursor=""))},t.prototype.setPythonEnabled=function(t){t!==this.pythonMode&&(this.pythonMode=t,this.forceRerender())},t.prototype.getText=function(){return this.pythonMode?pxt.Util.lf("<python code>"):this.getValue()},t.prototype.applyColour=function(){this.sourceBlock_&&this.constants_.FULL_BLOCK_FIELDS&&this.borderRect_&&this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary)},t}(Blockly.FieldTextInput);t.FieldTsExpression=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function h(t,e,i){var o=r.call(this,String(t),"-200","200","1","10","TurnRatio",i)||this;return o.isFieldCustom_=!0,o.params=e,o.sliderColor_="#a8aaa8",o}return __extends(h,r),h.prototype.createLabelDom_=function(t){var e=document.createElement("div"),i=Blockly.utils.dom.createSvgElement("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:html":"http://www.w3.org/1999/xhtml","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1",height:h.HALF+h.HANDLE_RADIUS+10+"px",width:2*h.HALF+"px"},e),o=Blockly.utils.dom.createSvgElement("defs",{},i),r=Blockly.utils.dom.createSvgElement("marker",{id:"head",orient:"auto",markerWidth:"2",markerHeight:"4",refX:"0.1",refY:"1.5"},o);Blockly.utils.dom.createSvgElement("path",{d:"M0,0 V3 L1.5,1.5 Z",fill:"#f12a21"},r);this.reporter_=pxsim.svg.child(i,"text",{x:h.HALF,y:96,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"}),this.path_=Blockly.utils.dom.createSvgElement("path",{x1:h.HALF,y1:h.HALF,"marker-end":"url(#head)",style:"fill: none; stroke: #f12a21; stroke-width: 10"},i),this.updateGraph_();var n=document.createElement("span");return n.setAttribute("class","blocklyFieldSliderReadout"),[e,n]},h.prototype.updateGraph_=function(){if(this.path_){var t=goog.math.clamp(this.getValue()||0,-200,200),e=t/100,i=Math.max(-1,Math.min(1,e)),o=Math.max(i)*Math.PI/2,r=h.RADIUS-6,n=h.HALF,l=h.HALF-22;1<Math.abs(e)&&(n-=(e-(0<e?1:-1))*r/2);var a=.2+.5*Math.abs(i),s=r*a,c=r*Math.sin(Math.PI/2-o),u=r*Math.cos(Math.PI/2-o),p=c-r*a*Math.cos(2*o),d="M "+n+" "+l+" C "+n+" "+(l-s)+" "+(n+(u-r*a*Math.sin(2*o)))+" "+(l-p)+" "+(n+u)+" "+(l-c);this.path_.setAttribute("d",d),this.reporter_.textContent=""+t}},h.prototype.setReadout_=function(t,e){this.updateGraph_()},h.RADIUS=(h.HALF=80)-(h.HANDLE_RADIUS=30)-1,h}(Blockly.FieldSlider);t.FieldTurnRatio=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t){var e,i=o.call(this,(e=t,function(){var i=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){var t=this.sourceBlock_.workspace.getVariablesOfType(e.name);t.forEach(function(t){var e=t.name.replace(/^\d+/,"");i.push([e,t.name])})}else e.initialMembers.forEach(function(t){return i.push([t,t])});return i.push([lf("Add a new {0}...",e.memberName),"CREATE"]),i}))||this;return i.opts=t,i}return __extends(t,o),t.prototype.init=function(){o.prototype.init.call(this),this.initVariables()},t.prototype.onItemSelected_=function(t,e){var i=this;"CREATE"===e.getValue()?function l(a,s,c,u){Blockly.prompt(c,null,function(t){if(t){var e=!1;if(pxtc.isIdentifierStart(t.charCodeAt(0),2)){e=!0;for(var i=1;i<t.length;i++)pxtc.isIdentifierPart(t.charCodeAt(i),2)||(e=!1)}if(!e)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),function(){return l(a,s,c,u)});for(var o=p(a,s.name),i=0;i<o.length;i++){var r=o[i],n=r[0];r[1];if(n===t)return void Blockly.alert(lf("A {0} named '{1}' already exists.",s.memberName,t),function(){return l(a,s,c,u)})}u(d(a,s,t))}},{placeholder:s.promptHint})}(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),function(t){return t&&i.setValue(t)}):o.prototype.onItemSelected_.call(this,t,e)},t.prototype.doClassValidation_=function(e){var t;return(null===(t=this.opts)||void 0===t?void 0:t.initialMembers)&&!this.opts.initialMembers.find(function(t){return t==e})&&this.getOptions(),o.prototype.doClassValidation_.call(this,e)},t.prototype.initVariables=function(){var t=this;if(this.sourceBlock_&&this.sourceBlock_.workspace){var e=this.sourceBlock_.workspace,o=p(e,this.opts.name);if(this.opts.initialMembers.forEach(function(i){o.some(function(t){var e=t[0];t[1];return e===i})||d(e,t.opts,i)}),"CREATE"===this.getValue()){var i=function(t,e,i){var o=t.getVariablesOfType(e);if(o&&o.length)for(var r=0;r<o.length;r++){var n=l(o[r])[0];if(n===i)return o[r].name}return}(e,this.opts.name,this.opts.initialMembers[0]);i&&this.setValue(i)}}},t}(Blockly.FieldDropdown);function l(t){var e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]}function p(t,e){var i=t.getVariablesOfType(e);return i&&i.length?i.map(l):[]}function r(t,e){var i=t.map(function(t){t[0];return t[1]});if(e.isBitMask){for(var o=0;o<i.length;o++){var r=1<<o;if(i.indexOf(r)<0)return r}return 1<<i.length}if(e.isHash)return 0;var n=e.firstValue||0;for(o=0;o<i.length;o++)if(i.indexOf(n+o)<0)return n+o;return n+i.length}function d(t,e,i){var o=r(p(t,e.name),e)+i;return Blockly.Variables.getOrCreateVariablePackage(t,null,o,e.name),o}t.FieldUserEnum=e,t.getNextValue=r}(pxtblockly||(pxtblockly={})),function(e){var t;function h(t,e){for(var i=0,o=t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE);i<o.length;i++){var r=o[i];if(parseInt(r.name.substr(0,r.name.indexOf(";")))===e.projectId){t.deleteVariableById(r.getId());break}}}function y(t){return i(t,function(t){return t instanceof e.FieldTilemap&&!t.isGreyBlock})}function v(t){return i(t,function(t){return t instanceof e.FieldTileset})}function i(t,s){var c=[];return t.getTopBlocks(!1).forEach(function(t){return function t(e){for(var i=0,o=e.inputList;i<o.length;i++){for(var r=o[i],n=0,l=r.fieldRow;n<l.length;n++){var a=l[n];s(a)&&c.push({block:e,field:a.name,ref:a})}r.connection&&r.connection.targetBlock()&&t(r.connection.targetBlock())}e.nextConnection&&e.nextConnection.targetBlock()&&t(e.nextConnection.targetBlock())}(t)}),c}(t=e.svg||(e.svg={})).hasClass=function(t,e){return pxt.BrowserUtils.containsClass(t,e)},t.addClass=function(t,e){pxt.BrowserUtils.addClass(t,e)},t.removeClass=function(t,e){pxt.BrowserUtils.removeClass(t,e)},e.parseColour=function(t){var e=Number(t);return isNaN(e)?goog.isString(t)&&t.match(/^#[0-9a-fA-F]{6}$/)?t:"#000":Blockly.hueToRgb(e)},e.bitmapToImageURI=function(t,e,i){var o=pxt.appTarget.runtime.palette.slice(1),r=document.createElement("canvas");r.width=e,r.height=e;var n,l=Math.min(e/t.width,e/t.height),a=Math.max(Math.floor(e*(1-t.width/t.height)/2),0),s=Math.max(Math.floor(e*(1-t.height/t.width)/2),0);i?((n=r.getContext("2d",{alpha:!1})).fillStyle="#dedede",n.fillRect(0,0,e,e)):n=r.getContext("2d");for(var c=0;c<t.width;c++)for(var u=0;u<t.height;u++){var p=t.get(c,u);p?(n.fillStyle=o[p-1],n.fillRect(a+c*l,s+u*l,l,l)):i&&(n.fillStyle="#dedede",n.fillRect(a+c*l,s+u*l,l,l))}return r.toDataURL()},e.tilemapToImageURI=function(t,e,i,o){var r=pxt.appTarget.runtime.palette.slice(),n=document.createElement("canvas");n.width=e,n.height=e;var l,a=Math.min(e/t.tilemap.width,e/t.tilemap.height),s=Math.max(Math.floor(e*(1-t.tilemap.width/t.tilemap.height)/2),0),c=Math.max(Math.floor(e*(1-t.tilemap.height/t.tilemap.width)/2),0);i?((l=n.getContext("2d",{alpha:!1})).fillStyle="#dedede",l.fillRect(0,0,e,e)):l=n.getContext("2d");for(var u=[],p=0;p<t.tilemap.width;p++)for(var d=0;d<t.tilemap.height;d++){var h=t.tilemap.get(p,d);if(h){if(!u[h]){var m=t.tileset.tiles[h];u[h]=m?pxt.sprite.computeAverageColor(pxt.sprite.Bitmap.fromData(m.bitmap),r):"#dedede"}l.fillStyle=u[h],l.fillRect(s+p*a,c+d*a,a,a)}else i&&(l.fillStyle="#dedede",l.fillRect(s+p*a,c+d*a,a,a))}return n.toDataURL()},e.getAllBlocksWithTilemaps=y,e.getAllBlocksWithTilesets=v,e.needsTilemapUpgrade=function(t){return!!t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map(function(t){return pxt.sprite.legacy.blocklyVariableToTile(t.name)}).length},e.upgradeTilemapsInWorkspace=function(t,r){var e=t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map(function(t){return pxt.sprite.legacy.blocklyVariableToTile(t.name)});if(e.length){Blockly.Events.disable();for(var n=[],i=0,o=e;i<o.length;i++){var l=o[i];l.qualifiedName?n[l.projectId]=r.resolveTile(l.qualifiedName):l.data&&(n[l.projectId]=r.createNewTile(l.data,"myTiles.tile"+l.projectId)),h(t,l)}for(var a=function(t){var e=pxt.sprite.legacy.decodeTilemap(t.ref.getInitText(),"typescript"),i=[],o=new pxt.sprite.TilemapData(e.tilemap,{tileWidth:e.tileset.tileWidth,tiles:e.tileset.tiles.map(function(t,e){return null!=t.projectId?n[t.projectId]:(i[e]||(i[e]=r.resolveTile(t.qualifiedName)),i[e])})},e.layers);t.ref.setValue(pxt.sprite.encodeTilemap(o,"typescript"))},s=0,c=y(t);s<c.length;s++)a(c[s]);for(var u=0,p=v(t);u<p.length;u++){var d=p[u];d.ref.doValueUpdate_(d.ref.getValue()),d.ref.isDirty_&&d.ref.forceRerender()}Blockly.Events.enable()}},e.getAllReferencedTiles=function(t,e){for(var i={},o=0,r=y(t);o<r.length;o++){var n=r[o];if(n.block.id!==e)for(var l=0,a=n.ref.getTileset().tiles;l<a.length;l++){var s=a[l];i[s.id]=s}}for(var c=pxt.react.getTilemapProject(),u=0,p=c.getAllTilemaps();u<p.length;u++)for(var d=0,h=p[u].data.tileset.tiles;d<h.length;d++)s=h[d],i[s.id]=s;for(var m=0,f=v(t);m<f.length;m++){var g=f[m].ref.getValue();i[g]||(i[g]=c.resolveTile(g))}return Object.keys(i).map(function(t){return i[t]})}}(pxtblockly||(pxtblockly={}));