var pxt;!function(o){var e;(e=o.winrt||(o.winrt={})).browserDownloadAsync=function(n,e,t){var r;return o.winrt.promisify(Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(r=e,n)}).then(function(){return Windows.System.Launcher.launchFileAsync(r)}).then(function(e){}))},e.saveOnlyAsync=function(r){var i=o.appTarget.compile.useUF2,e=i?[".uf2"]:[".hex"],n=new Windows.Storage.Pickers.FileSavePicker;return n.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,n.fileTypeChoices.insert("MakeCode binary file",e),n.suggestedFileName=r.downloadFileBaseName,o.winrt.promisify(n.pickSaveFileAsync().then(function(e){if(e){var n=i?r.outfiles[pxtc.BINARY_UF2]:r.outfiles[pxtc.BINARY_HEX];o.isOutputText()||(n=atob(n));var t=[];return o.Util.stringToUint8Array(n).forEach(function(e){return t.push(e)}),Windows.Storage.FileIO.writeBytesAsync(e,t).then(function(){return!0})}return Promise.resolve(!1)}))}}(pxt||(pxt={})),function(p){!function(c){var e=function(){function e(){this.onDeviceConnectionChanged=function(e){},this.onConnectionChanged=function(){},this.onData=function(e){},this.onEvent=function(e){},this.onError=function(e){},this.connecting=!1,this.handleInputReport=this.handleInputReport.bind(this)}return e.prototype.disposeAsync=function(){return Promise.resolve()},e.prototype.error=function(e){throw new Error(p.U.lf("USB/HID error ({0})",e))},e.prototype.setConnecting=function(e){this.connecting=e,this.onConnectionChanged&&this.onConnectionChanged()},e.prototype.isConnecting=function(){return this.connecting},e.prototype.isConnected=function(){return!!this.dev},e.prototype.reconnectAsync=function(){var e=this;return this.disconnectAsync().then(function(){return e.initAsync()})},e.prototype.isSwitchingToBootloader=function(){d=!0,this.dev&&(f=!0)},e.prototype.disconnectAsync=function(){if(this.dev){var e=this.dev;delete this.dev;try{e.close()}catch(e){}this.onConnectionChanged&&this.onConnectionChanged()}return Promise.resolve()},e.prototype.sendPacketAsync=function(e){if(!this.dev)return Promise.resolve();for(var n=[0],t=0;t<Math.max(e.length,64);++t)n.push(e[t]||0);var r=new Windows.Storage.Streams.DataWriter;r.writeBytes(n);var i=r.detachBuffer(),o=this.dev.createOutputReport(0);return o.data=i,p.winrt.promisify(this.dev.sendOutputReportAsync(o).then(function(e){}))},e.prototype.handleInputReport=function(e){for(var n=Windows.Storage.Streams.DataReader.fromBuffer(e.report.data),t=[];n.unconsumedBufferLength;)t.push(n.readByte());65==t.length&&0===t[0]&&t.shift(),this.onData(new Uint8Array(t))},e.prototype.initAsync=function(n){var t=this;void 0===n&&(n=!1),p.Util.assert(!this.dev,"HID interface not properly reseted");var r,i=Windows.Devices,o=i.HumanInterfaceDevice.HidDevice,a=function(){var e=new Error(p.U.lf("Device not found"));return e.type="devicenotfound",Promise.reject(e)},e=s.reduce(function(e,n){return e.then(function(e){return e&&e.length?Promise.resolve(e):i.Enumeration.DeviceInformation.findAllAsync(n,null)})},Promise.resolve(null));return this.setConnecting(!0),e.then(function(e){if(!e||!e[0])return p.debug("no hid device found"),Promise.reject(new Error("no hid device found"));p.debug("hid enumerate "+e.length+" devices");var n=e[0];return p.debug("hid connect to "+n.name+" ("+n.id+")"),r=n.id,o.fromIdAsync(n.id,Windows.Storage.FileAccessMode.readWrite)}).then(function(e){if(t.dev=e,!t.dev){p.debug("can't connect to hid device");var n=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(r).currentStatus;return p.reportError("winrt_device","could not connect to HID device; device status: "+n),Promise.reject(new Error("can't connect to hid device"))}return p.debug("hid device version "+t.dev.version),t.dev.addEventListener("inputreportreceived",t.handleInputReport),Promise.resolve()}).finally(function(){t.setConnecting(!1)}).catch(function(e){return n?a():c.bootloaderViaBaud(t).then(function(){return t.initAsync(!0)}).catch(function(){return a()})})},e}();c.WinRTPacketIO=e,c.packetIO=void 0,c.mkWinRTPacketIOAsync=function(){return p.debug("packetio: mk winrt packetio"),c.packetIO=new e,c.packetIO.initAsync().catch(function(e){return c.packetIO=void 0,Promise.reject(e)}).then(function(){return c.packetIO})};var s=[],a=[],u=0,d=!1,f=!1;c.initWinrtHid=function(t,r){var e=Windows.Devices,i=Windows.Devices.Enumeration.DeviceInformation,o=e.HumanInterfaceDevice.HidDevice;p.appTarget&&p.appTarget.compile&&p.appTarget.compile.hidSelectors&&p.appTarget.compile.hidSelectors.forEach(function(e){var n=o.getDeviceSelector(parseInt(e.usagePage),parseInt(e.usageId),parseInt(e.vid),parseInt(e.pid));s.indexOf(n)<0&&s.push(n)}),s.forEach(function(e){var n=i.createWatcher(e,null);n.addEventListener("added",function(e){p.debug("new hid device detected: "+e.id),d?d=!1:1==++u&&t&&t()}),n.addEventListener("removed",function(e){p.debug("hid device closed: "+e.id),f?f=!1:0<--u&&t?t():0===u&&r&&(r(),c.packetIO=void 0)}),n.addEventListener("updated",function(e){}),a.push(n)}),a.filter(function(e){return!e.status}).forEach(function(e){return e.start()})}}(p.winrt||(p.winrt={}))}(pxt||(pxt={})),function(d){!function(e){var r,i,u={};function o(e){if(!e)return Promise.resolve([]);var n=Windows.Devices,t=n.SerialCommunication.SerialDevice,r=n.Enumeration.DeviceInformation,i=[];return e.forEach(function(e){var n=t.getDeviceSelectorFromUsbVidPid(parseInt(e.vid),parseInt(e.pid));i.push(n)}),i.reduce(function(e,n){var t;return e.then(function(e){return t=e,r.findAllAsync(n,null)}).then(function(e){if(t)for(var n=0;n<e.length;++n)t.push(e[n]);else t=e;return Promise.resolve(t)})},Promise.resolve(null)).then(function(e){return e?Promise.map(e,function(e){return t.fromIdAsync(e.id)}):Promise.resolve([])})}function a(n){i&&!i.test(n.name)||(d.debug("serial port added "+n.name+" - "+n.id),u[n.id]={info:n},Windows.Devices.SerialCommunication.SerialDevice.fromIdAsync(n.id).done(function(e){u[n.id].device=e,function t(r){var i=u[r];if(!i)return;if(!i.device){var e=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(r).currentStatus;return void d.reportError("winrt_device","could not connect to serial device; device status: "+e)}var n=Windows.Storage.Streams;i.device.baudRate=115200;var o=i.device.inputStream;var a=new n.DataReader(o);a.inputStreamOptions=n.InputStreamOptions.partial;var c={};var s=function(){u[r]&&!i.cancellingDeferred&&(i.readingOperation=a.loadAsync(32),i.readingOperation.done(function(e){var n=a.readString(4*Math.floor(a.unconsumedBufferLength/4));d.Util.bufferSerial(c,n,r),setTimeout(function(){return s()},1)},function(e){var n=i.readingOperation.operation.status;n===Windows.Foundation.AsyncStatus.canceled?(a.detachStream(),a.close(),i.cancellingDeferred&&setTimeout(function(){return i.cancellingDeferred.resolve()},25)):setTimeout(function(){return t(r)},1e3)}))};setTimeout(function(){return s()},100)}(n.id)}))}function c(e){delete u[e.id]}function s(e){var n=u[e.id];n&&n.info.update(e)}e.initSerial=function(){var e=!(!d.appTarget.serial||!(d.appTarget.serial.nameFilter||d.appTarget.serial.vendorId&&d.appTarget.serial.productId));if(d.appTarget.serial&&d.appTarget.serial.log&&e){var n,t=Windows.Devices.SerialCommunication.SerialDevice;d.appTarget.serial.vendorId&&d.appTarget.serial.productId?n=t.getDeviceSelectorFromUsbVidPid(parseInt(d.appTarget.serial.vendorId),parseInt(d.appTarget.serial.productId)):(i=new RegExp(d.appTarget.serial.nameFilter),n=t.getDeviceSelector()),(r=Windows.Devices.Enumeration.DeviceInformation.createWatcher(n,null)).addEventListener("added",a),r.addEventListener("removed",c),r.addEventListener("updated",s),r.start()}},e.suspendSerialAsync=function(){r&&(r.stop(),r.removeEventListener("added",a),r.removeEventListener("removed",c),r.removeEventListener("updated",s),r=void 0);var i=Promise.resolve();return Object.keys(u).forEach(function(e){var n=u[e],t=n.readingOperation;if(t){var r=Promise.defer();n.cancellingDeferred=r,i=i.then(function(){return r.promise.timeout(500).catch(function(e){d.reportError("winrt_device","could not cancel reading operation for a device: "+e.message)})}),t.cancel()}}),i.then(function(){Object.keys(u).forEach(function(e){var n=u[e];n.device&&n.device.close()}),u={}})},e.bootloaderViaBaud=function(n){if(!(d.appTarget&&d.appTarget.compile&&d.appTarget.compile.useUF2&&d.appTarget.simulator&&d.appTarget.simulator.boardDefinition&&d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo))return Promise.reject(new Error("device does not support switching to bootloader via baudrate"));var t,e=d.appTarget.simulator.boardDefinition.bootloaderBaudSwitchInfo;return o([{vid:e.vid,pid:e.pid,usageId:void 0,usagePage:void 0}]).then(function(e){return e&&0!==e.length?((t=e).length&&n.isSwitchingToBootloader(),t.forEach(function(e){e.baudRate=1200,e.close()}),Promise.delay(1500)):Promise.reject(new Error("no serial devices to switch into bootloader"))})},e.connectSerialDevicesAsync=o}(d.winrt||(d.winrt={}))}(pxt||(pxt={})),function(p){!function(i){function o(){return"undefined"!=typeof Windows}function a(){return o()?(n.resolve(null),n.promise.then(function(e){return Promise.resolve(e&&e.kind===Windows.ApplicationModel.Activation.ActivationKind.file)})):Promise.resolve(!1)}function t(){return o()?Promise.resolve().then(function(){return i.packetIO?(p.log("disconnecting packetIO"),i.packetIO.disconnectAsync()):Promise.resolve()}).catch(function(e){e.message="error disconnecting packetIO: "+e.message,p.reportException(e)}).then(function(){return p.log("suspending serial"),i.suspendSerialAsync()}).catch(function(e){e.message="error suspending serial: "+e.message,p.reportException(e)}):Promise.resolve()}function c(e){Windows.UI.WebUI.WebUIApplication.removeEventListener("activated",c),n.resolve(e)}function s(e){p.log("suspending");var n=e.suspendingOperation.getDeferral();return t().then(function(){return n.complete()},function(e){return n.complete()}).done()}function u(e){p.log("resuming"),i.packetIO&&(p.log("reconnet pack io"),i.packetIO.reconnectAsync().done()),i.initSerial()}var n,d;function f(e,n){if(void 0===n&&(n=!1),e.kind===Windows.ApplicationModel.Activation.ActivationKind.file){var t=e.files.getAt(0);if(t&&t.isOfType(Windows.Storage.StorageItemTypes.file)){var r=t;Windows.Storage.FileIO.readBufferAsync(r).then(function(e){for(var n=[],t=Windows.Storage.Streams.DataReader.fromBuffer(e);t.unconsumedBufferLength;)n.push(t.readByte());return t.close(),p.cpp.unpackSourceFromHexAsync(new Uint8Array(n))}).then(function(e){return d(e,{openHomeIfFailed:n})})}}}p.BrowserUtils.isWinRT=o,i.promisify=function(e){return new Promise(function(n,t){e.done(function(e){return n(e)},function(e){return t(e)})})},i.toArray=function(e){for(var n=[],t=e.length,r=0;r<t;++r)n.push(e[r]);return n},i.isWindows=function(){return!!navigator&&/Win32/i.test(navigator.platform)},i.isWinRT=o,i.initAsync=function(e){if(!o()||p.BrowserUtils.isIFrame())return Promise.resolve();var n=Windows.UI.Core,t=n.SystemNavigationManager.getForCurrentView(),r=Windows.UI.WebUI.WebUIApplication;return r.addEventListener("suspending",s),r.addEventListener("resuming",u),t.onbackrequested=function(e){p.log("BACK NAVIGATION"),t.appViewBackButtonVisibility=n.AppViewBackButtonVisibility.collapsed,e.handled=!0},i.initSerial(),a().then(function(){e&&(d=e,r.removeEventListener("activated",c),r.addEventListener("activated",f))})},i.captureInitialActivation=function(){o()&&(n=Promise.defer(),Windows.UI.WebUI.WebUIApplication.addEventListener("activated",c))},i.loadActivationProject=function(){return n.promise.then(function(e){return f(e,!0)})},i.hasActivationProjectAsync=a,i.releaseAllDevicesAsync=t}(p.winrt||(p.winrt={}))}(pxt||(pxt={})),function(v){var g;(function(e){var o,a=v.Util;function c(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return e.join("\\")}function s(e){var n=c(o.path,e);return v.debug("winrt: reading "+n),g.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(n).then(function(e){return Windows.Storage.FileIO.readTextAsync(e)}))}function u(e,n,t){var r=c(o.path,e);return v.debug("winrt: writing "+c(r,n)),g.promisify(Windows.Storage.StorageFolder.getFolderFromPathAsync(r)).then(function(e){return e.createFileAsync(n,Windows.Storage.CreationCollisionOption.replaceExisting)}).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,t)}).then(function(){})}function d(e,n){void 0===n&&(n=null);var t=new Error(n||"Error "+e);throw t.statusCode=e,t}e.fileApiAsync=function(e,n){if(a.startsWith(e,"pkg/")){var t=e.slice(4);return n?(r=t,i=n,v.debug("winrt: writing package at "+r),g.promisify(o.createFolderAsync(r,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(){return Promise.map(i.files,function(n){return s(c(r,n.name)).then(function(e){if(n.name!=v.SIMSTATE_JSON){if(n.name==v.CONFIG_NAME)try{JSON.parse(n.content).name||(v.log("Trying to save invalid JSON config"),d(410))}catch(e){v.log("Trying to save invalid format JSON config"),d(410)}e!==n.prevContent&&(v.log("merge error for "+n.name+": previous content changed..."),d(409))}},function(e){})})}).then(function(){return Promise.map(i.files,function(e){return u(r,e.name,e.content)})}).then(function(){return u(r,f,JSON.stringify(i.header,null,4))}).then(function(){return p(r,!1)})):p(t,!0)}if("list"==e)return function(){if(o)return Promise.resolve();var e=Windows.Storage.ApplicationData.current.localFolder;return v.debug("winrt: initializing workspace"),g.promisify(e.createFolderAsync(v.appTarget.id,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(e){o=e,v.debug("winrt: initialized workspace at "+o.path)}).then(function(){})}().then(l);throw d(404);var r,i};var f=".header.json";function p(r,i){return v.debug("winrt: reading package under "+r),s(c(r,v.CONFIG_NAME)).then(function(e){var t=JSON.parse(e);return Promise.map(v.allPkgFiles(t),function(t){return(n=c(r,t),e=c(o.path,n),v.debug("winrt: "+e),g.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(e).then(function(e){return e.getBasicPropertiesAsync().then(function(e){return{name:n,mtime:e.dateModified.getTime()}})}))).then(function(e){var n={name:t,mtime:e?e.mtime:null};return null!=e&&i?s(c(r,t)).then(function(e){return n.content=e,n}):n});var n,e}).then(function(e){var n={path:r,header:null,config:t,files:e};return s(c(r,f)).then(function(e){e&&(n.header=JSON.parse(e))},function(e){}).then(function(){return n})})})}function l(){return g.promisify(o.getFoldersAsync()).then(function(e){return Promise.map(e,function(e){return p(e.name,!1)})}).then(function(e){return Promise.resolve({pkgs:e})})}function n(){return g.promisify(o.deleteAsync(Windows.Storage.StorageDeleteOption.default).then(function(){o=void 0}))}e.getProvider=function(e){return{listAsync:e.listAsync,getAsync:e.getAsync,setAsync:e.setAsync,resetAsync:n}}})((g=v.winrt||(v.winrt={})).workspace||(g.workspace={}))}(pxt||(pxt={}));