var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<r;t++)for(var a=arguments[t],s=0,o=a.length;s<o;s++,i++)n[i]=a[s];return n},pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts;!function(o){var i=function(){function e(e){this.packageFiles=e}return e.prototype.resolve=function(e,t){return""},e.prototype.readFile=function(e,t){var r="this"==e.id?t:"pxt_modules/"+e.id+"/"+t;return void 0!==this.packageFiles[r]?this.packageFiles[r]:o.appTarget.bundledpkgs[e.id]?o.appTarget.bundledpkgs[e.id][t]:(console.log("file missing: "+e.id+" / "+t),null)},e.prototype.writeFile=function(e,t,r){"this"==e.id&&t==o.CONFIG_NAME?this.packageFiles[o.CONFIG_NAME]=r:console.log("write file? "+e.id+" / "+t)},e.prototype.getHexInfoAsync=function(e){return Promise.resolve({hex:["SKIP"]})},e.prototype.cacheStoreAsync=function(e,t){return Promise.resolve()},e.prototype.cacheGetAsync=function(e){return Promise.resolve("")},e.prototype.downloadPackageAsync=function(e){return Promise.resolve()},e.prototype.resolveVersionAsync=function(e){return Promise.resolve("*")},e}();function a(e){if(e.target.preferredEditor==o.PYTHON_PROJECT_NAME){var t=o.U.clone(e);t.ast=!0,t.target.preferredEditor=o.JAVASCRIPT_PROJECT_NAME;for(var r=0,n=t.sourceFiles;r<n.length;r++){var i=n[r];o.U.endsWith(i,".py")&&(t.fileSystem[i.slice(0,-3)+".ts"]=" ")}var a=pxtc.compile(t);e.apisInfo=pxtc.getApiInfo(a.ast,t.jres)}}function r(e,t){var r=new i(e),n=new o.MainPackage(r);return n.loadAsync().then(function(){var e=n.getTargetOptions();return e.hasHex&&(e.isNative=t.native),n.getCompileOptionsAsync(e)}).then(function(e){return s(n.targetVersion(),e),a(e),e})}function s(e,t){if(e){o.debug("applying TS patches relative to "+e);for(var r=0,n=Object.keys(t.fileSystem);r<n.length;r++){var i=n[r];if(-1==i.indexOf("/")&&o.U.endsWith(i,".ts")){var a=t.fileSystem[i],s=o.patching.patchJavaScript(e,a);a!=s&&(o.debug("applying TS patch to "+i),t.fileSystem[i]=s)}}}}o.SimpleHost=i,o.prepPythonOptions=a,o.simpleGetCompileOptionsAsync=r,o.simpleCompileAsync=function(e,t){return r(e,"boolean"==typeof t?{native:t}:t||{}).then(function(e){return pxtc.compile(e)}).then(function(e){return e.success||(e.errors=e.diagnostics.map(ts.pxtc.getDiagnosticString).join("")||"Unknown error."),e})},o.patchTS=s,o.setupSimpleCompile=function(){"undefined"==typeof global||global.btoa||(global.btoa=function(e){return Buffer.from(e,"binary").toString("base64")},global.atob=function(e){return Buffer.from(e,"base64").toString("binary")}),"undefined"!=typeof pxtTargetBundle&&(o.debug("setup app bundle"),o.setAppTarget(pxtTargetBundle)),o.debug("simple setup done")}}(pxt||(pxt={})),function(S){S.simshim=function(e,t){for(var r,h=ts.SyntaxKind,g=e.getTypeChecker(),v=S.cpp.nsWriter("declare namespace"),b="",n=0,i=e.getSourceFiles();n<i.length;n++){var a=i[n];if(t){var s=t(a.fileName);if(S.debug("SimShim[1]: "+s.dir),!S.U.endsWith(s.dir,"/sim")&&!S.U.startsWith(a.fileName,"sim/"))continue}else if(!S.U.startsWith(a.fileName,"sim/"))continue;S.debug("SimShim[2]: "+a.fileName);for(var o=0,l=a.statements;o<l.length;o++){var u=l[o],c=u;u.kind==h.ModuleDeclaration&&"pxsim"==c.name.text&&m((r=c).body)}}var p={};return p[S.appTarget.corepkg]=v.finish(),p;function y(e){var t;return ts.isExpression(e)&&(t=g.getContextualType(e)),t||(t=g.getTypeAtLocation(e)),t}function x(e){var t=g.typeToString(e,r,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t=t.replace(/^pxsim\./,"")){case"RefAction":return"() => void";case"RefBuffer":return"Buffer";default:return t}}function f(r){var e=k(r);if(e){v.setNs(b),v.write(e);var t=b;b&&(b+="."),b+=r.name.text;var n=t?"":"declare",i="";if(r.heritageClauses)for(var a=0,s=r.heritageClauses;a<s.length;a++){var o=s[a];o.token==h.ExtendsKeyword&&(i=" extends "+x(y(o.types[0])))}v.write(n+" class "+r.name.text+i+" {"),v.incrIndent();for(var l=function(t){switch(t.kind){case h.MethodDeclaration:d(t);break;case h.PropertyDeclaration:!function(e){var t=k(e);if(t){var r=e.name.getText(),n="//% shim=."+r,i=g.getTypeAtLocation(e);v.write(t),v.write(n),v.write("public "+r+": "+x(i)+";"),v.write("")}}(t);break;case h.Constructor:!function(e){var t=k(e);if(t){g.getTypeAtLocation(e);var r=e.parameters.map(function(e){return e.name.getText()+": "+x(y(e))});v.write(t),v.write('//% shim="new '+b+'"'),v.write("constructor("+r.join(", ")+");"),v.write("")}}(t);break;case h.GetAccessor:var e=r.members.some(function(e){return e.kind==h.SetAccessor&&e.name.getText()==t.name.getText()});d(t,e)}},u=0,c=r.members;u<c.length;u++)l(c[u]);b=t,v.decrIndent(),v.write("}")}}function k(e){var t=pxtc.getComments(e);return/^\s*\/\/%/m.test(t)?t:null}function d(e,t){void 0===t&&(t=!1);var r=k(e);if(r){var n,i=e.name.getText(),a=e.kind==h.MethodDeclaration||e.kind==h.GetAccessor||e.kind==h.SetAccessor,s="//% shim="+(a?"."+i:b+"::"+i),o=g.getSignatureFromDeclaration(e),l=g.getReturnTypeOfSignature(o),u=/Async$/.test(i),c=(n=l,pxtc.isObjectType(n)&&n.objectFlags&ts.ObjectFlags.Reference&&"Promise"==n.symbol.name?n.typeArguments[0]:null);c?(s+=" promise",l=c,u||S.U.userError(b+"::"+i+" should be called "+i+"Async")):u&&S.U.userError(b+"::"+i+" doesn't return a promise"),S.debug("emitFun: "+i);var p=e.parameters.map(function(e){return e.name.getText()+(e.questionToken?"?":"")+": "+x(y(e))}),f=i.replace(/Async$/,""),d=a?"public":"function",m="("+p.join(", ")+")";e.kind==h.GetAccessor&&(d=t?"public":"readonly",m="",s+=" property"),a||v.setNs(b),v.write(r),v.write(s),v.write(d+" "+f+m+": "+x(l)+";"),v.write("")}}function m(e){switch(e.kind){case h.ModuleDeclaration:return(r=b)&&(b+="."),b+=(t=e).name.text,m(t.body),void(b=r);case h.ModuleBlock:return e.statements.forEach(m);case h.FunctionDeclaration:return d(e);case h.ClassDeclaration:return f(e)}var t,r}}}(pxt||(pxt={})),function(f){var d;(d=f.pxtc||(f.pxtc={})).annotate=function(e,t,r){var n=d.target;d.target=r;var i=e.getSourceFiles().filter(function(e){return e.fileName===t})[0],u=e.getTypeChecker();function s(e,t,r,n){void 0===r&&(r=!1),void 0===n&&(n=null);var i=r||!(p(e).flags&f.TypeFlags.Void),a=n||c(e);if(e.expression&&a){var s=!1;switch(a.kind){case d.SK.PropertySignature:case d.SK.PropertyAssignment:case d.SK.PropertyDeclaration:d.isStatic(a)||(s=!0);break;case d.SK.Parameter:d.isCtorField(a)&&(s=!0);break;case d.SK.GetAccessor:case d.SK.SetAccessor:case d.SK.MethodDeclaration:case d.SK.MethodSignature:s=!0}if(s){var o=e.expression;o.kind===d.SK.PropertyAccessExpression?t.unshift(o.expression):t.unshift(e.expression)}}var l={decl:a,qName:a?d.getNodeFullName(u,a):"?",args:t,isExpression:i};d.pxtInfo(e).callInfo=l}function c(e){if(!e)return null;var t,r=u.getSymbolAtLocation(e);if(r&&!(t=r.valueDeclaration)&&r.declarations){var n=r.declarations[0];n&&n.kind==f.SyntaxKind.ImportEqualsDeclaration&&(r=u.getSymbolAtLocation(n.moduleReference))&&(t=r.valueDeclaration)}if(!t&&e.kind==d.SK.PropertyAccessExpression){var i=e;t={kind:d.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:i.name.getText()},name:i.name},d.pxtInfo(t).flags|=2}return t}function p(e){var t,r=d.pxtInfo(e);return r.typeCache?r.typeCache:(f.isExpression(e)&&(t=u.getContextualType(e)),t||(t=u.getTypeAtLocation(e)),t?f.isStringLiteral(e)?t:d.checkType(t):t)}!function n(e){f.forEachChild(e,function(e){switch(e.kind){case f.SyntaxKind.CallExpression:s(e,e.arguments.slice(0),null,c(e.expression));break;case f.SyntaxKind.PropertyAccessExpression:s(e,[]);break;case f.SyntaxKind.TaggedTemplateExpression:s(e,[e.template],!0,c(e.tag));break;case f.SyntaxKind.BinaryExpression:!function(e){var t=e.left,r=e.right,n=p(e.left),i=p(e.right);switch(e.operatorToken.kind!=d.SK.PlusToken&&e.operatorToken.kind!=d.SK.PlusEqualsToken||(d.isStringType(n)||d.isStringType(i)&&e.operatorToken.kind==d.SK.PlusToken)&&(d.pxtInfo(e).exprInfo={leftType:u.typeToString(n),rightType:u.typeToString(i)}),e.operatorToken.kind){case f.SyntaxKind.EqualsToken:case f.SyntaxKind.PlusEqualsToken:case f.SyntaxKind.MinusEqualsToken:if(t.kind==d.SK.PropertyAccessExpression){var a=c(t);a&&a.kind==d.SK.GetAccessor?(a=f.getDeclarationOfKind(a.symbol,d.SK.SetAccessor),s(t,[r],!1,a)):a&&(a.kind==d.SK.PropertySignature||a.kind==d.SK.PropertyAssignment||d.target&&d.target.switches.slowFields)&&s(t,[r])}}}(e);break;case f.SyntaxKind.Identifier:var t=c(e);if(t&&"main.ts"!==t.getSourceFile().fileName&&t.kind==f.SyntaxKind.VariableDeclaration){var r=d.pxtInfo(e);r.flags|=4,r.commentAttrs||(r.commentAttrs=d.parseComments(t))}}n(e)})}(i),d.target=n}}(ts||(ts={})),function(e){!function(C){function o(e){for(var t='"',r=0;r<e.length;++r){var n=255&e.charCodeAt(r),i=String.fromCharCode(n);t+="\\"==i||'"'==i?"\\"+i:"\n"==i?"\\n":n<=15?"\\x0"+n.toString(16):n<32||127<n?"\\x"+n.toString(16):i}return t+'"'}C.asmStringLiteral=o;var e=function(){function e(){}return e.prototype.nop=function(){return"TBD(nop)"},e.prototype.reg_gets_imm=function(e,t){return"TBD(reg_gets_imm)"},e.prototype.proc_setup=function(e,t){return"TBD(proc_setup)"},e.prototype.push_fixed=function(e){return"TBD(push_fixed)"},e.prototype.push_local=function(e){return"TBD(push_local)"},e.prototype.push_locals=function(e){return"TBD(push_locals)"},e.prototype.pop_fixed=function(e){return"TBD(pop_fixed)"},e.prototype.pop_locals=function(e){return"TBD(pop_locals)"},e.prototype.proc_return=function(){return"TBD(proc_return)"},e.prototype.debugger_stmt=function(e){return""},e.prototype.debugger_bkpt=function(e){return""},e.prototype.debugger_proc=function(e){return""},e.prototype.unconditional_branch=function(e){return"TBD(unconditional_branch)"},e.prototype.beq=function(e){return"TBD(beq)"},e.prototype.bne=function(e){return"TBD(bne)"},e.prototype.cmp=function(e,t){return"TBD(cmp)"},e.prototype.cmp_zero=function(e){return"TBD(cmp_zero)"},e.prototype.arithmetic=function(){return""},e.prototype.load_reg_src_off=function(e,t,r,n,i,a){return"TBD(load_reg_src_off)"},e.prototype.rt_call=function(e,t,r){return"TBD(rt_call)"},e.prototype.call_lbl=function(e,t){return"TBD(call_lbl)"},e.prototype.call_reg=function(e){return"TBD(call_reg)"},e.prototype.helper_prologue=function(){return"TBD(lambda_prologue)"},e.prototype.helper_epilogue=function(){return"TBD(lambda_epilogue)"},e.prototype.pop_clean=function(e){return"TBD"},e.prototype.load_ptr_full=function(e,t){return"TBD(load_ptr_full)"},e.prototype.emit_int=function(e,t){return"TBD(emit_int)"},e.prototype.obj_header=function(e){return".word "+e},e.prototype.string_literal=function(e,t){var r="pxt::string_inline_ascii_vt",n=C.target.utf8?C.U.toUTF8(t,!0):t;if(n!==t){if(16<t.length){r="pxt::string_skiplist16_vt";for(var i=[],a=0,s=0;s+16<=t.length;s+=16)a+=C.U.toUTF8(t.slice(s,s+16),!0).length,i.push(a);return"\n.balign 4\n"+e+": "+this.obj_header(r)+"\n        .short "+n.length+", "+t.length+"\n        .word "+e+"data\n"+e+"data:\n        .short "+i.map(function(e){return e.toString()}).join(", ")+"\n        .string "+o(n)+"\n"}r="pxt::string_inline_utf8_vt"}return"\n.balign 4\n"+e+": "+this.obj_header(r)+"\n        .short "+n.length+"\n        .string "+o(n)+"\n"},e.prototype.hex_literal=function(e,t){return"\n.balign 4\n"+e+": "+this.obj_header("pxt::buffer_vt")+"\n"+r(t)+"\n"},e}();function r(e,t){return void 0===t&&(t=""),"\n                .word "+(e.length>>1)+t+"\n                .hex "+e+(e.length%4==0?"":"00")+"\n        "}C.AssemblerSnippets=e,C.hexLiteralAsm=r,C.numBytes=function(e){for(var t=0,r=e;0<r;r>>>=8)t++;return t||1};var t=function(){function e(e,t,r){var n=this;this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.labelledHelpers={},this.write=function(e){n.resText+=C.asmline(e)},this.t=e,this.bin=t,this.proc=r,this.proc&&this.work()}return e.prototype.emitHelpers=function(){this.emitLambdaTrampoline(),this.emitArrayMethods(),this.emitFieldMethods(),this.emitBindHelper()},e.prototype.redirectOutput=function(e){var t=this.write,r="";this.write=function(e){return r+=C.asmline(e)};try{e()}finally{this.write=t}return r},e.prototype.stackSize=function(){return this.baseStackSize+this.exprStack.length},e.prototype.stackAlignmentNeeded=function(e){if(void 0===e&&(e=0),!C.target.stackAlign)return 0;var t=C.target.stackAlign-(this.stackSize()+e&C.target.stackAlign-1);return t==C.target.stackAlign?0:t},e.prototype.getAssembly=function(){return this.resText},e.prototype.work=function(){var l=this;this.write("\n;\n; Function "+this.proc.getFullName()+"\n;\n"),this.emitLambdaWrapper(this.proc.isRoot);var e=this.proc.label(),u=e+"_bkpt",c=e+"_locals",p=e+"_end";this.write(".section code"),this.write(e+":"),this.proc.classInfo&&this.proc.info.thisParameter&&!C.target.switches.skipClassCheck&&!C.target.switches.noThisCheckOpt&&(this.write("mov r7, lr"),this.write("ldr r0, [sp, #0]"),this.emitInstanceOf(this.proc.classInfo,"validate"),this.write("mov lr, r7")),this.write("\n"+e+"_nochk:\n    @stackmark func\n    @stackmark args\n"),this.proc.fillDebugInfo=function(e){var t=e.getLabels();l.proc.debugInfo={locals:(1==l.proc.seqNo?l.bin.globals:l.proc.locals).map(function(e){return e.getDebugInfo()}),args:l.proc.args.map(function(e){return e.getDebugInfo()}),name:l.proc.getName(),codeStartLoc:C.U.lookup(t,c),codeEndLoc:C.U.lookup(t,p),bkptLoc:C.U.lookup(t,u),localsMark:C.U.lookup(e.stackAtLabel,c),idx:l.proc.seqNo,calls:l.calls};for(var r=0,n=l.calls;r<n.length;r++){var i=n[r];i.addr=C.U.lookup(t,i.callLabel),i.stack=C.U.lookup(e.stackAtLabel,i.callLabel),i.callLabel=void 0}for(var a=0;a<l.proc.body.length;++a){var s=l.proc.body[a].breakpointInfo;if(s){var o=C.U.lookup(e.stackAtLabel,"__brkp_"+s.id);o!==l.proc.debugInfo.localsMark&&(console.log(s),console.log(e.stackAtLabel),C.U.oops("offset doesn't match: "+o+" != "+l.proc.debugInfo.localsMark))}}},this.bin.options.breakpoints&&this.write(this.t.debugger_proc(u)),this.baseStackSize=1;var t=this.proc.locals.length;this.write("push {lr}"),this.write(".locals:\n"),this.proc.perfCounterNo&&(this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::startPerfCounter")),this.write(this.t.proc_setup(t)),this.baseStackSize+=t,this.write("@stackmark locals"),this.write(c+":");for(var r=0;r<this.proc.body.length;++r){var n=this.proc.body[r];switch(n.stmtKind){case C.ir.SK.Expr:this.emitExpr(n.expr);break;case C.ir.SK.StackEmpty:if(0<this.exprStack.length){for(var i=0,a=this.proc.body.slice(r-4,r+1);i<a.length;i++){var s=a[i];console.log("PREVSTMT "+s.toString().trim())}for(var o=0,f=this.exprStack;o<f.length;o++){var d=f[o];console.log("EXPRSTACK "+d.currUses+"/"+d.totalUses+" E: "+d.toString())}C.oops("stack should be empty")}this.write("@stackempty locals");break;case C.ir.SK.Jmp:this.emitJmp(n);break;case C.ir.SK.Label:this.write(n.lblName+":"),this.validateJmpStack(n);break;case C.ir.SK.Breakpoint:if(this.bin.options.breakpoints){var m="__brkp_"+n.breakpointInfo.id;n.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(m)):this.write(this.t.debugger_bkpt(m))}break;default:C.oops()}}C.assert(0<=t&&t<127),0<t&&this.write(this.t.pop_locals(t)),this.proc.perfCounterNo&&(this.write("mov r4, r0"),this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::stopPerfCounter"),this.write("mov r0, r4")),this.write(p+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args"),this.write("; endfun")},e.prototype.mkLbl=function(e){var t=e+this.bin.lblNo++;return"_"!=t[0]&&(t="."+t),t},e.prototype.dumpStack=function(){for(var e="[",t=0,r=this.exprStack;t<r.length;t++){var n=r[t];e+=n.sharingInfo()+": "+n.toString()+"; "}return e+="]"},e.prototype.terminate=function(e){C.assert(e.exprKind==C.ir.EK.SharedRef);var t=e.args[0];C.U.assert(t.currUses!=t.totalUses),C.U.assert(this.exprStack[0]===t,"term at top");for(var r=1;r<this.exprStack.length;){var n=this.exprStack[r];if(n.currUses!=n.totalUses)break;r++}return this.write("@dummystack "+r),this.write(this.t.pop_locals(r)),r},e.prototype.validateJmpStack=function(e,t){void 0===t&&(t=0);var r=this.exprStack.length-t;null==e.lblStackSize?e.lblStackSize=r:e.lblStackSize!=r&&(console.log(e.lblStackSize,r),console.log(this.dumpStack()),C.U.oops("stack misaligned at: "+e.lblName))},e.prototype.emitJmp=function(e){var t=0;if(e.jmpMode==C.ir.JmpMode.Always)e.expr&&this.emitExpr(e.expr),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)+" ; with expression");else{var r=this.mkLbl("jmpz");this.emitExpr(e.expr),(e.expr.exprKind!=C.ir.EK.RuntimeCall||"thumb::subs"!==e.expr.data&&!C.U.startsWith(e.expr.data,"_cmp_"))&&this.write(this.t.cmp_zero("r0")),e.jmpMode==C.ir.JmpMode.IfNotZero?this.write(this.t.beq(r)):this.write(this.t.bne(r)),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)),this.write(r+":")}this.validateJmpStack(e.lbl,t)},e.prototype.clearStack=function(e){void 0===e&&(e=!1);for(var t=0;0<this.exprStack.length&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)t++,this.exprStack.shift();if(t&&this.write(this.t.pop_locals(t)),!e){var r=this.exprStack.filter(function(e){return e.currUses==e.totalUses&&-1!=e.irCurrUses});if(0<r.length){this.write(this.t.reg_gets_imm("r7",0));for(var n=0,i=r;n<i.length;n++){var a=i[n];a.irCurrUses=-1,this.write(this.loadFromExprStack("r7",a,0,!0))}}}},e.prototype.emitExprInto=function(e,t){switch(e.exprKind){case C.ir.EK.NumberLiteral:"number"==typeof e.data?this.write(this.t.emit_int(e.data,t)):C.oops();break;case C.ir.EK.PointerLiteral:this.write(this.t.load_ptr_full(e.data,t));break;case C.ir.EK.SharedRef:var r=e.args[0];C.U.assert(!!r.currUses),C.U.assert(r.currUses<r.totalUses),r.currUses++;var n=this.exprStack.indexOf(r);if(C.U.assert(0<=n),0==n&&r.totalUses==r.currUses)this.write(this.t.pop_fixed([t])+" ; tmpref @"+this.exprStack.length),this.exprStack.shift(),this.clearStack();else{var i=n.toString()+":"+this.exprStack.length;this.write(this.t.load_reg_src_off(t,"sp",i,!0)+" ; tmpref @"+(this.exprStack.length-n))}break;case C.ir.EK.CellRef:var a=e.data;if(a.isGlobal()){var s=this.bitSizeInfo(a.bitSize),o="#"+a.index;(s.needsSignExt||a.index>=s.immLimit)&&(this.write(this.t.emit_int(a.index,t)),o=t),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off(t,"r7",o,!1,!1,s))}else{var l=this.cellref(a),u=l[0],c=l[1],p=l[2];this.write(this.t.load_reg_src_off(t,u,c,p))}break;default:C.oops()}},e.prototype.bitSizeInfo=function(e){var t={size:C.sizeOfBitSize(e),immLimit:128};return 1==t.size?t.immLimit=32:2==t.size&&(t.immLimit=64),1!=e&&3!=e||(t.needsSignExt=!0),t},e.prototype.emitExpr=function(e){var t=this;switch(e.exprKind){case C.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case C.ir.EK.Nop:this.write(this.t.nop());break;case C.ir.EK.FieldAccess:return this.emitExpr(e.args[0]),this.emitFieldAccess(e);case C.ir.EK.Store:return this.emitStore(e.args[0],e.args[1]);case C.ir.EK.RuntimeCall:return this.emitRtCall(e);case C.ir.EK.ProcCall:return this.emitProcCall(e);case C.ir.EK.SharedDef:return this.emitSharedDef(e);case C.ir.EK.Sequence:return e.args.forEach(function(e){return t.emitExpr(e)}),this.clearStack();case C.ir.EK.InstanceOf:return this.emitExpr(e.args[0]),this.emitInstanceOf(e.data,e.jsInfo);default:return this.emitExprInto(e,"r0")}},e.prototype.emitFieldAccess=function(e,t){void 0===t&&(t=!1);var r=e.data;r.classInfo.id,r.name;r.needsCheck&&!C.target.switches.skipClassCheck&&this.emitInstanceOf(r.classInfo,"validate");var n=4*r.idx+4,i="#"+n;124<n&&(this.write(this.t.emit_int(n,"r3")),i="r3"),t?this.write("str r1, [r0, "+i+"]"):this.write("ldr r0, [r0, "+i+"]")},e.prototype.emitClassCall=function(e){var t=this,r=e.virtualIndex+C.firstMethodOffset();this.write(this.t.emit_int(4*r,"r1"));var n=e.classInfo,i="";e.isThis&&(i+="_this"),this.emitLabelledHelper("classCall_"+n.id+i,function(){t.write("ldr r0, [sp, #0] ; ld-this"),t.loadVTable(),C.target.switches.skipClassCheck||e.isThis||t.checkSubtype(n),t.write("ldr r1, [r3, r1] ; ld-method"),t.write("bx r1 ; keep lr from caller"),t.write(".fail:"),t.write(t.t.callCPP("pxt::failedCast"))})},e.prototype.emitBindHelper=function(){this.write("\n                .section code\n                _pxt_bind_helper:\n                    push {r0, r2}\n                    movs r0, #2\n                    ldlit r1, _pxt_bind_lit\n                    "+this.t.callCPP("pxt::mkAction")+"\n                    pop {r1, r2}\n                    str r1, [r0, #12]\n                    str r2, [r0, #16]\n                    bx r4 ; return\n\n                _pxt_bind_lit:\n                    "+this.t.obj_header("pxt::RefAction_vtable")+"\n                    .short 0, 0 ; no captured vars\n                    .word .bindCode@fn\n                .bindCode:\n                    ; r0-bind object, r4-#args\n                    cmp r4, #12\n                    bge .fail\n                    lsls r3, r4, #2\n                    ldlit r2, _pxt_copy_list\n                    ldr r1, [r2, r3]\n\n                    ldr r3, [r0, #12]\n                    ldr r2, [r0, #16]\n                    adds r4, r4, #1\n                    bx r1\n                .fail:\n                    "+this.t.callCPP("pxt::failedCast")+"\n\n                _pxt_copy_list:\n            "),this.write(C.U.range(12).map(function(e){return".word _pxt_bind_"+e+"@fn"}).join("\n"));for(var e=0;e<12;e++){this.write("\n                _pxt_bind_"+e+":\n                    sub sp, #4\n                ");for(var t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+(t+1)+"]"),this.write("str r1, [sp, #4*"+t+"]");this.write("\n                    push {r3} ; this-ptr\n                    mov r1, lr\n                    str r1, [sp, #4*"+(e+1)+"] ; store LR\n                    blx r2\n                    ldr r1, [sp, #4*"+(e+1)+"]\n                    add sp, #8\n                    bx r1\n                ")}},e.prototype.ifaceCallCore=function(e,t,r){void 0===r&&(r=!1),this.write("\n                ldr r2, [r3, #12] ; load mult\n                movs r7, r2\n                beq .objlit ; built-in types have mult=0\n                muls r7, r1\n                lsrs r7, r2\n                lsls r7, r7, #1 ; r7 - hash offset\n                ldr r3, [r3, #4] ; iface table\n                adds r3, r3, r7\n                ; r0-this, r1-method idx, r2-free, r3-hash entry, r4-num args, r7-free\n                ");for(var n=0;n<C.vtLookups;++n)0<n&&this.write("    adds r3, #2"),this.write("\n                ldrh r2, [r3, #0] ; r2-offset of descriptor\n                ldrh r7, [r2, r3] ; r7-method idx\n                cmp r7, r1\n                beq .hit\n                ");"get"==t?(this.write("movs r0, #0 ; undefined"),this.write("bx lr")):this.write("b .fail2"),this.write("\n            .hit:\n                adds r3, r3, r2 ; r3-descriptor\n                ldr r2, [r3, #4]\n                lsls r7, r2, #31\n                beq .field\n            ");var i=this.t.emit_int(e,"r4")+"\n     bx r2";if("set"==t?this.write("\n                    ; check for next descriptor\n                    ldrh r7, [r3, #8]\n                    cmp r7, r1\n                    bne .fail2 ; no setter!\n                    ldr r2, [r3, #12]\n                    "+i+"\n                "):(this.write("\n                    ; check if it's getter\n                    ldrh r7, [r3, #2]\n                    cmp r7, #1\n                "),"get"==t?this.write("\n                        bne .bind\n                        "+i+"\n                    .bind:\n                        mov r4, lr\n                        bl _pxt_bind_helper\n                    "):this.write("\n                        beq .doublecall\n                        "+i+"\n                    .doublecall:\n                        ; call getter\n                        movs r4, #1\n                        push {r0, lr}\n                        blx r2\n                        pop {r1, r2}\n                        mov lr, r2\n                        b .moveArgs\n                    ")),r||(this.write("\n                .objlit:\n                    ldrh r2, [r3, #8]\n                    cmp r2, #"+pxt.BuiltInType.RefMap+"\n                    bne .fail\n                    mov r4, lr\n                "),"set"==t&&this.write("ldr r2, [sp, #4] ; ld-val"),this.write(this.t.callCPP("set"==t?"pxtrt::mapSet":"pxtrt::mapGet")),t?this.write("bx r4"):(this.write("mov lr, r4"),this.write("b .moveArgs"))),this.write(".field:"),"set"==t?this.write("\n                        ldr r3, [sp, #4] ; ld-val\n                        str r3, [r0, r2] ; store field\n                        bx lr\n                    "):"get"==t?this.write("\n                        ldr r0, [r0, r2] ; load field\n                        bx lr\n                    "):this.write("\n                        ldr r0, [r0, r2] ; load field\n                    "),!t){this.write(".moveArgs:");for(n=0;n<e;++n)n==e-1?this.write("movs r1, r0"):this.write("ldr r1, [sp, #4*"+(n+1)+"]"),this.write("str r1, [sp, #4*"+n+"]");this.lambdaCall(e-1)}r&&this.write(".objlit:"),this.write("\n            .fail:\n                "+this.t.callCPP("pxt::failedCast")+"\n            .fail2:\n                "+this.t.callCPP("pxt::missingProperty")+"\n            ")},e.prototype.emitIfaceCall=function(e,t,r){var n=this;void 0===r&&(r=""),C.U.assert(0<e.ifaceIndex),this.write(this.t.emit_int(e.ifaceIndex,"r1")),this.emitLabelledHelper("ifacecall"+t+"_"+r,function(){n.write("ldr r0, [sp, #0] ; ld-this"),n.loadVTable(),n.ifaceCallCore(t,r)})},e.prototype.checkSubtype=function(e,t,r){void 0===t&&(t=".fail"),void 0===r&&(r="r2"),e.classNo?(this.write("ldrh "+r+", [r3, #8]"),this.write("cmp "+r+", #"+e.classNo),e.classNo==e.lastSubtypeNo?this.write("bne "+t):(this.write("blt "+t),this.write("cmp "+r+", #"+e.lastSubtypeNo),this.write("bgt "+t))):this.write("b "+t+" ; always fails; class never instantiated")},e.prototype.loadVTable=function(e,t,r){void 0===e&&(e="r2"),void 0===t&&(t=".fail"),void 0===r&&(r=".fail"),this.write("lsls "+e+", r0, #30"),this.write("bne "+t),this.write("cmp r0, #0"),this.write("beq "+r),this.write("ldr r3, [r0, #0]"),this.write("; vtable in R3")},e.prototype.emitInstanceOf=function(e,t){var r=this,n="inst_"+e.id+"_"+t;this.emitLabelledHelper(n,function(){"validateNullable"==t?r.loadVTable("r2",".tagged",".undefined"):r.loadVTable("r2",".fail",".fail"),r.checkSubtype(e),"bool"==t?(r.write("movs r0, #"+C.taggedTrue),r.write("bx lr"),r.write(".fail:"),r.write("movs r0, #"+C.taggedFalse),r.write("bx lr")):"validate"==t?(r.write("bx lr"),r.write(".fail:"),r.write(r.t.callCPP("pxt::failedCast"))):"validateNullable"==t?(r.write(".undefined:"),r.write("bx lr"),r.write(".tagged:"),r.write("cmp r0, #"+C.taggedNull+" ; check for null"),r.write("bne .fail"),r.write("movs r0, #0"),r.write("bx lr"),r.write(".fail:"),r.write(r.t.callCPP("pxt::failedCast"))):C.U.oops()})},e.prototype.emitSharedDef=function(e){var t=e.args[0];if(C.U.assert(1<=t.totalUses),C.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return this.emitExpr(t);this.emitExpr(t),this.exprStack.unshift(t),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)},e.prototype.clearArgs=function(e,t){e.length,t.length;for(var r=e.concat(t),n=0,i=r;n<i.length;n++){var a=i[n];0==a.currUses&&1==a.totalUses||(console.log(a.toString()),console.log(r.map(function(e){return e.toString()})),C.U.oops("wrong uses: "+a.currUses+" "+a.totalUses)),a.currUses=1}this.clearStack()},e.prototype.builtInClassNo=function(e){return{id:"builtin"+e,classNo:e,lastSubtypeNo:e}},e.prototype.emitBeginTry=function(e){this.emitExprInto(e.args[0],"r0"),this.write("bl _pxt_save_exception_state")},e.prototype.emitRtCall=function(e,t){var u=this;void 0===t&&(t=null);var r=e.data;if("pxt::beginTry"==r)return this.emitBeginTry(e);var n=e.mask||{refMask:0},i=n.conversions||[],a=e.args.map(function(e,t){return{idx:t,expr:e,isSimple:e.isLiteral(),isRef:0!=(n.refMask&1<<t),conv:i.find(function(e){return e.argIdx==t})}});C.U.assert(a.length<=4);for(var s=!1,o=0,l=C.U.reversed(a);o<l.length;o++){(y=l[o]).expr.isPure()?y.isSimple||y.isRef||s&&!y.expr.isStateless()||(y.isSimple=!0):s=!0}for(var c=0,p=a;c<p.length;c++){(y=p[c]).conv&&(y.isSimple=!1)}var f=a.filter(function(e){return!e.isSimple});if(f.every(function(e){return e.expr.isPure()&&!e.isRef&&!e.conv})){for(var d=0,m=f;d<m.length;d++){m[d].isSimple=!0}f=[]}var h=f[0],g=!0;if(1!=f.length||h.conv||h.isRef){for(var v=0,b=f;v<b.length;v++){var y=b[v];this.pushArg(y.expr)}this.alignExprStack(0);var x=f.filter(function(e){return!!e.conv});if(x.length){var k=this.redirectOutput(function(){var e=0;C.target.switches.inlineConversions||(u.t.stackAligned()?e+=2:e+=1);for(var t=0,r=x;t<r.length;t++){var n=r[t];if(C.isThumb()&&"pxt::toInt"==n.conv.method){u.write(u.loadFromExprStack("r0",n.expr,e)),u.write("asrs r0, r0, #1");var i=C.target.switches.inlineConversions?n.expr.getId():e;u.write("bcs .isint"+i),u.write("lsls r0, r0, #1"),u.alignedCall(n.conv.method,"",e),u.write(".isint"+i+":"),u.write(u.t.push_fixed(["r0"]))}else u.write(u.loadFromExprStack("r0",n.expr,e)),n.conv.refTag?C.target.switches.skipClassCheck||u.emitInstanceOf(u.builtInClassNo(n.conv.refTag),n.conv.refTagNullable?"validateNullable":"validate"):(u.alignedCall(n.conv.method,"",e),n.conv.returnsRef&&u.write(u.loadFromExprStack("r0",n.expr,e,!0))),u.write(u.t.push_fixed(["r0"]));e++}for(var a=0,s=C.U.reversed(x);a<s.length;a++){n=s[a];e--,u.write(u.t.pop_fixed(["r"+n.idx]))}for(var o=0,l=f;o<l.length;o++){(n=l[o]).conv||u.write(u.loadFromExprStack("r"+n.idx,n.expr,e))}});C.target.switches.inlineConversions?this.write(k):this.emitHelper(this.t.helper_prologue()+k+this.t.helper_epilogue(),"conv")}else for(var S=0,T=f;S<T.length;S++){y=T[S];this.write(this.loadFromExprStack("r"+y.idx,y.expr))}}else this.emitExpr(h.expr),0!=h.idx&&this.write(this.t.mov("r"+h.idx,"r0")),g=!1;for(var w=0,I=a;w<I.length;w++){(y=I[w]).isSimple&&this.emitExprInto(y.expr,"r"+y.idx)}t?t():"langsupp::ignore"!=r&&this.alignedCall(r,"",0,!0),g&&this.clearArgs(f.filter(function(e){return!e.isRef}).map(function(e){return e.expr}),f.filter(function(e){return e.isRef}).map(function(e){return e.expr}))},e.prototype.alignedCall=function(e,t,r,n){void 0===t&&(t=""),void 0===r&&(r=0),void 0===n&&(n=!1),(C.U.startsWith(e,"_cmp_")||C.U.startsWith(e,"_pxt_"))&&(n=!1),this.write(this.t.call_lbl(e,n,this.stackAlignmentNeeded(r))+t)},e.prototype.emitLabelledHelper=function(e,t){if(this.labelledHelpers[e])this.write(this.t.call_lbl(this.labelledHelpers[e]));else{var r=this.redirectOutput(t);this.emitHelper(r,e),this.labelledHelpers[e]=this.bin.codeHelpers[r]}},e.prototype.emitHelper=function(e,t){if(void 0===t&&(t="hlp"),!this.bin.codeHelpers[e]){var r=Object.keys(this.bin.codeHelpers).length;this.bin.codeHelpers[e]="_"+t+"_"+r}this.write(this.t.call_lbl(this.bin.codeHelpers[e]))},e.prototype.pushToExprStack=function(e){e.totalUses=1,e.currUses=0,this.exprStack.unshift(e)},e.prototype.pushArg=function(e){this.clearStack(!0);this.exprStack.length;this.emitExpr(e),this.clearStack(!0),this.write(this.t.push_local("r0")+" ; proc-arg"),this.pushToExprStack(e)},e.prototype.loadFromExprStack=function(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=!1);var i=this.exprStack.indexOf(t);return C.assert(0<=i),this.t.load_reg_src_off(e,"sp",(i+r).toString(),!0,n)+" ; estack\n"},e.prototype.pushDummy=function(){var e=C.ir.numlit(0);e.totalUses=1,e.currUses=1,this.exprStack.unshift(e)},e.prototype.alignExprStack=function(e){var t=this.stackAlignmentNeeded(e);if(t)for(var r=0;r<t;++r)this.write("push {r5} ; align"),this.pushDummy()},e.prototype.emitFieldMethods=function(){for(var e=0,t=["get","set"];e<t.length;e++){var r=t[e];this.write("\n                .section code\n                _pxt_map_"+r+":\n                "),this.loadVTable("r4"),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefMap),".notmap","r4"),this.write(this.t.callCPPPush("set"==r?"pxtrt::mapSetByString":"pxtrt::mapGetByString")),this.write(".notmap:");var n="set"==r?2:1,i=!1;this.write("mov r4, r3 ; save VT"),"set"==r?(C.target.stackAlign&&(i=!0,this.write("push {lr} ; align")),this.write("\n                            push {r0, r2, lr}\n                            mov r0, r1\n                        ")):this.write("\n                            push {r0, lr}\n                            mov r0, r1\n                        "),this.write("\n                    bl pxtrt::lookupMapKey\n                    mov r1, r0 ; put key index in r1\n                    ldr r0, [sp, #0] ; restore obj pointer\n                    mov r3, r4 ; restore vt\n                    bl .dowork\n                "),this.write(this.t.pop_locals(n+(i?1:0))),this.write("pop {pc}"),this.write(".dowork:"),this.ifaceCallCore(n,r,!0)}},e.prototype.emitArrayMethod=function(e,t){this.write("\n            .section code\n            _pxt_"+(t?"buffer":"array")+"_"+e+":\n            "),this.loadVTable("r4");var r=this.builtInClassNo(t?pxt.BuiltInType.BoxedBuffer:pxt.BuiltInType.RefCollection);C.target.switches.skipClassCheck||this.checkSubtype(r,".fail","r4");var n=C.isStackMachine()||C.target.runtimeIsARM||t?"ldr":"ldrh";this.write("\n                asrs r1, r1, #1\n                bcc .notint\n                "+n+" r4, [r0, #"+(t?4:8)+"]\n                cmp r1, r4\n                bhs .oob\n            ");var i="r1";t?(i="#8",this.write("\n                    adds r4, r0, r1\n                ")):this.write("\n                    lsls r1, r1, #2\n                    ldr r4, [r0, #4]\n                ");var a=t?"b":"",s=t&&"get"==e?"lsls r0, r0, #1\nadds r0, #1":"";"set"==e?this.write("\n                        str"+a+" r2, [r4, "+i+"]\n                        bx lr\n                    "):this.write("\n                        ldr"+a+" r0, [r4, "+i+"]\n                        "+s+"\n                        bx lr\n                    "),this.write("\n            .notint:\n                lsls r1, r1, #1\n                "+this.t.pushLR()+"\n                push {r0, r2}\n                mov r0, r1\n                "+this.t.callCPP("pxt::toInt")+"\n                mov r1, r0\n                pop {r0, r2}\n            .doop:\n                "+this.t.callCPP("Array_::"+e+"At")+"\n                "+s+"\n                "+this.t.popPC()+"\n\n            .fail:\n                bl pxt::failedCast\n            "),"get"==e?this.write("\n                    .oob:\n                        movs r0, #"+(t?1:0)+" ; 0 or undefined\n                        bx lr\n                "):this.write("\n                    .oob:\n                        "+this.t.pushLR()+"\n                        b .doop\n                ")},e.prototype.emitArrayMethods=function(){for(var e=0,t=["get","set"];e<t.length;e++){var r=t[e];this.emitArrayMethod(r,!0),this.emitArrayMethod(r,!1)}},e.prototype.emitLambdaTrampoline=function(){var e=C.target.stackAlign?"r3,":"";this.write("\n            .section code\n            _pxt_lambda_trampoline:\n                push {"+e+" r4, r5, r6, r7, lr}\n                mov r4, r8\n                mov r5, r9\n                mov r6, r10\n                mov r7, r11\n                push {r4, r5, r6, r7} ; save high registers\n                mov r4, r1\n                mov r5, r2\n                mov r6, r3\n                mov r7, r0\n                "),this.emitInstanceOf(this.builtInClassNo(pxt.BuiltInType.RefAction),"validate"),this.write("\n                mov r0, sp\n                push {r4, r5, r6, r7} ; push args and the lambda\n                mov r1, sp\n                bl pxt::pushThreadContext\n                mov r6, r0          ; save ctx or globals\n                mov r5, r7          ; save lambda for closure\n                mov r0, r5          ; also save lambda pointer in r0 - needed by pxt::bindMethod\n                ldr r1, [r5, #8]    ; ld fnptr\n                movs r4, #3         ; 3 args\n                blx r1              ; execute the actual lambda\n                mov r7, r0          ; save result\n                @dummystack 4\n                add sp, #4*4        ; remove arguments and lambda\n                mov r0, r6   ; or pop the thread context\n                bl pxt::popThreadContext\n                mov r0, r7 ; restore result\n                pop {r4, r5, r6, r7} ; restore high registers\n                mov r8, r4\n                mov r9, r5\n                mov r10, r6\n                mov r11, r7\n                pop {"+e+" r4, r5, r6, r7, pc}"),this.write("\n            .section code\n            ; r0 - try frame\n            ; r1 - handler PC\n            _pxt_save_exception_state:\n                push {r0, lr}\n                "+this.t.callCPP("pxt::beginTry")+"\n                pop {r1, r4}\n                str r1, [r0, #1*4] ; PC\n                mov r1, sp\n                str r1, [r0, #2*4] ; SP\n                str r5, [r0, #3*4] ; lambda ptr\n                bx r4\n                "),this.write("\n            .section code\n            ; r0 - try frame\n            ; r1 - thread context\n            _pxt_restore_exception_state:\n                mov r6, r1\n                ldr r1, [r0, #2*4] ; SP\n                mov sp, r1\n                ldr r5, [r0, #3*4] ; lambda ptr\n                ldr r1, [r0, #1*4] ; PC\n                movs r0, #1\n                orrs r1, r0\n                bx r1\n                "),this.write("\n            .section code\n            _pxt_stringConv:\n            "),this.loadVTable(),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.BoxedString),".notstring"),this.write("\n                bx lr\n\n            .notstring: ; no string, but vtable in r3\n                ldr r7, [r3, #4*"+(C.firstMethodOffset()-1)+"]\n                cmp r7, #0\n                beq .fail\n                push {r0, lr}\n                movs r4, #1\n                blx r7\n                str r0, [sp, #0]\n                b .numops\n\n            .fail: ; not an object or no toString\n                push {r0, lr}\n            .numops:\n                "+this.t.callCPP("numops::toString")+"\n                pop {r1}\n                pop {pc}\n            ")},e.prototype.emitProcCall=function(e){var t=this,r=[],n=null,i="",a=e.data;if(a.proc&&a.proc.inlineBody)return this.emitExpr(a.proc.inlineSelf(e.args));for(var s=-1==a.virtualIndex,o=!1,l=0,u=C.U.reversed(e.args);l<u.length;l++){if((y=u[l]).isPure()){if(!o||y.isStateless())continue}else o=!0;r.push(y)}if(r.reverse(),r.length<=1){var c=r[0];c&&(n=c,this.clearStack(!0),this.emitExpr(c),c==e.args[e.args.length-1]?i="r0":(i="r3",this.write(this.t.mov("r3","r0")))),r=[]}else for(var p=0,f=r;p<f.length;p++){var d=f[p];this.pushArg(d)}this.alignExprStack(e.args.length);var m=["r1","r2","r3","r4"],h=[];if(r.length){for(var g=-1,v=0,b=r;v<b.length;v++){var y=b[v];g=Math.max(this.exprStack.indexOf(y),g)}if(++g<=m.length){m=m.slice(0,g),this.write(this.t.pop_fixed(m)),h=this.exprStack.splice(0,g);for(var x=[],k=g-1;0<=k;--k)r.indexOf(h[k])<0&&(x.push(m[k]),this.exprStack.unshift(h[k]));x.length&&this.write(this.t.push_fixed(x))}else m=null,this.write(this.t.reg_gets_imm("r7",0))}var S=C.U.reversed(e.args);s&&S.unshift(S.pop());for(var T=0,w=S;T<w.length;T++){d=w[T];if(0<=r.indexOf(d)){if(m)this.write(this.t.push_fixed([m[h.indexOf(d)]]));else{this.write(this.loadFromExprStack("r0",d)),this.write(this.t.push_local("r0")+" ; re-push"),this.write(this.loadFromExprStack("r7",d,1,!0));var I=this.exprStack.indexOf(d),E=C.ir.numlit(0);E.currUses=1,E.totalUses=1,this.exprStack[I]=E}this.exprStack.unshift(d)}else d===n?(this.write(this.t.push_local(i)+" ; the one arg"),this.pushToExprStack(d)):this.pushArg(d)}var N=this.mkLbl("_proccall"),_=-1;if(s){var K=e.args.length-1;this.write(this.loadFromExprStack("r0",e.args[0])),this.emitLabelledHelper("lambda_call"+K,function(){t.lambdaCall(K),t.write(".fail:"),t.write(t.t.callCPP("pxt::failedCast"))})}else if(null!=a.virtualIndex||null!=a.ifaceIndex)null!=a.ifaceIndex?a.isSet?(C.assert(2==e.args.length),this.emitIfaceCall(a,e.args.length,"set")):this.emitIfaceCall(a,e.args.length,a.noArgs?"get":""):this.emitClassCall(a),this.write(N+":");else{var A=a.proc;_=A.seqNo,this.write(this.t.call_lbl(A.label()+(a.isThis?"_nochk":""))),this.write(N+":")}this.calls.push({procIndex:_,stack:0,addr:0,callLabel:N}),s&&e.args[0].isStateless()?this.clearArgs([e.args[0]],e.args.slice(1)):this.clearArgs([],e.args)},e.prototype.lambdaCall=function(e){this.write("; lambda call"),this.loadVTable(),C.target.switches.skipClassCheck||this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefAction)),this.write("\n                movs r4, #"+e+"\n                ldrh r1, [r0, #4]\n                cmp r1, #0\n                bne .pushR5\n                ldr r1, [r0, #8]\n                bx r1 ; keep lr from the caller\n            .pushR5:\n                sub sp, #8\n            ");for(var t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+(t+2)+"]"),this.write("str r1, [sp, #4*"+t+"]");this.write("\n                str r5, [sp, #4*"+e+"]\n                mov r1, lr\n                str r1, [sp, #4*"+(e+1)+"]\n                mov r5, r0\n                ldr r7, [r5, #8]\n                blx r7 ; exec actual lambda\n                ldr r4, [sp, #4*"+(e+1)+"] ; restore what was in LR\n                ldr r5, [sp, #4*"+e+"] ; restore lambda ctx\n            ");for(t=0;t<e;++t)this.write("ldr r1, [sp, #4*"+t+"]"),this.write("str r1, [sp, #4*"+(t+2)+"]");this.write("\n                add sp, #8\n                bx r4\n            "),this.write("; end lambda call")},e.prototype.emitStore=function(e,t){var r=this;switch(e.exprKind){case C.ir.EK.CellRef:var n=e.data;if(this.emitExpr(t),n.isGlobal()){var i=this.bitSizeInfo(n.bitSize),a="#"+n.index;n.index>=i.immLimit&&(this.write(this.t.emit_int(n.index,"r1")),a="r1"),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off("r0","r7",a,!1,!0,i))}else{var s=this.cellref(n),o=s[0],l=s[1];a=s[2];this.write(this.t.load_reg_src_off("r0",o,l,a,!0))}break;case C.ir.EK.FieldAccess:this.emitRtCall(C.ir.rtcall("dummy",[e.args[0],t]),function(){return r.emitFieldAccess(e,!0)});break;default:C.oops()}},e.prototype.cellref=function(e){if(e.isGlobal())throw C.oops();if(e.iscap){var t=e.index+3;return C.assert(0<=t&&t<32),["r5",t.toString(),!0]}return e.isarg?["sp","args@"+(t=e.index).toString()+":"+this.baseStackSize,!1]:["sp","locals@"+e.index,!1]},e.prototype.emitLambdaWrapper=function(e){var t=this;if(this.write(""),this.write(".section code"),this.write(".balign 4"),e&&(this.proc.info.usedAsValue=!0),this.proc.info.usedAsValue||this.proc.info.usedAsIface){this.proc.info.usedAsValue&&(this.write(this.proc.label()+"_Lit:"),this.write(this.t.obj_header("pxt::RefAction_vtable")),this.write(".short 0, 0 ; no captured vars"),this.write(".word "+this.proc.label()+"_args@fn")),this.write(this.proc.label()+"_args:");var r=this.proc.args.length;if(0!=r){this.write("cmp r4, #"+r),this.write("bge "+this.proc.label()+"_nochk");var n=this.stackAlignmentNeeded(r+1),i=n?r+2:r+1;this.write("push {lr}"),this.emitLabelledHelper("expand_args_"+r,function(){t.write("movs r0, #0"),t.write("movs r1, #0"),n&&t.write("push {r0}");for(var e=r;0<e;e--)e!=r&&(t.write("cmp r4, #"+e),t.write("blt .zero"+e),t.write("ldr r0, [sp, #"+(i-1)+"*4]"),t.write("str r1, [sp, #"+(i-1)+"*4] ; clear existing"),t.write(".zero"+e+":")),t.write("push {r0}");t.write("bx lr")}),this.write("bl "+this.proc.label()+"_nochk");var a=r+(n?1:0);this.write("@dummystack "+a),this.write("add sp, #4*"+a),this.write("pop {pc}")}}},e.prototype.emitCallRaw=function(e){var t=C.hexfile.lookupFunc(e);C.assert(!!t,"unimplemented raw function: "+e),this.alignedCall(e)},e}();C.ProctoAssembler=t}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(C){var U={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::bnot":"~","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!="},g={"pxsim.Boolean_":"","pxsim.pxtcore":"","pxsim.String_":"","pxsim.ImageMethods":"","pxsim.Array_":"","pxsim.pxtrt":"","pxsim.numops":""},v={"pxsim.Array_.getAt":"","pxsim.Array_.length":"","pxsim.Array_.mk":"","pxsim.Array_.push":"","pxsim.Boolean_.bang":"","pxsim.String_.concat":"","pxsim.String_.stringConv":"","pxsim.numops.toBool":"","pxsim.numops.toBoolDecr":"","pxsim.pxtcore.mkAction":"","pxsim.pxtcore.mkClassInstance":"","pxsim.pxtrt.ldlocRef":"","pxsim.pxtrt.mapGetByString":"","pxsim.pxtrt.stclo":"","pxsim.pxtrt.stlocRef":""};function b(e){for(var t="",r=0,n=Object.keys(e);r<n.length;r++){var i=n[r],a=i.replace(/\./g,"_");t+="const "+(e[i]=a)+" = "+i+";\n"}return t}function P(e){"pxt."==(e=e.replace(/::/g,".")).slice(0,4)&&(e="pxtcore."+e.slice(4));var t="pxsim."+e;if(v.hasOwnProperty(t))return v[t];var r=t.lastIndexOf(".");if(0<r){var n=t.slice(0,r);if(g.hasOwnProperty(n))return g[n]+t.slice(r)}return t}C.isBuiltinSimOp=function(e){return!!C.U.lookup(U,e.replace(/\./g,"::"))},C.shimToJs=P;var y=["runtime","oops","doNothing","pxsim","globals","maybeYield","setupDebugger","isBreakFrame","breakpoint","trace","checkStack","leave","checkResumeConsumed","setupResume","setupLambda","checkSubtype","failedCast","buildResume","mkVTable","bind","leaveAccessor"];C.jsEmit=function(r){for(var n="(function (ectx) {\n'use strict';\n",e=0,t=y;e<t.length;e++){var i=t[e];n+="const "+i+" = ectx."+i+";\n"}n+="const __this = runtime;\n",n+="const pxtrt = pxsim.pxtrt;\n",n+="let yieldSteps = 1;\n",n+="ectx.setupYield(function() { yieldSteps = 100; })\n",n+="pxsim.setTitle("+JSON.stringify(r.getTitle())+");\n";for(var a={},s={},o=0,l=r.res.configData||[];o<l.length;o++){var u=l[o];a[u.key+""]=u.value,s[u.name]=u.key}n+="pxsim.setConfigData("+JSON.stringify(a,null,1)+", "+JSON.stringify(s,null,1)+");\n",n+="pxtrt.mapKeyNames = "+JSON.stringify(r.ifaceMembers,null,1)+";\n";var c=r.setPerfCounters(["SysScreen"]);n+="__this.setupPerfCounters("+JSON.stringify(c,null,1)+");\n",n+=b(v),n+=b(g);var p=0,f=0;r.procs.forEach(function(e){var t;e.cachedJS?(t=e.cachedJS,p+=t.length):(t=function(g,v){if(v.cachedJS)return v.cachedJS;var t="",b=function(e){t+=e+"\n"},y=function(e){t+="    "+e+"\n"},s=C.ir.EK,x=[],n=0,r={},i="";b("\nfunction "+v.label()+"(s) {\nlet r0 = s.r0, step = s.pc;\ns.pc = -1;\n"),v.perfCounterNo&&b("if (step == 0) __this.startPerfCounter("+v.perfCounterNo+");\n"),b("\nwhile (true) {\nif (yieldSteps-- < 0 && maybeYield(s, step, r0) || runtime !== pxsim.runtime) return null;\nswitch (step) {\n  case 0:\n"),v.locals.forEach(function(e){y(T(e)+" = undefined;")}),v.args.length&&(y("if (s.lambdaArgs) {"),v.args.forEach(function(e,t){y("  "+T(e)+" = (s.lambdaArgs["+t+"]);")}),y("  s.lambdaArgs = null;"),y("}")),v.classInfo&&v.info.thisParameter&&(y("r0 = s.arg0;"),K(v.classInfo,"validate"));for(var k=0,o=[],e=0,a=v.body;e<a.length;e++){var l=a[e];l.stmtKind==C.ir.SK.Label&&0<l.lblNumUses&&(l.lblId=++k)}for(var u=0,c=0,p=v.body;c<p.length;c++){var l=p[c];switch(l.stmtKind){case C.ir.SK.Expr:N(l.expr);break;case C.ir.SK.StackEmpty:A();break;case C.ir.SK.Jmp:for(var f=!1,d=u+1;d<v.body.length&&v.body[d].stmtKind==C.ir.SK.Label;++d)if(l.lbl==v.body[d]){f=!0;break}w(l,f);break;case C.ir.SK.Label:0<l.lblNumUses&&b("  case "+l.lblId+":");break;case C.ir.SK.Breakpoint:h(l);break;default:C.oops()}u++}A(),v.perfCounterNo&&b("__this.stopPerfCounter("+v.perfCounterNo+");\n"),v.isGetter()?y("return leaveAccessor(s, r0)"):y("return leave(s, r0)"),b("  default: oops()"),b("} } }");var m=C.nodeLocationInfo(v.action);return m.functionName=v.getName(),m.argumentNames=v.args&&v.args.map(function(e){return e.getName()}),b(v.label()+".info = "+JSON.stringify(m)),v.isGetter()&&b(v.label()+".isGetter = true;"),v.isRoot&&b(v.label()+".continuations = [ "+o.join(",")+" ]"),b(S(v.label()+"_mk",v.label(),n,Object.keys(r))),b(i),v.cachedJS=t;function S(e,t,r,n){var i="";i+="\nfunction "+e+"(s) {\n    checkStack(s.depth);\n    return {\n        parent: s, fn: "+t+", depth: s.depth + 1,\n        pc: 0, retval: undefined, r0: undefined, overwrittenPC: false, lambdaArgs: null,\n";for(var a=0;a<r;++a)i+="  tmp_"+a+": undefined,\n";for(var s=0,o=n;s<o.length;s++){var l=o[s];i+="  "+l+": undefined,\n"}return i+="} }\n"}function h(e){var t,r=e.breakpointInfo.id;if(y("s.lastBrkId = "+r+";"),g.options.breakpoints){var n="return breakpoint(s, "+(t=++k)+", "+r+", r0);";e.breakpointInfo.isDebuggerStmt?y(n):(y("if ((breakpoints[0] && isBreakFrame(s)) || breakpoints["+r+"]) "+n),g.options.trace&&y("else return trace("+r+", s, "+t+", "+v.label()+".info);"))}else{if(!g.options.trace)return;t=++k,y("return trace("+r+", s, "+t+", "+v.label()+".info);")}b("  case "+t+":")}function T(e){if(e.isGlobal())return"globals."+e.uniqueName();if(e.iscap)return"s.caps["+e.index+"]";var t=e.uniqueName();return r[t]=!0,"s."+t}function w(e,t){if(e.lbl.lblNumUses==C.ir.lblNumUsesJmpNext||t)return C.assert(e.jmpMode==C.ir.JmpMode.Always),void(e.expr&&N(e.expr));C.assert(0<e.lbl.lblNumUses);var r="{ step = "+e.lbl.lblId+"; continue; }";e.jmpMode==C.ir.JmpMode.Always?(e.expr&&N(e.expr),y(r)):(N(e.expr),e.jmpMode==C.ir.JmpMode.IfNotZero?y("if (r0) "+r):y("if (!r0) "+r))}function I(e){return function(e){switch(e.exprKind){case s.NumberLiteral:case s.PointerLiteral:case s.SharedRef:case s.CellRef:return!0;default:return!1}}(e)?E(e):(N(e),"r0")}function E(e){switch(e.exprKind){case s.NumberLiteral:if(!0===e.data)return"true";if(!1===e.data)return"false";if(null===e.data)return"null";if(void 0===e.data)return"undefined";if("number"==typeof e.data)return e.data+"";throw C.oops("invalid data: "+typeof e.data);case s.PointerLiteral:if(e.ptrlabel())return e.ptrlabel().lblId+"";if(null!=e.hexlit())return i+="const "+e.data+' = pxsim.BufferMethods.createBufferFromHex("'+e.hexlit()+'")\n',e.data;if("string"==typeof e.jsInfo)return e.jsInfo;C.U.oops();case s.SharedRef:var t=e.args[0];C.U.assert(!!t.currUses),C.U.assert(t.currUses<t.totalUses),t.currUses++;var r=x.indexOf(t);return C.U.assert(0<=r),"s.tmp_"+r;case s.CellRef:var n=e.data;return T(n);default:throw C.oops()}}function N(e){switch(e.exprKind){case s.JmpValue:y("// jmp value (already in r0)");break;case s.Nop:y("// nop");break;case s.FieldAccess:var t=e.data,r=t.shimName,n=I(e.args[0]);return r?void y("r0 = "+n+r+";"):void y("r0 = "+n+'.fields["'+t.name+'"];');case s.Store:return function(e,t){switch(e.exprKind){case s.CellRef:var r=e.data,n=I(t);y(T(r)+" = "+function(e){switch(e){case 0:return"";case 1:return"pxtrt.toInt8";case 3:return"pxtrt.toInt16";case 5:return"pxtrt.toInt32";case 2:return"pxtrt.toUInt8";case 4:return"pxtrt.toUInt16";case 6:return"pxtrt.toUInt32";default:throw C.oops()}}(r.bitSize)+"("+n+");");break;case s.FieldAccess:var i=e.data,a=i.shimName;a||(a='.fields["'+i.name+'"]'),N(C.ir.rtcall("="+a,[e.args[0],t]));break;default:C.oops()}}(e.args[0],e.args[1]);case s.RuntimeCall:return function(e){var t=C.ir.flattenArgs(e.args);t.precomp.forEach(N);var r=e.data,n=t.flattened.map(E);if("langsupp::ignore"!=r){var i="";if(i="."==r[0]?""+n[0]+r+"("+n.slice(1).join(", ")+")":"="==r[0]?"("+n[0]+")"+r.slice(1)+" = ("+n[1]+")":C.U.startsWith(r,"new ")?"new "+P(r.slice(4))+"("+n.join(", ")+")":C.U.lookup(U,r)?2==n.length?"("+n[0]+" "+C.U.lookup(U,r)+" "+n[1]+")":"("+C.U.lookup(U,r)+" "+n[0]+")":P(r)+"("+n.join(", ")+")",0==e.callingConvention)y("r0 = "+i+";");else{var a=++k;o.push(a),"String_::stringConv"==r&&y("if (("+n[0]+") && ("+n[0]+").vtable) {"),2==e.callingConvention?y("(function(cb) { "+i+".done(cb) })(buildResume(s, "+a+"));"):(y("setupResume(s, "+a+");"),y(i+";")),y("checkResumeConsumed();"),y("return;"),"String_::stringConv"==r&&y("} else { s.retval = ("+n[0]+') + ""; }'),b("  case "+a+":"),y("r0 = s.retval;")}}}(e);case s.ProcCall:return function(e){var t=e.data,r=t.proc;if(r&&r.inlineBody)return N(r.inlineSelf(e.args));var n=C.ir.rtcall("<frame>",[]);n.totalUses=1,n.currUses=0;var i=x.length;x.push(n);var a="s.tmp_"+i,s=++k,o=-1==t.virtualIndex;if(r)y(a+" = "+r.label()+"_mk(s);");else{var l="generic";null!=t.ifaceIndex?l="if_"+g.ifaceMembers[t.ifaceIndex]:o?l="lambda":null!=t.virtualIndex?l=t.classInfo.id+"_v"+t.virtualIndex:C.U.oops();var u=e.args.length;l+="_"+u+"_mk",g.recordHelper(v.usingCtx,l,function(){var e=C.U.range(u).map(function(e){return"arg"+e});return S(l,"null",5,e)}),y(a+" = "+l+"(s);")}e.args.forEach(function(e,t){var r="arg"+t;o&&(r=0==t?"argL":"arg"+(t-1)),y(a+"."+r+" = "+I(e)+";")});var c="s.pc = "+s+"; return "+a+";";if(null!=t.callLocationIndex&&(c="s.callLocIdx = "+t.callLocationIndex+"; "+c),null!=t.ifaceIndex){C.U.assert(null==r);var p=g.ifaceMembers[t.ifaceIndex];C.U.assert(!!p,"no name for "+t.ifaceIndex),y("if (!"+a+".arg0.vtable.iface) {");var f=e.args.map(function(e,t){return a+".arg"+t});f.splice(1,0,JSON.stringify(p));var d="pxsim_pxtrt.map"+(t.isSet?"Set":"Get")+"ByString";t.noArgs?y("  s.retval = "+d+"("+f.join(", ")+");"):(C.U.assert(!t.isSet),y("  setupLambda("+a+", "+d+"("+f.slice(0,2).join(", ")+"), "+e.args.length+");"),y("  "+c)),y("} else {"),y("  "+a+".fn = "+a+'.arg0.vtable.iface["'+(t.isSet?"set/":"")+p+'"];');var m=a+'.arg0.fields["'+p+'"]';t.isSet?(y("  if ("+a+".fn === null) { "+m+" = "+a+".arg1; }"),y("  else if ("+a+".fn === undefined) { failedCast("+a+".arg0) } ")):t.noArgs?(y("  if ("+a+".fn == null) { s.retval = "+m+"; }"),y("  else if (!"+a+".fn.isGetter) { s.retval = bind("+a+"); }")):(y("  if ("+a+".fn == null) { setupLambda("+a+", "+m+", "+e.args.length+"); "+c+" }"),y("  else if ("+a+".fn.isGetter) { "+a+".stage2Call = true; "+c+"; }")),y(" else { "+c+" }"),y("}"),c=""}else if(-1==t.virtualIndex)C.U.assert(null==r),y("setupLambda("+a+", "+a+".argL);");else if(null!=t.virtualIndex){C.U.assert(null==r),C.assert(0<=t.virtualIndex),K(t.classInfo,"validate",a+".arg0");var h=t.classInfo.vtable[t.virtualIndex];y(a+".fn = "+a+".arg0.vtable.methods."+h.getName()+";")}else C.U.assert(null!=r);c&&y(c),b("  case "+s+":"),y("r0 = s.retval;"),n.currUses=1}(e);case s.SharedDef:return function(e){var t=e.args[0];if(C.U.assert(1<=t.totalUses),C.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return N(t);var r=x.length;x.push(t);var n=I(t);"r0"!=n&&(n="r0 = "+n),y("s.tmp_"+r+" = "+n+";")}(e);case s.Sequence:return e.args.forEach(N);case s.InstanceOf:return N(e.args[0]),void K(e.data,e.jsInfo);default:y("r0 = "+E(e)+";")}}function _(e,t){void 0===t&&(t="r0");var r=e.id+"_VT";return"checkSubtype("+t+", "+r+")"}function K(e,t,r){void 0===r&&(r="r0"),"bool"==t?y("r0 = "+_(e)+";"):"validate"==t?y("if (!"+_(e,r)+") failedCast("+r+");"):C.U.oops()}function A(){for(var e=0,t=x;e<t.length;e++){var r=t[e];r.totalUses!==r.currUses&&C.oops()}n=Math.max(x.length,n),x=[]}}(r,e),f+=t.length),n+="\n"+t+"\n"}),n+=C.U.values(r.codeHelpers).join("\n")+"\n",r.usedClassInfos.forEach(function(e){n+=function(e){C.U.assert(void 0!==e.classNo),C.U.assert(void 0!==e.lastSubtypeNo);var t=parseInt(e.attrs.maxBgInstances);t||(t=null);for(var r="const "+e.id+"_VT = mkVTable({\n  name: "+JSON.stringify(C.getName(e.decl))+",\n  numFields: "+e.allfields.length+",\n  classNo: "+e.classNo+",\n  lastSubtypeNo: "+e.lastSubtypeNo+",\n  maxBgInstances: "+t+",\n  methods: {\n",n=0,i=e.vtable;n<i.length;n++)r+='    "'+(o=i[n]).getName()+'": '+o.label()+",\n";r+="  },\n",r+="  iface: {\n";for(var a=0,s=e.itable;a<s.length;a++){var o;r+='    "'+(o=s[a]).name+'": '+(o.proc?o.proc.label():"null")+",\n",o.setProc?r+='    "set/'+o.name+'": '+o.setProc.label()+",\n":o.proc||(r+='    "set/'+o.name+'": null,\n')}return r+="  },\n",e.toStringMethod&&(r+="  toStringMethod: "+e.toStringMethod.label()+",\n"),r+="});\n"}(e)}),r.res.breakpoints&&(n+="\nconst breakpoints = setupDebugger("+r.res.breakpoints.length+", ["+r.globals.filter(function(e){return e.isUserVariable}).map(function(e){return'"'+e.uniqueName()+'"'}).join(",")+"])\n");var d=(n+="\nreturn "+(r.procs[0]?r.procs[0].label():"null")+"\n})\n").length,m=function(e){return(100*e/d).toFixed(2)+"%"},h="// total="+n.length+" new="+m(f)+" cached="+m(p)+" other="+m(d-f-p)+"\n";r.writeFile(C.BINARY_JS,h+n)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(m){m.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};var i={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::eors":"_numops_eors","numops::ands":"_numops_ands","numops::lsls":"_numops_lsls","numops::asrs":"_numops_asrs","numops::lsrs":"_numops_lsrs","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt"},e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.stackAligned=function(){return m.target.stackAlign&&1<m.target.stackAlign},t.prototype.pushLR=function(){return this.stackAligned()?"push {lr, r5}  ; r5 for align":"push {lr}"},t.prototype.popPC=function(){return this.stackAligned()?"pop {pc, r5}  ; r5 for align":"pop {pc}"},t.prototype.nop=function(){return"nop"},t.prototype.mov=function(e,t){return"mov "+e+", "+t},t.prototype.helper_ret=function(){return"bx r4"},t.prototype.reg_gets_imm=function(e,t){return"movs "+e+", #"+t},t.prototype.push_fixed=function(e){return"push {"+e.join(", ")+"}"},t.prototype.pop_fixed=function(e){return"pop {"+e.join(", ")+"}"},t.prototype.proc_setup=function(e,t){var r="";if(0<e){r+="    movs r0, #0\n";for(var n=0;n<e;++n)r+="    push {r0} ;loc\n"}return r},t.prototype.proc_return=function(){return"pop {pc}"},t.prototype.debugger_stmt=function(e){return m.oops(),"\n    @stackempty locals\n    ldr r0, [r6, #0] ; debugger\n    subs r0, r0, #4  ; debugger\n"+e+":\n    ldr r0, [r0, #0] ; debugger\n"},t.prototype.debugger_bkpt=function(e){return m.oops(),"\n    @stackempty locals\n    ldr r0, [r6, #0] ; brk\n"+e+":\n    ldr r0, [r0, #0] ; brk\n"},t.prototype.debugger_proc=function(e){return m.oops(),"\n    ldr r0, [r6, #0]  ; brk-entry\n    ldr r0, [r0, #4]  ; brk-entry\n"+e+":"},t.prototype.push_local=function(e){return"push {"+e+"}"},t.prototype.push_locals=function(e){return"sub sp, #4*"+e+" ; push locals "+e+" (align)"},t.prototype.pop_locals=function(e){return"add sp, #4*"+e+" ; pop locals "+e},t.prototype.unconditional_branch=function(e){return"bb "+e},t.prototype.beq=function(e){return"beq "+e},t.prototype.bne=function(e){return"bne "+e},t.prototype.cmp=function(e,t){return"cmp "+e+", "+t},t.prototype.cmp_zero=function(e){return"cmp "+e+", #0"},t.prototype.load_reg_src_off=function(e,t,r,n,i,a){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);var s="str",o="ldr";return a&&(32==a.immLimit?s="strb":64==a.immLimit&&(s="strh"),o=a.needsSignExt?s.replace("str","ldrs"):s.replace("str","ldr")),i?s+" "+e+", ["+t+", "+r+"]":o+" "+e+", ["+t+", "+r+"]"},t.prototype.rt_call=function(e,t,r){return e+" "+t+", "+r},t.prototype.alignedCall=function(e,t){return t?this.push_locals(t)+"\nbl "+e+"\n"+this.pop_locals(t):"bl "+e},t.prototype.call_lbl=function(e,t,r){var n=m.U.lookup(i,e);return n&&(e=n,t=!1),!t&&0<e.indexOf("::")&&(t=!0),t?this.callCPP(e,r):this.alignedCall(e,r)},t.prototype.call_reg=function(e){return"blx "+e},t.prototype.helper_prologue=function(){return"\n    @stackmark args\n    "+this.pushLR()+"\n"},t.prototype.helper_epilogue=function(){return"\n    "+this.popPC()+"\n    @stackempty args\n"},t.prototype.load_ptr_full=function(e,t){return m.assert(!!e),"\n    ldlit "+t+", "+e+"\n"},t.prototype.load_vtable=function(e,t){return"ldr "+e+", ["+t+", #0]"},t.prototype.lambda_init=function(){return"\n    mov r5, r0\n    mov r4, lr\n    bl pxtrt::getGlobalsPtr\n    mov r6, r0\n    bx r4\n"},t.prototype.saveThreadStack=function(){return"mov r7, sp\n    str r7, [r6, #4]\n"},t.prototype.restoreThreadStack=function(){return m.target.switches.gcDebug?"movs r7, #0\n    str r7, [r6, #4]\n":""},t.prototype.callCPPPush=function(e){return this.pushLR()+"\n"+this.callCPP(e)+"\n"+this.popPC()+"\n"},t.prototype.callCPP=function(e,t){return this.saveThreadStack()+this.alignedCall(e,t)+"\n"+this.restoreThreadStack()},t.prototype.inline_decr=function(e){return"\n    lsls r1, r0, #30\n    bne .tag"+e+"\n    bl _pxt_decr\n.tag"+e+":\n"},t.prototype.arithmetic=function(){for(var r=this,t="",n=function(e){var t=".boxed:\n";return t+="\n                    "+r.pushLR()+"\n                    push {r0, r1}\n                    "+r.saveThreadStack()+"\n                    "+e+"\n                    "+r.restoreThreadStack()+"\n                    add sp, #8\n                    "+r.popPC()+"\n                "},e=function(e){t+="\n_numops_"+e+":\n    @scope _numops_"+e+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n"},i=function(e){t+="    blx lr\n",t+=n("bl numops::"+e)},a=0,s=["adds","subs"];a<s.length;a++){e(d=s[a]),t+="\n    subs r2, r1, #1\n    "+d+" r2, r0, r2\n    bvs .boxed\n    movs r0, r2\n",i(d)}for(var o=0,l=["ands","orrs","eors"];o<l.length;o++){e(d=l[o]),t+="    "+d+" r0, r1\n","eors"==d&&(t+="    adds r0, r0, #1\n"),i(d)}for(var u=0,c=["lsls","lsrs","asrs"];u<c.length;u++){e(d=c[u]),t+="\n    ; r3 := (r1 >> 1) & 0x1f\n    lsls r3, r1, #26\n    lsrs r3, r3, #27\n","asrs"==d?t+="\n    asrs r0, r3\n    movs r2, #1\n    orrs r0, r2\n":(t+="lsrs"==d?"\n    asrs r2, r0, #1\n    lsrs r2, r3\n    lsrs r3, r2, #30\n    bne .boxed\n":"\n    asrs r2, r0, #1\n    lsls r2, r3\n    lsrs r3, r2, #30\n    beq .ok\n    cmp r3, #3\n    bne .boxed\n.ok:\n",t+="\n    lsls r0, r2, #1\n    adds r0, r0, #1\n"),i(d)}t+="\n@scope _numops_toInt\n_numops_toInt:\n    asrs r0, r0, #1\n    bcc .over\n    blx lr\n.over:\n    lsls r0, r0, #1\n    "+this.callCPPPush("pxt::toInt")+"\n\n_numops_fromInt:\n    lsls r2, r0, #1\n    asrs r1, r2, #1\n    cmp r0, r1\n    bne .over2\n    adds r0, r2, #1\n    blx lr\n.over2:\n    "+this.callCPPPush("pxt::fromInt")+"\n";for(var p=0,f=Object.keys(m.thumbCmpMap);p<f.length;p++){var d;d=(d=f[p]).replace(/.*::/,""),t+="\n.section code\n_cmp_"+d+":\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n    subs r0, r1\n    b"+d.replace("qq","q").replace("neq","ne")+" .true\n.false:\n    movs r0, #0\n    bx lr\n.true:\n    movs r0, #1\n    bx lr\n",t+=n("\n                        bl numops::"+d+"\n                        bl numops::toBoolDecr\n                        cmp r0, #0")}return t},t.prototype.emit_int=function(e,r){var n=!1;function t(e){m.assert(0<=e&&e<=255);var t="";return n?e&&(t="adds "+r+", #"+e+"\n"):t="movs "+r+", #"+e+"\n",n=!0,t}function i(e){return void 0===e&&(e=8),"lsls "+r+", "+r+", #"+e+"\n"}m.assert(null!=e);var a=Math.floor(e),s=!1;a<0&&(s=!0,a=-a);var o=0;if(255<a){for(var l=a;0==(1&l);)l>>>=1,o++;m.numBytes(l)<m.numBytes(a)?a=l:o=0}var u="";switch(m.numBytes(a)){case 4:u+=t(a>>>24&255),u+=i();case 3:u+=t(a>>>16&255),u+=i();case 2:u+=t(a>>>8&255),u+=i();case 1:u+=t(255&a);break;default:m.oops()}return o&&(u+=i(o)),s&&(u+="negs "+r+", "+r+"\n"),4<u.split("\n").length?"ldlit "+r+", "+Math.floor(e)+"\n":u},t}(m.AssemblerSnippets);m.ThumbSnippets=e}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(L){!function(E){var N,e,_={"pxtrt::mapSetGeneric":"mapset","pxtrt::mapGetGeneric":"mapget"},K={};function A(e,t,r){for(var n=E.computeHashMultiplier(e.itable.map(function(e){return e.idx})),i=E.U.toArray(n.mapping);3&i.length;)i.push(0);var a="\n"+P(e)+"_start:\n        .short "+(8*e.allfields.length+8)+"  ; size in bytes\n        .byte "+pxt.ValTypeObject+", "+pxt.VTABLE_MAGIC+" ; magic\n        .short "+i.length+" ; entries in iface hashmap\n        .short "+(e.lastSubtypeNo||e.classNo)+" ; last sub class-id\n        .short "+e.classNo+" ; class-id\n        .short 0 ; reserved\n        .word "+n.mult+" ; hash-mult\n        .word 0,0, 0,0, 0,0, 0,0 ; space for 4 (VM_NUM_CPP_METHODS) native methods\n";a+="\n        .balign 4\n"+e.id+"_IfaceVT:\n";for(var s=i.length>>2,o="",l=s,u={},c=0,p=e.itable;c<p.length;c++){var f=p[c];u[f.idx+""]=l;var d=f.proc?f.proc.isGetter()?1:2:0;o+="  .short "+f.idx+", "+d+" ; "+f.name+"\n",o+="  .word "+(f.proc?f.proc.vtLabel()+"@fn":f.info)+"\n",l+=1,f.setProc&&(o+="  .short "+f.idx+", 2 ; set "+f.name+"\n",o+="  .word "+f.setProc.vtLabel()+"@fn\n",l+=1)}o+="  .word 0, 0, 0, 0 ; the end\n",l+=1;for(var m=0;m<i.length;++m)r.itEntries++,i[m]&&r.itFullEntries++;return a+="  .short "+E.U.toArray(i).map(function(e,t){return u[e+""]||s}).join(", ")+"\n",a+=o,a+="\n"}function C(e){var t=e.getTime()/1e3;return(t>>>0)+", "+(t/4294967296|0)}(e=N||(N={}))[e.Invalid=0]="Invalid",e[e.InfoHeader=1]="InfoHeader",e[e.OpCodeMap=2]="OpCodeMap",e[e.NumberLiterals=3]="NumberLiterals",e[e.ConfigData=4]="ConfigData",e[e.IfaceMemberNames=5]="IfaceMemberNames",e[e.Function=32]="Function",e[e.Literal=33]="Literal",e[e.VTable=34]="VTable";var U={};function P(e){return e.classNo||(U[e.id]=e),e.id+"_VT"}E.vmEmit=function(r,e){var l="; VM start\n"+E.hexfile.hexPrelude()+"\n";U={};var t={dblText:[],dbls:{},opcodeMap:{},opcodes:E.vm.opcodes.map(function(e){return"pxt::op_"+e.replace(/ .*/,"")})};for(t.opcodes.unshift(null);t.opcodes.length<128;)t.opcodes.push(null);var u=0;function n(e,t,r,n,i){if(void 0===i&&(i=0),l+="\n; --- "+e+"\n.section code\n    .set "+e+" = "+u+"\n",n)for(var a=0,s=n;a<s.length;a++){var o=s[a];l+="    .set "+o+" = "+u+"\n"}l+="\n_start_"+e+":\n    .byte "+t+", 0x00\n    .short "+i+"\n    .word _end_"+e+"-_start_"+e+"\n",l+=r(),l+="\n.balign 8\n_end_"+e+":\n",u++}var i=new Date,a=E.U.toUTF8(e.name,!0);100<a.length&&(a=a.slice(0,100));var s=a.length+1;1&s&&s++;var o=128-s;n("_info",N.InfoHeader,function(){return'\n                ; magic - \\0 added by assembler\n                .string "\\nPXT64\\n"\n                .hex 5471fe2b5e213768 ; magic\n                .hex '+E.hexfile.hexTemplateHash()+" ; hex template hash\n                .hex 0000000000000000 ; @SRCHASH@\n                .word "+r.globalsWords+"   ; num. globals\n                .word "+r.nonPtrGlobals+" ; non-ptr globals\n                .word 0, 0 ; last usage time\n                .word "+C(i)+" ; installation time\n                .word "+C(i)+" ; publication time - TODO\n                .space 64 ; reserved\n                .string "+JSON.stringify(a)+"\n                .space "+o+" ; pad to 128 bytes\n"}),r.procs.forEach(function(e){n(e.label(),N.Function,function(){return function(d,f,s){var t="",o=function(e){t+=e+"\n"},m=function(e){t+="    "+e+"\n"},h=E.ir.EK,i=[],g=[],a=!1,l=0,v=0,b=8388607;pxt.options.debug&&console.log("EMIT",s.toString()),u(),t="";for(var e=0,r=i;e<r.length;e++){var n=r[e];n.reset()}return a=!0,E.U.assert(0==v),u(),t;function u(){o(";\n; Proc: "+s.getFullName()+"\n;"),m(".section code"),f.procs[0]==s&&o("; main"),m(".short 0, "+s.args.length+" ; #args"),m(".short "+s.captured.length+", 0 ; #cap"),m(".word 0, 0"),l=s.locals.length+g.length,m("pushmany "+l+" ; incl. "+g.length+" tmps");for(var e=0,t=s.body;e<t.length;e++){var r=t[e];switch(r.stmtKind){case E.ir.SK.Expr:x(r.expr);break;case E.ir.SK.StackEmpty:S();for(var n=0,i=g;n<i.length;n++){var a=i[n];a&&E.oops("uses: "+a.currUses+"/"+a.totalUses+" "+a.toString())}break;case E.ir.SK.Jmp:c(r);break;case E.ir.SK.Label:o(r.lblName+":");break;case E.ir.SK.Breakpoint:break;default:E.oops()}}m("ret "+s.args.length+", "+l)}function c(e){var t=e.lbl.lblName;e.jmpMode==E.ir.JmpMode.Always?(e.expr&&x(e.expr),m("jmp "+t)):(x(e.expr),e.jmpMode==E.ir.JmpMode.IfNotZero?m("jmpnz "+t):e.jmpMode==E.ir.JmpMode.IfZero?m("jmpz "+t):E.oops())}function y(e){if(e.isGlobal())return E.U.assert(0==(3&e.index)),"glb "+(e.index>>2)+" ; "+e.getName();if(e.iscap)return"cap "+e.index+" ; "+e.getName();if(e.isarg){var t=s.args.length-e.index-1;return E.assert(0<=t,"arg#"+t),"loc "+(v+l+2+t)+" ; "+e.getName()}var t=e.index+g.length;return E.assert(!a||t<l,"cell#"+t),E.assert(0<=t,"cell#"+t),"loc "+(v+t)}function p(e){switch(e.exprKind){case h.NumberLiteral:var t=E.taggedSpecial(e.data);if(null!=t)m("ldspecial "+t+" ; "+e.data);else{var r=e.data,n=0,i=0;if((0|r)==r){if(Math.abs(r)<=b)return void m(r<0?"ldintneg "+-r:"ldint "+r);n=(r<<1|1)>>>0,i=r<0?1:0}else{var a=new Float64Array(1);a[0]=r;var s=new Uint32Array(a.buffer);s[1]+=65536,n=s[0],i=s[1]}var o=n+","+i,l=E.U.lookup(d.dbls,o);null==l&&(l=d.dblText.length,d.dblText.push(".word "+n+", "+i+"  ; "+l+": "+e.data),d.dbls[o]=l),m("ldnumber "+l+" ; "+e.data)}return;case h.PointerLiteral:return void m("ldlit "+e.data);case h.SharedRef:var u=e.args[0];(!u.currUses||u.currUses>=u.totalUses)&&(console.log(u.sharingInfo()),E.U.assert(!1)),u.currUses++;var c=g.indexOf(u);return c<0&&(console.log(g,u),E.assert(!1)),m("ldloc "+(c+v)+(u.currUses==u.totalUses?" ; LAST":"")),void S();case h.CellRef:m("ld"+y(e.data));var p=e.data;return void(p.isGlobal()&&(1==p.bitSize?m("sgnext"):2==p.bitSize&&m("clrhi")));case h.InstanceOf:x(e.args[0]),f=e.data,"bool"==e.jsInfo?m("checkinst "+P(f)):E.U.oops();break;default:throw E.oops("kind: "+e.exprKind)}var f}function x(e){switch(e.exprKind){case h.JmpValue:m("; jmp value (already in r0)");break;case h.Nop:m("; nop");break;case h.FieldAccess:var t=e.data;x(e.args[0]),m("ldfld "+t.idx+", "+P(t.classInfo));break;case h.Store:return function(e,t){switch(e.exprKind){case h.CellRef:x(t);var r=e.data,n="st"+y(r);!r.isGlobal()||1!=r.bitSize&&2!=r.bitSize||(n=n.replace("stglb","stglb1")),m(n);break;case h.FieldAccess:var i=e.data;x(e.args[0]),k(),x(t),m("stfld "+i.idx+", "+P(i.classInfo)),v--;break;default:E.oops()}}(e.args[0],e.args[1]);case h.RuntimeCall:return function(e){var t=e.data;if("pxt::beginTry"!=t){t=E.U.lookup(K,t)||t,S();var r=E.U.lookup(_,t),n=e.args,i=0;if("pxt::mkClassInstance"!=t){for(var a=0;a<n.length;++a)x(n[a]),a<n.length-1&&(k(),i++);"langsupp::ignore"==t?i&&m("popmany "+i+" ; ignore"):r?m(r):function(e){var t=E.hexfile.lookupFunc(e);t||E.U.oops("missing function: "+e);var r=d.opcodeMap[t.name];null==r&&(r=d.opcodes.length,d.opcodes.push(t.name),d.opcodeMap[t.name]=r,t.value=r),m("callrt "+e)}(t),v-=i}else m("newobj "+n[0].data)}else m("try "+e.args[0].data)}(e);case h.ProcCall:return function(e){var t=e.data,r=t.proc;if(r&&r.inlineBody){var n=r.inlineSelf(e.args);return pxt.options.debug&&console.log("INLINE",e.toString(),"->",n.toString()),x(n)}for(var i=0,a=e.args.slice(),s=-1==t.virtualIndex?a.shift():null,o=0,l=a;o<l.length;o++){var u=l[o];x(u),k(),i++}var c=a.length;if(s)x(s),m("callind "+c);else if(null!=t.ifaceIndex){var p=t.ifaceIndex+" ; ."+f.ifaceMembers[t.ifaceIndex];t.isSet?(m("callset "+p),E.U.assert(2==c)):t.noArgs?(m("callget "+p),E.U.assert(1==c)):m("calliface "+c+", "+p)}else null!=t.virtualIndex?E.U.oops():m("callproc "+r.label());v-=i}(e);case h.SharedDef:return function(e){var t=e.args[0];if(E.U.assert(1<=t.totalUses),E.U.assert(0===t.currUses),t.currUses=1,i.push(t),1==t.totalUses)return x(t);x(t);for(var r=-1,n=0;n<g.length;++n)if(null==g[n]){r=n;break}r<0?(a&&(console.log(t,g),E.assert(!1,"missed tmp")),r=g.length,g.push(t)):g[r]=t,m("stloc "+(r+v))}(e);case h.Sequence:return e.args.forEach(x);default:return p(e)}}function k(){m("push"),v++}function S(){for(var e=0;e<g.length;++e){var t=g[e];t&&t.currUses==t.totalUses&&(a||i.push(t),g[e]=null)}}}(t,r,e)},[e.label()+"_Lit"])}),l+="_code_end:\n\n",l+="_helpers_end:\n\n",r.usedClassInfos.forEach(function(e){n(P(e),N.VTable,function(){return A(e,0,r)})}),E.U.values(U).forEach(function(e){e.itable=[],e.classNo=65520,n(P(e),N.VTable,function(){return A(e,0,r)})}),U={};var c=0;n("ifaceMemberNames",N.IfaceMemberNames,function(){return"    .word "+r.ifaceMembers.length+", 0 ; num. entries\n"+r.ifaceMembers.map(function(e){return"    .word "+r.emitString(e)+", 0  ; "+c+++" ."+e}).join("\n")}),l+="_vtables_end:\n\n",E.U.iterMap(r.hexlits,function(e,t){n(t,N.Literal,function(){return E.hexLiteralAsm(e)},[],pxt.BuiltInType.BoxedBuffer)}),E.U.unique(r.ifaceMembers.concat(Object.keys(r.strings)),function(e){return e}).forEach(function(e){var t=E.U.toUTF8(e,!0);n(r.strings[e],N.Literal,function(){return".word "+t.length+"\n.string "+JSON.stringify(t)},[],pxt.BuiltInType.BoxedString)}),n("numberLiterals",N.NumberLiterals,function(){return t.dblText.join("\n")});var p=r.res.configData||[];n("configData",N.ConfigData,function(){return p.map(function(e){return"    .word "+e.key+", "+e.value+"  ; "+e.name+"="+e.value}).join("\n")+"\n    .word 0, 0"});for(var f=t.opcodes.map(function(e){return null==e?"":e}).join("\0")+"\0",d="";f;){var m=f.slice(0,64);f=f.slice(64),1&m.length&&(m+="\0"),d+=".hex "+E.U.toHex(E.U.stringToUint8Array(m))+"\n"}n("opcodeMap",N.OpCodeMap,function(){return d}),l+="_literals_end:\n",l+="\n; The end.\n",r.writeFile(E.BINARY_ASM,l);var h=E.assemble(e.target,r,l);if(h.src&&r.writeFile(E.BINARY_ASM,h.src),pxt.options.debug){var g=h.thumbFile.peepCounts,v=Object.keys(g);v.sort(function(e,t){return g[t]-g[e]});for(var b=0,y=v.slice(0,50);b<y.length;b++){var x=y[b];console.log(x+"  "+g[x])}}if(h.buf){for(var k="",S=0,T=h.buf;S<T.length;S++){var w=T[S];k+=String.fromCharCode(255&w,w>>8)}var I=L.pxtc.encodeBase64(k);r.writeFile(pxt.outputName(E.target),I)}}}(L.pxtc||(L.pxtc={}))}(ts||(ts={})),function(Xe){var et;(function(he){var ge,e,ve,t;(e=ge=he.DecompileParamKeys||(he.DecompileParamKeys={})).DecompileLiterals="decompileLiterals",e.TaggedTemplate="taggedTemplate",e.DecompileIndirectFixedInstances="decompileIndirectFixedInstances",e.DecompileArgumentAsString="decompileArgumentAsString",(t=ve=he.CommentKind||(he.CommentKind={}))[t.SingleLine=0]="SingleLine",t[t.MultiLine=1]="MultiLine",he.FILE_TOO_LARGE_CODE=9266,he.DECOMPILER_ERROR=9267;var be,r,ye=Xe.SyntaxKind,xe=1500,l=97,u=122,ke=160,Se=120,Te=480,we=360,o=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,c=/^(?:Array<(.+)>)|(?:(.+)\[\])$/,Ie="math_number",Ee="math_number_minmax",Ne="math_integer",_e="math_whole_number",Ke="text",Ae="logic_boolean",Ce={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"**":{type:"math_arithmetic",op:"POWER"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},h=/^\s*\/\/\s*(.*)$/,g=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/,n=function(){function e(e){this.renames=e,this.renames.sort(function(e,t){return e.span.start-t.span.start})}return e.prototype.getRenamesInSpan=function(e,t){for(var r=[],n=0,i=this.renames;n<i.length;n++){var a=i[n];if(a.span.start>t)break;a.span.start>=e&&r.push(a)}return r},e.prototype.getRenameForPosition=function(e){for(var t=0,r=this.renames;t<r.length;t++){var n=r[t];if(n.span.start>e)return;if(n.span.start===e)return n}},e}();function p(e,t,r){if(void 0===r&&(r=!0),1===e.length&&"x"!==e&&"y"!==e&&"z"!==e){var n=e.charCodeAt(0);if(l<=n&&n<=u)for(var i=n-l,a=1;a<26;a++){var s=String.fromCharCode(l+(i+a)%26);if("x"!==s&&"y"!==s&&"z"!==s&&!t[s])return r&&(t[s]=!0),s}}for(a=2;;a++){var o=e+a;if(!t[o])return r&&(t[o]=!0),o}}function Ue(e,l,t,r){switch(void 0===t&&(t=!1),void 0===r&&(r=!1),e.kind){case ye.WhileStatement:case ye.IfStatement:case ye.Block:return;case ye.ExpressionStatement:return Ue(e.expression,l,t,r);case ye.VariableStatement:return function(e,t){for(var r=0,n=e.declarationList.declarations;r<n.length;r++){var i=n[r],a=s(i,t);if(a)return a}}(e,l);case ye.CallExpression:return function(e,T,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);var s=et.pxtInfo(e).callInfo;if(!s)return et.Util.lf("Function call not supported in the blocks");var n,w=T.attrs(s);if(Xe.isIdentifier(e.expression)&&(n=T.declaredFunctions[e.expression.text]),!t&&s.isExpression&&!n){var i=T.aliasBlocks[s.qName];if(!i)return et.Util.lf("No output expressions as statements");s.decompilerBlockAlias=T.aliasBlocks[s.qName]}if("Math.pow"!=s.qName){if(pxt.Util.startsWith(s.qName,"Math.")){var a=s.qName.substring(5);if(Ge(a))return}if(w.blockId===et.PAUSE_UNTIL_TYPE){var o=e.arguments[0];if(1===e.arguments.length&&function(e){if(e.kind!==ye.FunctionExpression&&e.kind!==ye.ArrowFunction)return!1;var t=e;if(function(e){switch(e.kind){case ye.BinaryExpression:var t=e.operatorToken.kind;return t!=ye.PlusEqualsToken&&t!=ye.MinusEqualsToken&&t!=ye.EqualsToken;case ye.PrefixUnaryExpression:case ye.PostfixUnaryExpression:var r=e.operator;return r!=ye.PlusPlusToken&&r!=ye.MinusMinusToken;case ye.CallExpression:var n=et.pxtInfo(e).callInfo;return et.assert(!!n),n.isExpression;case ye.ParenthesizedExpression:case ye.NumericLiteral:case ye.StringLiteral:case ye.NoSubstitutionTemplateLiteral:case ye.TrueKeyword:case ye.FalseKeyword:case ye.NullKeyword:case ye.TaggedTemplateExpression:return!0;default:return!1}}(t.body))return!0;var r=t.body;if(1===r.statements.length){var n=Be(r.statements[0]);if(n.kind===ye.ReturnStatement)return!0}return!1}(o))return;return et.Util.lf("Predicates must be inline expressions that return a value")}var l=qe(s,w);if(l&&!w.handlerStatement&&!r)return et.Util.lf("Events must be top level");if(!w.blockId||!w.block){var u=pxt.blocks.builtinFunctionInfo[s.qName];if(!u)return n?n.parameters.length!==s.args.length?et.Util.lf("Function calls in blocks must have the same number of arguments as the function definition"):void 0:et.Util.lf("Call statements must have a valid declared function");w.blockId=u.blockId}var c=ze(s,T.blocks),p=T.blocks.apis.byQName[s.qName],f=pxt.blocks.compileInfo(p),d=f.parameters.length+(f.thisParameter?1:0);if(w.imageLiteral){if(1<s.args.length-d)return et.Util.lf("Function call has more arguments than are supported by its block");var m=e.arguments[0];if(m.kind!=ye.StringLiteral&&m.kind!=ye.NoSubstitutionTemplateLiteral)return et.Util.lf("Only string literals supported for image literals");var h=(m.text||"").replace(/\s+/g,""),g=w.imageLiteralRows||5,v=(w.imageLiteralColumns||5)*w.imageLiteral,b=v*g;return v*g!=h.length?et.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",b,h.length):void 0}var y=s.args.length-d;if(0<y&&!function(){if(w.mutatePropertyEnum&&2===y&&2<=s.args.length){var e=s.args[s.args.length-2],t=s.args[s.args.length-1];if(e.kind===ye.ArrayLiteralExpression&&N(t)){var r=[],n=!e.elements.some(function(e){return e.kind!==ye.PropertyAccessExpression||e.expression.kind!==ye.Identifier||(r.push(e.name.text),e.expression.text!==w.mutatePropertyEnum)});if(n){var i=Oe(t);if(i){var a=i[0];return a.length===r.length&&!r.some(function(e){return-1===a.indexOf(e)})}}}}return!1}()){var x=y;if(l&&x--,w.defaultInstance&&x--,0<x)return et.Util.lf("Function call has more arguments than are supported by its block")}if(f.parameters.length||l){var k,S=w.defaultInstance||!!f.thisParameter;if(c.forEach(function(e,t){k||S&&0===t||(S&&t--,k=function(e){var t=Be(e.value),i=e.info,r=e.param;if(i.isEnum){if(S(t))return;if(t.kind===ye.CallExpression){var n=et.pxtInfo(t).callInfo,a=T.attrs(n);if(n&&"TD_ID"===a.shim&&n.args&&1===n.args.length){var s=Be(n.args[0]);if(S(s))return}}else if(t.kind===ye.Identifier){var o=et.pxtInfo(t).commentAttrs;if(o&&o.enumIdentity)return}return et.Util.lf("Enum arguments may only be literal property access expressions")}if(je(t)&&(r.fieldEditor||r.shadowBlockId)){var l=!(!r.fieldOptions||!r.fieldOptions[ge.DecompileLiterals]);if(!l&&r.shadowBlockId){var u=T.blocks.blocksById[r.shadowBlockId];if(u&&u.parameters&&u.parameters.length){var c=u.parameters[0].name;l=!u.attributes.paramFieldEditorOptions||!u.attributes.paramFieldEditorOptions[c]||!!u.attributes.paramFieldEditorOptions[c][ge.DecompileLiterals]}else l=!0}if(!l)return et.Util.lf("Field editor does not support literal arguments")}else if(t.kind===ye.TaggedTemplateExpression&&r.fieldEditor){var p=r.fieldOptions&&r.fieldOptions[ge.TaggedTemplate];if(!p)return et.Util.lf("Tagged templates only supported in custom fields with param.fieldOptions.taggedTemplate set");var f=Be(t.tag);if(f.kind!==ye.Identifier)return et.Util.lf("Tagged template literals must use an identifier as the tag");var d=f.getText();if(d.trim()!=p.trim())return et.Util.lf("Function only supports template literals with tag '{0}'",p);var m=t.template;if(m.kind!==ye.NoSubstitutionTemplateLiteral)return et.Util.lf("Tagged template literals cannot have substitutions")}else if(t.kind===ye.ArrowFunction){var h=t;if(h.parameters.length)if("objectdestructuring"===w.mutate){var g=Be(h.parameters[0]);if(g.kind===ye.Parameter&&g.name.kind!==ye.ObjectBindingPattern)return et.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments")}else for(var v=0,b=h.parameters;v<b.length;v++){var y=b[v];if(y.name.kind!==ye.Identifier)return et.Util.lf("Only identifiers allowed as function arguments")}}else if(T.blocks.apis.byQName[i.type]){var x=T.blocks.apis.byQName[i.type];if(x.attributes.fixedInstances){if(_(r))return;if(r.shadowBlockId){var k=T.blocks.blocksById[r.shadowBlockId];if(k){var u=pxt.blocks.compileInfo(k);if(u.parameters&&_(u.parameters[0]))return}}var n=et.pxtInfo(t).callInfo;if(n&&T.attrs(n).fixedInstance)return;return et.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}}return;function S(e){for(var t=i.type.split("."),r=[];e.kind===ye.PropertyAccessExpression;)r.unshift(e.name.text),e=e.expression;if(e.kind!==ye.Identifier)return!1;r.unshift(e.text);for(var n=0;n<t.length;n++)if(t[n]!==r[n])return!1;return!0}}(e))}),k)return k}if(p){var I=T.blocks.apis.byQName[p.namespace];if(I&&I.attributes.fixedInstances&&!I.attributes.decompileIndirectFixedInstances&&s.args.length){var E=et.pxtInfo(s.args[0]).callInfo;if(!E||!T.attrs(E).fixedInstance)return et.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}}}(e,l,t,r);case ye.VariableDeclaration:return s(e,l);case ye.PostfixUnaryExpression:case ye.PrefixUnaryExpression:return(n=e).operand.kind!=ye.Identifier?et.Util.lf("-- and ++ may only be used on an identifier"):n.operator!==ye.PlusPlusToken&&n.operator!==ye.MinusMinusToken?et.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0;case ye.FunctionExpression:case ye.ArrowFunction:return function(e,t){var r=!1;if(e.parameters.length){var n=Me(e)[0];if(n&&et.pxtInfo(n).callInfo){var i=et.pxtInfo(n).callInfo;r="objectdestructuring"===t.attrs(i).mutate?e.parameters[0].name.kind!==ye.ObjectBindingPattern:e.parameters.some(function(e){return e.name.kind!==ye.Identifier})}}if(r)return et.Util.lf("Unsupported parameters in error function")}(e,l);case ye.BinaryExpression:return function(e,t){if(e.left.kind===ye.ElementAccessExpression){if(e.operatorToken.kind!==ye.EqualsToken)return et.Util.lf("Element access expressions may only be assigned to using the equals operator")}else{if(e.left.kind===ye.PropertyAccessExpression)return e.operatorToken.kind!==ye.EqualsToken&&e.operatorToken.kind!==ye.PlusEqualsToken?et.Util.lf("Property access expressions may only be assigned to using the = and += operators"):De(e.left,t);if(e.left.kind!==ye.Identifier)return et.Util.lf("This expression cannot be assigned to");switch(e.operatorToken.kind){case ye.EqualsToken:return De(e.right,t);case ye.PlusEqualsToken:case ye.MinusEqualsToken:return;default:return et.Util.lf("Unsupported operator token in statement {0}",ye[e.operatorToken.kind])}}}(e,l);case ye.ForStatement:return function(r){if(!r.initializer||!r.incrementor||!r.condition)return et.Util.lf("for loops must have an initializer, incrementor, and condition");if(r.initializer.kind!==ye.VariableDeclarationList)return et.Util.lf("only variable declarations are permitted in for loop initializers");var e=r.initializer;if(!e.declarations)return et.Util.lf("for loop with out-of-scope variables not supported");if(1!=e.declarations.length)return et.Util.lf("for loop with multiple variables not supported");var t=e.declarations[0];if(t.initializer.kind!==ye.NumericLiteral||"0"!==t.initializer.text)return et.Util.lf("for loop initializers must be initialized to 0");var n=t.name.text;if(!function(e){if(r.incrementor.kind===ye.PostfixUnaryExpression||r.incrementor.kind===ye.PrefixUnaryExpression){var t=r.incrementor;if(t.operator===ye.PlusPlusToken&&t.operand.kind===ye.Identifier)return t.operand.text===e}return!1}(n))return et.Util.lf("for loop incrementors may only increment the variable declared in the initializer");if(r.condition.kind!==ye.BinaryExpression)return et.Util.lf("for loop conditionals must be binary comparison operations");var i=r.condition;return i.left.kind!==ye.Identifier||i.left.text!==n?et.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):i.operatorToken.kind!==ye.LessThanToken&&i.operatorToken.kind!==ye.LessThanEqualsToken?et.Util.lf("for loop conditional operator must be either < or <="):void 0}(e);case ye.ForOfStatement:return function(e){if(e.initializer.kind!==ye.VariableDeclarationList)return et.Util.lf("only variable declarations are permitted in for of loop initializers")}(e);case ye.FunctionDeclaration:return function(e,t){if(!t)return et.Util.lf("Function declarations must be top level");if(0<e.parameters.length&&l.opts.allowedArgumentTypes)for(var r=0,n=e.parameters;r<n.length;r++){var i=n[r];if(i.initializer||i.questionToken)return et.Util.lf("Function parameters cannot be optional");var a=i.type?i.type.getText():void 0;if(!a)return et.Util.lf("Function parameters must declare a type");if(-1===l.opts.allowedArgumentTypes.indexOf((s=a,void 0,(o=c.exec(s))?(o[1]||o[2])+"[]":s)))return et.Util.lf("Only types that can be added in blocks can be used for function arguments")}var s,o}(e,r);case ye.EnumDeclaration:return function(e,t){if(!t)return et.Util.lf("Enum declarations must be top level");var r=e.name.text;if(!l.blocks.enumsByName[r])return et.Util.lf("Enum declarations in user code must have a block");var n=!1;return e.members.forEach(function(e){if(e.name.kind!==ye.Identifier&&(n=!0),!n&&e.initializer){if(e.initializer.kind===ye.NumericLiteral)return;if(e.initializer.kind===ye.BinaryExpression){var t=e.initializer;if(t.operatorToken.kind===ye.LessThanLessThanToken&&t.left.kind===ye.NumericLiteral&&t.right.kind===ye.NumericLiteral&&"1"==t.left.text)return}n=!0}}),n?et.Util.lf("Invalid initializer for enum member"):void 0}(e,r);case ye.ModuleDeclaration:return(a=Pe(i=e,l))&&Le(i)?a:void 0;case ye.ReturnStatement:return function(e){if(!function e(t){var r=Xe.getEnclosingBlockScopeContainer(t);if(r)switch(r.kind){case ye.SourceFile:case ye.ArrowFunction:case ye.FunctionExpression:return!1;case ye.FunctionDeclaration:return r.parent&&r.parent.kind===ye.SourceFile&&!Ue(r,l,!1,!0);default:return e(r)}return!1}(e))return et.Util.lf("Return statements can only be used within top-level function declarations")}(e);case ye.BreakStatement:case ye.ContinueStatement:case ye.DebuggerStatement:case ye.EmptyStatement:return}var n,i,a;return et.Util.lf("Unsupported statement in block: {0}",ye[e.kind]);function s(e,t){var r;return e.name.kind!==ye.Identifier?r=et.Util.lf("Variable declarations may not use binding patterns"):e.initializer?Fe(e)||(r=De(e.initializer,t)):r=et.Util.lf("Variable declarations must have an initializer"),r}}function Pe(e,t){if(!Xe.isModuleBlock(e.body))return et.Util.lf("Namespaces cannot be nested.");var r=t.blocks.kindsByName[e.name.text];if(!r)return et.Util.lf("Only namespaces with 'kind' blocks can be decompiled");for(var n,i,a=et.Util.lf("Namespaces may only contain valid 'kind' exports"),s=0,o=e.body.statements;s<o.length;s++){var l=o[s];if(n=l,(i=Xe.getLeadingCommentRangesOfNode(n,n.getSourceFile()))&&i.length)return a;if(!Xe.isVariableStatement(l)||!l.declarationList.declarations)return a;var u=1===l.declarationList.declarations.length,c=l.modifiers&&1===l.modifiers.length&&l.modifiers[0].kind===ye.ExportKeyword,p=l.declarationList.flags&Xe.NodeFlags.Const;if(!(u&&c&&p))return a;var f=l.declarationList.declarations[0];if(!f.initializer||!Xe.isCallExpression(f.initializer)||!Xe.isIdentifier(f.name))return a;var d=f.initializer;if(d.arguments.length)return a;if(Xe.isPropertyAccessExpression(d.expression)&&Xe.isIdentifier(d.expression.expression)){if(d.expression.expression.text!==r.name||d.expression.name.text!==r.createFunctionName)return a}else{if(!Xe.isIdentifier(d.expression))return a;if(d.expression.text!==r.createFunctionName)return a}}}function Le(e){if(!Xe.isModuleBlock(e.body))return et.Util.lf("Namespaces cannot be nested.");if(e.name.text!==pxt.sprite.TILE_NAMESPACE)return et.Util.lf("Tileset namespace must be named myTiles");for(var u=et.Util.lf("The myTiles namespace can only export tile variables with image literal initializers and no duplicate ids"),c=et.Util.lf("Tileset members must have a blockIdentity comment and no other annotations"),p=new RegExp(pxt.sprite.TILE_PREFIX+"(\\d+)"),f=[],d=/^\s*\/\/%\s*blockIdentity=[^\s]+\s*$/,t=function(t){var e=Xe.getLeadingCommentRangesOfNode(t,t.getSourceFile());if(!e||!e.length)return{value:c};var r=e.map(function(e){return t.getSourceFile().text.substr(e.pos,e.end-e.pos)}).filter(function(e){return!!e});if(1!==r.length||!d.test(r[0]))return{value:c};if(!Xe.isVariableStatement(t)||!t.declarationList.declarations)return{value:u};var n=1===t.declarationList.declarations.length,i=t.modifiers&&1===t.modifiers.length&&t.modifiers[0].kind===ye.ExportKeyword,a=t.declarationList.flags&Xe.NodeFlags.Const;if(!(n&&i&&a))return{value:u};var s=t.declarationList.declarations[0];if(!s.initializer||!Xe.isTaggedTemplateExpression(s.initializer)||!Xe.isIdentifier(s.name))return{value:u};var o=s.initializer;if(!Xe.isIdentifier(o.tag)||"img"!==o.tag.text)return{value:u};var l=p.exec(s.name.text);if(!l||-1!==f.indexOf(l[1]))return{value:u};f.push(l[1])},r=0,n=e.body.statements;r<n.length;r++){var i=t(n[r]);if("object"==typeof i)return i.value}}function Fe(e){if(e.initializer){if(e.initializer.kind===Xe.SyntaxKind.NullKeyword||e.initializer.kind===Xe.SyntaxKind.FalseKeyword||(n=e.initializer).kind===ye.ArrayLiteralExpression&&0===n.elements.length)return!0;if(Xe.isStringOrNumericLiteral(e.initializer)){var t=e.initializer.getText();return"0"===t||Re(t)}var r=et.pxtInfo(e.initializer).callInfo;if(r&&r.isAutoCreate)return!0}var n;return!1}function Oe(e){if(1===e.parameters.length&&e.parameters[0].name.kind===ye.ObjectBindingPattern){var t=e.parameters[0].name.elements,n={};return[t.map(function(e){if(i(e.propertyName)&&i(e.name)){var t=e.name.text;if(e.propertyName){var r=e.propertyName.text;return n[r]=t,r}return t}return""}),n]}return;function i(e){return!e||e.kind===ye.Identifier}}function De(e,t){switch(e.kind){case ye.NumericLiteral:case ye.TrueKeyword:case ye.FalseKeyword:case ye.ExpressionStatement:case ye.ArrayLiteralExpression:case ye.ElementAccessExpression:return;case ye.ParenthesizedExpression:return De(e.expression,t);case ye.StringLiteral:case ye.FirstTemplateToken:case ye.NoSubstitutionTemplateLiteral:return s=e.text,o.test(s)?void 0:et.Util.lf("Only whitespace character allowed in string literals is space");case ye.Identifier:var r=et.pxtInfo(e);return(a=e)&&a.kind===ye.Identifier&&"undefined"===a.text?et.Util.lf("Undefined is not supported in blocks"):!$e(e)||r.commentAttrs&&r.commentAttrs.blockIdentity&&r.commentAttrs.enumIdentity?void 0:et.Util.lf("Variable is declared in another file");case ye.BinaryExpression:var n=e.operatorToken.getText();return Ce[n]?void 0:et.Util.lf("Could not find operator {0}",n);case ye.PrefixUnaryExpression:var i=e.operator;return i===ye.MinusToken||i===ye.PlusToken||i===ye.ExclamationToken?void 0:et.Util.lf("Unsupported prefix unary operator{0}",i);case ye.PropertyAccessExpression:return function(e,t){var r=et.pxtInfo(e).callInfo;if(r){var n=t.attrs(r),i=t.compInfo(r);if(n.blockIdentity||"lists_length"===n.blockId||"text_length"===n.blockId)return;if(r.decl.kind===ye.EnumMember){if(e.expression.kind===ye.Identifier){var a=e.expression.text;if(t.declaredEnums[a])return}var s=Me(e),o=s[0],l=s[1],u=!0;if(o){var c=et.pxtInfo(o).callInfo;if(c&&c.args){var p=t.blocks.apis.byQName[c.qName],f=1==p.kind||2==p.kind;p&&c.args.forEach(function(e,t){if(e===l){var r=p.parameters[f?t-1:t];r.isEnum&&(u=!1)}})}}return u?et.Util.lf("Enum value without a corresponding block"):void 0}if(n.fixedInstance&&e.parent){if(e.parent.parent&&e.parent.kind===ye.PropertyAccessExpression&&e.parent.parent.kind===ye.CallExpression){var d=e.parent.parent;if(d.expression===e.parent)return}else if(e.parent.kind===ye.CallExpression&&e.parent.expression!==e)return}else{if(n.blockCombine||n.blockId&&i&&i.thisParameter)return De(e.expression,t);if(Xe.isIdentifier(e.expression)&&t.declaredKinds[e.expression.text]){var m=e.name.text,h=t.declaredKinds[e.expression.text];if(h&&(-1!==h.kindInfo.initialMembers.indexOf(m)||-1!==h.declaredNames.indexOf(m)))return}}}return et.Util.lf("No call info found")}(e,t);case ye.CallExpression:return Ue(e,t,!0,void 0);case ye.TaggedTemplateExpression:return function(e,t){var r=et.pxtInfo(e).callInfo;if(!r)return et.Util.lf("Invalid tagged template");var n=t.attrs(r);if(!n.blockIdentity)return et.Util.lf("Tagged template does not have blockIdentity set");var i=t.blocks.apis.byQName[n.blockIdentity];return i?1!==pxt.blocks.compileInfo(i).parameters.length?et.Util.lf("Tagged template functions must have 1 argument"):void 0:et.Util.lf("Could not find blockIdentity for tagged template")}(e,t)}var a,s;return et.Util.lf("Unsupported syntax kind for output expression block: {0}",ye[e.kind])}function Me(e){return e.parent?e.parent.kind===ye.ParenthesizedExpression?Me(e.parent):[e.parent,e]:[void 0,e]}function Be(e){for(;e.kind===ye.ParenthesizedExpression;)e=e.expression;return e}function Re(e){return'""'===e||"''"===e||"``"===e}function $e(e){return!!(4&et.pxtInfo(e).flags)}function qe(e,t){return t.blockId!==et.PAUSE_UNTIL_TYPE&&(e.decl.parameters,e.args.some(function(e,t){return e&&N(e)}))}function je(e){if(!e)return!1;switch(e.kind){case ye.ParenthesizedExpression:return je(e.expression);case ye.ArrayLiteralExpression:for(var t=0,r=e.elements;t<r.length;t++){var n=r[t];if(!je(n)&&n.kind!==ye.TaggedTemplateExpression)return!1}return!0;case ye.NumericLiteral:case ye.StringLiteral:case ye.NoSubstitutionTemplateLiteral:case ye.TrueKeyword:case ye.FalseKeyword:return!0;case ye.PrefixUnaryExpression:var i=e;return(i.operator===ye.PlusToken||i.operator===ye.MinusToken)&&je(i.operand);default:return!1}}function N(e){return e.kind===ye.ArrowFunction||e.kind===ye.FunctionExpression}function ze(e,t){var r=[],n=t.apis.byQName[e.qName];if(n){var i=t.apis.byQName[e.qName].attributes,a=pxt.blocks.compileInfo(n),s=(pxt.blocks.builtinFunctionInfo[e.qName],i.imageLiteral?1:0);a.thisParameter?r.push({value:Be(e.args[0]),info:null,param:a.thisParameter}):i.defaultInstance&&r.push({value:Be(e.args[0]),info:n.parameters[0],param:{definitionName:"__instance__",actualName:"this"}});var o=!(!a.thisParameter&&!i.defaultInstance);o&&s++;for(var l=s;l<e.args.length;l++)r.push({value:Be(e.args[l]),info:n.parameters[o?l-1:l],param:a.parameters[l-s]})}return r}function Ve(e){return e.body.statements.map(function(e){var t=e.declarationList.declarations[0];return{name:t.name.text,initializer:t.initializer.getText()}})}function _(e){return e&&e.fieldOptions&&e.fieldOptions[ge.DecompileIndirectFixedInstances]}function Ge(e){return Je(e)||He(e)||Qe(e)||-1!==pxt.blocks.MATH_FUNCTIONS.binary.indexOf(e)}function Je(e){return-1!==pxt.blocks.MATH_FUNCTIONS.unary.indexOf(e)}function He(e){return-1!==pxt.blocks.MATH_FUNCTIONS.infix.indexOf(e)}function Qe(e){return-1!==pxt.blocks.ROUNDING_FUNCTIONS.indexOf(e)}function f(e,t,r){void 0===r&&(r=!1);var n=[],i=e.getFullText();if(t&&t.length)for(var a=0,s=t;a<s.length;a++){var o=s[a],l=Xe.getLineOfLocalPosition(e,o.end),u=Xe.getStartPositionOfLine(l+1,e)||i.length,c=Xe.getStartPositionOfLine(l+2,e)||i.length,p=!r&&!i.substr(u,c-u).trim(),f=i.substr(o.pos,o.end-o.pos);if(f&&(f=f.replace(/\r\n/g,"\n")),o.kind===Xe.SyntaxKind.SingleLineCommentTrivia){var d=h.exec(f);d?n.push({kind:ve.SingleLine,text:d[1],start:o.pos,end:o.end,hasTrailingNewline:!!o.hasTrailingNewLine,followedByEmptyLine:p,isTrailingComment:r}):n.push({kind:ve.SingleLine,text:"",start:o.pos,end:o.end,hasTrailingNewline:!!o.hasTrailingNewLine,followedByEmptyLine:p,isTrailingComment:r})}else{var m=f.split("\n").map(function(e){var t=g.exec(e);return t?t[1]:""});n.push({kind:ve.MultiLine,lines:m,start:o.pos,end:o.end,hasTrailingNewline:!!o.hasTrailingNewLine,followedByEmptyLine:p,isTrailingComment:r})}}return n}function We(e){for(var t="",r=0,n=e;r<n.length;r++){var i=n[r];if(i.kind===ve.SingleLine){if(i.text===et.ON_START_COMMENT||i.text===et.HANDLER_COMMENT)continue;t+=i.text.trim()+"\n"}else for(var a=0,s=i.lines;a<s.length;a++)t+=s[a].trim()+"\n"}return t.trim()}function Ye(e){for(var r,t,n=e.getFullText(),i=Xe.createScanner(e.languageVersion,!1,e.languageVariant,n,void 0,e.getFullStart()),a=[];i.getTextPos()<e.end;){var s=i.scan();if(s===ye.SingleLineCommentTrivia||s===ye.MultiLineCommentTrivia){r=Xe.getLeadingCommentRanges(n,i.getTokenPos())||[],t=(t=Xe.getTrailingCommentRanges(n,i.getTokenPos())||[]).filter(function(t){return!r.some(function(e){return e.pos===t.pos})}),a.push.apply(a,f(e,r,!1)),a.push.apply(a,f(e,t,!0));for(var o=0,l=a;o<l.length;o++){var u=l[o];u.end>i.getTextPos()&&i.setTextPos(u.end)}}}return a.sort(function(e,t){return e.start-t.start}),a}function Ze(e,t){for(var r,n=0;n<t.length;n++)!(r=t[n]).owner&&r.start>=e.pos&&r.end<=e.end&&(r.owner=e)}he.RenameMap=n,he.buildRenameMap=function(e,a,s){void 0===s&&(s={});var o=Xe.createLanguageService(new et.LSHost(e)),l=[],t=(function i(e){Xe.forEachChild(e,function(e){if(e.kind===ye.VariableDeclaration&&e.name.kind===ye.Identifier){var t=e.name.getText();if(s[t]){var r=p(t,s),n=o.findRenameLocations(a.fileName,e.name.pos+1,!1,!1);n&&n.forEach(function(e){l.push({name:r,diff:r.length-t.length,span:e.textSpan})})}else s[t]=!0}i(e)})}(a),s);return[new n(l),t]},he.getNewName=p,(r=be||(be={}))[r.None=0]="None",r[r.InBlocksOnly=1]="InBlocksOnly",r[r.InTextBlocks=2]="InTextBlocks",he.decompileToBlocks=function(R,k,c,r){var t=0,e=k.statements,i={blocksInfo:R,outfiles:{},diagnostics:[],success:!0,times:{}};c.generateSourceMap&&(i.blockSourceMap=[]);var n,$={blocks:R,declaredFunctions:{},declaredEnums:{},declaredKinds:{},functionParamIds:{},attrs:q,compInfo:function(e){var t=R.apis.byQName[e.qName];if(t)return pxt.blocks.compileInfo(t)},localReporters:[],tileset:[],opts:c||{},aliasBlocks:{}},a=(k.getFullText(),""),o=[],m={},S=[],T=[],w=(n=0,function(){return""+n++}),s=R.apis.byQName;Object.keys(s).forEach(function(e){var t=s[e];t.attributes.blockAliasFor&&s[t.attributes.blockAliasFor]&&($.aliasBlocks[t.attributes.blockAliasFor]=t.qName)});var I=Ye(k),l=function(e){var t,r,i;if(e.kind!==ye.FunctionDeclaration||Ue(e,$,!1,!0))if(e.kind!==ye.EnumDeclaration||Ue(e,$,!1,!0))if(Xe.isModuleDeclaration(e))if(Pe(e,$))Le(e)||($.tileset=Ve(e).map(function(e){var t=e.name,r=e.initializer;return{projectId:parseInt(t.substr(pxt.sprite.TILE_PREFIX.length)),data:pxt.sprite.imageLiteralToBitmap(r).data()}}));else{var n=e.name.text,a=Ve(e);$.declaredKinds[n]&&(t=$.declaredKinds[n].declaredNames).push.apply(t,a.map(function(e){return e.name}))}else e.kind===ye.Block&&Xe.forEachChild(e,l);else{var s=e.name.text;$.declaredEnums[s]=!0,(r=e,i=[],r.members.forEach(function(e){et.U.assert(e.name.kind===ye.Identifier);var t,r=e.name.text;if(e.initializer)if(e.initializer.kind===ye.NumericLiteral)t=parseInt(e.initializer.text);else{var n=e.initializer;et.U.assert(n.left.kind===ye.NumericLiteral),et.U.assert("1"===n.left.text),et.U.assert(n.operatorToken.kind===ye.LessThanLessThanToken),et.U.assert(n.right.kind===ye.NumericLiteral),t=1<<parseInt(n.right.text)}else t=0===i.length?0:i[i.length-1][1]+1;i.push([r,t])}),i).forEach(function(e){var t=e[0],r=e[1];o.push({name:r+t,type:s})})}else $.declaredFunctions[me(e.name)]=e};Object.keys(R.kindsByName).forEach(function(e){var t=R.kindsByName[e];$.declaredKinds[e]={kindInfo:t,declaredNames:[]}}),Xe.forEachChild(k,l);var u,p=function(){return(Math.PI*Math.random()).toString(36).slice(2)};Object.keys($.declaredFunctions).forEach(function(t){$.functionParamIds[t]={},$.declaredFunctions[t].parameters.forEach(function(e){$.functionParamIds[t][e.name.getText()]=p()+p()})}),Object.keys($.declaredKinds).forEach(function(e){var t="KIND_"+e;$.declaredKinds[e].declaredNames.forEach(function(e){return o.push({name:e,type:t})})}),(o.length||$.tileset.length)&&(g("<variables>"),o.forEach(function(e){g('<variable type="'+et.U.htmlEscape(e.type)+'">'+et.U.htmlEscape(e.name)+"</variable>")}),$.tileset.forEach(function(e){g('<variable type="'+pxt.sprite.BLOCKLY_TILESET_TYPE+'">'+pxt.sprite.legacy.tileToBlocklyVariable(e)+"</variable>")}),g("</variables>"));try{u=ce(e,void 0,!0,void 0,!c.snippetMode);for(var f=0,d=I;f<d.length;f++){var h=d[f];h.owner||S.push({refId:w(),comment:[h]})}}catch(e){if(!e.programTooLarge)return pxt.reportException(e),i.success=!1,i.diagnostics=et.patchUpDiagnostics([{file:k,start:k.getFullStart(),length:k.getFullWidth(),messageText:e.message,category:Xe.DiagnosticCategory.Error,code:he.DECOMPILER_ERROR}]),i;i.success=!1,i.diagnostics=et.patchUpDiagnostics([{file:k,start:k.getFullStart(),length:k.getFullWidth(),messageText:e.message,category:Xe.DiagnosticCategory.Error,code:he.FILE_TOO_LARGE_CODE}])}return u?x(u):c.snippetMode||e.length||(F(Xe.pxtc.ON_START_TYPE,N(Xe.pxtc.ON_START_TYPE,e[0])),O()),S.forEach(function(e){!function(e){var t=0,r=We(e.comment);if(r.trim()){var n=r.split("\n");n.forEach(function(e){return t=Math.max(t,e.length)});var i=Math.max(Math.min(10*t,Te),ke),a=Math.max(Math.min(40*n.length,we),Se);g('<comment h="'+a+'" w="'+i+'" data="'+et.U.htmlEscape(e.refId)+'">'),g(et.U.htmlEscape(r)),g("</comment>")}}(e)}),i.outfiles[k.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]='<xml xmlns="http://www.w3.org/1999/xhtml">\n'+a+"</xml>",i;function g(e,t){void 0===t&&(t="\n"),a+=e+t}function E(e,t){var r=t||'Language feature "'+e.getFullText().trim()+'"" not supported in blocks',n=et.patchUpDiagnostics([{file:k,start:e.getFullStart(),length:e.getFullWidth(),messageText:r,category:Xe.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+r),et.U.pushRange(i.diagnostics,n),i.success=!1}function q(e){var t=R.apis.byQName[e.decompilerBlockAlias||e.qName];if(t){var r=t.attributes;if(!r.blockId||R.blocksById[r.blockId]||r.blockId===et.PAUSE_UNTIL_TYPE)return t.attributes}else if(e.decl){var n=et.parseComments(e.decl);if(n)return n}return{paramDefl:{},callingConvention:0}}function v(){if(xe<++t){var e=new Error(et.Util.lf("Could not decompile because the script is too large"));throw e.programTooLarge=!0,e}}function b(e,t){if(e==Xe.pxtc.ON_START_TYPE)return"xRRgvHNlG#rZ^u`HECiY";var r=function(){for(var e="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=e.length,r=[],n=0;n<20;n++)r[n]=e.charAt(Math.random()*t);return r.join("")}();if(t){var n=t.getFullStart();i.blockSourceMap.push({id:r,startPos:n,endPos:n+t.getFullWidth()})}return r}function N(e,t){var r={kind:"statement",type:e};return i.blockSourceMap&&(r.id=b(e,t)),r}function _(e,t){return{kind:"expr",type:e}}function j(e,t,r,n){return(!r||r===Ie)&&n&&n.min&&n.max&&(r=Ee),{kind:"value",name:e,value:t,shadowType:r,shadowMutation:n}}function y(e){if(e.expression.kind==ye.CallExpression){var t=e.expression,r=et.pxtInfo(t).callInfo;if(!r)return E(e),!1;var n=q(r);return n.blockId&&!n.handlerStatement&&!r.isExpression&&qe(r,n)}return!1}function x(e){e&&(F(e.type,e),A(e),void 0!==e.data&&g("<data>"+et.U.htmlEscape(e.data)+"</data>"),e.handlers&&e.handlers.forEach(P),e.next&&(g("<next>"),x(e.next),g("</next>")),void 0!==e.comment&&g('<comment pinned="false">'+et.U.htmlEscape(We(e.comment))+"</comment>"),O())}function K(t,e){g("<mutation ",""),Object.keys(t).forEach(function(e){void 0!==t[e]&&g(e+'="'+t[e]+'" ',"")}),e?(g(">"),e.forEach(function(t){g("<"+t.nodeName+" ",""),Object.keys(t.attributes).forEach(function(e){g(e+'="'+t.attributes[e]+'" ',"")}),g("/>")}),g("</mutation>")):g("/>")}function A(e){e.mutation&&K(e.mutation,e.mutationChildren),e.fields&&e.fields.forEach(U),e.inputs&&e.inputs.forEach(C)}function C(e){g('<value name="'+e.name+'">');var t=!1;if("expr"===e.value.kind){var r=e.value;if(r.type===Ie&&e.shadowType===Ee&&(r.type=Ee,r.fields[0].name="SLIDER",r.mutation=e.shadowMutation),!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"math_number_minmax":case"math_integer":case"math_whole_number":case"logic_boolean":case"text":t=!e.shadowType}}if(t)L(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case Ie:case Ne:case _e:g('<shadow type="'+e.shadowType+'"><field name="NUM">0</field></shadow>');break;case Ee:g('<shadow type="'+Ee+'">'),e.shadowMutation&&K(e.shadowMutation),g('<field name="SLIDER">0</field></shadow>');break;case Ae:g('<shadow type="'+Ae+'"><field name="BOOL">TRUE</field></shadow>');break;case Ke:g('<shadow type="'+Ke+'"><field name="TEXT"></field></shadow>');break;default:g('<shadow type="'+e.shadowType+'"/>')}L(e.value)}g("</value>")}function U(e){g('<field name="'+et.U.htmlEscape(e.name)+'">'+et.U.htmlEscape(e.value.toString())+"</field>")}function P(e){g('<statement name="'+et.U.htmlEscape(e.name)+'">'),x(e.statement),g("</statement>")}function L(e,t){if(void 0===t&&(t=!1),"text"===e.kind)g((r=e).value);else{var r=e,n=t||r.isShadow,i=n?"shadow":"block";n||v(),g("<"+i+" "+(r.id?'id="'+r.id+'" ':"")+'type="'+et.U.htmlEscape(r.type)+'">'),A(r),g("</"+i+">")}}function F(e,t){v(),g("<block "+(t&&t.id?'id="'+t.id+'" ':"")+'type="'+et.U.htmlEscape(e)+'">')}function O(){g("</block>")}function z(e){if(De(e,$))return M(e);switch(e.kind){case ye.ExpressionStatement:case ye.ParenthesizedExpression:return z(e.expression);case ye.Identifier:return function(e){if($e(e)){var t=et.pxtInfo(e),r=R.apis.byQName[t.commentAttrs.blockIdentity];return re(r,t.commentAttrs.enumIdentity)}var n=me(e),i=e.text,a=null;return $.localReporters.some(function(e){for(var t=0;t<e.length;++t)if(e[t].name===i)return a=e[t],!0;return!1}),a?Z(n,a.type,!1):(fe(n,be.InBlocksOnly),W("variables_get","VAR",n))}(e);case ye.StringLiteral:case ye.FirstTemplateToken:case ye.NoSubstitutionTemplateLiteral:return H(e.text);case ye.NumericLiteral:return J(e.text);case ye.TrueKeyword:return Q(!0);case ye.FalseKeyword:return Q(!1);case ye.BinaryExpression:return function(e){var t=e.operatorToken.getText(),r=Ce[t];if(B(e))return V(e);var n,i,a=r.leftName||"A",s=r.rightName||"B";"&&"===t||"||"===t?(n=ae(a,e.left),i=ae(s,e.right)):(n=G(a,e.left,Ie),i=G(s,e.right,Ie));var o=_(r.type);return o.fields=[],r.op&&o.fields.push(X("OP",r.op)),o.inputs=[n,i],o}(e);case ye.PrefixUnaryExpression:return function(e){switch(e.operator){case ye.ExclamationToken:var t=_("logic_negate");return t.inputs=[ae("BOOL",e.operand)],t;case ye.PlusToken:return z(e.operand);case ye.MinusToken:return e.operand.kind==ye.NumericLiteral?J("-"+e.operand.text):ee(e.operand);default:E(e)}}(e);case ye.PropertyAccessExpression:return te(e);case ye.ArrayLiteralExpression:return n=e,(i=_("lists_create_with")).inputs=n.elements.map(function(e,t){return G("ADD"+t,e)}),i.mutation={items:n.elements.length.toString()},i;case ye.ElementAccessExpression:return t=e,(r=_("lists_index_get")).inputs=[G("LIST",t.expression),G("INDEX",t.argumentExpression,Ie)],r;case ye.TaggedTemplateExpression:return function(e){var t,r=et.pxtInfo(e).callInfo,n=function(e){if(e.parent&&e.parent.kind===ye.CallExpression){var t=e.parent,r=et.pxtInfo(t).callInfo,n=t.arguments.indexOf(e);if(r&&-1!==n){var i=R.apis.byQName[r.qName];if(i){var a=pxt.blocks.compileInfo(i);return a&&a.parameters[n]}}}}(e);if(n&&n.shadowBlockId){var i=$.blocks.blocksById[n.shadowBlockId];i&&"TD_ID"===i.attributes.shim&&(t=i)}t||(t=$.blocks.apis.byQName[q(r).blockIdentity]);var a=pxt.blocks.compileInfo(t),s=_(t.attributes.blockId),o=e.template.text;return s.fields=[X(a.parameters[0].actualName,o)],s}(e);case ye.CallExpression:return ne(e,void 0,void 0,!0);default:E(e,et.Util.lf("Unsupported syntax kind for output expression block: {0}",ye[e.kind]))}var t,r,n,i}function D(n,i,e){if(r){var t=r.getRenamesInSpan(i,e);if(t.length){var a=0;t.forEach(function(e){var t=e.span.start+a-i,r=t+e.span.length;a+=e.diff,n=n.slice(0,t)+e.name+n.slice(r)})}}return n}function M(e){var t=D(e.getFullText(),e.getFullStart(),e.getEnd()).trim();return de(e),Ze(e,I),W(et.TS_OUTPUT_TYPE,"EXPRESSION",t)}function B(e){if(e.kind===ye.BinaryExpression){var t=e;if("+"===t.operatorToken.getText()||t.operatorToken.kind==ye.PlusEqualsToken)return!!et.pxtInfo(e).exprInfo}return!1}function V(e){var t=[];!function e(t,r){B(t)?(e(t.left,r),e(t.right,r)):r.push(t)}(e,t);for(var r=[],n=0;n<t.length;n++)(0<n||!Re(t[n].getText()))&&r.push(G("ADD"+r.length,t[n],Ke));var i=_("text_join");return i.inputs=r,i.mutation={items:r.length.toString()},i}function G(e,t,r,n){var i;if("expr"==(i="number"==typeof t?J(t.toString()):"boolean"==typeof t?Q(t):"string"==typeof t?H(t):z(t)).kind&&"math_number"==i.type){var a=i.fields[0].value;"math_integer"==r&&a%1==0&&(i.type="math_integer"),"math_whole_number"==r&&a%1==0&&0<a&&(i.type="math_whole_number")}return j(e,i,r,n)}function J(e){return W("math_number","NUM",e)}function H(e){return W("text","TEXT",e)}function Q(e){return W("logic_boolean","BOOL",e?"TRUE":"FALSE")}function W(e,t,r,n){var i=_(e);return i.fields=[X(t,r)],i.isShadow=n,i}function Y(e,t){return j(e,W("variables_get_reporter","VAR",t,!0),"variables_get_reporter")}function Z(e,t,r){var n=pxt.blocks.reporterTypeForArgType(t),i=W(n,"VALUE",e,r);return"argument_reporter_custom"===n&&(i.mutation={typename:t}),i}function X(e,t){return{kind:"field",name:e,value:t}}function ee(e){var t=_("math_arithmetic");return t.inputs=[G("A",0,Ie),G("B",e,Ie)],t.fields=[X("OP","MINUS")],t}function te(e,t,r){void 0===t&&(t=!1);var n=et.pxtInfo(e).callInfo;if(n){if(e.expression.kind===ye.Identifier){var i=e.expression.text;if($.declaredEnums[i]){var a=R.enumsByName[i];if(a&&a.blockId)return W(a.blockId,"MEMBER",e.name.text)}else if($.declaredKinds[i])return W($.declaredKinds[i].kindInfo.blockId,"MEMBER",e.name.text)}var s=q(n);if(r=s.blockId||r,s.blockCombine)return le(e,e,null,"@get@");if("lists_length"===s.blockId||"text_length"===s.blockId)return(c=_(et.U.htmlEscape(s.blockId))).inputs=[G("VALUE",e.expression)],c;var o=et.U.htmlEscape(s.blockId||n.qName),l=Me(e)[0],u=l&&et.pxtInfo(l).callInfo;if(t||!r&&!s.blockIdentity||u&&u.qName===s.blockIdentity)return{kind:"text",value:o};s.enumval&&u&&s.useEnumVal&&(o=s.enumval);var c,p=$.compInfo(n);return r&&p&&p.thisParameter?((c=_(r)).inputs=[G(et.U.htmlEscape(p.thisParameter.definitionName),e.expression,p.thisParameter.shadowBlockId)],c):re(s.blockIdentity?R.apis.byQName[s.blockIdentity]:R.blocksById[r],o)}E(e)}function re(e,t){var r=/(?:%|\$)([a-zA-Z0-9_]+)/.exec(e.attributes.block),n=_(et.U.htmlEscape(e.attributes.blockId));return n.fields=[{kind:"field",name:et.U.htmlEscape(r[1]),value:t}],n}function ne(e,t,r,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1);var f,a,s,o,l,u,c,p,d,m,h=e,g=!1,v=Ue(h,$,n,i);if(v)f=ie(h,void 0,v);else switch(h.kind){case ye.Block:return ce(h.statements,t,i);case ye.ExpressionStatement:return ne(h.expression,t,r||h,n,i);case ye.VariableStatement:if(!(f=ce(h.declarationList.declarations,void 0,!1,r||h)))return x();g=!0;break;case ye.FunctionExpression:case ye.ArrowFunction:return p=t,ne(h.body,p);case ye.BinaryExpression:f=function(e){switch(e.left.text,e.operatorToken.kind){case ye.EqualsToken:return e.left.kind===ye.Identifier?se(e,e.left,e.right):e.left.kind==ye.PropertyAccessExpression?oe(e,e.left,e.right,"@set@"):(a=(i=e).left,s=e.right,(o=N("lists_index_set",i)).inputs=[G("LIST",a.expression),G("INDEX",a.argumentExpression,Ie),G("VALUE",s)],o);case ye.PlusEqualsToken:if(B(e)){var t=N("variables_set",e),r=me(e.left);return fe(r,be.InBlocksOnly),t.inputs=[j("VALUE",V(e),Ie)],t.fields=[X("VAR",r)],t}return e.left.kind==ye.PropertyAccessExpression?oe(e,e.left,e.right,"@change@"):se(e,e.left,e.right,!0);case ye.MinusEqualsToken:var n=N("variables_change",e);return n.inputs=[j("VALUE",ee(e.right),Ie)],n.fields=[X("VAR",me(e.left))],n;default:return void E(e,et.Util.lf("Unsupported operator token in statement {0}",ye[e.operatorToken.kind]))}var i,a,s,o}(h);break;case ye.PostfixUnaryExpression:case ye.PrefixUnaryExpression:f=function(e){var t=e.operator===ye.PlusPlusToken;if(t||e.operator===ye.MinusMinusToken)return se(e,e.operand,t?1:-1,!0);E(e)}(h);break;case ye.VariableDeclaration:var b=h;if(Fe(b))return c=b,T.push([me(c.name),c]),x();f=function(e){if((t=e).name.kind!==ye.Identifier?(E(t,et.Util.lf("Variable declarations may not use binding patterns")),0):t.initializer||(E(t,et.Util.lf("Variable declarations must have an initializer")),0))return se(e,e.name,e.initializer);var t}(h);break;case ye.WhileStatement:(u=N("device_while",l=h)).inputs=[ae("COND",l.expression)],u.handlers=[{name:"DO",statement:ne(l.statement)}],f=u;break;case ye.IfStatement:f=function(e){var t=function e(t){var r={ifStatements:[{expression:t.expression,thenStatement:t.thenStatement}],elseStatement:t.elseStatement};if(t.elseStatement&&t.elseStatement.kind==ye.IfStatement){var n=e(t.elseStatement);r.ifStatements=r.ifStatements.concat(n.ifStatements),r.elseStatement=n.elseStatement}return r}(e),n=N("controls_if",e);if(n.mutation={elseif:(t.ifStatements.length-1).toString(),else:t.elseStatement?"1":"0"},n.inputs=[],n.handlers=[],t.ifStatements.forEach(function(e,t){var r=ne(e.thenStatement);n.inputs.push(ae("IF"+t,e.expression)),n.handlers.push({name:"DO"+t,statement:r})}),t.elseStatement){var r=ne(t.elseStatement);n.handlers.push({name:"ELSE",statement:r})}return n}(h);break;case ye.ForStatement:f=function(e){var t,r=e.initializer,n=(r.declarations[0].name.text,e.condition),i=me(r.declarations[0].name);if(n.operatorToken.kind!==ye.LessThanToken||function e(t){return t.kind===ye.Identifier&&me(t)===i||Xe.forEachChild(t,e)}(e.statement))if((t=N("pxt_controls_for",e)).fields=[],t.inputs=[],t.handlers=[],t.inputs=[Y("VAR",i)],n.operatorToken.kind===ye.LessThanToken){var a=Be(n.right);if(a.kind===ye.NumericLiteral){var s=parseFloat(a.text)-1,o=J(s+"");t.inputs.push(j("TO",o,_e))}else{var l=_("math_arithmetic");l.fields=[X("OP","MINUS")],l.inputs=[G("A",a,Ie),G("B",1,Ie)],t.inputs.push(j("TO",l,_e))}}else n.operatorToken.kind===ye.LessThanEqualsToken&&t.inputs.push(G("TO",n.right,_e));else(t=N("controls_repeat_ext",e)).fields=[],t.inputs=[G("TIMES",n.right,_e)],t.handlers=[];var u=ne(e.statement);return t.handlers=[{name:"DO",statement:u}],t}(h);break;case ye.ForOfStatement:f=function(e){var t=me(e.initializer.declarations[0].name),r=N("pxt_controls_for_of",e);r.inputs=[G("LIST",e.expression),Y("VAR",t)];var n=ne(e.statement);return r.handlers=[{name:"DO",statement:n}],r}(h);break;case ye.FunctionDeclaration:f=function(e){var r=me(e.name);$.localReporters.push(e.parameters.map(function(e){return{name:e.name.getText(),type:e.type.getText()}}));var n,t=ne(e.body);return $.localReporters.pop(),(n=N("function_definition",e)).mutation={name:r},e.parameters&&(n.mutationChildren=[],e.parameters.forEach(function(e){var t=e.name.getText();n.mutationChildren.push({nodeName:"arg",attributes:{name:t,type:e.type.getText(),id:$.functionParamIds[r][t]}})})),n.handlers=[{name:"STACK",statement:t}],n}(h);break;case ye.CallExpression:f=function(e,t){var P=et.pxtInfo(e).callInfo,L=q(P);if("Math.pow"==P.qName){var r=_("math_arithmetic");return r.inputs=[j("A",z(e.arguments[0]),Ie),j("B",z(e.arguments[1]),Ie)],r.fields=[X("OP","POWER")],r}if(pxt.Util.startsWith(P.qName,"Math.")){var n=P.qName.substring(5);if(Ge(n)){var i;if(Qe(n))i=_("math_js_round");else{i=_("math_js_op");var a=void 0;a=Je(n)?"unary":He(n)?"infix":"binary",i.mutation={"op-type":a}}return i.inputs=P.args.map(function(e,t){return j("ARG"+t,z(e),"math_number")}),i.fields=[X("OP",n)],i}}if(L.blockId===et.PAUSE_UNTIL_TYPE){var s=N(et.PAUSE_UNTIL_TYPE,e),o=e.arguments[0],l=void 0;return l=o.body.kind===ye.Block?o.body.statements[0].expression:o.body,s.inputs=[j("PREDICATE",z(l),"logic_boolean")],s}if(!L.blockId||!L.block){var u=pxt.blocks.builtinFunctionInfo[P.qName];if(!u){var c=me(e.expression);if($.declaredFunctions[c]){var p,f=!0;if(P.isExpression){var d=Me(e)[0];f=d&&d.kind===ye.ExpressionStatement}return p=N(f?"function_call":"function_call_output",e),P.args.length&&(p.mutationChildren=[],p.inputs=[],$.declaredFunctions[c].parameters.forEach(function(e,t){var r=e.name.getText(),n=$.functionParamIds[c][r];p.mutationChildren.push({nodeName:"arg",attributes:{name:r,type:e.type.getText(),id:n}});var i=z(P.args[t]),a=j(n,i);p.inputs.push(a)})),p.mutation={name:c},p}return ie(e)}L.blockId=u.blockId}if(L.imageLiteral)return function(e,t){var r=e.arguments[0];if(r.kind==ye.StringLiteral||r.kind==ye.NoSubstitutionTemplateLiteral){var n=q(t),i=N(n.blockId,e);i.fields=[];var a=(r.text||"").replace(/\s+/g,""),s=(n.imageLiteralColumns||5)*n.imageLiteral,o=n.imageLiteralRows||5,l=s*o;if(l==a.length){for(var u="",c=0;c<o;++c){for(var p=0;p<s;++p)u+=/[#*1]/.test(a[c*s+p])?"#":".";u+="\n"}return i.fields.push(X("LEDS","`"+u+"`")),i}E(e,et.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",l,a.length))}else E(e)}(e,P);Xe.isFunctionLike(P.decl);var m=ze(P,$.blocks),h=$.blocks.apis.byQName[P.decompilerBlockAlias||P.qName],F=pxt.blocks.compileInfo(h),O=t?_(L.blockId):N(L.blockId,e),D=function(e){return(O.inputs||(O.inputs=[])).push(e)},M=function(e){return(O.fields||(O.fields=[])).push(e)};"Math.max"==P.qName&&M({kind:"field",name:"op",value:"max"});var B=0;return m.forEach(function(e,t){var r,n,i=e.value,a=e.param,s=e.info,o=F.parameters[F.thisParameter?t-1:t],l=o&&o.range;if(l){var u=l.min,c=l.max;r={min:u.toString(),max:c.toString()}}if(0===t&&L.defaultInstance){if(i.getText()===L.defaultInstance)return;O.mutation={showing:"true"}}if(!L.mutatePropertyEnum||t!==P.args.length-2){var p;if(a&&a.isOptional&&++B,a&&a.shadowBlockId&&(p=R.blocksById[a.shadowBlockId]),i.kind===ye.CallExpression){var f=et.pxtInfo(i).callInfo,d=f&&q(f);d&&"TD_ID"===d.shim&&s.isEnum&&(i=Be(f.args[0]))}if(a&&s&&s.isEnum&&i.kind===ye.Identifier)M(X(et.U.htmlEscape(a.definitionName),et.pxtInfo(i).commentAttrs.enumIdentity));else if(a&&a.fieldOptions&&a.fieldOptions[ge.DecompileArgumentAsString])M(X(et.U.htmlEscape(a.definitionName),et.Util.htmlEscape(i.getText())));else switch(i.kind){case ye.FunctionExpression:case ye.ArrowFunction:i.body;var m=function(e){var t=Oe(e);if(t)return{callbackproperties:t[0].join(","),renamemap:et.Util.htmlEscape(JSON.stringify(t[1]))}}(i),h=!1;if(m)O.mutation=m;else{var g=i,v=R.blocksById[L.blockId].parameters[F.thisParameter?t-1:t],b=function(e,t){var r,n,i,a;"reporter"===L.draggableParameters?D((r="HANDLER_DRAG_PARAM_"+e.name,n=t,i=e.type,a=pxt.blocks.reporterTypeForArgType(i),j(r,Z(n,i,!0),a))):D(Y("HANDLER_DRAG_PARAM_"+e.name,t))};if(g.parameters.length&&(L.optionalVariableArgs?(O.mutation={numargs:g.parameters.length.toString()},g.parameters.forEach(function(e,t){O.mutation["arg"+t]=e.name.text})):g.parameters.forEach(function(e,t){var r=v.handlerParameters[t];L.draggableParameters?b(r,e.name.text):M(X("HANDLER_"+r.name,e.name.text))})),L.draggableParameters){if(g.parameters.length<v.handlerParameters.length)for(var y=g.parameters.length;y<v.handlerParameters.length;y++){var x=v.handlerParameters[y];b(x,x.name)}"reporter"===L.draggableParameters&&($.localReporters.push(v.handlerParameters),h=!0)}}var k=ne(i);(O.handlers||(O.handlers=[])).push({name:"HANDLER",statement:k}),h&&$.localReporters.pop();break;case ye.PropertyAccessExpression:var S=et.pxtInfo(i).callInfo,T=et.U.htmlEscape(a.definitionName),w=q(S);p&&"TD_ID"===p.attributes.shim?D(j(T,te(i,!1,a.shadowBlockId),a.shadowBlockId,r)):s&&s.isEnum||S&&(w.fixedInstance||w.blockIdentity===P.qName)?M(X(T,te(i,!0).value)):D(G(T,i,a.shadowBlockId,r));break;case ye.BinaryExpression:if(a&&a.shadowOptions&&a.shadowOptions.toString){var I=i;if(I.operatorToken.kind===ye.PlusToken&&((n=I.left).kind===ye.StringLiteral||n.kind===ye.NoSubstitutionTemplateLiteral)&&""===n.text){D(G(et.U.htmlEscape(a.definitionName),I.right,a.shadowBlockId||"text"));break}}D(G(et.U.htmlEscape(a.definitionName),i,a.shadowBlockId,r));break;default:var E=void 0,N=et.U.htmlEscape(a.definitionName),_=!0;if("Math.random"==P.qName)E=j(N,function(e){switch(e.kind){case ye.NumericLiteral:var t=e;return J((parseInt(t.text)-1).toString());case ye.BinaryExpression:var r=e;if(r.operatorToken.kind==ye.PlusToken&&"1"==r.right.text)return z(r.left);default:return z(e)}}(i),Ie,r),_=!1;else if(je(i)){var K="text"==a.fieldEditor?i.text:i.getText(),A=a.shadowBlockId&&!function(e){switch(e){case Ie:case Ee:case Ne:case _e:case Ke:case Ae:return!0;default:return!1}}(a.shadowBlockId);if(ue(a)&&a.fieldOptions.onParentBlock)return void M(X(N,K));if(A){var C=function(e){if(R.blocksById[e]){var t=pxt.blocks.compileInfo(R.blocksById[e]);if(!t.thisParameter&&1===t.parameters.length)return t.parameters[0]}}(a.shadowBlockId);if(C&&ue(C)){var U=W(a.shadowBlockId,C.definitionName,K,!0);a.shadowOptions&&(U.mutation={customfield:et.Util.htmlEscape(JSON.stringify(a.shadowOptions))}),E=j(N,U,a.shadowBlockId,r),_=!1}}}else if(i.kind===ye.TaggedTemplateExpression&&a.fieldOptions&&a.fieldOptions[ge.TaggedTemplate])return void M(X(N,et.Util.htmlEscape(i.getText())));_&&(E=G(N,i,a.shadowBlockId,r)),D(E)}}}),B&&(O.mutation||(O.mutation={}),O.mutation._expanded=B.toString()),O}(h,n);break;case ye.DebuggerStatement:o=h,f=N(et.TS_DEBUGGER_TYPE,o);break;case ye.BreakStatement:s=h,f=N(et.TS_BREAK_TYPE,s);break;case ye.ContinueStatement:a=h,f=N(et.TS_CONTINUE_TYPE,a);break;case ye.EmptyStatement:f=void 0;break;case ye.EnumDeclaration:case ye.ModuleDeclaration:return Ze(h,I),x();case ye.ReturnStatement:d=h,m=N(et.TS_RETURN_STATEMENT_TYPE,d),d.expression?m.inputs=[j("RETURN_VALUE",z(d.expression),Ie)]:m.mutation={no_return_value:"true"},f=m;break;default:return void E(h,t?et.Util.lf("Unsupported statement in block: {0}",ye[h.kind]):et.Util.lf("Statement kind unsupported in blocks: {0}",ye[h.kind]))}if(f){for(var y=f;y.next;)y=y.next;y.next=x(),y.next&&(y.next.prev=y)}return g||function(e){for(var t,n=[],r=0;r<I.length&&(!(t=I[r]).owner&&t.start>=e.pos&&t.end<=e.end&&(t.owner=e,t.ownerStatement=f,n.push(t)),!(t.start>e.end));r++);if(t&&t.isTrailingComment){var i=Xe.getLineAndCharacterOfPosition(k,e.end),a=Xe.getLineAndCharacterOfPosition(k,t.start);if(i.line===a.line){if(t.ownerStatement){t.ownerStatement.comment.splice(t.ownerStatement.comment.indexOf(t),1);for(var s=0,o=S;s<o.length;s++){var l=o[s];l.comment.splice(l.comment.indexOf(t),1)}}t.owner=e,t.ownerStatement=f,n.push(t)}}if(n.length){var u=[];if(function e(t){var r=Me(t)[0];return!r||r.kind==ye.SourceFile||(r.kind==ye.ExpressionStatement?e(r):r.kind==ye.VariableDeclarationList&&e(r.parent))}(e)){var c=[],p=[];n.forEach(function(e,t){var r=e.owner&&e.start<e.owner.getStart();e.kind===ve.MultiLine&&r&&(c.length&&(p.push(c),c=[]),t!=n.length-1)?p.push([e]):(c.push(e),e.followedByEmptyLine&&r&&(p.push(c),c=[]))}),n=c,p.forEach(function(e){var t=w();u.push(t),S.push({comment:e,refId:t})})}f&&(u.length&&(f.data?f.data+=";"+u.join(";"):f.data=u.join(";")),n&&n.length&&(f.comment?f.comment=f.comment.concat(n):f.comment=n))}}(r||h),f;function x(){if(t&&t.length)return ne(t.shift(),t,void 0,!1,i)}}function ie(e,t,r){c.errorOnGreyBlocks&&E(e);var n=N(et.TS_STATEMENT_TYPE,e);n.mutation={},de(e);var i=e.getText();i=D(i,e.getStart(),e.getEnd()),Ze(e,I),t&&(i=t+i);var a=[];if(e.kind===ye.VariableStatement)for(var s=0,o=e.declarationList.declarations;s<o.length;s++){var l=o[s];a.push(me(l.name))}else e.kind===ye.VariableDeclaration&&a.push(me(e.name));a.length&&(n.mutation.declaredvars=a.join(","));var u=i.split("\n");return n.mutation.numlines=u.length.toString(),r&&c.includeGreyBlockMessages&&(n.mutation.error=et.U.htmlEscape(r)),u.forEach(function(e,t){n.mutation["line"+t]=et.U.htmlEscape(e)}),n}function ae(e,t){return function(e){var t=Be(e);switch(t.kind){case ye.TrueKeyword:case ye.FalseKeyword:case ye.Identifier:case ye.ElementAccessExpression:return;case ye.BinaryExpression:return function(e){switch(e.operatorToken.kind){case ye.EqualsEqualsToken:case ye.EqualsEqualsEqualsToken:case ye.ExclamationEqualsToken:case ye.ExclamationEqualsEqualsToken:case ye.LessThanToken:case ye.LessThanEqualsToken:case ye.GreaterThanToken:case ye.GreaterThanEqualsToken:case ye.AmpersandAmpersandToken:case ye.BarBarToken:return;default:return et.Util.lf("Binary expressions in conditionals must evaluate to booleans")}}(t);case ye.CallExpression:return function(e){var t=et.pxtInfo(e).callInfo;if(t){var r=$.blocks.apis.byQName[t.qName];if(r&&"boolean"==r.retType)return;if(Xe.isIdentifier(e.expression)&&$.declaredFunctions[e.expression.text])return}return et.Util.lf("Only functions that return booleans are allowed as conditions")}(t);case ye.PrefixUnaryExpression:if(t.operator===ye.ExclamationToken)return;default:return et.Util.lf("Conditions must evaluate to booleans or identifiers")}}(t)?j(e,M(t),Ae):G(e,t,Ae)}function se(e,t,r,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1);var a=me(t);fe(a,be.InBlocksOnly);var s=N(n?"variables_change":"variables_set",e.parent||e);return s.inputs=[G("VALUE",r,Ie)],s.fields=[X("VAR",a)],s}function oe(e,t,r,n){return le(e,t,r,n)}function le(e,t,r,n){var i=et.pxtInfo(t).callInfo,a=$.blocks.apis.byQName[i?i.qName:""];if(a&&a.attributes.blockCombine){var s=a.namespace+"."+a.retType+"."+n,o=$.blocks.blocks.find(function(e){return e.qName==s}),l=r?N(o.attributes.blockId,e):_(o.attributes.blockId),u=o.attributes._def.parameters,c=i.qName;return o.combinedProperties&&o.combinedProperties.forEach(function(e){0===e.indexOf(i.qName)&&"@"===e.charAt(i.qName.length)&&(c=e)}),l.inputs=[G(u[0].name,t.expression)],l.fields=[X(u[1].name,c)],r&&l.inputs.push(G(u[2].name,r)),l}E(t)}function ue(e){return e&&e.fieldOptions&&e.fieldOptions[ge.DecompileLiterals]}function ce(e,t,r,n,i){void 0===r&&(r=!1),void 0===i&&(i=!1);for(var a=[],s=t||[],o=e.length-1;0<=o;o--){var l=e[o];(l.kind===ye.FunctionDeclaration||l.kind==ye.ExpressionStatement&&y(l))&&!Ue(l,$,!1,r)?a.unshift(l):s.unshift(l)}if(a.map(function(e){return ne(e,void 0,void 0,!1,r)}).forEach(x),s.length){var u=s.shift(),c=ne(u,s,n,!1,r);if(i){var p=c,f=u;if(T.forEach(function(e){var t,r=e[0],n=e[1];m[r]!==be.InBlocksOnly&&(n.initializer,(t=m[r]===be.InTextBlocks?ie(n,"let "):se(u,n.name,n.initializer,!1,!0)).next=p,p=t,f=n)}),p){var d=N(Xe.pxtc.ON_START_TYPE,f);return d.handlers=[{name:"HANDLER",statement:p}],d}pe(c)}return c}i&&pe(void 0)}function pe(e){c.alwaysEmitOnStart&&(F(Xe.pxtc.ON_START_TYPE,e),O())}function fe(e,t){m[e]!==be.InTextBlocks&&(m[e]=t)}function de(e){Xe.forEachChild(e,function(e){e.kind===ye.Identifier&&fe(me(e),be.InTextBlocks),de(e)})}function me(e){if(r){var t=r.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}},he.getLeadingComments=function(e,t,r){return f(t,r||Xe.getLeadingCommentRangesOfNode(e,t))},he.getTrailingComments=function(e,t){return f(t,Xe.getTrailingCommentRanges(t.getFullText(),e.end))},he.getCommentsForStatement=function(e,t){for(var r,n=[],i=0;i<t.length&&(!(r=t[i]).owner&&r.start>=e.pos&&r.end<=e.end&&(r.owner=e,n.push(r)),!(r.start>e.end));i++);return n},he.buildCommentMap=Ye})((et=Xe.pxtc||(Xe.pxtc={})).decompiler||(et.decompiler={}))}(ts||(ts={})),function(e){var t;(function(e){function o(e,t){var r;switch(e){case"void":return"None";case"boolean":return"bool";case"string":return"str"}if(null===(r=t.byQName[e])||void 0===r?void 0:r.pyQName)return t.byQName[e].pyQName;var n=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(e);return n?"List["+o(n[1]||n[2],t)+"]":e}function l(e,t){return"```"+(t?"python":"ts")+"\n"+e+"\n```"}e.displayStringForSymbol=function(e,t,r){if(e){switch(e.kind){case 3:case 1:return function(e,t,r){var n="";3===e.kind?n+=t?"def ":"function ":n+="(method) ",n+=t?e.pyQName:e.qName;var i="";e.parameters&&e.parameters.length&&(i=e.parameters.map(function(e){return e.name+": "+(t?e.pyTypeString:e.type)}).join(", "));var a=e.retType||"void";return t&&(a=o(a,r)),l(n+"("+i+"): "+a,t)}(e,t,r);case 6:case 7:return function(e,t){var r=t?e.pyQName:e.qName;if(6===e.kind)return l("enum "+r,t);var n="(enum member) "+r;return e.attributes.enumval&&(n+=" = "+e.attributes.enumval),l(n,!1)}(e,t);case 5:return s=e,l("namespace "+(t?s.pyQName:s.qName),!1);case 9:return a=e,l("interface "+(t?a.pyQName:a.qName),!1);case 8:return n=e,l("class "+((i=t)?n.pyQName:n.qName),i);case 4:return function(e,t,r){var n=t?e.pyQName:"let "+e.qName;if(e.retType){var i=e.retType;return t&&(i=o(i,r)),l(n+": "+i,t)}return l(n,t)}(e,t,r);case 2:return function(e,t,r){var n="(property) "+(t?e.pyQName:e.qName);if(e.retType){var i=e.retType;return t&&(i=o(i,r)),l(n+": "+i,!1)}return l(n,!1)}(e,t,r)}var n,i,a,s;return"**"+e.qName+"**"}},e.displayStringForKeyword=function(e,t){return"```"+(t?"py":"ts")+"\n(keyword) "+e+"\n```"}})((t=e.pxtc||(e.pxtc={})).service||(t.service={}))}(ts||(ts={})),function(e){var S;(function(e){var r={r0:0,r1:1,r2:2,r3:3,r4:4,r5:5,r6:6,r7:7,r8:8,r9:9,r10:10,r11:10,r12:12,sp:13,r13:13,lr:14,r14:14,pc:15,r15:15},t=function(e){function t(){var t=e.call(this)||this;return t.addEnc("$r0","R0-7",function(e){return t.inrange(7,e,e)}),t.addEnc("$r1","R0-7",function(e){return t.inrange(7,e,e<<3)}),t.addEnc("$r2","R0-15",function(e){return t.inrange(15,e,7&e|(8&e)<<4)}),t.addEnc("$r3","R0-15",function(e){return t.inrange(15,e,e<<3)}),t.addEnc("$r4","R0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$r5","R0-7",function(e){return t.inrange(7,e,e<<8)}),t.addEnc("$r01","R0-7",function(e){return t.inrange(7,e,e|e<<3)}),t.addEnc("$i0","#0-255",function(e){return t.inrange(255,e,e)}),t.addEnc("$i1","#0-1020",function(e){return t.inrange(255,e/4,e>>2)}),t.addEnc("$i2","#0-510",function(e){return t.inrange(127,e/4,e>>2)}),t.addEnc("$i3","#0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$i4","#0-31",function(e){return t.inrange(31,e,e<<6)}),t.addEnc("$i5","#0-124",function(e){return t.inrange(31,e/4,e>>2<<6)}),t.addEnc("$i6","#1-32",function(e){return 0==e?null:32==e?0:t.inrange(31,e,e<<6)}),t.addEnc("$i7","#0-62",function(e){return t.inrange(31,e/2,e>>1<<6)}),t.addEnc("$i32","#0-2^32",function(e){return 1}),t.addEnc("$rl0","{R0-7,...}",function(e){return t.inrange(255,e,e)}),t.addEnc("$rl1","{LR,R0-7,...}",function(e){return 16384&e?t.inrange(255,-16385&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$rl2","{PC,R0-7,...}",function(e){return 32768&e?t.inrange(255,-32769&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$la","LABEL",function(e){return t.inrange(255,e/4,e>>2)}).isWordAligned=!0,t.addEnc("$lb","LABEL",function(e){return t.inrangeSigned(127,e/2,e>>1)}),t.addEnc("$lb11","LABEL",function(e){return t.inrangeSigned(1023,e/2,e>>1)}),t.addInst("adcs  $r0, $r1",16704,65472),t.addInst("add   $r2, $r3",17408,65280),t.addInst("add   $r5, pc, $i1",40960,63488),t.addInst("add   $r5, sp, $i1",43008,63488),t.addInst("add   sp, $i2",45056,65408).canBeShared=!0,t.addInst("adds  $r0, $r1, $i3",7168,65024),t.addInst("adds  $r0, $r1, $r4",6144,65024),t.addInst("adds  $r01, $r4",6144,65024),t.addInst("adds  $r5, $i0",12288,63488),t.addInst("adr   $r5, $la",40960,63488),t.addInst("ands  $r0, $r1",16384,65472),t.addInst("asrs  $r0, $r1",16640,65472),t.addInst("asrs  $r0, $r1, $i6",4096,63488),t.addInst("bics  $r0, $r1",17280,65472),t.addInst("bkpt  $i0",48640,65280),t.addInst("blx   $r3",18304,65415),t.addInst("bx    $r3",18176,65408),t.addInst("cmn   $r0, $r1",17088,65472),t.addInst("cmp   $r0, $r1",17024,65472),t.addInst("cmp   $r2, $r3",17664,65280),t.addInst("cmp   $r5, $i0",10240,63488),t.addInst("eors  $r0, $r1",16448,65472),t.addInst("ldmia $r5!, $rl0",51200,63488),t.addInst("ldmia $r5, $rl0",51200,63488),t.addInst("ldr   $r0, [$r1, $i5]",26624,63488),t.addInst("ldr   $r0, [$r1, $r4]",22528,65024),t.addInst("ldr   $r5, [pc, $i1]",18432,63488),t.addInst("ldr   $r5, $la",18432,63488),t.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,t.addInst("ldr   $r5, [sp]",38912,63488).canBeShared=!0,t.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),t.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),t.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),t.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),t.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),t.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),t.addInst("lsls  $r0, $r1",16512,65472),t.addInst("lsls  $r0, $r1, $i4",0,63488),t.addInst("lsrs  $r0, $r1",16576,65472),t.addInst("lsrs  $r0, $r1, $i6",2048,63488),t.addInst("mov   $r2, $r3",17920,65280),t.addInst("movs  $r0, $r1",0,65472),t.addInst("movs  $r5, $i0",8192,63488),t.addInst("muls  $r0, $r1",17216,65472),t.addInst("mvns  $r0, $r1",17344,65472),t.addInst("negs  $r0, $r1",16960,65472),t.addInst("nop",18112,65535),t.addInst("orrs  $r0, $r1",17152,65472),t.addInst("pop   $rl2",48128,65024),t.addInst("push  $rl1",46080,65024),t.addInst("rev   $r0, $r1",47616,65472),t.addInst("rev16 $r0, $r1",47680,65472),t.addInst("revsh $r0, $r1",47808,65472),t.addInst("rors  $r0, $r1",16832,65472),t.addInst("sbcs  $r0, $r1",16768,65472),t.addInst("sev",48960,65535),t.addInst("stm   $r5!, $rl0",49152,63488),t.addInst("stmia $r5!, $rl0",49152,63488),t.addInst("stmea $r5!, $rl0",49152,63488),t.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1, $r4]",20480,65024),t.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,t.addInst("str   $r5, [sp]",36864,63488).canBeShared=!0,t.addInst("strb  $r0, [$r1, $i4]",28672,63488),t.addInst("strb  $r0, [$r1, $r4]",21504,65024),t.addInst("strh  $r0, [$r1, $i7]",32768,63488),t.addInst("strh  $r0, [$r1, $r4]",20992,65024),t.addInst("sub   sp, $i2",45184,65408),t.addInst("subs  $r0, $r1, $i3",7680,65024),t.addInst("subs  $r0, $r1, $r4",6656,65024),t.addInst("subs  $r01, $r4",6656,65024),t.addInst("subs  $r5, $i0",14336,63488),t.addInst("svc   $i0",57088,65280),t.addInst("sxtb  $r0, $r1",45632,65472),t.addInst("sxth  $r0, $r1",45568,65472),t.addInst("tst   $r0, $r1",16896,65472),t.addInst("udf   $i0",56832,65280),t.addInst("uxtb  $r0, $r1",45760,65472),t.addInst("uxth  $r0, $r1",45696,65472),t.addInst("wfe",48928,65535),t.addInst("wfi",48944,65535),t.addInst("yield",48912,65535),t.addInst("cpsid i",46706,65535),t.addInst("cpsie i",46690,65535),t.addInst("beq   $lb",53248,65280),t.addInst("bne   $lb",53504,65280),t.addInst("bcs   $lb",53760,65280),t.addInst("bcc   $lb",54016,65280),t.addInst("bmi   $lb",54272,65280),t.addInst("bpl   $lb",54528,65280),t.addInst("bvs   $lb",54784,65280),t.addInst("bvc   $lb",55040,65280),t.addInst("bhi   $lb",55296,65280),t.addInst("bls   $lb",55552,65280),t.addInst("bge   $lb",55808,65280),t.addInst("blt   $lb",56064,65280),t.addInst("bgt   $lb",56320,65280),t.addInst("ble   $lb",56576,65280),t.addInst("bhs   $lb",53760,65280),t.addInst("blo   $lb",54016,65280),t.addInst("b     $lb11",57344,63488),t.addInst("bal   $lb11",57344,63488),t.addInst("bl    $lb",61440,63488,!0),t.addInst("bb    $lb",57344,63488,!0),t.addInst("ldlit   $r5, $i32",18432,63488),t}return __extends(t,e),t.prototype.toFnPtr=function(e,t,r){return S.target.runtimeIsARM&&/::/.test(r)?e+t&-2:e+t|1},t.prototype.wordSize=function(){return 4},t.prototype.is32bit=function(e){return"bl"==e.name||"bb"==e.name},t.prototype.postProcessAbsAddress=function(e,t){return t^=1,t-=e.baseOffset},t.prototype.emit32=function(e,t,r){var n=!!(t%2);n&&(t=t+1&-4);var i=t>>1;if(S.assert(null!=i),(0|i)!=i||!(-2097152<i&&i<2097152))return S.assembler.emitErr("jump out of range",r);var a=2047&i,s=i>>11&1023;return{opcode:4026531840&i?62464|s:61440|s,opcode2:n?59392|a:63488|a,stack:0,numArgs:[t],labelName:r}},t.prototype.expandLdlit=function(e){for(var t,r=!1,n=[],i={},a=1,s=0;s<e.lines.length;++s){var o=e.lines[s];if(n.push(o),"instruction"==o.type&&o.instruction&&"ldlit"==o.instruction.name){if(!t){for(var l=o.location+900,u=s+1;u<e.lines.length&&!(e.lines[u].location>l);++u){var c=e.lines[u].getOp();("b"==c||"bb"==c||"pop"==c&&"pc"==e.lines[u].words[2])&&(t=e.lines[u])}if(t)r=!1;else for(r=!0;--u>s;)if("instruction"==e.lines[u].type){t=e.lines[u];break}}var p=o.words[1],f="#"+o.words[3];(v=S.U.lookup(i,f))||(v="_ldlit_"+ ++a,i[f]=v),o.update("ldr "+p+", "+v)}if(o===t){t=null;var d=[],m="_jmpwords_"+ ++a;r&&d.push("bb "+m),d.push(".balign 4");for(var h=0,g=Object.keys(i);h<g.length;h++){var v=i[f=g[h]];d.push(v+": .word "+f.slice(1))}r&&d.push(m+":");for(var b=0,y=d;b<y.length;b++){var x=y[b];e.buildLine(x,n);var k=n[n.length-1];k.scope=o.scope,k.lineNo=o.lineNo}i={}}}e.lines=n},t.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);if(null==i)return null;var a=e.location()+4;return n&&(a&=4294967292),i-a},t.prototype.isPop=function(e){return 48128==e},t.prototype.isPush=function(e){return 46080==e},t.prototype.isAddSP=function(e){return 45056==e},t.prototype.isSubSP=function(e){return 45184==e},t.prototype.peephole=function(e,t,r){var n=this.encoders.$lb11,i=this.encoders.$lb;function a(e,t){return null!=e.encode(t.numArgs[0]+8)&&null!=e.encode(t.numArgs[0]-8)&&null!=e.encode(t.numArgs[0])}var s,o,l,u,c=e.getOp(),p=!1;"bne"!=c&&"beq"!=c||("b"==t.getOp()&&0==e.numArgs[0]&&(p=!0),"bb"==t.getOp()&&2==e.numArgs[0]&&(p=!0)),"bb"==c&&a(n,e)?e.update("b "+e.words[1]):"b"==c&&-2==e.numArgs[0]?e.update(""):"bne"==c&&p&&a(i,t)?(e.update("beq "+t.words[1]),t.update("")):"beq"==c&&p&&a(i,t)?(e.update("bne "+t.words[1]),t.update("")):"push"!=c||16384!=e.numArgs[0]||"push"!=t.getOp()||16384&t.numArgs[0]?"pop"==c&&"pop"==t.getOp()&&32768==t.numArgs[0]?(e.update(e.text.replace("}",", pc}")),t.update("")):"push"==c&&"pop"==t.getOp()&&e.numArgs[0]==t.numArgs[0]?(S.assert(0<e.numArgs[0]),e.update(""),t.update("")):"push"==c&&"pop"==t.getOp()&&4==e.words.length&&4==t.words.length?(S.assert("{"==e.words[1]),e.update("mov "+t.words[2]+", "+e.words[2]),t.update("")):r&&"movs $r5, $i0"==e.getOpExt()&&"mov $r0, $r1"==t.getOpExt()&&e.numArgs[0]==t.numArgs[1]&&(l=r,u=e.numArgs[0],"pop"==l.getOp()&&l.numArgs[0]&1<<u)?(e.update("movs r"+t.numArgs[0]+", #"+e.numArgs[1]),t.update("")):"pop"==c&&0<=f(e)&&"push"==t.getOp()&&f(e)==f(t)?(e.update("ldr r"+f(e)+", [sp, #0]"),t.update("")):"push"==c&&"ldr $r5, [sp, $i1]"==t.getOpExt()&&f(e)==t.numArgs[0]&&0==t.numArgs[1]?t.update(""):r&&"push"==c&&0<=f(e)&&(s=t,o=f(e),"movs $r5, $i0"==s.getOpExt()&&s.numArgs[0]!=o)&&"pop"==r.getOp()&&f(e)==f(r)&&(e.update(""),r.update("")):(e.update(t.text.replace("{","{lr, ")),t.update(""))},t.prototype.registerNo=function(e){if(!e)return null;e=e.toLowerCase();var t=r[e];return void 0===t?null:t},t.prototype.testAssembler=function(){S.assembler.expectError(this,"lsl r0, r0, #8"),S.assembler.expectError(this,"push {pc,lr}"),S.assembler.expectError(this,"push {r17}"),S.assembler.expectError(this,"mov r0, r1 foo"),S.assembler.expectError(this,"movs r14, #100"),S.assembler.expectError(this,"push {r0"),S.assembler.expectError(this,"push lr,r0}"),S.assembler.expectError(this,"pop {lr,r0}"),S.assembler.expectError(this,"b #+11"),S.assembler.expectError(this,"b #+102400"),S.assembler.expectError(this,"bne undefined_label"),S.assembler.expectError(this,".foobar"),S.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),S.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),S.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),S.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),S.assembler.expect(this,'6261      .string "abc"\n0063      \n'),S.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),S.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")},t}(S.assembler.AbstractProcessor);function f(e){S.assert("push"==e.getOp()||"pop"==e.getOp());for(var t=0,r=-1,n=e.numArgs[0];0<n;)1&n&&(r=-1==r?t:-2),n>>=1,t++;return 0<=r?r:-1}e.ThumbProcessor=t})((S=e.pxtc||(e.pxtc={})).thumb||(S.thumb={}))}(ts||(ts={})),function(x){var k;(function(g){var v,e,b=k.Util;b.assert,(e=v=g.EK||(g.EK={}))[e.None=0]="None",e[e.NumberLiteral=1]="NumberLiteral",e[e.PointerLiteral=2]="PointerLiteral",e[e.RuntimeCall=3]="RuntimeCall",e[e.ProcCall=4]="ProcCall",e[e.SharedRef=5]="SharedRef",e[e.SharedDef=6]="SharedDef",e[e.FieldAccess=7]="FieldAccess",e[e.Store=8]="Store",e[e.CellRef=9]="CellRef",e[e.Sequence=10]="Sequence",e[e.JmpValue=11]="JmpValue",e[e.Nop=12]="Nop",e[e.InstanceOf=13]="InstanceOf";var a,t,l,r,n=0,i=function(){function e(){}return e.prototype.isExpr=function(){return!1},e.prototype.isStmt=function(){return!1},e.prototype.getId=function(){return this._id||(this._id=++n),this._id},e}(),y=function(i){function r(e,t,r){var n=i.call(this)||this;return n.exprKind=e,n.args=t,n.data=r,n.callingConvention=0,n}return __extends(r,i),r.clone=function(e){var t=new r(e.exprKind,e.args?e.args.slice(0):null,e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t.mask=e.mask,t.isStringLiteral=e.isStringLiteral,t},r.prototype.reset=function(){this.currUses=0,this.prevTotalUses&&(this.totalUses=this.prevTotalUses)},r.prototype.ptrlabel=function(){return this.jsInfo instanceof s?this.jsInfo:null},r.prototype.hexlit=function(){var e=this.jsInfo;return null!=e.hexlit?e.hexlit:null},r.prototype.isExpr=function(){return!0},r.prototype.isPure=function(){return this.isStateless()||this.exprKind==v.CellRef},r.prototype.isLiteral=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:return!0;default:return!1}},r.prototype.isStateless=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:case v.SharedRef:return!0;default:return!1}},r.prototype.sharingInfo=function(){var e=this,t=this.getId();return this.exprKind!=v.SharedRef&&this.exprKind!=v.SharedDef||((e=this.args[0])?t=e.getId():e={currUses:"",totalUses:""}),e.currUses+"/"+e.totalUses+" #"+t},r.prototype.toString=function(){return o(this)},r.prototype.canUpdateCells=function(){switch(this.exprKind){case v.NumberLiteral:case v.PointerLiteral:case v.CellRef:case v.JmpValue:case v.SharedRef:case v.Nop:return!1;case v.SharedDef:case v.FieldAccess:case v.InstanceOf:return this.args[0].canUpdateCells();case v.RuntimeCall:case v.ProcCall:case v.Sequence:case v.Store:return!0;default:throw k.oops()}},r}(g.Node=i);g.Expr=y,(t=a=g.SK||(g.SK={}))[t.None=0]="None",t[t.Expr=1]="Expr",t[t.Label=2]="Label",t[t.Jmp=3]="Jmp",t[t.StackEmpty=4]="StackEmpty",t[t.Breakpoint=5]="Breakpoint",(r=l=g.JmpMode||(g.JmpMode={}))[r.Always=1]="Always",r[r.IfZero=2]="IfZero",r[r.IfNotZero=3]="IfNotZero",g.lblNumUsesJmpNext=-101;var s=function(n){function e(e,t){var r=n.call(this)||this;return r.stmtKind=e,r.expr=t,r}return __extends(e,n),e.prototype.isStmt=function(){return!0},e.prototype.toString=function(){return o(this)},e}(i);function o(e){return function e(t){if(t.isExpr()){var r=t,n=r.args?r.args[0]:null;switch(r.exprKind){case v.NumberLiteral:case v.PointerLiteral:return r.data+"";case v.CellRef:return r.data.toString();case v.JmpValue:return"JMPVALUE";case v.Nop:return"NOP";case v.SharedRef:return"SHARED_REF(#"+n.getId()+")";case v.SharedDef:return"SHARED_DEF(#"+n.getId()+" u("+n.totalUses+"): "+e(n)+")";case v.FieldAccess:return e(n)+"."+r.data.name;case v.RuntimeCall:return r.data+"("+r.args.map(e).join(", ")+")";case v.ProcCall:var i=r.data;return(null!=i.ifaceIndex?"IFACE@"+i.ifaceIndex:null!=i.virtualIndex?"VTABLE@"+i.virtualIndex:k.getDeclName(i.proc.action))+"("+r.args.map(e).join(", ")+")";case v.Sequence:return"("+r.args.map(e).join("; ")+")";case v.InstanceOf:return"("+e(r.args[0])+" instanceof "+r.data.id+")";case v.Store:return"{ "+e(r.args[0])+" := "+e(r.args[1])+" }";default:throw k.oops()}}else{var a=t,s=a.expr?e(a.expr):"{null}";switch(a.stmtKind){case g.SK.Expr:return"    "+s+"\n";case g.SK.Jmp:var o="goto "+a.lblName+"\n";switch(a.jmpMode){case l.Always:return a.expr?"    { JMPVALUE := "+s+" } "+o:"    "+o;case l.IfZero:return"    if (! "+s+") "+o;case l.IfNotZero:return"    if ("+s+") "+o;default:throw k.oops()}case g.SK.StackEmpty:return"    ;\n";case g.SK.Breakpoint:return"    // brk "+a.breakpointInfo.id+"\n";case g.SK.Label:return a.lblName+":\n";default:throw k.oops()}}}(e)}g.Stmt=s;var u=function(){function e(e,t,r){this.index=e,this.def=t,this.info=r,this.isarg=!1,this.iscap=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.isUserVariable=!1,this.bitSize=0,t&&(k.isInPxtModules(t)||(this.isUserVariable=!0),r&&k.setCellProps(this))}return e.prototype.getName=function(){return k.getDeclName(this.def)},e.prototype.getDebugInfo=function(){return{name:this.getName(),type:this._debugType,index:this.index}},e.prototype.toString=function(){var e="";return this.def&&(e+=this.getName()||"?"),this.isarg&&(e="ARG "+e),"["+e+"]"},e.prototype.uniqueName=function(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+k.getNodeId(this.def)},e.prototype.isLocal=function(){return this._isLocal},e.prototype.isGlobal=function(){return this._isGlobal},e.prototype.loadCore=function(){return d(v.CellRef,null,this)},e.prototype.load=function(){var e=this.loadCore();return k.target.isNative&&0!=this.bitSize?6==this.bitSize?m("pxt::fromUInt",[e]):m("pxt::fromInt",[e]):this.isByRefLocal()?m("pxtrt::ldlocRef",[e]):e},e.prototype.isByRefLocal=function(){return this.isLocal()&&this.info.captured&&this.info.written},e.prototype.storeDirect=function(e){return d(v.Store,[this.loadCore(),e])},e.prototype.storeByRef=function(e){if(this.isByRefLocal())return m("pxtrt::stlocRef",[this.loadCore(),e]);if(k.target.isNative&&0!=this.bitSize){var t=6==this.bitSize?"pxt::toUInt":"pxt::toInt";return this.storeDirect(m(t,[e],1))}return this.storeDirect(e)},Object.defineProperty(e.prototype,"isTemporary",{get:function(){return!1},enumerable:!0,configurable:!0}),e}(),c=function(n){function i(e,t){var r=n.call(this,e,null,null)||this;return r.index=e,r.owningProc=t,r.uid=i.unnamedCellCounter++,r}return __extends(i,n),i.prototype.getName=function(){return"unnamed"+this.uid},i.prototype.uniqueName=function(){return this.getName()+"___U"+this.index},i.prototype.isByRefLocal=function(){return!1},Object.defineProperty(i.prototype,"isTemporary",{get:function(){return!0},enumerable:!0,configurable:!0}),i.unnamedCellCounter=0,i}(g.Cell=u);g.UnnamedCell=c;var p=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.numArgs=0,e.info=null,e.seqNo=-1,e.isRoot=!1,e.locals=[],e.captured=[],e.args=[],e.parent=null,e.debugInfo=null,e.fillDebugInfo=null,e.classInfo=null,e.perfCounterName=null,e.perfCounterNo=0,e.body=[],e.lblNo=0,e.action=null,e.cachedJS=null,e.usingCtx=null,e}return __extends(e,t),e.prototype.reset=function(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]},e.prototype.isGetter=function(){return this.action&&this.action.kind==x.SyntaxKind.GetAccessor},e.prototype.vtLabel=function(){return this.label()+(k.isStackMachine()?"":"_args")},e.prototype.label=function(){return k.getFunctionLabel(this.action)},e.prototype.toString=function(){return"\nPROC "+k.getDeclName(this.action)+"\n"+this.body.map(function(e){return e.toString()}).join("")+"\n"},e.prototype.emit=function(e){this.body.push(e)},e.prototype.emitExpr=function(e){this.emit(f(a.Expr,e))},e.prototype.mkLabel=function(e){var t=f(a.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t},e.prototype.emitLbl=function(e){this.emit(e)},e.prototype.emitLblDirect=function(e){var t=f(a.Label,null);t.lblName=e,t.lbl=t,this.emit(t)},e.prototype.getFullName=function(){var e=this.getName();if(this.action){var t=x.pxtc.nodeLocationInfo(this.action);e+=" "+t.fileName.replace("pxt_modules/","")+":"+(t.line+1)}return e},e.prototype.getName=function(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"},e.prototype.mkLocal=function(e,t){var r=new u(this.locals.length,e,t);return this.locals.push(r),r},e.prototype.mkLocalUnnamed=function(){var e=new c(this.locals.length,this);return this.locals.push(e),e},e.prototype.localIndex=function(t,e){return void 0===e&&(e=!1),this.captured.filter(function(e){return e.def==t})[0]||this.locals.filter(function(e){return e.def==t})[0]||(e?null:this.args.filter(function(e){return e.def==t})[0])},e.prototype.stackEmpty=function(){this.emit(f(a.StackEmpty,null))},e.prototype.emitJmpZ=function(e,t){this.emitJmp(e,t,l.IfZero)},e.prototype.emitJmp=function(e,t,r,n){void 0===r&&(r=l.Always),void 0===n&&(n=null);var i=f(a.Jmp,t);i.jmpMode=r,n&&n.exprKind==v.NumberLiteral&&(n=null),i.terminateExpr=n,"string"==typeof e?i.lblName=e:(i.lbl=e,i.lblName=i.lbl.lblName),this.emit(i)},e.prototype.inlineSelf=function(e){var t=h(e,!1,!0),r=t.precomp,n=t.flattened;b.assert(n.length==this.args.length),this.args.map(function(e,t){e.repl=n[t],e.replUses=0});var i=function e(t){switch((t=y.clone(t)).exprKind){case v.PointerLiteral:case v.NumberLiteral:return t;case v.RuntimeCall:for(var r=0;r<t.args.length;++r)t.args[r]=e(t.args[r]);return t;case v.CellRef:var n=t.data;return n.repl?(n.replUses++,n.repl):t;case v.FieldAccess:return t.args[0]=e(t.args[0]),t;default:throw b.oops()}}(this.inlineBody);return this.args.forEach(function(e,t){e.repl.exprKind==v.SharedRef&&(e.repl.args[0].prevTotalUses||(e.repl.args[0].prevTotalUses=e.repl.args[0].totalUses),e.repl.args[0].totalUses+=e.replUses-1),e.repl=null,e.replUses=0}),r.length?(r.push(i),d(v.Sequence,r)):i},e.prototype.resolve=function(){var e,n=function(e,t){if(e.args)for(var r=0;r<e.args.length;++r)e.args[r]=t(e.args[r])},i=function(e){switch(e.exprKind){case v.SharedDef:throw b.oops();case v.SharedRef:var t=e.args[0];if(t.totalUses)return t.totalUses--,e;t.totalUses=-1,t.currUses=0,t.irCurrUses=0;var r=y.clone(e);return r.exprKind=v.SharedDef,r.args[0]=i(r.args[0]),r}return n(e,i),e},t=function(r){if(r.exprKind==v.SharedRef)return r;switch(n(r,t),r.exprKind){case v.Sequence:r.args=r.args.filter(function(e,t){return t==r.args.length-1||!e.isPure()||(e.exprKind==v.SharedRef&&0<e.args[0].totalUses&&e.args[0].totalUses--,!1)})}return r},a=function(e){switch(e.exprKind){case v.SharedDef:var t=e.args[0];if(b.assert(t.totalUses<0,"arg.totalUses < 0"),b.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return a(t);t.totalUses=1;break;case v.SharedRef:return b.assert(0<e.args[0].totalUses,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e;case v.PointerLiteral:var r=e.ptrlabel();r&&(r.lblNumUses||(r.lblNumUses=0),r.lblNumUses++)}return n(e,a),e},r=function(e){switch(e.exprKind){case v.SharedDef:n(e,r);case v.SharedRef:var t=e.args[0];return b.assert(0<t.totalUses,"arg.totalUses > 0"),1==t.totalUses?(b.assert(e.exprKind==v.SharedDef),t):(t.irCurrUses++,e);default:return n(e,r),e}};this.body=this.body.filter(function(e){return!e.expr||(e.expr=t(i(e.expr)),e.stmtKind!=g.SK.Expr||!e.expr.isPure())});for(var s=b.toDictionary(this.body.filter(function(e){return e.stmtKind==g.SK.Label}),function(e){return e.lblName}),o=0;o<this.body.length;++o)this.body[o].stmtNo=o;for(var l=0,u=this.body;l<u.length;l++)switch((e=u[l]).expr&&(e.expr=a(e.expr)),e.stmtKind){case g.SK.Expr:break;case g.SK.Jmp:e.lbl=b.lookup(s,e.lblName),e.lbl||k.oops("missing label: "+e.lblName),e.lbl.lblNumUses?e.lbl.lblNumUses++:e.lbl.lblNumUses=1;break;case g.SK.StackEmpty:case g.SK.Label:case g.SK.Breakpoint:break;default:k.oops()}for(var c=[],p=null,f=!k.target.debugMode,d=null,m=0,h=this.body;m<h.length;m++)(e=h[m]).expr&&(e.expr=t(r(e.expr))),p&&p.lbl==e&&p.stmtKind==g.SK.Jmp&&e.stmtKind==g.SK.Label&&p.jmpMode==g.JmpMode.Always&&1==e.lblNumUses&&(e.lblNumUses=g.lblNumUsesJmpNext),(p=e).stmtKind==g.SK.Breakpoint?c[e.breakpointInfo.id]=e.breakpointInfo:f&&(e.stmtKind==g.SK.Jmp?e.expr&&(d?f=!1:d=e.expr):e.stmtKind==g.SK.StackEmpty||(e.stmtKind==g.SK.Label?e.lblNumUses!=g.lblNumUsesJmpNext&&(f=!1):f=!1));f&&d&&function n(i){var e=function(){if(!i.args)return 0;for(var e=0,t=0,r=i.args;t<r.length;t++)e+=n(r[t]);return i.mask&&i.mask.conversions&&(e+=4*i.mask.conversions.length),e};switch(i.exprKind){case v.NumberLiteral:return 2;case v.PointerLiteral:return 6;case v.RuntimeCall:return e()+2+2+4;case v.CellRef:return 2;case v.FieldAccess:return e()+(i.data.needsCheck?4:0)+2;case v.ProcCall:case v.SharedRef:case v.SharedDef:case v.Store:case v.Sequence:case v.JmpValue:case v.Nop:case v.InstanceOf:return 1e6;default:throw b.oops()}}(d)<=4*this.args.length+4+2+(k.target.isNative?4:30)&&(this.inlineBody=d),pxt.options.debug&&pxt.debug(this.toString())},e}(i);function f(e,t){return new s(e,t)}function d(e,t,r){return new y(e,t,r)}function m(e,t,r){void 0===r&&(r=0);var n=d(v.RuntimeCall,t,e);return r&&(n.mask={refMask:r}),n}function h(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);for(var n=!!t&&e.some(function(e){return e.canUpdateCells()}),i=[],a=0,s=b.reversed(e);a<s.length;a++){var o=s[a];o.isStateless()||(o.exprKind!=v.CellRef||n)&&(o.canUpdateCells()&&(n=!0),i.push(o))}i.reverse(),k.isStackMachine()&&!r&&(i=[]);var l=[],u=e.map(function(e){if(0<=i.indexOf(e)){var t=e,r=e;return e.exprKind==v.SharedDef?(e.args[0].totalUses++,t=g.op(v.SharedRef,[e.args[0]])):(t=g.op(v.SharedRef,[e]),r=g.op(v.SharedDef,[e]),e.totalUses=2,e.currUses=0),l.push(r),t}return e});return{precomp:l,flattened:u}}g.Procedure=p,g.iterExpr=function e(t,r){if(r(t),t.args)for(var n=0,i=t.args;n<i.length;n++)e(i[n],r)},g.stmt=f,g.op=d,g.numlit=function(e){return d(v.NumberLiteral,null,e)},g.shared=function(e){switch(e.exprKind){case v.SharedRef:e=e.args[0];break;case v.NumberLiteral:return e}return d(v.SharedRef,[e])},g.ptrlit=function(e,t){var r=d(v.PointerLiteral,null,e);return r.jsInfo=t,r},g.rtcall=m,g.rtcallMask=function(e,t,r,n){b.startsWith(e,"@nomask@")&&(e=e.slice(8),t=0);var i=m(e,n,t);return i.callingConvention=r,i},g.flattenArgs=h})((k=x.pxtc||(x.pxtc={})).ir||(k.ir={}))}(ts||(ts={})),function(Tr){!function(Tt){var n,e,r=function(){function e(e,t){this.wave=e,this.id=t,this.flags=0,this.resetAll()}return e.prototype.refresh=function(){this.flags&=-9,!this.proc||this.usedActions||zt(this.proc.action)?this.proc&&!this.proc.cachedJS?this.resetEmit():this.usedNodes&&(this.flags|=32):this.resetEmit(),this.classInfo&&this.classInfo.reset()},e.prototype.resetEmit=function(){this.flags&=-41,this.proc&&this.proc.classInfo&&this.proc.classInfo.ctor==this.proc&&(this.proc.classInfo.ctor=null),this.functionInfo=null,this.variableInfo=null,this.classInfo=null,this.callInfo=null,this.proc=null,this.cell=null,this.exprInfo=null,this.usedNodes=null,this.usedActions=null},e.prototype.resetTSC=function(){this.flags&=16,this.typeCache=null,this.symbolCache=null,this.commentAttrs=null,this.valueOverride=null,this.declCache=void 0,this.fullName=null,this.constantFolded=void 0},e.prototype.resetAll=function(){this.resetTSC(),this.resetEmit()},e}();function t(e){return e<<2|2}Tt.PxtNode=r,(e=n||(n={}))[e.Enum=0]="Enum",e[e.Number=1]="Number",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Unsupported=4]="Unsupported",Tt.taggedUndefined=0,Tt.taggedNull=t(1),Tt.taggedFalse=t(2),Tt.taggedNaN=t(3),Tt.taggedTrue=t(16),Tt.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},Tt.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0};var wt={"Array_::getAt":{name:"_pxt_array_get",argsFmt:["T","T","T"],value:0},"Array_::setAt":{name:"_pxt_array_set",argsFmt:["T","T","T","T"],value:0},"BufferMethods::getByte":{name:"_pxt_buffer_get",argsFmt:["T","T","T"],value:0},"BufferMethods::setByte":{name:"_pxt_buffer_set",argsFmt:["T","T","T","I"],value:0},"pxtrt::mapGetGeneric":{name:"_pxt_map_get",argsFmt:["T","T","S"],value:0},"pxtrt::mapSetGeneric":{name:"_pxt_map_set",argsFmt:["T","T","S","T"],value:0}},It=Tt.ir.EK;Tt.SK=Tr.SyntaxKind,Tt.numReservedGlobals=1;var i=0,Et=1;function Nt(e){if(e.pxt)return!!(16&e.pxt.flags);var t=Tr.getSourceFileOfNode(e);return!!t&&Tt.isPxtModulesFilename(t.fileName)}function _t(e){if(e.pxt)return(t=e.pxt).wave!=Et&&(t.wave=Et,Tt.compileOptions&&Tt.compileOptions.skipPxtModulesTSC&&16&t.flags?Tt.compileOptions.skipPxtModulesEmit?t.refresh():t.resetEmit():t.resetAll()),t;var t=new r(Et,++i);return Nt(e)&&(t.flags|=16),e.pxt=t}function Kt(e){return _t(e).id}function At(e){return e?Tr.SyntaxKind[e.kind]:"<null>"}function Ct(e,t,r){void 0===r&&(r=!1);var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&er)return Yt||(Yt=t,Xt=e),n;throw n}function Ut(){return Tt.target.isNative&&Tt.target.nativeType==Tt.NATIVE_TYPE_VM}function Pt(){return Tt.target.isNative&&Tt.target.nativeType!=Tt.NATIVE_TYPE_VM}function Lt(){return Tt.target.isNative&&Tt.target.nativeType==Tt.NATIVE_TYPE_THUMB}function Ft(e){return Pt()?Tt.ir.rtcall("pxt::fromInt",[e]):e}function Ot(e){return Pt()?Tt.ir.rtcall("pxt::fromBool",[e]):e}function Dt(e){switch(e){case 0:return Tt.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw Tt.oops()}}function a(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw Tt.oops()}}function Mt(e){switch(e.kind){case Tt.SK.TemplateHead:case Tt.SK.TemplateMiddle:case Tt.SK.TemplateTail:case Tt.SK.StringLiteral:case Tt.SK.NoSubstitutionTemplateLiteral:return!0;default:return!1}}function Bt(e){return e&&e.modifiers&&e.modifiers.some(function(e){return e.kind==Tt.SK.StaticKeyword})}function Rt(e){return e.modifiers&&e.modifiers.some(function(e){return e.kind==Tt.SK.ReadonlyKeyword})}function $t(e,t){return e.explicitDefaults?e.explicitDefaults.indexOf(t)<0?null:e.paramDefl[t]:null}function s(e){if(!e)return null;switch(e.kind){case Tt.SK.MethodDeclaration:return"";case Tt.SK.Constructor:return"new/";case Tt.SK.GetAccessor:return"get/";case Tt.SK.SetAccessor:return"set/";default:return null}}function qt(e){return s(e)+ir(e)}function jt(e){return null!=s(e)}function zt(e){for(var t=e,r=!1;;)switch((t=t.parent)||Ct(9229,Zt("cannot determine parent of {0}",At(e))),t.kind){case Tt.SK.MethodDeclaration:case Tt.SK.Constructor:case Tt.SK.GetAccessor:case Tt.SK.SetAccessor:case Tt.SK.FunctionDeclaration:case Tt.SK.ArrowFunction:case Tt.SK.FunctionExpression:return t;case Tt.SK.WhileStatement:case Tt.SK.DoStatement:case Tt.SK.ForInStatement:case Tt.SK.ForOfStatement:case Tt.SK.ForStatement:r=!0;break;case Tt.SK.SourceFile:return r?Wt:null}}function o(e){return"objectFlags"in e}function Vt(e){return!!e&&(e.kind==Tt.SK.VariableDeclaration||e.kind==Tt.SK.BindingElement&&Vt(e.parent.parent))}function Gt(e){return!!e&&(Vt(e)&&!zt(e)||e.kind==Tt.SK.PropertyDeclaration&&Bt(e))}function Jt(e){return!!e&&(e.kind==Tt.SK.Parameter||e.kind==Tt.SK.BindingElement&&Jt(e.parent.parent))}Tt.isInPxtModules=Nt,Tt.pxtInfo=_t,Tt.getNodeId=Kt,Tt.stringKind=At,Tt.isStackMachine=Ut,Tt.needsNumberConversions=Pt,Tt.isThumb=Lt,Tt.sizeOfBitSize=Dt,Tt.isBitSizeSigned=a,Tt.setCellProps=function(e){var t;if(e._isLocal=Vt(t=e.def)&&!Gt(t)||Jt(e.def),e._isGlobal=Gt(e.def),!e.def.isThisParameter){var r=fr(e.def);r.flags&Tr.TypeFlags.Void&&Tt.oops("void-typed variable, "+e.toString()),e.bitSize=function(e){if(!e||!e.type)return 0;if(!yr(fr(e)))return 0;if(e.type.kind!=Tt.SK.TypeReference)return 0;switch(e.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}}(e.def),0!=e.bitSize?e._debugType=(a(e.bitSize)?"int":"uint")+8*Dt(e.bitSize):br(r)?e._debugType="string":r.flags&Tr.TypeFlags.NumberLike&&(e._debugType="number")}e.isLocal()&&0!=e.bitSize&&(e.bitSize=0,Ct(9256,Zt("bit sizes are not supported for locals and parameters")))},Tt.isStatic=Bt,Tt.isReadOnly=Rt,Tt.getExplicitDefault=$t,Tt.isObjectType=o;var Ht=function(){function e(e,t){this.id=e,this.decl=t,this.baseClassInfo=null,this.allfields=[],this.methods={},this.attrs=nr(t),this.reset()}return e.prototype.reset=function(){this.vtable=null,this.itable=null},Object.defineProperty(e.prototype,"isUsed",{get:function(){return!!(8&_t(this.decl).flags)},enumerable:!0,configurable:!0}),e.prototype.allMethods=function(){for(var e=[],t=0,r=Object.keys(this.methods);t<r.length;t++)for(var n=r[t],i=0,a=this.methods[n];i<a.length;i++){var s=a[i];e.push(s)}return e},e.prototype.usedMethods=function(){for(var e=[],t=0,r=Object.keys(this.methods);t<r.length;t++)for(var n=r[t],i=0,a=this.methods[n];i<a.length;i++){var s=a[i];8&_t(s).flags&&e.push(s)}return e},e}();Tt.ClassInfo=Ht;var Qt,Wt,Yt,Zt=Tt.assembler.lf,Xt=0,er=0;function tr(e,t){var r=_t(t);return null==r.fullName&&(r.fullName=Tt.getFullName(e,t.symbol)),r.fullName}function l(e){e.kind==Tt.SK.VariableDeclaration&&(e=e.parent.parent);var t=function(e){var t=Tr.getSourceFileOfNode(e);if(!t)return"";var r=Tr.getLeadingCommentRangesOfNode(e,t);return r?r.map(function(e){return t.text.slice(e.pos,e.end)}).join("\n"):""};return e.symbol&&e.symbol.declarations&&1<e.symbol.declarations.length?e.symbol.declarations.map(t).join("\n"):t(e)}function rr(e){for(var t="",r=0,n=e.declarations;r<n.length;r++){t+=l(n[r])}return Tt.parseCommentString(t)}function nr(e){var t=e?_t(e):null;if(!t||2&t.flags)return Tt.parseCommentString("");if(t.commentAttrs)return t.commentAttrs;var r=Tt.parseCommentString(l(e));return r._name=ir(e),t.commentAttrs=r}function ir(e){return e.name&&e.name.kind==Tt.SK.Identifier?e.name.text:"???"}function ar(e){if(o(e)&&e.objectFlags&Tr.ObjectFlags.Reference){var t=e;if(t.typeArguments&&t.typeArguments.length)return t.target}return null}function sr(e){return!!o(e)&&(e.objectFlags&Tr.ObjectFlags.Reference&&e.symbol&&"Array"==e.symbol.name)}function or(e){return!!o(e)&&(!!(e.objectFlags&Tr.ObjectFlags.Interface)||!!(e.objectFlags&Tr.ObjectFlags.Anonymous))}function lr(e){return!!e.isThisType||!!o(e)&&!!(e.objectFlags&Tr.ObjectFlags.Class||e.symbol&&e.symbol.flags&Tr.SymbolFlags.Class)}function ur(e){var t=ar(e);return lr(t||e)}function cr(e,t){return void 0===t&&(t=-1),sr(e)?u(e.typeArguments[0]):Qt.getIndexTypeOfType(e,Tr.IndexKind.Number)}function u(e){return e}function pr(e){return null===e?Tt.taggedNull:void 0===e?Tt.taggedUndefined:!1===e?Tt.taggedFalse:!0===e?Tt.taggedTrue:isNaN(e)?Tt.taggedNaN:null}function fr(e){var t,r=_t(e);if(r.typeCache)return r.typeCache;if(Tr.isExpression(e)&&(t=Qt.getContextualType(e)),!t)try{t=Qt.getTypeAtLocation(e)}catch(e){Ct(9203,Zt("Unknown type for expression"))}return t?u(r.typeCache=t):t}function c(e){if(!(e.flags&Tr.TypeFlags.Union))return n.Unsupported;var t,r=!0;return e.types.forEach(function(e){if(void 0===t)e.flags&Tr.TypeFlags.NumberLike?t=n.Number:e.flags&Tr.TypeFlags.BooleanLike?t=n.Boolean:e.flags&Tr.TypeFlags.StringLike?t=n.String:e.flags&Tr.TypeFlags.EnumLike&&(t=n.Enum);else switch(t){case n.Number:r=r&&!!(e.flags&Tr.TypeFlags.NumberLike);break;case n.Boolean:r=r&&!!(e.flags&Tr.TypeFlags.BooleanLike);break;case n.String:r=r&&!!(e.flags&Tr.TypeFlags.StringLike);break;case n.Enum:r=r&&!!(e.flags&Tr.TypeFlags.EnumLike)}}),r?t:n.Unsupported}function dr(e){var t=Qt.getSignatureFromDeclaration(e);return!(Qt.getReturnTypeOfSignature(t).flags&Tr.TypeFlags.Void)}function mr(e){var t,r=(t=e)&&t.name?e.name.text:null;return r||(r=e.kind==Tt.SK.Constructor?"constructor":"inline"),function e(t){if(!t)return"";switch(t.kind){case Tt.SK.ModuleBlock:return e(t.parent);case Tt.SK.ClassDeclaration:case Tt.SK.ModuleDeclaration:return e(t.parent)+t.name.text+".";default:return""}}(e.parent)+r}function hr(e){return mr(e).replace(/[^\w]+/g,"_")}function gr(e){return hr(e)+"__P"+Kt(e)}Tt.getNodeFullName=tr,Tt.getComments=l,Tt.parseCommentsOnSymbol=rr,Tt.parseComments=nr,Tt.getName=ir,Tt.checkType=u,Tt.taggedSpecial=pr,Tt.getDeclName=mr,Tt.getFunctionLabel=gr;var vr=function(){function e(e){this.decl=e,this.capturedVars=[]}return Object.defineProperty(e.prototype,"isUsed",{get:function(){return!!(8&_t(this.decl).flags)},enumerable:!0,configurable:!0}),e}();function p(e,t,r){return!!(e.flags&t)||c(e)===r}function br(e){return p(e,Tr.TypeFlags.String|Tr.TypeFlags.StringLiteral,n.String)}function yr(e){return p(e,Tr.TypeFlags.Number|Tr.TypeFlags.NumberLiteral,n.Number)}Tt.FunctionAddInfo=vr,Tt.compileBinary=function(e,g,F,t){Tt.compilerHooks.preBinary&&Tt.compilerHooks.preBinary(e,g,F),Tt.target=g.target,Tt.compileOptions=g,Tt.target.debugMode=!!g.breakpoints;var o=Tr.createDiagnosticCollection();Qt=e.getTypeChecker();var r=Tt.U.cpuUs(),C=[],n=[],b={},u={},v=null,U=null,p=!1,a=[];if(Et++,g.target.isNative){if(!g.extinfo||!g.extinfo.hexinfo)return{diagnostics:[{file:e.getSourceFiles()[0],start:0,length:0,category:Tt.DiagnosticCategory.Error,code:9043,messageText:Zt("The hex file is not available, please connect to internet and try again.")}],emittedFiles:[],emitSkipped:!0};Tt.hexfile.setupFor(g.target,g.extinfo||Tt.emptyExtInfo()),Tt.hexfile.setupInlineAssembly(g)}var O,D=new xr;function i(){D.reset(),O=null,F.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}],F.procCallLocations=[]}D.res=F,D.options=g,D.target=g.target,g.computeUsedSymbols&&(F.usedSymbols={},F.usedArguments={});var s=[];if(!g.forceEmit||0==F.diagnostics.length){var l=e.getSourceFiles().slice(),c=l.find(function(e){return"main.ts"===e.fileName});c&&(l=l.filter(function(e){return"main.ts"!==e.fileName})).push(c),l.forEach(function(e){e.statements.forEach(function(e){s.push(e)})})}var f=e.getSourceFiles().filter(function(e){return Tt.Util.endsWith(e.fileName,t)})[0],d={kind:Tt.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:Tt.SK.Block,statements:s},parent:f,pos:0,end:0},m=_t(Wt=d);for(m.flags|=3,le(d),C=[],i(),p=!0,yt(d);Ne(),!j(););!function(){var e=D.globals.slice(0);e.forEach(function(e,t){return e.index=t});var r=function(e){return 0==e?10:Dt(e)};e.sort(function(e,t){return r(e.bitSize)-r(t.bitSize)||e.index-t.index});for(var t=4*Tt.numReservedGlobals,n=0,i=0,a=e;i<a.length;i++){for(var s=a[i],o=Dt(s.bitSize);t&o-1;)t++;n||0!=s.bitSize||(n=t),s.index=t,t+=o}D.globalsWords=t+3>>2,D.nonPtrGlobals=n?n>>2:D.globalsWords}(),p=!1,function(){for(var e=0,t=D.usedClassInfos;e<t.length;e++){var r=t[e];z(r)}var n=Object.keys(D.ifaceMemberMap);n.sort(Tt.U.strcmp),n.unshift(""),D.emitString(""),D.ifaceMembers=n,D.ifaceMemberMap={};for(var i=0,a=0,s=n;a<s.length;a++){var o=s[a];D.ifaceMemberMap[o]=i++}for(var l=0,u=D.usedClassInfos;l<u.length;l++)for(var r=u[l],c=0,p=r.itable;c<p.length;c++){var f=p[c];f.idx=R(f.name)}for(var d=0,m=D.usedClassInfos;d<m.length;d++){var r=m[d];r.lastSubtypeNo=void 0,r.classNo=void 0}for(var h=pxt.BuiltInType.User0,g=function(e){Tt.U.assert(!e.classNo),e.classNo=h++;for(var t=0,r=e.derivedClasses;t<r.length;t++){var n=r[t];n.isUsed&&g(n)}e.lastSubtypeNo=h-1},v=0,b=D.usedClassInfos;v<b.length;v++){for(var r=b[v],y=r;y.baseClassInfo;)y=y.baseClassInfo;y.classNo||g(y)}}();var h=Tt.U.cpuUs();F.times.pass0=h-r;var y=o.getDiagnostics();i(),p=!1,D.finalPass=!0,xt(d),Tt.U.assert(0==C.length),F.configData=[];for(var x=0,k=Object.keys(u);x<k.length;x++){var S=k[x];u["!"+S]||F.configData.push({name:S.replace(/^\!/,""),key:u[S].key,value:u[S].value})}F.configData.sort(function(e,t){return e.key-t.key});var T=Tt.U.cpuUs();if(F.times.pass1=T-h,gt(d,function(){if(!g.noEmit){D.writeFile=function(e,t){F.outfiles[e]=t};for(var e=0,t=D.procs;e<t.length;e++){var r=t[e];r.cachedJS&&!r.inlineBody||r.resolve()}Tt.target.isNative&&(D.procs=D.procs.filter(function(e){return!(e.inlineBody&&!e.info.usedAsIface&&!e.info.usedAsValue)})),g.target.isNative?(g.extinfo.yotta&&D.writeFile("yotta.json",JSON.stringify(g.extinfo.yotta,null,2)),g.extinfo.platformio&&D.writeFile("platformio.json",JSON.stringify(g.extinfo.platformio,null,2)),g.target.nativeType==Tt.NATIVE_TYPE_VM?Tt.vmEmit(D,g):Tt.processorEmit(D,g,F)):Tt.jsEmit(D)}}),F.times.passFinal=Tt.U.cpuUs()-T,g.ast){var w=Tt.U.cpuUs();Tt.annotate(e,t,Tt.target),F.times.passAnnotate=Tt.U.cpuUs()-w}return Tt.compileOptions=null,0==y.length&&(y=o.getDiagnostics()),Tt.compilerHooks.postBinary&&Tt.compilerHooks.postBinary(e,g,F),{diagnostics:y,emittedFiles:void 0,emitSkipped:!!g.noEmit};function I(e,t,r,n,i,a,s){o.add(Tr.createDiagnosticForNode(t,{code:r,message:n,key:n.replace(/^[a-zA-Z]+/g,"_"),category:e},i,a,s))}function E(e,t,r,n,i,a){I(Tt.DiagnosticCategory.Error,e,t,r,n,i,a)}function M(e,t,r){if(void 0===r&&(r=9202),t)return Ct(r,t);e||Ct(r,Zt("Sorry, this language feature is not supported"));var n=At(e),i=!1,a=null;switch(e.kind){case Tr.SyntaxKind.ForInStatement:n=Zt("for in loops");break;case Tr.SyntaxKind.ForOfStatement:n=Zt("for of loops"),i=!0;break;case Tr.SyntaxKind.PropertyAccessExpression:n=Zt("property access");break;case Tr.SyntaxKind.DeleteExpression:n=Zt("delete");break;case Tr.SyntaxKind.GetAccessor:n=Zt("get accessor method"),i=!0;break;case Tr.SyntaxKind.SetAccessor:n=Zt("set accessor method"),i=!0;break;case Tr.SyntaxKind.TaggedTemplateExpression:n=Zt("tagged templates");break;case Tr.SyntaxKind.SpreadElement:n=Zt("spread");break;case Tr.SyntaxKind.TryStatement:case Tr.SyntaxKind.CatchClause:case Tr.SyntaxKind.FinallyKeyword:case Tr.SyntaxKind.ThrowStatement:n=Zt("throwing and catching exceptions");break;case Tr.SyntaxKind.ClassExpression:n=Zt("class expressions"),a=Zt("declare a class as class C {} not let C = class {}")}var s="";return s=i?Zt("{0} not currently supported",n):Zt("{0} not supported",Tr.SyntaxKind[e.kind]),a&&(s+=" - "+a),Ct(r,s)}function N(e){return Kt(e)+""}function B(e){var t=_t(e);return t.functionInfo||(t.functionInfo=new vr(e)),t.functionInfo}function P(e){var t=_t(e);return t.variableInfo||(t.variableInfo={}),t.variableInfo}function _(e,t){void 0===t&&(t=!1);var r=P(e);t&&(r.written=!0);var n=zt(e);if(null==n||n==O.action);else{for(var i=O.action;i&&i!=n;){var a=B(i);a.capturedVars.indexOf(e)<0&&a.capturedVars.push(e),i=zt(i)}r.captured=!0}}function L(e){var t=e(D);return p&&D.recordAction(U,e),t}function R(r,n){return void 0===n&&(n=!1),L(function(e){n&&(Tt.U.lookup(e.explicitlyUsedIfaceMembers,r)||(Tt.U.assert(!e.finalPass),e.explicitlyUsedIfaceMembers[r]=!0));var t=Tt.U.lookup(e.ifaceMemberMap,r);return null!=t||(Tt.U.assert(!e.finalPass),t=e.ifaceMemberMap[r]=-1,e.emitString(r)),t})}function K(e){e.flags&Tr.TypeFlags.Void&&Ct(9203,Zt("void-typed variables not supported"))}function A(e){var t=_t(e);K(fr(e)),t.cell||(t.cell=new Tt.ir.Cell(null,e,P(e))),D.globals.indexOf(t.cell)<0&&D.globals.push(t.cell)}function $(e){if(Gt(e)){le(e);var t=_t(e);return t.cell||A(e),t.cell}var r=O.localIndex(e);return r||(D.finalPass?Ct(9204,Zt("cannot locate identifer")):r=O.mkLocal(e,P(e))),r}function q(e){return e.kind==Tt.SK.MethodDeclaration&&0==e.parameters.length&&"toString"==ir(e)}function j(){p=!1;for(var e,t=D.usedClassInfos.length,r=0,n=D.usedClassInfos;r<n.length;r++){for(var i=n[r],a=0,s=i.allMethods();a<s.length;a++){var o=s[a],l=_t(o),u=B(o);8&l.flags?u.virtualParent&&ue(u.virtualParent.decl):u.virtualParent&&u.virtualParent.isUsed?ue(o):(q(o)||(e=ir(o),null!=Tt.U.lookup(D.explicitlyUsedIfaceMembers,e)))&&ue(o)}var c=Se(i.decl);c&&ue(c)}return p=!0,0==C.length&&t==D.usedClassInfos.length}function z(s){if(Tt.assert(s.isUsed,"inf.isUsed"),s.vtable)return s.vtable;var e=s.baseClassInfo?z(s.baseClassInfo).slice(0):[];s.derivedClasses=[],s.baseClassInfo&&s.baseClassInfo.derivedClasses.push(s);for(var t=0,r=s.usedMethods();t<r.length;t++){var n=r[t];D.numMethods++;var i=B(n),a=nr(n);if(q(n)&&!a.shim&&(s.toStringMethod=xe(n),s.toStringMethod.info.usedAsIface=!0),i.virtualParent){D.numVirtMethods++;var o=qt(n),l=!1,u=xe(n);Tt.U.assert(!!u);for(var c=0;c<e.length;++c)qt(e[c].action)==o&&(e[c]=u,i.virtualIndex=c,l=!0);l||(i.virtualIndex=e.length,e.push(u))}}s.vtable=e,s.itable=[];for(var p={},f=0,d=s.allfields;f<d.length;f++){var m=d[f],h=ir(m),g=Re(s,m,!1);p[h]=!0,s.itable.push({name:h,info:(g.idx+1)*(Ut()?1:4),idx:R(h),proc:null})}for(var v=s;v;v=v.baseClassInfo)for(var b=function(e){var t=ir(e);if(nr(e).shim)return"continue";var r=xe(e),n=s.itable.find(function(e){return e.name==t}),i=e.kind==Tt.SK.SetAccessor,a=e.kind==Tt.SK.GetAccessor;n?(i&&!n.setProc?n.setProc=r:a&&!n.proc&&(n.proc=r),n.info=0):s.itable.push({name:t,info:0,idx:R(t),proc:i?null:r,setProc:i?r:null}),r.info.usedAsIface=!0},y=0,x=v.usedMethods();y<x.length;y++)b(n=x[y]);return s.vtable}function V(e){if(32&e.flags||16&e.flags&&Tt.compileOptions.skipPxtModulesEmit)throw F.needsFullRecompile=!0,Ct(9200,Zt("full recompile required"))}function G(e,t){void 0===t&&(t=null),t||(t=e.symbol.valueDeclaration);var r=_t(t);if(!r.classInfo){var n=hr(t)+"__C"+Kt(t),i=new Ht(n,t);(r.classInfo=i).attrs.autoCreate&&(b[i.attrs.autoCreate]=!0),i.baseClassInfo=function(e){if(e.heritageClauses)for(var t=0,r=e.heritageClauses;t<r.length;t++){var n=r[t];switch(n.token){case Tt.SK.ExtendsKeyword:if(!n.types||1!=n.types.length)throw Ct(9228,Zt("invalid extends clause"));var i=fr(n.types[0]);if(!i||!lr(i)||(a=ar(i))&&a.typeParameters&&a.typeParameters.length)throw Ct(9228,Zt("cannot inherit from this type"));return Qt.getTypeAtLocation(e),G(i);case Tt.SK.ImplementsKeyword:break;default:throw Ct(9228,Zt("invalid heritage clause"))}}var a;return null}(t);for(var a=i.baseClassInfo?Tt.U.toDictionary(i.baseClassInfo.allfields,function(e){return ir(e)}):{},s=function(e,t){return void 0===t&&(t=i.baseClassInfo),t?t.methods[e]||s(e,t.baseClassInfo):null},o=0,l=t.members;o<l.length;o++){var u=l[o];if(u.kind==Tt.SK.PropertyDeclaration){var c=u;Bt(c)||i.allfields.push(c);var p=ir(c);(s(p)||Tt.U.lookup(a,p))&&E(c,9279,Zt("redefinition of '{0}' as field",p))}else if(u.kind==Tt.SK.Constructor)for(var f=0,d=u.parameters;f<d.length;f++){var m=d[f];kr(m)&&i.allfields.push(m)}else if(jt(u)){var h=B(u);h.parentClassInfo=i,h.isUsed&&Te(i),p=ir(u),i.methods.hasOwnProperty(p)||(i.methods[p]=[]),i.methods[p].push(u);var g=Tt.U.lookup(a,p);if(g){var v=_t(g);64&v.flags||(v.flags|=64,8&v.flags&&R(p,!0),V(v))}}}i.baseClassInfo&&(i.allfields=i.baseClassInfo.allfields.concat(i.allfields),function(e){for(var t=0,r=e.allMethods();t<r.length;t++){for(var n=r[t],i=null,a=qt(n),s=ir(n),o=e.baseClassInfo;o;o=o.baseClassInfo)if(o.methods.hasOwnProperty(s))for(var l=0,u=o.methods[s];l<u.length;l++){var c=u[l];qt(c)==a&&(i=c)}if(i){var p=B(n),f=B(i);i.parameters.length!=n.parameters.length&&E(n,9255,Zt("the overriding method is currently required to have the same number of arguments as the base one")),(p.virtualParent=f).virtualParent||(V(_t(i)),f.virtualParent=f),Tt.assert(f.virtualParent==f,"pinf.virtualParent == pinf")}}}(i))}return r.classInfo}function J(e){if(!e)return!1;if(Mt(e))return!1;switch(e.kind){case Tt.SK.ArrayLiteralExpression:return e.elements.some(J);default:return null==Je(e)}}function H(e){var t=Ge(e);if(t)return Ze(t.val);if(Gt(e)&&nr(e).shim)return he(e,e,[]);var r=$(e);return _(e),r.load()}function Q(e){nr(e).shim&&Ct(9207,Zt("built-in functions cannot be yet used as values; did you forget ()?"));var t=B(e);return W(t),t.location?t.location.load():(Tt.assert(!D.finalPass||0==t.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),t.usedAsValue=!0,ue(e),Ee(e))}function W(e){void 0===e.usedBeforeDecl?e.usedBeforeDecl=!0:D.finalPass&&e.usedBeforeDecl&&e.capturedVars.length&&zt(e.decl)&&!e.alreadyEmitted&&Ct(9278,Zt("function referenced before all variables it uses are defined"))}function Y(e){var t=fe(e),r=Ge(t);if(r)return Ze(r.val);if(t&&(Vt(t)||Jt(t)))return H(t);if(t&&t.kind==Tt.SK.FunctionDeclaration)return Q(t);if("undefined"==e.text)return Ze(void 0);throw M(e,Zt("Unknown or undeclared identifier"),9235)}function Z(e){var t=function e(t){return t?jt(t)?t:e(t.parent):null}(e);t||Ct(9208,Zt("'this' used outside of a method"));var r=B(t);return r.thisParameter||Tt.oops("no this"),H(r.thisParameter)}function X(e){var t,r;if(""==e)t=Tt.ir.rtcall("String_::mkEmpty",[]);else{var n=(r=e,L(function(e){return e.emitString(r)}));t=Tt.ir.ptrlit(n,JSON.stringify(e))}return t.isStringLiteral=!0,t}function ee(e){var t=de(e),r=vt(e);return Tt.target.isNative||Mt(e)?Me(r,t):Me(r=Tt.ir.rtcallMask("String_::stringConv",1,1,[r]),!0)}function te(e){for(var n=0,t=function(e,t){return Mt(r=t)&&""==r.text?e:(n++,tt("String_::concat",[Me(e,!0),ee(t)],null));var r},r=_t(ee(e.head)).valueOverride,i=0,a=e.templateSpans;i<a.length;i++){var s=a[i];r=t(r=t(r,s.expression),s.literal)}return 0==n?tt("String_::concat",[Me(r,!0),Me(Tt.ir.rtcall("String_::mkEmpty",[]),!1)],null):r}function re(e){var t=fe(e),r=Ge(t);if(r)return Ze(r.val);if(t.kind==Tt.SK.SetAccessor&&(t=ne(t)),t.kind==Tt.SK.GetAccessor)return ve(e,e,[],null,t);if(t.kind==Tt.SK.EnumMember)throw Ct(9210,Zt("Cannot compute enum value"));if(t.kind==Tt.SK.PropertySignature||t.kind==Tt.SK.PropertyAssignment)return ve(e,e,[],null,t,e.expression);if(t.kind==Tt.SK.PropertyDeclaration||t.kind==Tt.SK.Parameter){if(Bt(t))return H(t);if(ie(t))return ve(e,e,[],null,t,e.expression);var n=function(e){var t=fr(e.expression);if(ur(t)){var r=G(t),n=e.expression.kind==Tt.SK.ThisKeyword;return Tt.target.switches.noThisCheckOpt&&(n=!1),Re(r,$e(r,e.name.text),!n)}throw M(e,Zt("bad field access"),9247)}(e);return Tt.ir.op(It.FieldAccess,[vt(e.expression)],n)}if(jt(t)||t.kind==Tt.SK.MethodSignature)throw Ct(9211,Zt("cannot use method as lambda; did you forget '()' ?"));if(t.kind==Tt.SK.FunctionDeclaration)return Q(t);if(Vt(t))return H(t);throw M(e,Zt("Unknown property access for {0}",At(t)),9237)}function ne(e){var t=Tr.getDeclarationOfKind(e.symbol,Tt.SK.GetAccessor);if(null==t)throw Ct(9281,Zt("setter currently requires a corresponding getter"));return t}function ie(e){if(e.kind==Tt.SK.Parameter||e.kind==Tt.SK.PropertyDeclaration){var t=_t(e);return!!Tt.target.switches.slowFields||!!(64&t.flags)}return!1}function ae(e,t){void 0===t&&(t=null);var r=fr(e.expression),n={callingConvention:0,paramDefl:{}},i=null,a=!1;if(!t&&br(r)?i="String_::charAt":sr(r)?i=t?"Array_::setAt":"Array_::getAt":or(r)&&(n=rr(r.symbol),i=t?n.indexerSet:n.indexerGet),!i&&r.flags&(Tr.TypeFlags.Any|Tr.TypeFlags.StructuredOrTypeVariable)&&(i=t?"pxtrt::mapSetGeneric":"pxtrt::mapGetGeneric",a=!0),i){if(a||Xe(e.argumentExpression))return tt(i,[e.expression,e.argumentExpression],n,t?[t]:[]);throw M(e,Zt("non-numeric indexer on {0}",i),9238)}throw M(e,Zt("unsupported indexer"),9239)}function se(e){var t,r,n=!(!Gt(r=e)||J(r.initializer)&&!nr(r).whenUsed)||(t=e).kind==Tt.SK.FunctionDeclaration&&!zt(t)||jt(t)||Tr.isClassDeclaration(e);return!Tt.target.switches.noTreeShake&&!(g.testMode&&n&&!Nt(e))&&n}function oe(e){if(!se(e))return!0;var t=_t(e);return D.finalPass?!!(8&t.flags):t==U}function le(e){if(e){var t=_t(e);t.classInfo?Te(t.classInfo):(g.computeUsedSymbols&&e.symbol&&(F.usedSymbols[tr(Qt,e)]=null),Ut()&&jt(e)&&R(ir(e),!0),ce(e),8&t.flags||(t.flags|=8,se(e)&&C.push(e)))}}function ue(e){le(e)}function ce(e){p&&(U?U.usedNodes[N(e)]=e:Tt.U.oops("no using ctx for: "+ir(e)))}function pe(e){if(!e)return null;var t=_t(e);if(void 0!==t.declCache)return t.declCache;var r,n=Qt.getSymbolAtLocation(e);if(n&&!(r=n.valueDeclaration)&&n.declarations){var i=n.declarations[0];i&&i.kind==Tr.SyntaxKind.ImportEqualsDeclaration&&(n=Qt.getSymbolAtLocation(i.moduleReference))&&(r=n.valueDeclaration)}return r}function fe(e){var t=pe(e);if(le(t),!t&&e&&e.kind==Tt.SK.PropertyAccessExpression){var r=e;_t(t={kind:Tt.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:r.name.getText()},name:r.name}).flags|=2}return m.declCache=t||null,t}function de(e){return e.kind==Tt.SK.NullKeyword||e.kind==Tt.SK.NumericLiteral?!!e.isRefOverride:!Mt(e)}function me(e){Tt.assert(e.length<=8,"args.length <= 8");var r=0;return e.forEach(function(e,t){de(e)&&(r|=1<<t)}),r}function he(e,t,r){var n,i,a,s=nr(e),o=!(fr(t).flags&Tr.TypeFlags.Void),l=s.shim;if(0<=l.indexOf("(")){var u=/(.*)\((.*)\)$/.exec(l);if(u){r.length&&Tt.U.userError("no arguments expected");var c=[];if(u[2].replace(/\s/g,"")){for(var p=0,f=u[2].split(/,/);p<f.length;p++){var d=f[p],m=parseInt(d);isNaN(m)&&(null==(m=We(t,d))&&(a=void 0,null==(a=Qe(n=t,i=d,"userconfig"))&&(a=Qe(n,i,"config")),m=a),null==m&&Tt.U.userError("invalid argument: "+d+" in "+l)),c.push(Tt.ir.numlit(m))}4<c.length&&Tt.U.userError("too many args")}return l=u[1],g.target.isNative&&Tt.hexfile.validateShim(mr(e),l,s,!0,c.map(function(e){return!0})),Tt.ir.rtcallMask(l,0,s.callingConvention,c)}}return"TD_NOOP"==l?(Tt.assert(!o,"!hasRet"),Tt.target.switches.profile&&"perfCounter"==s.shimArgument&&(r[0]&&r[0].kind==Tt.SK.StringLiteral&&(O.perfCounterName=r[0].text),O.perfCounterName||(O.perfCounterName=O.getFullName())),Ze(void 0)):"TD_ID"==l||"ENUM_GET"===l?(Tt.assert(1==r.length,"args.length == 1"),vt(r[0])):(g.target.shimRenames&&Tt.U.lookup(g.target.shimRenames,l)&&(l=g.target.shimRenames[l]),g.target.isNative&&Tt.hexfile.validateShim(mr(e),l,s,o,r.map(Xe)),tt(l,r,s))}function ge(e,i,a){if(e){var t=e.getParameters(),r=i.length;t.length>i.length&&t.slice(i.length).forEach(function(e){if(e.valueDeclaration&&e.valueDeclaration.kind==Tt.SK.Parameter){var t=e.valueDeclaration;if(t.initializer)(function(e){switch(e.kind){case Tt.SK.UndefinedKeyword:case Tt.SK.NullKeyword:case Tt.SK.TrueKeyword:case Tt.SK.FalseKeyword:case Tt.SK.NumericLiteral:return!0;case Tt.SK.PropertyAccessExpression:return vt(e).exprKind==It.NumberLiteral;default:return!1}})(t.initializer)||Ct(9212,Zt("only numbers, null, true and false supported as default arguments")),i.push(t.initializer);else{var r=$t(a,ir(t)),n=r?Ze(parseInt(r)):null;null==n&&(n=Ze(void 0)),i.push(Me(n))}}else Ct(9213,Zt("unsupported default argument (shouldn't happen)"))});for(var n=0;n<r;n++){var s=t[n];s&&s.valueDeclaration&&s.valueDeclaration.kind==Tt.SK.Parameter&&(i[n],s.valueDeclaration)}a.imageLiteral&&(Mt(i[0])||Ct(9214,Zt("Only image literals (string literals) supported here; {0}",At(i[0]))),i[0]=function(e){e||(e="0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n");var t=0,r=0,n=0,i="",a=0;e+="\n";for(var s=0;s<e.length;++s)switch(e[s]){case".":case"_":case"0":i+="0,",t++,a++;break;case"#":case"*":case"1":i+="255,",t++,a++;break;case"\t":case"\r":case" ":break;case"\n":t&&(0==r?r=t:t!=r&&Ct(9205,Zt("lines in image literal have to have the same width (got {0} and then {1} pixels)",r,t)),t=0,n++);break;default:Ct(9206,Zt("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var o="_img"+D.lblNo++;a%2!=0&&(i+="0"),D.otherLiterals.push("\n.balign 4\n"+o+": .short 0xffff\n        .short "+r+", "+n+"\n        .byte "+i+"\n");var l="new pxsim.Image("+r+", ["+i+"])";return{kind:Tt.SK.NumericLiteral,imageLiteral:o,jsLit:l}}(i[0].text))}}function ve(r,e,t,n,i,a){var s;void 0===i&&(i=null),void 0===a&&(a=null),i||(i=fe(e));var o=!1,l=!1,u=!1,c=r===e;if(i)switch(i.kind){case Tt.SK.PropertySignature:case Tt.SK.PropertyAssignment:case Tt.SK.PropertyDeclaration:case Tt.SK.MethodSignature:o=!0;break;case Tt.SK.Parameter:kr(i)&&(o=!0);break;case Tt.SK.GetAccessor:case Tt.SK.SetAccessor:case Tt.SK.MethodDeclaration:l=o=!0,u=Bt(i);break;case Tt.SK.FunctionDeclaration:u=!0;break;case Tt.SK.ModuleDeclaration:break;default:i=null}else e.kind==Tt.SK.PropertyAccessExpression&&(o=!0);Tt.target.switches.slowMethods&&(l=!1);var p=nr(i),f=t.slice(0);if(o&&Bt(i)&&(o=!1),o&&!a&&e.kind==Tt.SK.PropertyAccessExpression&&(a=e.expression),F.usedArguments&&p.trackArgs){var d=a?[a].concat(f):f,m=p.trackArgs.map(function(e){return d[e]}).map(function(e){var t=fe(e);return!t||t.kind!=Tt.SK.EnumMember&&t.kind!=Tt.SK.VariableDeclaration?e&&e.kind==Tt.SK.StringLiteral?e.text:"*":tr(Qt,t)}).join(","),h=tr(Qt,i),g=F.usedArguments[h];g||(g=F.usedArguments[h]=[]),g.indexOf(m)<0&&g.push(m)}function v(){var e=ke(i,r,f.map(function(e){return vt(e)})),t=e.data;return f[0]&&t.proc&&t.proc.classInfo&&(t.isThis=f[0].kind==Tt.SK.ThisKeyword),e}if(ge(n,f,p),u&&!(S=B(i)).location)return p.shim&&!Pe(i)?he(i,r,f):(ue(i),v());if(e.kind==Tt.SK.SuperKeyword){for(var b=O.classInfo.baseClassInfo.ctor,y=O.classInfo.baseClassInfo;y&&!b;y=y.baseClassInfo)b=y.ctor;if(!b&&D.finalPass)throw Ct(9280,Zt("super() call requires an explicit constructor in base class"));var x=f.map(function(e){return vt(e)});return x.unshift(Z(e)),be(b,r,x)}if(o){if(Tt.U.assert(!Bt(i)),a?f.unshift(a):M(r,Zt("strange method call"),9241),!i){Tt.U.assert(e.kind==Tt.SK.PropertyAccessExpression);var k=e.name.text;return ye(f.map(function(e){return vt(e)}),{ifaceIndex:R(k,!0),callLocationIndex:St(r),noArgs:c})}var S;if((S=B(i)).parentClassInfo&&Te(S.parentClassInfo),ue(i),a.kind==Tt.SK.SuperKeyword)return v();var T=!!S.virtualParent,w=!!Ut()||!!Tt.target.switches.slowMethods;if(T&&!w)return i.kind==Tt.SK.MethodDeclaration?Tt.U.assert(!c):i.kind==Tt.SK.GetAccessor||i.kind==Tt.SK.SetAccessor?Tt.U.assert(c):Tt.U.assert(!1),Tt.U.assert(!D.finalPass||null!=S.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),ye(f.map(function(e){return vt(e)}),{classInfo:S.parentClassInfo,virtualIndex:S.virtualIndex,noArgs:c,isThis:f[0].kind==Tt.SK.ThisKeyword});if(p.shim&&!Pe(i))return he(i,r,f);if(p.helper){for(var I=void 0,E=0,N=Qt.getSymbolsInScope(r,Tr.SymbolFlags.Module);E<N.length;E++){var _=N[E];if("helpers"==_.name)for(var K=0,A=_.declarations||[_.valueDeclaration];K<A.length;K++){var C=A[K];if(C.kind==Tt.SK.ModuleDeclaration)for(var U=0,P=C.body.statements;U<P.length;U++){var L=P[U];(null===(s=L.symbol)||void 0===s?void 0:s.name)==p.helper&&(I=L)}}}return I||Ct(9215,Zt("helpers.{0} not found",p.helper)),I.kind!=Tt.SK.FunctionDeclaration&&Ct(9216,Zt("helpers.{0} isn't a function",p.helper)),ue(i=I),v()}return T||Tt.target.switches.slowMethods||!l?ye(f.map(function(e){return vt(e)}),{ifaceIndex:R(ir(i),!0),isSet:c&&2==f.length,callLocationIndex:St(r),noArgs:c}):(Tt.U.assert(i.kind!=Tt.SK.MethodSignature),v())}return i&&i.kind==Tt.SK.ModuleDeclaration&&("String"==ir(i)?Ct(9219,Zt('to convert X to string use: X + ""')):Ct(9220,Zt("namespaces cannot be called directly"))),f.unshift(e),Tt.U.assert(!c),ye(f.map(function(e){return vt(e)}),{virtualIndex:-1,callLocationIndex:St(r),noArgs:c})}function be(e,t,r){Tt.U.assert(!D.finalPass||!!e);var n={proc:e,callLocationIndex:St(t),virtualIndex:null,ifaceIndex:null};return Tt.ir.op(It.ProcCall,r,n)}function ye(e,t){return Tt.ir.op(It.ProcCall,e,t)}function xe(e){return _t(e).proc}function ke(e,t,r){var n=xe(e);return e.kind==Tt.SK.FunctionDeclaration&&W(B(e)),Tt.assert(!!n||!D.finalPass,"!!proc || !bin.finalPass"),be(n,t,r)}function Se(e){return e.members.filter(function(e){return e.kind==Tt.SK.Constructor})[0]}function Te(e){ce(e.decl),e.isUsed||(_t(e.decl).flags|=8,e.baseClassInfo&&Te(e.baseClassInfo),D.usedClassInfos.push(e))}function we(u){function h(e){return/^[0-9a-f]$/i.test(e)}var e=fe(u.tag);if(!e)throw M(u,Zt("invalid tagged template"),9265);var t,c=nr(e),r={decl:e,qName:e?tr(Qt,e):"?",args:[u.template],isExpression:!0};function n(e){t=function(e,t){var r=v;if("_"==t[0]&&"_"==t[1]&&g.jres[t]&&(r=g.jres[t],t=""),""==t&&r){var n=/font\/x-mkcd-b(\d+)/.exec(r.mimeType);if(n)if(D.finalPass){for(var i=parseInt(n[1]),a=atob(r.data),s=D.usedChars,o="",l=0;l<a.length;l+=i){var u=a.charCodeAt(l)+(a.charCodeAt(l+1)<<8);(u<128||s[u>>5]&1<<(31&u))&&(o+=a.slice(l,l+i))}t=Tt.U.toHex(Tt.U.stringToUint8Array(o))}else t="aabbccdd";else r.dataEncoding&&"base64"!=r.dataEncoding?"hex"==r.dataEncoding?t=r.data:Ct(9271,Zt("invalid jres encoding '{0}' on '{1}'",r.dataEncoding,r.id)):t=Tt.U.toHex(Tt.U.stringToUint8Array(Tr.pxtc.decodeBase64(r.data)))}if(/^e[14]/i.test(t)&&e.parent&&e.parent.kind==Tt.SK.CallExpression&&"image.ofBuffer"==e.parent.expression.getText()){var c=/^e([14])(..)(..)..(.*)/i.exec(t);t="870"+c[1]+c[2]+"00"+c[3]+"000000"+c[4]}for(var p="",f=0;f<t.length;++f){var d=t[f];if(!h(d)){if(/^[\s\.]$/.test(d))continue;throw M(e,Zt("invalid character in hex literal '{0}'",d),9265)}h(t[f+1])&&(p+=d+t[f+1],f++)}if(Tt.target.isNative){var m=D.emitHexLiteral(p.toLowerCase());return Tt.ir.ptrlit(m,m)}return m="_hex"+N(e),Tt.ir.ptrlit(m,{hexlit:p.toLowerCase()})}(u,e(u.template.text))}if(_t(u).callInfo=r,u.template.kind!=Tt.SK.NoSubstitutionTemplateLiteral)throw M(u,Zt("substitution not supported in hex literal",c.shim),9265);switch(c.shim){case"@hex":n(function(e){return e});break;case"@f4":n(function(e){if(!Array.isArray(c.groups))throw M(u,Zt("missing groups in @f4 literal"),9272);var r=[],t=[],a={},n=0;c.groups.forEach(function(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];a[i]=t}}),e+="\n";for(var i=0;i<e.length;++i){var s=e[i];switch(s){case" ":case"\t":break;case"\n":0<t.length&&(r.push(t),n=Math.max(t.length,n),t=[]);break;default:var o=Tt.U.lookup(a,s);if(null==o){if(2!=c.groups.length)throw M(u,Zt("invalid character in image literal: '{0}'",o),9273);o=1}t.push(o)}}var l=8;return c.groups.length<=2?l=1:c.groups.length<=16&&(l=4),Tt.f4EncodeImg(n,r.length,l,function(e,t){return r[t][e]||0})});break;default:if(void 0===c.shim&&c.helper)return function(e,t){for(var r,n,i=Qt.getSymbolsInScope(e,Tr.SymbolFlags.Module),a=0,s=i;a<s.length;a++){var o=s[a];if("helpers"==o.name)for(var l=0,u=o.declarations||[o.valueDeclaration];l<u.length;l++){var c=u[l];if(c.kind==Tt.SK.ModuleDeclaration)for(var p=0,f=c.body.statements;p<f.length;p++){var d=f[p];(null===(r=d.symbol)||void 0===r?void 0:r.name)==t.helper&&(n=d)}}}n||Ct(9215,Zt("helpers.{0} not found",t.helper)),n.kind!=Tt.SK.FunctionDeclaration&&Ct(9216,Zt("helpers.{0} isn't a function",t.helper));var m=n;return ue(m),ke(m,e,[X(e.text)])}(u.template,c);throw M(u,Zt("invalid shim '{0}' on tagged template",c.shim),9265)}return c.helper&&(t=Tt.ir.rtcall(c.helper,[t])),t}function Ie(e){var t=e.parameters.slice(0);if(!Bt(e)&&jt(e)){var r=B(e);r.thisParameter||(r.thisParameter={kind:Tt.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),t.unshift(r.thisParameter)}return t}function Ee(e,t){void 0===t&&(t=!1);var r=gr(e);return Tt.ir.ptrlit(r+"_Lit",r)}function Ne(){for(O=xe(d);0<C.length;)yt(C.pop())}function _e(){var e=a;if(0<e.length){a=[];for(var t=0,r=e;t<r.length;t++){var n=r[t],i=O;try{Ae(n)}finally{O=i}}}}function Ke(e){D.finalPass&&e.functionsToDefine&&Tt.U.pushRange(a,e.functionsToDefine)}function Ae(n){var e=B(n),i=null;if(D.finalPass){if(e.alreadyEmitted)return Tt.U.assert(e.usedBeforeDecl),null;e.alreadyEmitted=!0}var t=n.kind==Tt.SK.ArrowFunction||n.kind==Tt.SK.FunctionExpression,r=e.capturedVars.slice(0),a=r.map(function(e,t){var r=new Tt.ir.Cell(t,e,P(e));return r.iscap=!0,r});void 0===e.usedBeforeDecl&&(e.usedBeforeDecl=!1),0<r.length?(Tt.assert(null!=zt(n),"getEnclosingFunction(node) != null)"),i=Tt.ir.shared(Tt.ir.rtcall("pxt::mkAction",[Tt.ir.numlit(r.length),Ee(n,!0)])),e.usedAsValue=!0,r.forEach(function(e,t){var r=O.localIndex(e);r||Ct(9223,Zt("cannot find captured value: {0}",Qt.symbolToString(e.symbol)));var n=r.loadCore();O.emitExpr(Tt.ir.rtcall("pxtrt::stclo",[i,Tt.ir.numlit(t),n]))}),n.kind==Tt.SK.FunctionDeclaration&&(e.location=O.mkLocal(n,P(n)),O.emitExpr(e.location.storeDirect(i)),i=null)):t&&(i=Ee(n),e.usedAsValue=!0),Tt.assert(!!i==t,"!!lit == isExpression");var s=xe(n);if(s)(O=s).reset();else{Tt.assert(!D.finalPass,"!bin.finalPass");var o=_t(n),l=new Tt.ir.Procedure;l.isRoot=!!(1&o.flags),l.action=n,l.info=e,(o.proc=l).usingCtx=U,O=l,L(function(e){return e.addProc(l)})}O.captured=a;var u=[];if(n.parent.kind==Tt.SK.ClassDeclaration){var c=G(null,n.parent);if(O.classInfo?Tt.assert(O.classInfo==c,"proc.classInfo == classInfo"):O.classInfo=c,n.kind==Tt.SK.Constructor){if(c.baseClassInfo)for(var p=0,f=c.baseClassInfo.decl.members;p<f.length;p++){var d=f[p];d.kind==Tt.SK.Constructor&&ue(d)}c.ctor?Tt.assert(c.ctor==O,"classInfo.ctor == proc"):c.ctor=O;for(var m=0,h=c.allfields;m<h.length;m++)if((E=h[m]).kind==Tt.SK.PropertyDeclaration&&!Bt(E)){var g=E;g.initializer&&u.push(g)}}}var v=[],b=[];O.args=Ie(n).map(function(e,t){e.name.kind===Tt.SK.ObjectBindingPattern&&v.push(e),n.kind==Tt.SK.Constructor&&kr(e)&&b.push(e);var r=new Tt.ir.Cell(t,e,P(e));return Ke(r.info),r.isarg=!0,r}),O.args.forEach(function(e){if(e.isByRefLocal()){var t=Tt.ir.shared(Tt.ir.rtcall("pxtrt::mklocRef",[]));O.emitExpr(Tt.ir.rtcall("pxtrt::stlocRef",[t,e.loadCore()],1)),O.emitExpr(e.storeDirect(t))}}),v.forEach(function(e){return mt(e)});for(var y=0,x=b;y<x.length;y++){var k=x[y],S=Re(O.classInfo,$e(O.classInfo,ir(k)),!1),T=Tt.ir.op(It.FieldAccess,[H(e.thisParameter)],S);O.emitExpr(Tt.ir.op(It.Store,[T,H(k)]))}for(var w=0,I=u;w<I.length;w++){var E=I[w];S=Re(O.classInfo,$e(O.classInfo,ir(E)),!1),T=Tt.ir.op(It.FieldAccess,[H(e.thisParameter)],S),O.emitExpr(Tt.ir.op(It.Store,[T,vt(E.initializer)]))}if(_e(),n.body.kind==Tt.SK.Block){if(xt(n.body),dr(O.action)){var N=O.body[O.body.length-1];N&&N.stmtKind==Tt.ir.SK.Jmp&&N.jmpMode==Tt.ir.JmpMode.Always||O.emitJmp(lt(n).ret,Ze(void 0),Tt.ir.JmpMode.Always)}}else{var _=vt(n.body);O.emitJmp(lt(n).ret,_,Tt.ir.JmpMode.Always)}O.emitLblDirect(lt(n).ret),O.stackEmpty();var K=O.mkLabel("final");if(dr(O.action)?O.emitJmp(K):O.emitJmp(K,Ze(void 0)),O.emitLbl(K),e.capturedVars.length&&e.usedBeforeDecl&&n.kind==Tt.SK.FunctionDeclaration&&!D.finalPass){e.capturedVars.sort(function(e,t){return t.pos-e.pos});var A=P(e.capturedVars[0]);A.functionsToDefine||(A.functionsToDefine=[]),A.functionsToDefine.push(n)}return Tt.assert(!D.finalPass||0==C.length,"!bin.finalPass || usedWorkList.length == 0"),i}function Ce(e){var t=Tt.ir.shared(e);return O.emitExpr(t),t}function Ue(){return Ce(Tt.ir.op(It.JmpValue,[]))}function Pe(e){if(g.target.isNative)return!1;var t=e;return t.body&&(t.body.kind!=Tt.SK.Block||0<t.body.statements.length)}function Le(e){if(oe(e)&&!(32&_t(e).flags)){var t=nr(e);if(null!=t.shim){if("@"==t.shim[0])return;if(g.target.isNative&&Tt.hexfile.validateShim(mr(e),t.shim,t,dr(e),Ie(e).map(function(e){return Sr(fr(e))})),!Pe(e))return}if(!Tr.isInAmbientContext(e)&&e.body){var r=null,n=O;try{r=Ae(e)}finally{O=n}return r}}}function Fe(){}function Oe(e){var t=e;t.needsIRCache=!0,n.push(t)}function De(e,t){void 0===t&&(t=null);var r=n.length;return e.kind!=Tt.SK.PropertyAccessExpression&&e.kind!=Tt.SK.ElementAccessExpression||Oe(e.expression),t&&Oe(t),n.length==r?Fe:function(){for(var e=r;e<n.length;++e)n[e].cachedIR=null,n[e].needsIRCache=!1;n.splice(r,n.length-r)}}function Me(e,t){void 0===t&&(t=!1);var r={kind:Tt.SK.NullKeyword,isRefOverride:t};return _t(r).valueOverride=e,r}function Be(e,t,r,n){void 0===n&&(n=null);var i=De(e),a=n?vt(n):Ze(1),s=Tt.ir.shared(vt(e)),o=Tt.ir.shared(ze(t,s,a));return qe(e,Me(o,!0)),i(),r?s:o}function Re(e,t,r){void 0===r&&(r=!0),Bt(t)&&Tt.U.oops("fieldIndex on static field: "+ir(t));var n=nr(t),i=e.allfields.indexOf(t);return i<0&&D.finalPass&&Tt.U.oops("missing field"),{idx:i,name:ir(t),isRef:!0,shimName:n.shim,classInfo:e,needsCheck:r}}function $e(e,t){var r=e.allfields.filter(function(e){return e.name.text==t})[0];return r||Ct(9224,Zt("field {0} not found",t)),r}function qe(e,t,r){void 0===r&&(r=!1);var n=fe(e),i=Gt(n);if(e.kind==Tt.SK.Identifier||i)if(n&&(i||Vt(n)||Jt(n))){var a=$(n);_(n,!0),O.emitExpr(a.storeByRef(vt(t)))}else M(e,Zt("bad target identifier"),9248);else if(e.kind==Tt.SK.PropertyAccessExpression){var s=fe(e);if(!s||s.kind!=Tt.SK.GetAccessor&&s.kind!=Tt.SK.SetAccessor)if(s&&(s.kind==Tt.SK.PropertySignature||s.kind==Tt.SK.PropertyAssignment||ie(s)))O.emitExpr(ve(e,e,[t],null,s));else{var o=vt(e);O.emitExpr(Tt.ir.op(It.Store,[o,vt(t)]))}else ne(s),(s=Tr.getDeclarationOfKind(s.symbol,Tt.SK.SetAccessor))||M(e,Zt("setter not available"),9253),O.emitExpr(ve(e,e,[t],null,s))}else if(e.kind==Tt.SK.ElementAccessExpression)O.emitExpr(ae(e,t));else if(e.kind==Tt.SK.ArrayLiteralExpression)if(t.kind==Tt.SK.ArrayLiteralExpression){var l=t.elements.map(function(e){var t=Tt.ir.shared(vt(e));return O.emitExpr(t),t});e.elements.forEach(function(e,t){qe(e,Me(l[t]))})}else{var u=Tt.ir.shared(vt(t));e.elements.forEach(function(e,t){qe(e,Me(et("Array_::getAt",[u,Tt.ir.numlit(t)])))})}else M(e,Zt("bad assignment target"),9249)}function je(e){if(Lt())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":case"numops::orrs":return"@nomask@"+e}if(Ut())switch(e){case"pxt::switch_eq":return"numops::eq"}return e}function ze(e,t,r){return et(je(e),[t,r])}function Ve(e,t){if(!t)return null;var r=t.val;switch(function e(t){if(t.kind==Tt.SK.Identifier)return t.text;if(t.kind==Tt.SK.PropertyAccessExpression){var r=t,n=e(r.expression);if(n)return n+"."+r.name.text}return null}(e)){case"Math.floor":return{val:Math.floor(r)};case"Math.ceil":return{val:Math.ceil(r)};case"Math.round":return{val:Math.round(r)}}return null}function Ge(e){if(!e)return null;var t=_t(e);if(void 0!==t.constantFolded)return t.constantFolded;if(Vt(e)&&e.parent.flags&Tr.NodeFlags.Const){var r=e;r.initializer&&(t.constantFolded=Je(r.initializer))}else if(e.kind==Tt.SK.EnumMember){var n=e,i=function(e){var t=nr(e).enumval;if(!t){var r=Qt.getConstantValue(e);if(null==r)return null;t=r+""}return/^[+-]?\d+$/.test(t)?t:/^0x[A-Fa-f\d]{2,8}$/.test(t)?t:(Tt.U.userError("enumval only support number literals"),"0")}(n);if(null==i)t.constantFolded=Je(n.initializer);else{var a=parseInt(i);isNaN(a)||(t.constantFolded={val:a})}}else if(e.kind==Tt.SK.PropertyDeclaration&&Bt(e)&&Rt(e)){var s=e;t.constantFolded=Je(s.initializer)}return t.constantFolded}function Je(e){if(!e)return null;var t=_t(e);if(void 0===t.constantFolded){t.constantFolded=null;var r=function(e){if(!e)return null;switch(e.kind){case Tt.SK.PrefixUnaryExpression:var t=e,r=Je(t.operand);return function(e,t){if(!t)return null;var r=t.val;switch(e){case Tt.SK.PlusToken:return{val:+r};case Tt.SK.MinusToken:return{val:-r};case Tt.SK.TildeToken:return{val:~r};case Tt.SK.ExclamationToken:return{val:!r};default:return null}}(t.operator,r);case Tt.SK.BinaryExpression:var t=e,n=Je(t.left);if(!n)return null;var i=Je(t.right);return i?function(e,t,r){if(!t||!r)return null;var n=t.val,i=r.val;switch(e){case Tt.SK.PlusToken:return{val:n+i};case Tt.SK.MinusToken:return{val:n-i};case Tt.SK.SlashToken:return{val:n/i};case Tt.SK.PercentToken:return{val:n%i};case Tt.SK.AsteriskToken:return{val:n*i};case Tt.SK.AsteriskAsteriskToken:return{val:Math.pow(n,i)};case Tt.SK.AmpersandToken:return{val:n&i};case Tt.SK.BarToken:return{val:n|i};case Tt.SK.CaretToken:return{val:n^i};case Tt.SK.LessThanLessThanToken:return{val:n<<i};case Tt.SK.GreaterThanGreaterThanToken:return{val:n>>i};case Tt.SK.GreaterThanGreaterThanGreaterThanToken:return{val:n>>>i};case Tt.SK.LessThanEqualsToken:return{val:n<=i};case Tt.SK.LessThanToken:return{val:n<i};case Tt.SK.GreaterThanEqualsToken:return{val:i<=n};case Tt.SK.GreaterThanToken:return{val:i<n};case Tt.SK.EqualsEqualsToken:return{val:n==i};case Tt.SK.EqualsEqualsEqualsToken:return{val:n===i};case Tt.SK.ExclamationEqualsEqualsToken:return{val:n!==i};case Tt.SK.ExclamationEqualsToken:return{val:n!=i};case Tt.SK.BarBarToken:return{val:n||i};case Tt.SK.AmpersandAmpersandToken:return{val:n&&i};default:return null}}(t.operatorToken.kind,n,i):null;case Tt.SK.NumericLiteral:var t=e,a=parseFloat(t.text);return isNaN(a)?null:{val:a};case Tt.SK.NullKeyword:return{val:null};case Tt.SK.TrueKeyword:return{val:!0};case Tt.SK.FalseKeyword:return{val:!1};case Tt.SK.UndefinedKeyword:return{val:void 0};case Tt.SK.CallExpression:var t=e;return 1==t.arguments.length?Ve(t.expression,Je(t.arguments[0])):null;case Tt.SK.PropertyAccessExpression:case Tt.SK.Identifier:return Ge(pe(e));case Tt.SK.AsExpression:return Je(e.expression);default:return null}}(e);t.constantFolded=r}return t.constantFolded}function He(e){var t=Tt.target.switches.boxDebug,r=null;if(t)try{Tt.target.switches.boxDebug=!1,r=vt(e)}finally{Tt.target.switches.boxDebug=t}else r=vt(e);var n=Ye(r);if(void 0===n)throw Ct(9267,Zt("a constant number-like expression is required here"));return n}function Qe(e,t,r){var n=Qt.getSymbolsInScope(e,Tr.SymbolFlags.Module).filter(function(e){return e.name==r&&!!e.valueDeclaration})[0];if(!n)return null;for(var i=0,a=n.valueDeclaration.body.statements;i<a.length;i++){var s=a[i];if(s.kind==Tt.SK.VariableStatement)for(var o=0,l=s.declarationList.declarations;o<l.length;o++){var u=l[o];if(u.symbol.name==t)return He(u.initializer)}}return null}function We(e,t){var r=Qt.getSymbolsInScope(e,Tr.SymbolFlags.Enum).filter(function(e){return"DAL"==e.name&&!!e.valueDeclaration})[0];if(!r)return null;var n=r.valueDeclaration.members.filter(function(e){return e.symbol.name==t})[0];return n?Qt.getConstantValue(n):null}function Ye(e){if(e.exprKind==Tt.ir.EK.NumberLiteral){var t=e.data;if(g.target.isNative&&!Ut()){if(t==Tt.taggedNull||t==Tt.taggedUndefined||t==Tt.taggedFalse)return 0;if(t==Tt.taggedTrue)return 1;if("number"==typeof t)return t>>1}else if("number"==typeof t)return t}else if(e.exprKind==Tt.ir.EK.RuntimeCall&&2==e.args.length){var r=Ye(e.args[0]),n=Ye(e.args[1]);if(void 0===r||void 0===n)return;switch(e.data){case"numops::orrs":return r|n;case"numops::adds":return r+n;default:return void console.log(e)}}}function Ze(e){if(g.target.isNative&&!Ut()){var t=pr(e);if(null!=t)return Tt.ir.numlit(t);if("number"==typeof e){if(n=e,!Tt.target.switches.boxDebug&&(0|n)==n&&-1073741824<=n&&n<=1073741823)return Tt.ir.numlit(e<<1|1);var r=D.emitDouble(e);return Tt.ir.ptrlit(r,JSON.stringify(e))}throw Tt.U.oops("bad literal: "+e)}return Tt.ir.numlit(e);var n}function Xe(e){if(e.kind==Tt.SK.NullKeyword){var t=_t(e).valueOverride;if(null!=t)return t.exprKind==It.NumberLiteral?!g.target.isNative||!!(1&t.data):t.exprKind==It.RuntimeCall&&"pxt::ptrOfLiteral"==t.data?t.args[0].exprKind==It.PointerLiteral&&!isNaN(parseFloat(t.args[0].jsInfo)):t.exprKind==It.PointerLiteral&&!isNaN(parseFloat(t.jsInfo))}return e.kind==Tt.SK.NumericLiteral||Sr(fr(e))}function et(e,t){return Tt.ir.rtcallMask(e,(1<<t.length)-1,0,t)}function tt(s,e,o,t){void 0===t&&(t=null);var l=[],r=Tt.hexfile.lookupFunc(s);if(Lt()){var n=Tt.U.lookup(wt,s);n&&(s=(r=n).name)}r&&(l=r.argsFmt),t&&(e=e.concat(t));var i,a,u=me(e),c=[],p=e.map(function(e,t){var r=vt(e);if(!Pt())return r;var n=l[t+1],i=Xe(e);if(!n&&s.indexOf("::")<0&&(n=i?"I":"_"),n){if("_"==n[0]||"T"==n||"N"==n){var a=function(e){switch(e){case"_Buffer":return pxt.BuiltInType.BoxedBuffer;case"_Image":return Tt.target.imageRefTag||pxt.BuiltInType.RefImage;case"_Action":return pxt.BuiltInType.RefAction;case"_RefCollection":return pxt.BuiltInType.RefCollection;default:return null}}(n);return a&&c.push({argIdx:t,method:"_validate",refTag:a,refTagNullable:!!o.argsNullable}),r}if("I"==n)return r.exprKind==It.NumberLiteral&&"number"==typeof r.data?Tt.ir.numlit(r.data>>1):(c.push({argIdx:t,method:"pxt::toInt"}),r);if("B"==n)return u&=~(1<<t),ot(e,r);if("S"==n)return r.isStringLiteral||(c.push({argIdx:t,method:"_pxt_stringConv",returnsRef:!0}),u|=1<<t),r;if("F"==n||"D"==n)return"D"==n&&Tt.U.oops("double arguments not yet supported"),i||Tt.U.userError("argsFmt=...F/D... but argument not a number in "+s),c.push({argIdx:t,method:"D"==n?"pxt::toDouble":"pxt::toFloat"}),r;throw Tt.U.oops("invalid format specifier: "+n)}throw Tt.U.userError("not enough args for "+s)}),f=Tt.ir.rtcallMask(s,u,o?o.callingConvention:0,p);if(f.mask||(f.mask={refMask:0}),f.mask.conversions=c,g.target.isNative){var d=l[0];"I"==d?f=Ft(f):"B"==d?f=Ot(f):"F"==d?(a=f,f=Pt()?Tt.ir.rtcall("pxt::fromFloat",[a]):a):"D"==d&&(Tt.U.oops("double returns not yet supported"),i=f,f=Pt()?Tt.ir.rtcall("pxt::fromDouble",[i]):i)}return f}function rt(e){if(D.numStmts++,g.breakpoints){var t=Tr.getSourceFileOfNode(e);if(!g.justMyCode||!Nt(t)){for(var r=e.pos;/^\s$/.exec(t.text[r]);)r++;var n=Tr.getLineAndCharacterOfPosition(t,r),i=Tr.getLineAndCharacterOfPosition(t,e.end),a={id:F.breakpoints.length,isDebuggerStmt:e.kind==Tt.SK.DebuggerStatement,fileName:t.fileName,start:r,length:e.end-r,line:n.line,endLine:i.line,column:n.character,endColumn:i.character};F.breakpoints.push(a);var s=Tt.ir.stmt(Tt.ir.SK.Breakpoint,null);s.breakpointInfo=a,O.emit(s)}}}function nt(e,t){switch(t){case Tt.SK.PlusToken:return"numops::adds";case Tt.SK.MinusToken:return"numops::subs";case Tt.SK.SlashToken:return"numops::div";case Tt.SK.PercentToken:return"numops::mod";case Tt.SK.AsteriskToken:return"numops::muls";case Tt.SK.AsteriskAsteriskToken:return"Math_::pow";case Tt.SK.AmpersandToken:return"numops::ands";case Tt.SK.BarToken:return"numops::orrs";case Tt.SK.CaretToken:return"numops::eors";case Tt.SK.LessThanLessThanToken:return"numops::lsls";case Tt.SK.GreaterThanGreaterThanToken:return"numops::asrs";case Tt.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case Tt.SK.LessThanEqualsToken:return"numops::le";case Tt.SK.LessThanToken:return"numops::lt";case Tt.SK.GreaterThanEqualsToken:return"numops::ge";case Tt.SK.GreaterThanToken:return"numops::gt";case Tt.SK.EqualsEqualsToken:return"numops::eq";case Tt.SK.EqualsEqualsEqualsToken:return"numops::eqq";case Tt.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case Tt.SK.ExclamationEqualsToken:return"numops::neq";default:return null}}function it(r){if(r.operatorToken.kind==Tt.SK.EqualsToken)return function(e){var t=e.right;e.parent.kind==Tt.SK.ExpressionStatement&&(t=null);var r=De(e.left,t);qe(e.left,e.right,!0);var n=t?vt(t):Ze(void 0);return r(),n}(r);var e=Je(r);if(e)return Ze(e.val);var t=null,n=null;if(r.operatorToken.kind!=Tt.SK.PlusToken&&r.operatorToken.kind!=Tt.SK.PlusEqualsToken||(t=fr(r.left),n=fr(r.right),(br(t)||br(n)&&r.operatorToken.kind==Tt.SK.PlusToken)&&(_t(r).exprInfo={leftType:Qt.typeToString(t),rightType:Qt.typeToString(n)})),r.operatorToken.kind==Tt.SK.CommaToken){if(ut(r.left))return vt(r.right);var i=ct(r.left);return Tt.ir.op(It.Sequence,[i,vt(r.right)])}switch(r.operatorToken.kind){case Tt.SK.BarBarToken:case Tt.SK.AmpersandAmpersandToken:return function(e){var t=vt(e.left),r=(br(fr(e.left)),O.mkLabel("lazy"));t=Tt.ir.shared(t);var n=Tt.ir.rtcall("numops::toBool",[t]),i=O.mkLabel("lazySkip"),a=e.operatorToken.kind==Tt.SK.BarBarToken?Tt.ir.JmpMode.IfZero:e.operatorToken.kind==Tt.SK.AmpersandAmpersandToken?Tt.ir.JmpMode.IfNotZero:Tt.U.oops();return O.emitJmp(i,n,a),O.emitJmp(r,t,Tt.ir.JmpMode.Always,t),O.emitLbl(i),O.emitExpr(et("langsupp::ignore",[t])),O.emitJmp(r,vt(e.right),Tt.ir.JmpMode.Always),O.emitLbl(r),Ue()}(r);case Tt.SK.InstanceOfKeyword:return function(e){var t=fr(e.right),r=ur(t)?fe(e.right):null;r&&r.kind==Tt.SK.ClassDeclaration||Ct(9275,Zt("unsupported instanceof expression"));var n=G(t,r);Te(n);var i=Tt.ir.op(Tt.ir.EK.InstanceOf,[vt(e.left)],n);return i.jsInfo="bool",i}(r)}if(r.operatorToken.kind==Tt.SK.PlusToken&&(br(t)||br(n)))return tt("String_::concat",[ee(r.left),ee(r.right)],null);if(r.operatorToken.kind==Tt.SK.PlusEqualsToken&&br(t)){var a=De(r.left),s=Tt.ir.shared(tt("String_::concat",[ee(r.left),ee(r.right)],null));return qe(r.left,Me(s)),a(),s}var o=function(e){switch(e){case Tt.SK.PlusEqualsToken:return Tt.SK.PlusToken;case Tt.SK.MinusEqualsToken:return Tt.SK.MinusToken;case Tt.SK.AsteriskEqualsToken:return Tt.SK.AsteriskToken;case Tt.SK.AsteriskAsteriskEqualsToken:return Tt.SK.AsteriskAsteriskToken;case Tt.SK.SlashEqualsToken:return Tt.SK.SlashToken;case Tt.SK.PercentEqualsToken:return Tt.SK.PercentToken;case Tt.SK.LessThanLessThanEqualsToken:return Tt.SK.LessThanLessThanToken;case Tt.SK.GreaterThanGreaterThanEqualsToken:return Tt.SK.GreaterThanGreaterThanToken;case Tt.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return Tt.SK.GreaterThanGreaterThanGreaterThanToken;case Tt.SK.AmpersandEqualsToken:return Tt.SK.AmpersandToken;case Tt.SK.BarEqualsToken:return Tt.SK.BarToken;case Tt.SK.CaretEqualsToken:return Tt.SK.CaretToken;default:return Tt.SK.Unknown}}(r.operatorToken.kind),l=nt(0,o||r.operatorToken.kind);return l||M(r.operatorToken,Zt("unsupported operator"),9250),o?Be(r.left,l,!1,r.right):function(e){e=je(e);var t=[r.left,r.right];return Tt.ir.rtcallMask(e,me(t),0,t.map(function(e){return vt(e)}))}(l)}function at(e){e.statements.forEach(xt)}function st(e){if(e.flags&Tr.NodeFlags.Let||e.flags&Tr.NodeFlags.Const)return!0;throw Ct(9260,Zt("variable needs to be defined using 'let' instead of 'var'"))}function ot(e,t){if(void 0===t&&(t=null),!t&&Lt()&&e.kind==Tt.SK.BinaryExpression){var r=e,n=Tt.U.lookup(Tt.thumbCmpMap,nt(0,r.operatorToken.kind));if(n)return Tt.ir.rtcall(n,[vt(r.left),vt(r.right)])}return t||(t=vt(e)),Ut()?t:Tt.ir.rtcall("numops::toBoolDecr",[t])}function lt(e){var t=Kt(e);return{fortop:".fortop."+t,cont:".cont."+t,brk:".brk."+t,ret:".ret."+t}}function ut(e){if(!e)return!0;switch(e.kind){case Tt.SK.Identifier:case Tt.SK.StringLiteral:case Tt.SK.NumericLiteral:case Tt.SK.NullKeyword:return!0}return!1}function ct(e){return vt(e)}function pt(e){if(!ut(e)){rt(e);var t=ct(e);O.emitExpr(t),O.stackEmpty()}}function ft(e){switch(e.kind){case Tt.SK.WhileStatement:case Tt.SK.ForInStatement:case Tt.SK.ForOfStatement:case Tt.SK.ForStatement:case Tt.SK.DoStatement:return!0;default:return!1}}function dt(e,t,r){if(e.name.kind===Tt.SK.ObjectBindingPattern||e.name.kind==Tt.SK.ArrayBindingPattern)return t||(t=e.initializer?Tt.ir.shared(vt(e.initializer)):H(e),r=e.initializer?fr(e.initializer):fr(e)),e.name.elements.forEach(function(e){return dt(e,t,r)}),O.stackEmpty(),null;if(!oe(e))return null;if(Ge(e))return null;var n;if(Gt(e)?(A(e),n=$(e)):n=O.mkLocal(e,P(e)),Ke(n.info),n.isByRefLocal()&&O.emitExpr(n.storeDirect(Tt.ir.rtcall("pxtrt::mklocRef",[]))),K(fr(e)),e.kind===Tt.SK.BindingElement){rt(e);var i=function e(t,r,n){var i=t.parent.parent;if(i.kind===Tt.SK.BindingElement){var a=e(i,r,n);r=a[0],n=a[1]}if(t.parent.kind==Tt.SK.ArrayBindingPattern){var s=t.parent.elements.indexOf(t);t.dotDotDotToken&&Ct(9203,Zt("spread operator not supported yet"));var o=cr(n,s);return[et("Array_::getAt",[r,Tt.ir.numlit(s)]),o]}var l=t.propertyName||t.name;return function(e,t,r,n){var i=Qt.getPropertyOfType(r,n);Tt.U.assert(!!i,"field sym");var a,s=Qt.getTypeOfSymbolAtLocation(i,e);if(ur(r)){var o=G(r);a=Tt.ir.op(It.FieldAccess,[t],Re(o,$e(o,n)))}else a=ye([t],{ifaceIndex:R(n,!0),callLocationIndex:St(e),noArgs:!0});return[a,s]}(t,r,n,l.text)}(e,t,r),a=i[0];i[1],O.emitExpr(n.storeByRef(a))}else if(e.initializer){if(rt(e),Gt(e)){var s=nr(e).jres;if(s){"true"==s&&(s=tr(Qt,e));var o=Tt.U.lookup(g.jres||{},s);o?v=o:Ct(9270,Zt("resource '{0}' not found in any .jres file",s))}}e.initializer,O.emitExpr(n.storeByRef(vt(e.initializer))),v=null,O.stackEmpty()}else(function(e){for(;e;){if(ft(e))return!0;e=e.parent}return!1})(e)&&(rt(e),O.emitExpr(n.storeByRef(Ze(void 0))),O.stackEmpty());return n}function mt(e){return dt(e,null,null)}function ht(e){!function(e,t){var r=function(e){e&&e.kind==Tt.SK.ClassDeclaration&&Ct(9261,Zt("Interface with same name as a class not supported"))};if(r(t.symbol.valueDeclaration),t.symbol.declarations&&t.symbol.declarations.forEach(r),t.heritageClauses)for(var n=0,i=t.heritageClauses;n<i.length;n++){var a=i[n];switch(a.token){case Tt.SK.ExtendsKeyword:lr(fr(a.types[0]))&&Ct(9262,Zt("Extending a class by an interface not supported."))}}}(0,e);var t=nr(e);t.autoCreate&&(b[t.autoCreate]=!0)}function gt(t,e){var r=Yt;er++;try{Yt=null;var n=e(t);return Yt&&Ct(Xt,Yt),Yt=r,er--,n}catch(e){return er--,Yt=null,E(t,e.ksErrorCode||9200,e.message),pxt.debug(e.stack),null}}function vt(e,t){void 0===t&&(t=!0);var r=e;if(t&&r.cachedIR)return r.cachedIR;var n=gt(r,bt)||Ze(void 0);return t&&r.needsIRCache?(r.cachedIR=Tt.ir.shared(n),r.cachedIR):n}function bt(e){var t=function(e){switch(e.kind){case Tt.SK.NullKeyword:var t=_t(e).valueOverride;return t||Ze(null);case Tt.SK.TrueKeyword:return Ze(!0);case Tt.SK.FalseKeyword:return Ze(!1);case Tt.SK.TemplateHead:case Tt.SK.TemplateMiddle:case Tt.SK.TemplateTail:case Tt.SK.NumericLiteral:case Tt.SK.StringLiteral:case Tt.SK.NoSubstitutionTemplateLiteral:return function(e){if(e.kind!=Tt.SK.NumericLiteral){if(Mt(e))return X(e.text);throw Tt.oops()}return e.imageLiteral?Tt.ir.ptrlit(e.imageLiteral,e.jsLit):Ze(parseFloat(e.text))}(e);case Tt.SK.TaggedTemplateExpression:return we(e);case Tt.SK.PropertyAccessExpression:return re(e);case Tt.SK.BinaryExpression:return it(e);case Tt.SK.PrefixUnaryExpression:return function(e){var t=Je(e);if(t)return Ze(t.val);switch(e.operator){case Tt.SK.ExclamationToken:return Ot(Tt.ir.rtcall("Boolean_::bang",[ot(e.operand)]));case Tt.SK.PlusPlusToken:return Be(e.operand,"numops::adds",!1);case Tt.SK.MinusMinusToken:return Be(e.operand,"numops::subs",!1);case Tt.SK.PlusToken:case Tt.SK.MinusToken:return null!=(n=Ye(r=vt(e.operand)))?Ze(-n):e.operator==Tt.SK.MinusToken?ze("numops::subs",Ze(0),r):ze("numops::subs",r,Ze(0));case Tt.SK.TildeToken:var r,n;return null!=(n=Ye(r=vt(e.operand)))?Ze(~n):et(je("numops::bnot"),[r]);default:throw M(e,Zt("unsupported prefix unary operation"),9245)}}(e);case Tt.SK.PostfixUnaryExpression:return function(e){if(yr(fr(e.operand)))switch(e.operator){case Tt.SK.PlusPlusToken:return Be(e.operand,"numops::adds",!0);case Tt.SK.MinusMinusToken:return Be(e.operand,"numops::subs",!0)}throw M(e,Zt("unsupported postfix unary operation"),9246)}(e);case Tt.SK.ElementAccessExpression:return ae(e);case Tt.SK.ParenthesizedExpression:return vt(e.expression);case Tt.SK.TypeAssertionExpression:return(c=e).expression,vt(c.expression);case Tt.SK.ArrayLiteralExpression:return function(e){cr(fr(e));for(var t=Tt.ir.shared(Tt.ir.rtcall("Array_::mk",[])),r=0,n=e.elements;r<n.length;r++){var i=n[r],a=de(i)?2:0;O.emitExpr(Tt.ir.rtcall("Array_::push",[t,vt(i)],a))}return t}(e);case Tt.SK.NewExpression:return function(e){var t=Qt.getTypeAtLocation(e);if(t&&sr(t))throw Tt.oops();if(t&&ur(t)){var r=fe(e.expression);r.kind!=Tt.SK.ClassDeclaration&&Ct(9221,Zt("new expression only supported on class types"));for(var n=void 0,i=G(fr(e),r),a=i;a&&!(n=Se(a.decl));a=a.baseClassInfo);Te(i);var s=i.id+"_VT",o=Tt.ir.rtcall("pxt::mkClassInstance",[Tt.ir.ptrlit(s,s)]);if(n){o=Ce(o),le(n);var l=(e.arguments||[]).slice(0),u=nr(n);ge(Qt.getResolvedSignature(e),l,u);var c=l.map(function(e){return vt(e)});return u.shim?Tt.ir.rtcall(u.shim,c):(c.unshift(o),O.emitExpr(ke(n,e,c)),o)}return e.arguments&&e.arguments.length&&Ct(9222,Zt("constructor with arguments not found")),o}throw M(e,Zt("unknown type for new"),9243)}(e);case Tt.SK.SuperKeyword:case Tt.SK.ThisKeyword:return Z(e);case Tt.SK.CallExpression:return o=e,l=Qt.getResolvedSignature(o),ve(o,o.expression,o.arguments,l);case Tt.SK.FunctionExpression:case Tt.SK.ArrowFunction:return Le(e);case Tt.SK.Identifier:return Y(e);case Tt.SK.ConditionalExpression:return i=e,a=O.mkLabel("condexprz"),s=O.mkLabel("condexprfin"),O.emitJmp(a,ot(i.condition),Tt.ir.JmpMode.IfZero),O.emitJmp(s,vt(i.whenTrue),Tt.ir.JmpMode.Always),O.emitLbl(a),O.emitJmp(s,vt(i.whenFalse),Tt.ir.JmpMode.Always),O.emitLbl(s),Ue();case Tt.SK.AsExpression:return(n=e).expression,vt(n.expression);case Tt.SK.TemplateExpression:return te(e);case Tt.SK.ObjectLiteralExpression:return r=e,u=Tt.ir.shared(Tt.ir.rtcall("pxtrt::mkMap",[])),r.properties.forEach(function(e){var t,r;if(Tt.assert(!e.questionToken),e.kind==Tt.SK.ShorthandPropertyAssignment){var n=e;Tt.assert(!n.equalsToken&&!n.objectAssignmentInitializer),t=e.name.text;var i=Qt.getShorthandAssignmentValueSymbol(e),a=i&&i.valueDeclaration&&i.valueDeclaration.name;if(!a||a.kind!=Tt.SK.Identifier)throw M(e);r=Y(a)}else{if(e.name.kind==Tt.SK.ComputedPropertyName){var s=e.name.expression;return void O.emitExpr(tt("pxtrt::mapSetByString",[Me(u,!0),s,e.initializer],null))}t=e.name.kind==Tt.SK.StringLiteral?e.name.text:e.name.getText(),r=vt(e.initializer)}var o=Tt.target.isNative?Tt.ir.numlit(R(t)):Tt.ir.ptrlit(null,JSON.stringify(t)),l=[u,o,r];O.emitExpr(Tt.ir.rtcall(Tt.target.isNative?"pxtrt::mapSet":"pxtrt::mapSetByString",l))}),u;case Tt.SK.TypeOfExpression:return tt("pxt::typeOf",[e.expression],null);case Tr.SyntaxKind.DeleteExpression:return function(e){var t,r;if(e.expression.kind==Tt.SK.PropertyAccessExpression)t=(n=e.expression).expression,r=Me(X(n.name.text));else{if(e.expression.kind!=Tt.SK.ElementAccessExpression)throw Ct(9276,Zt("expression not supported as argument to 'delete'"));var n;t=(n=e.expression).expression,r=n.argumentExpression}var i=fr(t);if(lr(i))throw Ct(9277,Zt("'delete' not supported on class types"));if(sr(i))throw Ct(9277,Zt("'delete' not supported on array"));return tt("pxtrt::mapDeleteByString",[t,r],null)}(e);default:return M(e),null}var r,u,n,i,a,s,o,l,c}(e);if(t.isExpr())return t;throw new Error("expecting expression")}function yt(e){var t=_t(e);if(t.usedNodes){p=!1;for(var r=0,n=Tt.U.values(t.usedNodes);r<n.length;r++)le(n[r]);for(var i=0,a=t.usedActions;i<a.length;i++)(0,a[i])(D);p=!0}else Gt(e)||Tr.isClassDeclaration(e)?(p=!1,(U=t).usedNodes=null,U.usedActions=null,Gt(e)&&!Ge(e)&&A(e),xt(e),p=!0):((U=t).usedNodes={},U.usedActions=[],xt(e),U=null)}function xt(e){gt(e,kt)}function kt(e){switch(e.kind){case Tt.SK.SourceFile:return void e.statements.forEach(xt);case Tt.SK.InterfaceDeclaration:return ht(e);case Tt.SK.VariableStatement:return function(e){function t(e){var t=Tt.U.lookup(u,e.name);if(t||(u[(t=e).name]=t),t.value!=e.value)throw Ct(9269,Zt("conflicting values for config.{0}",e.name))}if(e.declarationList.flags&Tr.NodeFlags.Const){var r=e.parent&&e.parent.kind==Tt.SK.ModuleBlock?ir(e.parent.parent):"?";if("config"==r||"userconfig"==r)for(var n=0,i=e.declarationList.declarations;n<i.length;n++){var a=i[n],s=mr(a);if(a.initializer){var o=He(a.initializer),l=We(e,"CFG_"+s);if(null==l||0==l)throw Ct(9268,Zt("can't find DAL.CFG_{0}",s));"userconfig"==r&&(s="!"+s),t({name:s,key:l,value:o})}}}Tr.isInAmbientContext(e)||(st(e.declarationList),e.declarationList.declarations.forEach(xt))}(e);case Tt.SK.ModuleDeclaration:return void xt(e.body);case Tt.SK.EnumDeclaration:return;case Tt.SK.FunctionDeclaration:case Tt.SK.Constructor:case Tt.SK.MethodDeclaration:return void Le(e);case Tt.SK.ExpressionStatement:return void pt(e.expression);case Tt.SK.Block:case Tt.SK.ModuleBlock:return at(e);case Tt.SK.VariableDeclaration:return mt(e),void _e();case Tt.SK.IfStatement:return function(e){rt(e);var t=O.mkLabel("else");O.emitJmpZ(t,ot(e.expression)),xt(e.thenStatement);var r=O.mkLabel("afterif");O.emitJmp(r),O.emitLbl(t),e.elseStatement&&xt(e.elseStatement),O.emitLbl(r)}(e);case Tt.SK.WhileStatement:return function(e){rt(e);var t=lt(e);O.emitLblDirect(t.cont),rt(e.expression),O.emitJmpZ(t.brk,ot(e.expression)),xt(e.statement),O.emitJmp(t.cont),O.emitLblDirect(t.brk)}(e);case Tt.SK.DoStatement:return function(e){rt(e);var t=lt(e);O.emitLblDirect(t.cont),xt(e.statement),rt(e.expression),O.emitJmpZ(t.brk,ot(e.expression)),O.emitJmp(t.cont),O.emitLblDirect(t.brk)}(e);case Tt.SK.ForStatement:return function(e){e.initializer&&e.initializer.kind==Tt.SK.VariableDeclarationList?(st(e.initializer),e.initializer.declarations.forEach(xt)):pt(e.initializer),rt(e);var t=lt(e);O.emitLblDirect(t.fortop),e.condition&&(rt(e.condition),O.emitJmpZ(t.brk,ot(e.condition))),xt(e.statement),O.emitLblDirect(t.cont),pt(e.incrementor),O.emitJmp(t.fortop),O.emitLblDirect(t.brk)}(e);case Tt.SK.ForOfStatement:return function(e){if(e.initializer&&e.initializer.kind==Tt.SK.VariableDeclarationList){var t=e.initializer;if(1==t.declarations.length){st(t);var r=fr(e.expression),n="",i="";if(br(r))n="String_::charAt",i="String_::length";else{if(!sr(r))return void M(e.expression,"cannot use for...of with this expression");n="Array_::getAt",i="Array_::length"}le(t.declarations[0]);var a=mt(t.declarations[0]);Tt.U.assert(!!a||!D.finalPass),O.stackEmpty();var s=O.mkLocalUnnamed();O.emitExpr(s.storeByRef(vt(e.expression)));var o=O.mkLocalUnnamed();O.emitExpr(o.storeByRef(Ze(0))),O.stackEmpty(),rt(e);var l=lt(e);O.emitLblDirect(l.fortop);var u,c=Tt.ir.rtcall(i,[s.loadCore()]),p=ze("numops::lt_bool",o.load(),Ft(c));O.emitJmpZ(l.brk,p),a&&O.emitExpr(a.storeByRef(Tt.ir.rtcall(n,[s.loadCore(),(u=o.loadCore(),Pt()?Tt.ir.rtcall("pxt::toInt",[u]):u)]))),_e(),xt(e.statement),O.emitLblDirect(l.cont),O.emitExpr(o.storeByRef(ze("numops::adds",o.load(),Ze(1)))),O.emitJmp(l.fortop),O.emitLblDirect(l.brk),O.emitExpr(s.storeByRef(Ze(void 0)))}else M(e,"only a single variable may be used to iterate a collection")}else M(e,"only a single variable may be used to iterate a collection")}(e);case Tt.SK.ContinueStatement:case Tt.SK.BreakStatement:return function(e){rt(e);var r=e.label?e.label.text:null,n=e.kind==Tt.SK.BreakStatement,t=function e(t){return t?r&&t.kind==Tt.SK.LabeledStatement&&t.label.text==r?t.statement:t.kind==Tt.SK.SwitchStatement&&!r&&n?t:!r&&Tr.isIterationStatement(t,!1)?t:e(t.parent):null}(e);if(t){var i=lt(t);e.kind==Tt.SK.ContinueStatement?Tr.isIterationStatement(t,!1)?O.emitJmp(i.cont):E(e,9231,Zt("continue on non-loop")):e.kind==Tt.SK.BreakStatement?O.emitJmp(i.brk):Tt.oops()}else E(e,9230,Zt("cannot find outer loop"))}(e);case Tt.SK.LabeledStatement:return a=lt((i=e).statement),xt(i.statement),void O.emitLblDirect(a.brk);case Tt.SK.ReturnStatement:return function(e){rt(e);var t=null;e.expression?t=vt(e.expression):dr(O.action)&&(t=Ze(void 0)),O.emitJmp(lt(O.action).ret,t,Tt.ir.JmpMode.Always)}(e);case Tt.SK.ClassDeclaration:return(n=G(null,r=e)).isUsed&&D.usedClassInfos.indexOf(n)<0&&D.usedClassInfos.push(n),void r.members.forEach(xt);case Tt.SK.PropertyDeclaration:case Tt.SK.PropertyAssignment:return function(e){if(Bt(e))mt(e);else if(e.initializer){var t=G(fr(e.parent));D.finalPass&&t.isUsed&&!t.ctor&&Ct(9209,Zt("class field initializers currently require an explicit constructor"))}}(e);case Tt.SK.SwitchStatement:return function(e){rt(e);var s,t=lt(e),o=Tt.ir.shared(vt(e.expression)),r=e.caseBlock.clauses.map(function(e){var t=O.mkLabel("switch");if(e.kind==Tt.SK.CaseClause){var r=e,n=vt(r.expression),i=de(r.expression)?1:0,a=Tt.ir.rtcallMask(je("pxt::switch_eq"),i,0,[n,o]);O.emitJmp(t,a,Tt.ir.JmpMode.IfNotZero,o)}else e.kind==Tt.SK.DefaultClause?(Tt.assert(!s,"!defaultLabel"),s=t):Tt.oops();return t});s?O.emitJmp(s,o):O.emitJmp(t.brk,o),e.caseBlock.clauses.forEach(function(e,t){O.emitLbl(r[t]),e.statements.forEach(xt)}),O.emitLblDirect(t.brk)}(e);case Tt.SK.TypeAliasDeclaration:return;case Tr.SyntaxKind.TryStatement:return function(e){var t=function(e){return et("pxt::beginTry",[Tt.ir.ptrlit(e.lblName,e)])};rt(e);var r=O.mkLabel("catch");r.lblName="_catch_"+Kt(e);var n=O.mkLabel("finally");if(n.lblName="_finally_"+Kt(e),e.finallyBlock&&O.emitExpr(t(n)),e.catchClause&&O.emitExpr(t(r)),O.stackEmpty(),at(e.tryBlock),O.stackEmpty(),e.catchClause){var i=O.mkLabel("catchend");O.emitExpr(et("pxt::endTry",[])),O.emitJmp(i),O.emitLbl(r);var a=e.catchClause.variableDeclaration;if(a){mt(a);var s=$(a);O.emitExpr(s.storeByRef(et("pxt::getThrownValue",[])))}_e(),at(e.catchClause.block),O.emitLbl(i)}e.finallyBlock&&(O.emitExpr(et("pxt::endTry",[])),O.emitLbl(n),at(e.finallyBlock),O.emitExpr(et("pxt::endFinally",[])))}(e);case Tr.SyntaxKind.ThrowStatement:return rt(t=e),void O.emitExpr(et("pxt::throwValue",[vt(t.expression)]));case Tt.SK.DebuggerStatement:return void rt(e);case Tt.SK.GetAccessor:case Tt.SK.SetAccessor:return void Le(e);case Tt.SK.ImportEqualsDeclaration:case Tt.SK.EmptyStatement:case Tt.SK.SemicolonClassElement:return;default:M(e)}var t,r,n,i,a}function St(e){return F.procCallLocations.push(Tt.nodeLocationInfo(e))-1}},Tt.isStringType=br;var xr=function(){function e(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=function(e,t){},this.usedClassInfos=[],this.numStmts=1,this.commSize=0,this.itEntries=0,this.itFullEntries=0,this.numMethods=0,this.numVirtMethods=0,this.usedChars=new Uint32Array(2048),this.explicitlyUsedIfaceMembers={},this.ifaceMemberMap={},this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}return e.prototype.reset=function(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={},this.numStmts=0},e.prototype.getTitle=function(){var e=this.options.name||Tt.U.lf("Untitled");return 90<=e.length?e.slice(0,87)+"...":e},e.prototype.addProc=function(e){Tt.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length},e.prototype.recordHelper=function(e,t,r){var n=function(e){e.codeHelpers[t]||(e.codeHelpers[t]=r(e))};n(this),this.recordAction(e,n)},e.prototype.recordAction=function(e,t){e?e.usedActions&&e.usedActions.push(t):Tt.U.oops("no using ctx!")},e.prototype.emitLabelled=function(e,t,r){var n=Tt.U.lookup(t,e);if(null!=n)return n;var i=r+this.lblNo++;return t[e]=i},e.prototype.emitDouble=function(e){return this.emitLabelled(Tt.target.switches.numFloat?(n=e,(i=new Float32Array(1))[0]=n,Tt.U.toHex(new Uint8Array(i.buffer))):(t=e,(r=new Float64Array(1))[0]=t,Tt.U.toHex(new Uint8Array(r.buffer))),this.doubles,"_dbl");var t,r,n,i},e.prototype.emitString=function(e){if(!this.finalPass)for(var t=0;t<e.length;++t){var r=e.charCodeAt(t);128<=r&&(this.usedChars[r>>5]|=1<<(31&r))}return this.emitLabelled(e,this.strings,"_str")},e.prototype.emitHexLiteral=function(e){return this.emitLabelled(e,this.hexlits,"_hexlit")},e.prototype.setPerfCounters=function(e){if(!Tt.target.switches.profile)return[];var t=e.slice();return this.procs.forEach(function(e){e.perfCounterName&&(Tt.U.assert(Tt.target.switches.profile),e.perfCounterNo=t.length,t.push(e.perfCounterName))}),t},e}();function kr(e){if(!e.modifiers)return!1;if(e.parent.kind!=Tt.SK.Constructor)return!1;for(var t=0,r=e.modifiers;t<r.length;t++){var n=r[t];if(n.kind==Tt.SK.PrivateKeyword||n.kind==Tt.SK.PublicKeyword||n.kind==Tt.SK.ProtectedKeyword)return!0}return!1}function Sr(e){return e.flags&Tr.TypeFlags.Union?e.types.every(function(e){return Sr(e)}):!!(e.flags&(Tr.TypeFlags.NumberLike|Tr.TypeFlags.EnumLike|Tr.TypeFlags.BooleanLike))}Tt.Binary=xr,Tt.isCtorField=kr}(Tr.pxtc||(Tr.pxtc={}))}(ts||(ts={})),function(ts){var pxtc;!function(pxtc){function getTsCompilerOptions(e){var t=ts.getDefaultCompilerOptions();return t.target=ts.ScriptTarget.ES5,t.module=ts.ModuleKind.None,t.noImplicitAny=!0,t.noImplicitReturns=!0,t.allowUnreachableCode=!0,t}function nodeLocationInfo(e){var t=ts.getSourceFileOfNode(e),r=e.getStart?e.getStart():e.pos,n=ts.getLineAndCharacterOfPosition(t,r),i=n.line,a=n.character,s=ts.getLineAndCharacterOfPosition(t,e.end),o=s.line,l=s.character;return{start:r,length:e.end-r,line:i,column:a,endLine:o,endColumn:l,fileName:t.fileName}}function patchUpDiagnostics(e,t){void 0===t&&(t=!1),t&&(e=e.filter(function(e){return 5012!==e.code}));var r=e.filter(function(e){return 1148==e.code});return 0<r.length&&(e=r),e.map(function(e){if(!e.file)return{code:e.code,start:e.start,length:e.length,line:0,column:0,messageText:e.messageText,category:e.category,fileName:"?"};var t=ts.getLineAndCharacterOfPosition(e.file,e.start),r={code:e.code,start:e.start,length:e.length,line:t.line,column:t.character,messageText:e.messageText,category:e.category,fileName:e.file.fileName};return 1148==r.code&&(r.messageText=pxtc.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),r})}function py2tsIfNecessary(e){if(e.target.preferredEditor==pxt.PYTHON_PROJECT_NAME)return pxtc.transpile.pyToTs(e)}function mkCompileResult(){return{outfiles:{},diagnostics:[],success:!1,times:{}}}function storeGeneratedFiles(e,t){for(var r=0,n=e.generatedFiles||[];r<n.length;r++){var i=n[r];t.outfiles[i]=e.fileSystem[i]}}function runConversionsAndStoreResults(e,t){var r=pxtc.U.cpuUs();t||(t=mkCompileResult());var n=py2tsIfNecessary(e);n&&(t=__assign(__assign({},t),{diagnostics:n.diagnostics,sourceMap:n.sourceMap,globalNames:n.globalNames})),storeGeneratedFiles(e,t),e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));var i=e.sourceFiles.indexOf("main.ts");0<=i&&(e.sourceFiles.splice(i,1),e.sourceFiles.push("main.ts"));var a=e.sourceFiles.indexOf("_onCodeStop.ts");return 0<=a&&(e.sourceFiles.splice(a,1),e.sourceFiles.push("_onCodeStop.ts")),t.times.conversions=pxtc.U.cpuUs()-r,t}function timesToMs(e){for(var t=0,r=Object.keys(e.times);t<r.length;t++){var n=r[t];e.times[n]=Math.round(e.times[n])/1e3}}function buildProgram(e,i){var a={};for(var t in e.fileSystem)a[normalizePath(t)]=e.fileSystem[t];var r=getTsCompilerOptions(e),n={getSourceFile:function(e,t,r){e=normalizePath(e);var n="";return a.hasOwnProperty(e)?n=a[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:function(e){return e=normalizePath(e),a.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){i.outfiles[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=normalizePath(e),a[e]||""},directoryExists:function(e){return!0},getDirectories:function(){return[]}},s=e.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")});return ts.createProgram(s,r,n)}function isPxtModulesFilename(e){return pxtc.U.startsWith(e,"pxt_modules/")}function compile(opts,service){pxtc.compilerHooks||(pxtc.compilerHooks={},opts.target.compilerExtension&&eval(opts.target.compilerExtension)),pxtc.compilerHooks.init&&pxtc.compilerHooks.init(opts,service);var startTime=pxtc.U.cpuUs(),res=mkCompileResult(),program;if(service)storeGeneratedFiles(opts,res),program=service.getProgram();else{if(runConversionsAndStoreResults(opts,res),0<res.diagnostics.length)return res;program=buildProgram(opts,res)}var entryPoint=opts.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")}).pop().replace(/.*\//,"");if(res.diagnostics=patchUpDiagnostics(program.getSyntacticDiagnostics(),opts.ignoreFileResolutionErrors),0<res.diagnostics.length)return opts.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),pxtc.compileBinary(program,opts,res,entryPoint)),res;res.diagnostics=patchUpDiagnostics(program.getOptionsDiagnostics().concat(pxtc.Util.toArray(program.getGlobalDiagnostics())),opts.ignoreFileResolutionErrors);var semStart=pxtc.U.cpuUs();0==res.diagnostics.length&&(res.diagnostics=patchUpDiagnostics(program.getSemanticDiagnostics(),opts.ignoreFileResolutionErrors));var emitStart=pxtc.U.cpuUs();if(res.times["typescript-syn"]=semStart-startTime,res.times["typescript-sem"]=emitStart-semStart,res.times.typescript=emitStart-startTime,opts.ast&&(res.ast=program),opts.ast||opts.forceEmit||0==res.diagnostics.length){var binOutput=pxtc.compileBinary(program,opts,res,entryPoint);res.times.compilebinary=pxtc.U.cpuUs()-emitStart,res.diagnostics=res.diagnostics.concat(patchUpDiagnostics(binOutput.diagnostics))}0==res.diagnostics.length&&(res.success=!0);for(var _i=0,_a=opts.sourceFiles;_i<_a.length;_i++){var f=_a[_i];pxtc.Util.startsWith(f,"built/")&&(res.outfiles[f.slice(6)]=opts.fileSystem[f])}return res.times.all=pxtc.U.cpuUs()-startTime,pxt.tickEvent("compile",res.times),res}function decompile(e,t,r,n){void 0===n&&(n=!1);var i=e.getSourceFile(r);pxtc.annotate(e,r,pxtc.target||pxt.appTarget&&pxt.appTarget.compile);var a=pxtc.getApiInfo(e,t.jres),s=pxtc.getBlocksInfo(a,t.bannedCategories),o={snippetMode:t.snippetMode||!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:n,generateSourceMap:!!t.ast,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"]},l=pxtc.decompiler.buildRenameMap(e,i),u=l[0];l[1];return pxtc.decompiler.decompileToBlocks(s,i,o,u)}function getTSProgram(e,t){var i={},a={};for(var r in e.fileSystem)a[normalizePath(r)]=e.fileSystem[r];var n=getTsCompilerOptions(e),s={getSourceFile:function(e,t,r){e=normalizePath(e);var n="";return a.hasOwnProperty(e)?n=a[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:function(e){return e=normalizePath(e),a.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){i[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=normalizePath(e),a[e]||""},directoryExists:function(e){return!0},getDirectories:function(){return[]}};e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));var o=e.sourceFiles.filter(function(e){return pxtc.U.endsWith(e,".ts")}),l=o.filter(function(e){return"main.ts"!=e});o.length>l.length&&(o=l).push("main.ts");var u=o.indexOf("_onCodeStop.ts");0<=u&&(o.splice(u,1),o.push("_onCodeStop.ts"));var c=ts.createProgram(o,n,s,t);return pxtc.annotate(c,"main.ts",pxtc.target||pxt.appTarget&&pxt.appTarget.compile),c}function normalizePath(e){e=e.replace(/\\/g,"/");var t=[];return e.split("/").forEach(function(e){".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}pxtc.getTsCompilerOptions=getTsCompilerOptions,pxtc.nodeLocationInfo=nodeLocationInfo,pxtc.patchUpDiagnostics=patchUpDiagnostics,pxtc.py2tsIfNecessary=py2tsIfNecessary,pxtc.storeGeneratedFiles=storeGeneratedFiles,pxtc.runConversionsAndStoreResults=runConversionsAndStoreResults,pxtc.timesToMs=timesToMs,pxtc.isPxtModulesFilename=isPxtModulesFilename,pxtc.compile=compile,pxtc.decompile=decompile,pxtc.getTSProgram=getTSProgram}(pxtc=ts.pxtc||(ts.pxtc={}))}(ts||(ts={})),function(m){var e,h,g,v,b;e=m.elf||(m.elf={}),h=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],g=m.HF2.read32,v=m.HF2.read16,b=4096,e.parse=function(o){1179403647!=g(o,0)&&m.U.userError("no magic"),1!=o[4]&&m.U.userError("not 32 bit"),1!=o[5]&&m.U.userError("not little endian"),1!=o[6]&&m.U.userError("bad version"),2!=v(o,16)&&m.U.userError("wrong object type"),40!=v(o,18)&&m.U.userError("not ARM");var t=g(o,28);g(o,32),0==t&&m.U.userError("expecting program headers");for(var r=v(o,42),e=v(o,44),n=m.U.range(e).map(function(e){return function(e){for(var t={},r=e,n=0,i=h;n<i.length;n++){var a=i[n];t[a]=g(o,e),e+=4}var s=t;return s._filepos=r,s}(t+e*r)}),i=o.length+1;15&i;)i++;for(var a=0,s=0,l=n;s<l.length;s++)1==(d=l[s]).type&&(a=Math.max(a,d.vaddr+d.memsz));for(var u=(a+b-1&~(b-1))+(i&b-1),c=-1,p=0,f=n;p<f.length;p++){var d;4==(d=f[p]).type&&(c=d._filepos)}return{imageMemStart:u,imageFileStart:i,phOffset:c,template:o}},e.patch=function(e,t){var r=new Uint8Array(e.imageFileStart+t.length);return r.fill(0),m.U.memcpy(r,0,e.template),m.U.memcpy(r,e.imageFileStart,t),function(e,t){for(var r=t._filepos,n=0,i=h;n<i.length;n++){var a=i[n];m.HF2.write32(e,r,t[a]||0),r+=4}}(r,{_filepos:e.phOffset,type:1,offset:e.imageFileStart,vaddr:e.imageMemStart,paddr:e.imageMemStart,filesz:t.length,memsz:t.length,flags:5,align:b}),r}}(pxt||(pxt={})),function(g){!function(v){var b,e;(e=b||(b={}))[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF";var y=g.SyntaxKind;function x(e){switch(e){case y.CommaToken:return 2;case y.EqualsToken:case y.PlusEqualsToken:case y.MinusEqualsToken:case y.AsteriskEqualsToken:case y.AsteriskAsteriskEqualsToken:case y.SlashEqualsToken:case y.PercentEqualsToken:case y.LessThanLessThanEqualsToken:case y.GreaterThanGreaterThanEqualsToken:case y.GreaterThanGreaterThanGreaterThanEqualsToken:case y.AmpersandEqualsToken:case y.BarEqualsToken:case y.CaretEqualsToken:return 5;case y.QuestionToken:case y.ColonToken:return 7;case y.BarBarToken:return 10;case y.AmpersandAmpersandToken:return 20;case y.BarToken:return 30;case y.CaretToken:return 40;case y.AmpersandToken:return 50;case y.EqualsEqualsToken:case y.ExclamationEqualsToken:case y.EqualsEqualsEqualsToken:case y.ExclamationEqualsEqualsToken:return 60;case y.LessThanToken:case y.GreaterThanToken:case y.LessThanEqualsToken:case y.GreaterThanEqualsToken:case y.InstanceOfKeyword:case y.InKeyword:case y.AsKeyword:return 70;case y.LessThanLessThanToken:case y.GreaterThanGreaterThanToken:case y.GreaterThanGreaterThanGreaterThanToken:return 80;case y.PlusToken:case y.MinusToken:return 90;case y.AsteriskToken:case y.SlashToken:case y.PercentToken:return 100;case y.AsteriskAsteriskToken:return 101;case y.DotToken:return 120;default:return 0}}function f(e){switch(e){case y.EndOfFileToken:return b.EOF;case y.SingleLineCommentTrivia:return b.CommentLine;case y.MultiLineCommentTrivia:return b.CommentBlock;case y.NewLineTrivia:return b.NewLine;case y.WhitespaceTrivia:return b.Whitespace;case y.ShebangTrivia:case y.ConflictMarkerTrivia:return b.CommentBlock;case y.NumericLiteral:case y.StringLiteral:case y.RegularExpressionLiteral:case y.NoSubstitutionTemplateLiteral:case y.TemplateHead:case y.TemplateMiddle:case y.TemplateTail:return b.Literal;case y.Identifier:return b.Identifier;default:return e<y.Identifier?b.Operator:b.Keyword}}var d=!1;function m(e,t){for(;e[t]&&e[t].kind==b.Whitespace;)t++;return t}function k(){return{kind:b.EOF,synKind:y.EndOfFileToken,pos:0,lineNo:0,text:""}}function S(e,t){return{kind:b.Whitespace,synKind:y.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function T(e){if(!e)return!1;switch(e.synKind){case y.IfKeyword:case y.ElseKeyword:case y.LetKeyword:case y.ConstKeyword:case y.VarKeyword:case y.DoKeyword:case y.WhileKeyword:case y.SwitchKeyword:case y.CaseKeyword:case y.DefaultKeyword:case y.ForKeyword:case y.ReturnKeyword:case y.BreakKeyword:case y.ContinueKeyword:case y.TryKeyword:case y.CatchKeyword:case y.FinallyKeyword:case y.DeleteKeyword:case y.FunctionKeyword:case y.ClassKeyword:case y.YieldKeyword:case y.DebuggerKeyword:return!0;default:return!1}}function w(a,s,o){void 0===o&&(o=null);var l,n=[],u=0,c=!1;for(a=a.concat([k()]);a[u].kind!=b.EOF;){var e=u;g(),v.Util.assert(e<u,"Error at "+a[u].text),t(a.slice(e,u))}return n;function t(e){if(s&&(e=I(e)),0!=e.length){e.forEach(i),e=function e(t){var r=[];var n=0;for(;n<t.length;)if(t[n].blockSpanLength){var i=t.slice(n,n+t[n].blockSpanLength),a=!!i[0].blockSpanIsVirtual;delete i[0].blockSpanLength,delete i[0].blockSpanIsVirtual,n+=i.length,i=e(i),a?r.push((o=i,{kind:b.Tree,synKind:y.WhitespaceTrivia,pos:o[0].pos,lineNo:o[0].lineNo,children:o,endToken:null,text:""})):(r.push(S(i[0]," ")),r.push((s=I(i),{kind:b.Block,synKind:y.OpenBraceToken,pos:s[0].pos,lineNo:s[0].lineNo,stmts:[{tokens:s}],text:"{",endToken:null})))}else r.push(t[n++]);var s;var o;return r}(e);if(s&&0<n.length){var t=n[n.length-1].tokens[0].synKind,r=e[0].synKind;if(t==y.IfKeyword&&r==y.ElseKeyword||t==y.TryKeyword&&r==y.CatchKeyword||t==y.TryKeyword&&r==y.FinallyKeyword||t==y.CatchKeyword&&r==y.FinallyKeyword)return e.unshift(S(e[0]," ")),void v.Util.pushRange(n[n.length-1].tokens,e)}n.push({tokens:e})}}function i(e){if(e.kind==b.Tree){var t=e;t.children=v.Util.concat(w(t.children,!1,t).map(function(e){return e.tokens}))}}function p(e){for(void 0===e&&(e=!1);;)switch(a[++u].kind){case b.Whitespace:case b.CommentBlock:case b.CommentLine:break;case b.NewLine:if(e)break;break;default:return}}function f(){for(;a[u].kind==b.Whitespace;)u++;a[u].kind==b.NewLine&&u++}function d(){for(;;)switch(a[++u].kind){case b.EOF:return;case b.Tree:if(a[u].synKind==y.OpenBraceToken)return u--,void h()}}function m(){v.Util.assert(a[u].synKind==y.OpenBraceToken);var e=a[u];v.Util.assert(e.kind==b.Tree);var t=a[u];t.stmts=w(e.children,!0,l),delete e.children,t.kind=b.Block,u++,c=!0}function h(){var e=u+1;p(),a[u].synKind==y.OpenBraceToken?(m(),f()):(g(),a[e].blockSpanLength=u-e)}function g(){for(;;){var e=a[u],t=u;if(c=!1,(l=e).kind==b.EOF)return;if(s&&e.synKind==y.SemicolonToken)return u++,void f();if(e.synKind==y.EqualsGreaterThanToken){if(p(),a[u].synKind==y.OpenBraceToken){m();continue}var r=u;g();for(var n=u;a[n].kind==b.NewLine;)n--;return a[r].blockSpanLength=n-r,void(a[r].blockSpanIsVirtual=!0)}if(s&&x(e.synKind)){r=u;if(p(),!T(a[u]))continue;u=r}if(s&&e.kind==b.NewLine){if(p(),x((e=a[u]).synKind)&&e.synKind!=y.PlusToken&&e.synKind!=y.MinusToken)continue;return void(u=t+1)}if(e.synKind==y.OpenBraceToken&&o&&o.synKind==y.ClassKeyword){for(var i=u-1;0<=i&&a[i].kind==b.Whitespace;)i--;if(i<0||a[i].synKind!=y.EqualsToken)return u--,void h()}switch(v.Util.assert(t==u),e.synKind){case y.ForKeyword:case y.WhileKeyword:case y.IfKeyword:case y.CatchKeyword:if(p(),a[u].synKind!=y.OpenParenToken)continue;return void h();case y.DoKeyword:if(h(),u--,p(),a[u].synKind==y.WhileKeyword){u++;continue}return;case y.ElseKeyword:if(p(),a[u].synKind==y.IfKeyword)continue;return u=t,void h();case y.TryKeyword:case y.FinallyKeyword:return void h();case y.ClassKeyword:case y.NamespaceKeyword:case y.ModuleKeyword:case y.InterfaceKeyword:case y.FunctionKeyword:return void d()}v.Util.assert(!c,"forgot continue/return after expectBlock"),u++}}}function t(e){return e&&(e.kind==b.Whitespace||e.kind==b.NewLine)}function h(e){for(var t=[],r=!1,n=0;n<e.length;++n)r&&(n=m(e,n)),e[n]&&(t.push(e[n]),r=e[n].kind==b.NewLine);return t}function I(e){for(e=e.slice(0);t(e[0]);)e.shift();for(;t(e[e.length-1]);)e.pop();return e}v.toStr=function e(t){return Array.isArray(t)?"[[ "+t.map(e).join("  ")+" ]]":"string"==typeof t.text?JSON.stringify(t.text):t+""},v.format=function(e,t){var r=function(e){e;for(var r=g.createScanner(g.ScriptTarget.Latest,!1,g.LanguageVariant.Standard,e,function(e){var t=r.getTextPos();console.log("scanner error",t,e.message)}),t=[],n=0,i=-1;;){var a=r.scan();if(a==y.CloseBraceToken&&n==i&&(i=-1,a=r.reScanTemplateToken()),d&&a==y.SlashToken||a==y.SlashEqualsToken){var s=r.reScanSlashToken();s==y.RegularExpressionLiteral&&(a=s)}a==y.GreaterThanToken&&(a=r.reScanGreaterToken());var o={kind:f(a),synKind:a,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(a==y.OpenBraceToken&&n++,a==y.CloseBraceToken&&--n<0&&(n=-1e7),t.push(o),a!=y.TemplateHead&&a!=y.TemplateMiddle||(i=n),o.kind==b.EOF)break}return{tokens:t,braceBalance:n}}(e).tokens,n=w(r=function(e){var t=[];t.push({synKind:y.EndOfFileToken,token:{children:[]}});for(var r,n,i,a=0;a<e.length;++a){var s=e[a],o=t[t.length-1];switch(o.token.children.push(s),s.kind){case b.Operator:switch(s.synKind){case y.OpenBraceToken:case y.OpenParenToken:case y.OpenBracketToken:n=(r=s).synKind+1,i=void 0,(i=r).children=[],i.kind=b.Tree,t.push({synKind:n,token:i});break;case y.CloseBraceToken:case y.CloseParenToken:case y.CloseBracketToken:for(o.token.children.pop();;){if((o=t.pop()).synKind==s.synKind){o.token.endToken=s;break}if(0==t.length||o.synKind==y.CloseBraceToken){t.push(o);break}}}}}return t[0].token.children}(r=function(e,t){for(var r=[],n=!0,i=1,a=0;a<e.length;++a){if(n){var s=a;if(e[a=m(e,a)].kind==b.NewLine){var o=!1;0<=t&&e[a].pos>=t&&(t=-1,o=!0),r.push({text:"",kind:b.CommentLine,pos:e[a].pos,lineNo:i,synKind:y.SingleLineCommentTrivia,isCursor:o})}else a=s}r.push(e[a]),e[a].lineNo=i,e[a].kind==b.NewLine?(n=!0,i++):n=!1,0<=t&&e[a].pos>=t&&(t=-1)}return r}(r,t)),!0),s="",o="",i=-1,a=0;return n.forEach(c),n.forEach(function(e){return e.tokens.forEach(l)}),-1==i&&(i=o.length),{formatted:o,pos:i};function l(e){if(e.kind==b.Tree){var t=e;e.synKind,y.OpenBraceToken,t.children.forEach(l)}else e.kind==b.Block&&e.stmts.forEach(function(e){return e.tokens.forEach(l)})}function u(e,t){if(a==e.lineNo)t();else{a=e.lineNo;var r=s;s+="    ",t(),s=r}}function c(e){var t=h(e.tokens);1!=t.length||t[0].isCursor||""!=t[0].text?(o+=s,u(t[0],function(){!function i(a){a=function(e){var t,r=[],n=0,i=k();for(e=e.concat([k()]);n<e.length;){var a=e[n=m(e,n)];if(a.kind==b.EOF)break;var s=m(e,n+1);if(a.kind!=b.NewLine||e[s].synKind!=y.OpenBraceToken){var o=!0,l=0==r.length?(t=a,{kind:b.NewLine,synKind:y.NewLineTrivia,pos:t.pos,lineNo:t.lineNo,text:"\n"}):r[r.length-1];switch(l.synKind){case y.ExclamationToken:case y.TildeToken:case y.DotToken:o=!1;break;case y.PlusToken:case y.MinusToken:case y.PlusPlusToken:case y.MinusMinusToken:l.isPrefix&&(o=!1)}switch(a.synKind){case y.DotToken:case y.CommaToken:case y.NewLineTrivia:case y.ColonToken:case y.SemicolonToken:case y.OpenBracketToken:o=!1;break;case y.PlusPlusToken:case y.MinusMinusToken:l.kind!=b.Tree&&l.kind!=b.Identifier&&l.kind!=b.Keyword||(o=!1);case y.PlusToken:case y.MinusToken:(i.kind==b.EOF||x(i.synKind)||i.synKind==y.SemicolonToken)&&(a.isPrefix=!0);break;case y.OpenParenToken:if(l.kind==b.Identifier&&(o=!1),l.kind==b.Keyword)switch(l.synKind){case y.IfKeyword:case y.ForKeyword:case y.WhileKeyword:case y.SwitchKeyword:case y.ReturnKeyword:case y.ThrowKeyword:case y.CatchKeyword:break;default:o=!1}}l.kind==b.NewLine&&(o=!1),o&&r.push(S(a," ")),r.push(a),a.kind!=b.NewLine&&(i=a),n++}else n=s}return r}(a);for(var e=function(e){var t=a[e];switch(function(e,t){if(t.synKind==y.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(t.text)){var r=t.text.slice(1,t.text.length-1).split("\n").map(function(e){return e.replace(/\s/g,"")}).filter(function(e){return!!e});if(r.length<4||5<r.length)return;var n=Math.floor((Math.max.apply(Math,r.map(function(e){return e.length}))+2)/5);n<=0&&(n=1);for(var i="`\n",a=0;a<5;++a){for(var s=r[a]||"";s.length<5*n;)s+=".";i+=e+(s=(s=(s=s.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,function(e){return"/"+e})).replace(/./g,function(e){return" "+e}).replace(/\//g," ").slice(3)+"\n"}i+=e+"`",t.text=i}}(s,t),p(t),t.kind){case b.Tree:var r=t;u(t,function(){i(h(r.children))}),r.endToken&&p(r.endToken);break;case b.Block:var n=t;0==n.stmts.length?o+=" ":(o+="\n",n.stmts.forEach(c),o+=s.slice(4)),n.endToken?p(n.endToken):o+="}";break;case b.NewLine:if(a[e+1]&&a[e+1].kind==b.CommentLine&&""==a[e+1].text&&!a[e+1].isCursor)break;e==a.length-1?o+=s.slice(4):o+=s;break;case b.Whitespace:}},t=0;t<a.length;++t)e(t)}(t)}),"\n"!=o[o.length-1]&&(o+="\n")):o+="\n"}function p(e){-1==i&&e.pos+e.text.length>=t&&(i=o.length+(t-e.pos)),o+=e.text}}}(g.pxtc||(g.pxtc={}))}(ts||(ts={})),function(R){!function(D){var M;!function(l){var t=1024;l.asmTotalSource="";var u={},x=[];var E={commBase:0,funcInfo:{},codeStartIdx:-1,codePaddingSize:0,sha:null,codeStartAddrPadded:void 0,hexlines:void 0,jmpStartAddr:void 0,jmpStartIdx:void 0,codeStartAddr:void 0,elfInfo:void 0};function N(e){for(var t="",r=0;r<e.length;r+=2)t=e[r]+e[r+1]+t;return D.assert(r==e.length),t}function k(e){if(!(e=e.replace(/^[\s:]/,"")))return[];var t=[];if(e.replace(/([a-f0-9][a-f0-9])/gi,function(e){return t.push(parseInt(e,16)),""}))throw D.oops("bad bytes "+e);return t}function S(e){return e.flashCodeAlign||t}function c(e){return E.funcInfo[e]}function a(e){if("_pxt_comm_base"==e)return E.commBase;var t=c(e);return t?t.value:null}function _(){for(var e=E.sha?E.sha.slice(0,16):"";e.length<16;)e+="0";return e.toUpperCase()}function K(e){var t=0,r=":";return e.forEach(function(e){return t+=e}),e.push(255&-t),e.forEach(function(e){return r+=("0"+e.toString(16)).slice(-2)}),r.toUpperCase()}function A(e){if(D.assert(4==[254,255,1,0].length),64==e[0]&&80==e[1]&&88==e[2]&&84==e[3]||D.oops(),58==e[5]){var t=!1;if(64==e[4])t=!0;else{if(35!=e[4])return null;!0}var r=a(t?"pxt::string_inline_ascii_vt":"pxt::buffer_vt"),n=new Uint8Array(6);r||D.oops("missing vt: "+t),3&(r^=1)&&D.oops("Unaligned vt: "+r),pxt.HF2.write32(n,0,r);var i=0;if(t)for(;6+i<e.length&&0!=e[6+i];)i++;return 6+i>=e.length&&D.U.oops("constant string too long!"),pxt.HF2.write16(n,4,i),n}return null}function C(n,r){void 0===r&&(r=null);var i=function(e,t,r){return 64==e[t]&&80==e[t+1]&&88==e[t+2]&&84==e[t+3]?A(r()):null};if(r)for(var e=function(e){var t=i(r,e,function(){return r.slice(e,e+200)});t&&D.U.memcpy(r,e,t)},t=0;t<r.length-8;t+=4)e(t);else for(var a=0;a<n.blocks.length;++a){var s=n.blocks[a],o=n.ptrs[a]<<8,l=function(e){var t=o+e-32,r=i(s,e,function(){return D.UF2.readBytesFromFile(n,t,200)});r&&D.UF2.writeBytes(n,t,r)};for(t=32;t<288;t+=4)l(t)}}function U(e,t,r,n){for(var i=0;i<n.length;){var a=k(e[t]);if(a.pop(),0==a[3]){for(var s=4+r,o=a.length-s,l=0;l<o;++l)i<n.length&&(a[s++]=n[i++]);e[t]=K(a)}t++,r=0}}function P(e,t,r,n){for(var i=[];i.length<n;){var a=k(e[t]);if(a.pop(),0==a[3]){var s=a.slice(4+r);D.U.pushRange(i,s)}t++,r=0}return i}l.getCommBase=function(){return E.commBase},l.getStartAddress=function(){return E.codeStartAddrPadded},l.setupInlineAssembly=function(e){u={};var t=e.sourceFiles.filter(function(e){return D.U.endsWith(e,".asm")});l.asmTotalSource="";for(var r=0,n=0,i=t;n<i.length;n++){var a=i[n],s=e.fileSystem[a];s.replace(/^\s*(\w+):/gm,function(e,t){return u[t]=!0,""});var o=".section code\n@stackmark func\n@scope user"+r+++"\n"+s+"\n@stackempty func\n@scope\n";l.asmTotalSource+=o}},l.parseHexBytes=k,l.parseHexRecord=function(e){var t=k(e);return{len:t[0],addr:t[1]<<8|t[2],type:t[3],data:t.slice(4,t.length-1),checksum:t[t.length-1]}},l.flashCodeAlign=S,l.setupFor=function(o,t){if(!(E=x.find(function(e){return e.sha==t.sha}))){E={commBase:0,funcInfo:{},codeStartIdx:-1,codePaddingSize:0,sha:null,codeStartAddrPadded:void 0,hexlines:void 0,jmpStartAddr:void 0,jmpStartIdx:void 0,codeStartAddr:void 0,elfInfo:void 0},10<x.length&&(x=[]),x.push(E);var a=t.functions;E.commBase=t.commBase||0,E.sha=t.sha;var l=t.hexinfo.hex;if(E.hexlines=l,D.target.nativeType!=D.NATIVE_TYPE_VM){if(l.length<=2){var e=D.U.fromHex(l[0]);if(e[2]<=2&&96==e[3]){var r=e.length+4096-1&-4096;E.elfInfo={template:e,imageMemStart:1610612736+r,imageFileStart:r,phOffset:-1e3}}else E.elfInfo=pxt.elf.parse(e);E.codeStartAddr=E.elfInfo.imageMemStart,E.codeStartAddrPadded=E.elfInfo.imageMemStart;var n=l[0].indexOf("0108010842424242010801083ed8e98d");return n<0&&D.oops("no jmp table in elf"),E.jmpStartAddr=n/2,E.jmpStartIdx=-1,b(l[0].slice(n+32,n+32+8*a.length+16)),void y()}!function(e){for(var t=0;t<e.length;++t)if("2"==e[t][8]){var r=/^:02....02(....)..$/.exec(e[t]);D.U.assert(!!r);var n=16*parseInt(r[1],16);D.U.assert(0==(65535&n)),e[t]=K([2,0,0,4,0,n>>16])}}(l);var i=0,s="0000",u=0,c=0;E.codeStartAddr=0;for(var p=function(){if(!E.codeStartAddr){var e=k(l[c]),t=16-(u+e[0]&15)&15;if(t)if(15&e[2]){for(var r=u+e[0],n=[t,r>>8,255&r,0],i=0;i<t;++i)n.push(0);c++,l.splice(c,0,K(n)),E.codeStartAddr=r+t}else{if(16!=e[0]){for(e.pop(),e[0]=16;e.length<20;)e.push(0);l[c]=K(e)}E.codeStartAddr=u+16}else E.codeStartAddr=u+e[0];E.codeStartIdx=c+1;var a=S(o);E.codeStartAddrPadded=(E.codeStartAddr&~(a-1))+a;var s=E.codeStartAddrPadded-E.codeStartAddr;D.assert(0==(15&s)),E.codePaddingSize=s}};i<l.length;++i){if((m=/:02000004(....)/.exec(l[i]))&&(s=m[1]),m=/^:..(....)00/.exec(l[i])){var f=parseInt(s+m[1],16);!o.flashUsableEnd&&u&&65536<f-u&&p(),o.flashUsableEnd&&f>=o.flashUsableEnd&&p(),c=i,u=f}/^:00000001/.test(l[i])&&p(),(m=/^:10....000108010842424242010801083ED8E98D/.exec(l[i]))&&(E.jmpStartAddr=u,E.jmpStartIdx=i)}pxt.debug("code start: "+E.codeStartAddrPadded+", jmptbl: "+E.jmpStartAddr),E.jmpStartAddr||D.oops("No hex start"),E.codeStartAddr||D.oops("No hex end"),E.funcInfo={};for(var d=E.jmpStartIdx+1;d<l.length;++d){var m;if((m=/^:..(....)00(.{4,})/.exec(l[d]))&&(b(m[2]),0==a.length))break}return void y()}E.codeStartAddr=0,E.codeStartAddrPadded=0,E.jmpStartAddr=-1,E.jmpStartIdx=-1;for(var h=0,g=a;h<g.length;h++){var v=g[h];(E.funcInfo[v.name]=v).value=16777215}}function b(e){for(var t=o.shortPointers?4:8;e.length>=t;){var r=e.slice(0,t),n=parseInt(N(r),16);e=e.slice(t);var i=a.shift();if(!i)break;E.funcInfo[i.name]=i,n||D.U.oops("No value for "+i.name+" / "+r),0==i.argsFmt.length?n^=1:o.runtimeIsARM||o.nativeType!=D.NATIVE_TYPE_THUMB||1&n||D.U.oops("Non-thumb addr for "+i.name+" / "+r),i.value=n}}function y(){a.length&&D.oops("premature EOF in hex file; missing: "+a.map(function(e){return e.name}).join(", "))}},l.validateShim=function(e,t,r,n,i){if("TD_ID"!=t&&"TD_NOOP"!=t&&"ENUM_GET"!=t&&!D.U.lookup(u,t)){var a=e+"(...) (shim="+t+")",s=c(t);if(s){n?"V"==s.argsFmt[0]&&D.U.userError("expecting function for "+a):"V"!=s.argsFmt[0]&&D.U.userError("expecting procedure for "+a);for(var o=0;o<i.length;++o)s.argsFmt[o+1]||D.U.userError("excessive parameters passed to "+a);i.length!=s.argsFmt.length-1&&D.U.userError("not enough arguments for "+a+" (got "+i.length+"; fmt="+s.argsFmt.join(",")+")")}else D.U.userError("function not found: "+a)}},l.lookupFunc=c,l.lookupFunctionAddr=a,l.hexTemplateHash=_,l.hexPrelude=function(){return"    .startaddr 0x"+E.codeStartAddrPadded.toString(16)+"\n"},l.hexBytes=K,l.patchHex=function(e,t,r,n){var i=E.hexlines.slice(0,E.codeStartIdx),a=2*t.length+7>>3;D.assert(a<64e3,"program too large, bytes: "+2*t.length),t[17]=a,t[20]=e.commSize;for(var s=[],o=0;o<E.codePaddingSize>>1;++o)s.push(0);t=s.concat(t);var l=0;function u(e,t){for(var r=[16,t>>8&255,255&t,0],n=0;n<8;++n)r.push(255&(e[l]||0)),r.push((e[l]||0)>>>8),l++;return r}var c=[16912,0,65535&E.codeStartAddrPadded,E.codeStartAddrPadded>>>16],p=_();for(o=0;o<4;++o)c.push(parseInt(N(p.slice(4*o,4*o+4)),16));var f=n?D.UF2.newBlockFile(D.target.uf2Family):null;if(E.elfInfo){var d=new Uint8Array(2*t.length);for(o=0;o<t.length;++o)pxt.HF2.write16(d,2*o,t[o]);var m=pxt.elf.patch(E.elfInfo,d);for(o=0;o<c.length;++o)pxt.HF2.write16(m,2*o+E.jmpStartAddr,c[o]);if(C(null,m),f&&!e.target.switches.rawELF){var h=e.options.name||"pxt";return h=h.replace(/[^a-zA-Z0-9\-\.]+/g,"_"),f.filename="Projects/"+h+".elf",D.UF2.writeBytes(f,0,m),[D.UF2.serializeFile(f)]}return[D.U.uint8ArrayToString(m)]}if(f){if(D.UF2.writeHex(f,i),C(f),D.UF2.writeBytes(f,E.jmpStartAddr,u(c,E.jmpStartIdx).slice(4)),e.checksumBlock){for(var g=[],v=0,b=e.checksumBlock;v<b.length;v++){var y=b[v];g.push(255&y,y>>8)}D.UF2.writeBytes(f,e.target.flashChecksumAddr,g)}}else!function(e){for(var t=0;t<e.length;++t)for(var r=0;r<4;++r){var n=e[t].indexOf("40505854");if(!(0<n))break;var i=n-9>>1,a=A(P(e,t,i,200));a&&U(e,t,i,a)}}(i),i[E.jmpStartIdx]=K(u(c,E.jmpStartAddr)),e.checksumBlock&&D.U.oops("checksum block in HEX not implemented yet");l=0,r&&(i=[]);for(var x=E.codeStartAddr,k=x-16>>16;l<t.length;)f?D.UF2.writeBytes(f,x,u(t,x).slice(4)):(x>>16!=k&&(k=x>>16,i.push(K([2,0,0,4,k>>8,255&k]))),i.push(K(u(t,x)))),x+=16;if(!r){var S=E.hexlines.slice(E.codeStartIdx);f?D.UF2.writeHex(f,S):D.Util.pushRange(i,S)}if(e.packedSource)if(f){x=f.currPtr+4096&-256;for(var T=new Uint8Array(256),w=0;w<e.packedSource.length;w+=256){for(o=0;o<256;++o)T[o]=e.packedSource.charCodeAt(w+o);D.UF2.writeBytes(f,x,T,D.UF2.UF2_FLAG_NOFLASH),x+=256}}else for(o=x=0;o<e.packedSource.length;o+=16){g=[16,x>>8&255,255&x,14];for(var I=0;I<16;++I)g.push(255&(e.packedSource.charCodeAt(o+I)||0));i.push(K(g)),x+=16}return f?[D.UF2.serializeFile(f)]:i}}(M=D.hexfile||(D.hexfile={})),D.hexDump=function(e,t){function r(e,t){void 0===t&&(t=8);for(var r=e.toString(16);r.length<t;)r="0"+r;return r}void 0===t&&(t=0);for(var n="",i=0;i<e.length;i+=16){n+=r(t+i)+": ";for(var a="",s=0;s<16;s++){0==(3&s)&&(n+=" ");var o=e[i+s];null!=o?(n+=r(o,2)+" ",a+=32<=o&&o<127?String.fromCharCode(o):"."):n+="   "}n+=" "+a+"\n"}return n},D.asmline=function(e){return 0<=e.indexOf("\n")?(e=e.replace(/^\s*/gm,"").replace(/^(.*)$/gm,function(e,t){return";"==t[0]&&" "==t[1]||/:\*$/.test(t)?t:"    "+t}))+"\n":(/(^[\s;])|(:$)/.test(e)||(e="    "+e),e+"\n")},D.firstMethodOffset=function(){return 9};var b=[21078089,22513679,15655169,18636881,19658081,21486649,21919277,20041213,20548751,16180187,18361627,19338023,19772677,16506547,23530697,22998697,21225203,19815283,23679599,19822889,21136133,19540043,21837031,18095489,23924267,23434627,22582379,21584111,22615171,23403001,19640683,19998031,18460439,20105387,17595791,16482043,23199959,18881641,21578371,22765747,20170273,16547639,16434589,21435019,20226751,19506731,21454393,23224541,23431973,23745511];function x(e){var t=32;D.U.assert(D.U.unique(e,function(e){return""+e}).length==e.length,"non unique");for(var r=2;;r<<=1)if(t--,!(r<e.length)){for(var n=-1,i=-1,a=void 0,s=0,o=b;s<o.length;s++){var l=o[s]<<8|t,u=new Uint16Array(r+D.vtLookups+1);D.U.assert(0==(1&u.length));for(var c=0,p=[],f=0,d=e;f<d.length;f++){var m=d[f];D.U.assert(0<m);var h=Math.imul(m,l)>>>t;p.push(h);for(var g=!1,v=0;v<D.vtLookups;v++){if(!u[h+v]){g=!0,u[h+v]=m;break}c++}if(!g){c=-1;break}}(-1==n||c<n)&&(n=c,i=l,a=u)}if(0<=n)return{mult:i,mapping:a,size:r}}}function h(e,t,r){var n=x(e.itable.map(function(e){return e.idx})),i=D.target.shortPointers?".short":".word",a="\n        .balign 4\n"+e.id+"_VT:\n        .short "+(4*e.allfields.length+4)+"  ; size in bytes\n        .byte "+pxt.ValTypeObject+", "+pxt.VTABLE_MAGIC+" ; magic\n        "+i+" "+e.id+"_IfaceVT\n        .short "+e.classNo+" ; class-id\n        .short 0 ; reserved\n        .word "+n.mult+" ; hash-mult\n",s=function(e){"0"!=e&&(e+="@fn"),a+="        "+i+" "+e+"\n"};s("pxt::RefRecord_destroy"),s("pxt::RefRecord_print"),s("pxt::RefRecord_scan"),s("pxt::RefRecord_gcsize");var o=e.toStringMethod;s(o?o.vtLabel():"0");for(var l=0,u=e.vtable;l<u.length;l++){s(u[l].label()+"_nochk")}a+="\n        .balign "+(D.target.shortPointers?2:4)+"\n"+e.id+"_IfaceVT:\n";for(var c=2*n.mapping.length,p="",f=c,d={},m=0,h=e.itable;m<h.length;m++){var g=h[m];d[g.idx+""]=f;var v=g.proc?g.proc.isGetter()?1:2:0;p+="  .short "+g.idx+", "+v+" ; "+g.name+"\n",p+="  .word "+(g.proc?g.proc.vtLabel()+"@fn":g.info)+"\n",f+=8,g.setProc&&(p+="  .short "+g.idx+", 0 ; set "+g.name+"\n",p+="  .word "+g.setProc.vtLabel()+"@fn\n",f+=8)}p+="  .word 0, 0 ; the end\n",f+=8;for(var b=n.mapping,y=0;y<b.length;++y)r.itEntries++,b[y]&&r.itFullEntries++;return a+="  .short "+D.U.toArray(b).map(function(e,t){return(d[e+""]||c)-2*t}).join(", ")+"\n",a+=p,a+="\n"}D.vtLookups=3,D.computeHashMultiplier=x,D.vtableToAsm=h;var g=["GC"];function c(r,e){var n="\n    .short "+r.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of 64 bit words resulting from assembly\n    .word _pxt_config_data\n    .short 0 ; patched with comm section size\n    .short "+r.nonPtrGlobals+" ; number of globals that are not pointers (they come first)\n    .word _pxt_iface_member_names\n    .word _pxt_lambda_trampoline@fn\n    .word _pxt_perf_counters\n    .word _pxt_restore_exception_state@fn\n    .word "+r.emitString(r.getTitle())+" ; name\n",i=null;i=new D.ThumbSnippets;var t=r.setPerfCounters(g);r.procs.forEach(function(e){var t=new D.ProctoAssembler(i,r,e);n+="\n"+t.getAssembly()+"\n"});var a=new D.ProctoAssembler(i,r,null);a.emitHelpers(),n+="\n"+a.getAssembly()+"\n",n+=M.asmTotalSource,n+="_code_end:\n\n",D.U.iterMap(r.codeHelpers,function(e,t){n+="    .section code\n"+t+":\n"+e+"\n"}),n+=i.arithmetic(),n+="_helpers_end:\n\n",r.usedClassInfos.forEach(function(e){n+=h(e,0,r)}),n+="\n.balign 4\n_pxt_iface_member_names:\n",n+="    .word "+r.ifaceMembers.length+"\n";for(var s=0,o=0,l=r.ifaceMembers;o<l.length;o++){var u=l[o],c=r.emitString(u);n+="    .word "+c+"  ; "+s+++" ."+u+"\n"}n+="    .word 0\n",n+="_vtables_end:\n\n",n+="\n.balign 4\n_pxt_config_data:\n";for(var p=0,f=r.res.configData||[];p<f.length;p++){u=f[p];n+="    .word "+u.key+", "+u.value+"  ; "+u.name+"="+u.value+"\n"}n+="    .word 0\n\n",function(e,t){for(var r=0,n=D.U.unique(t.ifaceMembers.concat(Object.keys(t.strings)),function(e){return e});r<n.length;r++){var i=n[r];t.otherLiterals.push(e.string_literal(t.strings[i],i))}for(var a=0,s=Object.keys(t.doubles);a<s.length;a++){var o=s[a],l=t.doubles[o];t.otherLiterals.push("\n.balign 4\n"+l+": "+e.obj_header("pxt::number_vt")+"\n        .hex "+o+"\n")}for(var u=0,c=Object.keys(t.hexlits);u<c.length;u++)o=c[u],t.otherLiterals.push(e.hex_literal(t.hexlits[o],o)),t.otherLiterals.push()}(i,r),n+=r.otherLiterals.join(""),n+="\n.balign 4\n.section code\n_pxt_perf_counters:\n",n+="    .word "+t.length+"\n";for(var d="",m=0;m<t.length;++m){n+="    .word "+(c=".perf"+m)+"\n",d+=c+": .string "+JSON.stringify(t[m])+"\n"}return n+=d,n+="_literals_end:\n"}function a(e){var t;return(t=e.nativeType==D.NATIVE_TYPE_VM?new D.assembler.VMFile(new D.vm.VmProcessor(e)):new D.assembler.File(new D.thumb.ThumbProcessor)).ei.testAssembler(),e.switches.noPeepHole&&(t.disablePeepHole=!0),t.lookupExternalLabel=M.lookupFunctionAddr,t.normalizeExternalLabel=function(e){var t=M.lookupFunc(e);return t?t.name:e},t}function s(e){if(0<e.errors.length){var r="";throw e.errors.forEach(function(e){var t=/^user(\d+)/.exec(e.scope);if(t){parseInt(t[1]);r+=D.U.lf("At inline assembly:\n"),r+=e.message}}),r&&(console.log(D.U.lf("errors in inline assembly")),console.log(r)),new Error(e.errors[0].message)}}var i=!(D.processorInlineAssemble=function(e,t){var r=a(e);r.disablePeepHole=!0,r.emit(t),s(r);for(var n=[],i=0;i<r.buf.length;i+=2)n.push(((r.buf[i+1]||0)<<16|r.buf[i])>>>0);return n});function B(e,t,r){var n=a(e);return n.emit(r),r="; Interface tables: "+t.itFullEntries+"/"+t.itEntries+" ("+Math.round(100*t.itFullEntries/t.itEntries)+"%)\n; Virtual methods: "+t.numVirtMethods+" / "+t.numMethods+"\n"+n.getSource(!i,t.numStmts,e.flashEnd),s(n),{src:r,buf:n.buf,thumbFile:n}}function p(e,t,r,n){var i,a,s,o,l=r.extinfo.disabledDeps;e=l?M.hexPrelude()+"\n; compilation disabled on this variant due to "+r.extinfo.disabledDeps+'\n.hex 718E3B92C615A841C49866C975EE5197\n.string "'+r.extinfo.disabledDeps+'"':"; start\n"+M.hexPrelude()+"\n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+M.hexTemplateHash()+" ; hex template hash\n    .hex 873266330af9dbdb ; replaced in binary by program hash\n"+e,r.embedBlob&&(t.packedSource=(i=r.embedMeta,a=R.pxtc.decodeBase64(r.embedBlob),(s=D.Util.toUTF8(i)).length,a.length,o="A/¸/¢»",o+=D.U.uint8ArrayToString([255&s.length,s.length>>8,255&a.length,a.length>>8,0,0,0,0]),o+=s,(o+=a).length%2&&(o+="\0"),o),!t.target.noSourceInFlash&&t.packedSource.length<4e4&&(e+=function(e){for(var t="",r=0;r<e.length;++r){var n=255&e.charCodeAt(r);t+=n<=15?"0"+n.toString(16):n.toString(16)}return"\n    .balign 16\n_stored_program: .hex "+t+"\n"}(t.packedSource),t.packedSource=null));var u=M.flashCodeAlign(r.target);if(!l&&r.target.flashChecksumAddr){for(var c=0;1<<c<u;)c++;var p=parseInt(M.hexTemplateHash().slice(8,16),16),f=M.getStartAddress()/u;p=4294967040&p|c;var d=0,m=f;r.target.flashChecksumAddr<M.getStartAddress()&&(m-=d=Math.ceil((r.target.flashChecksumAddr+32)/u)),e+="\n    .balign 4\n__end_marker:\n    .word "+p+"\n\n; ------- this will get removed from the final binary ------\n__flash_checksums:\n    .word 0x87eeb07c ; magic\n    .word __end_marker ; end marker position\n    .word "+p+" ; end marker\n    ; template region\n    .short "+d+", "+m+"\n    .word 0x"+M.hexTemplateHash().slice(0,8)+"\n    ; user region\n    .short "+f+", 0xffff\n    .hex 87326633 ; replaced later\n    .word 0x0 ; terminator\n"}var h=r.extinfo.outputPrefix||"";t.writeFile(h+D.BINARY_ASM,e);var g=B(r.target,t,e);if(g.thumbFile.commPtr&&(t.commSize=g.thumbFile.commPtr-M.getCommBase()),g.src&&t.writeFile(h+D.BINARY_ASM,g.src),l)O();else{var v=n.configData||[];if(v.some(function(e){return"BOOTLOADER_BOARD_ID"==e.name})){var b="const uint32_t configData[] = {\n";b+="    0x1e9e10f1, 0x20227a79, // magic\n",b+="    "+v.length+", 0, // num. entries; reserved\n";for(var y=0,x=v;y<x.length;y++){var k=x[y];b+="    "+k.key+", 0x"+k.value.toString(16)+", // "+k.name+"\n"}b+="    0, 0\n};\n",t.writeFile(h+"config.c",b)}if(g.buf){for(var S=g.buf,T="",w=0;w<S.length;++w)T+=String.fromCharCode(255&S[w],S[w]>>8);var I=D.U.sha256(T).slice(0,16),E=D.U.range(4).map(function(e){return parseInt(I.slice(2*e,2*e+2),16)});D.U.assert(12935==S[12]);for(w=0;w<E.length;++w)S[12+w]=E[w];if(r.target.flashChecksumAddr){var N=g.thumbFile.lookupLabel("__flash_checksums")/2;D.U.assert(N==S.length-16);var _=S.slice(S.length-16);S.splice(S.length-16,16);var K=Math.ceil(2*S.length/u);D.U.assert(12935==_[_.length-4]),_[_.length-4]=E[0],_[_.length-3]=E[1],_[_.length-5]=K,t.checksumBlock=_}O()}if(!n.procDebugInfo){for(var A=0,C=n.breakpoints;A<C.length;A++){var U=C[A],P=D.U.lookup(g.thumbFile.getLabels(),"__brkp_"+U.id);null!=P&&(U.binAddr=P)}for(var L=0,F=t.procs;L<F.length;L++){F[L].fillDebugInfo(g.thumbFile)}n.procDebugInfo=t.procs.map(function(e){return e.debugInfo})}}function O(){if(pxt.isOutputText(D.target)){e=M.patchHex(t,g.buf,!1,!1).join("\r\n")+"\r\n";t.writeFile(h+pxt.outputName(D.target),e)}else{var e=R.pxtc.encodeBase64(M.patchHex(t,g.buf,!1,!!D.target.useUF2)[0]);t.writeFile(h+pxt.outputName(D.target),e)}}}D.assemble=B,D.processorEmit=function(e,t,r){var n=c(e),i=D.U.flatClone(t);p(n,e,t,r);var a=i.otherMultiVariants||[];if(a.length)try{for(var s=0,o=a;s<o.length;s++){var l=o[s],u=D.U.flatClone(i);u.extinfo=l.extinfo,l.target.isNative=!0,u.target=l.target,M.setupFor(u.target,u.extinfo),p(n,e,u,r)}}finally{M.setupFor(i.target,i.extinfo)}},D.validateShim=M.validateShim}(R.pxtc||(R.pxtc={}))}(ts||(ts={})),function(e){(e.pxtc||(e.pxtc={})).getHelpForKeyword=function(e,t){var r={abstract:null,any:null,as:null,break:null,case:null,catch:null,class:null,continue:null,const:null,constructor:null,debugger:null,declare:null,delete:null,do:null,else:null,enum:null,export:null,extends:null,false:lf("Represents the negative outcome of a logical expression"),finally:null,for:null,from:null,function:null,get:null,if:null,implements:null,in:null,instanceof:null,interface:null,is:null,let:null,namespace:null,new:null,null:null,private:null,protected:null,public:null,return:null,set:null,static:null,super:null,switch:null,this:null,throw:null,true:lf("Represents the positive outcome of a logical expression"),try:null,type:null,typeof:null,undefined:null,void:null,while:null,with:null,of:null};return t?{True:r.true,False:r.false,None:null,abs:null,all:null,any:null,ascii:null,bin:null,bool:null,bytearray:null,bytes:null,callable:null,chr:null,classmethod:null,compile:null,complex:null,copyright:null,credits:null,delattr:null,dict:null,dir:null,divmod:null,enumerate:null,eval:null,exec:null,exit:null,filter:null,float:null,format:null,frozenset:null,getattr:null,globals:null,hasattr:null,hash:null,help:null,hex:null,id:null,input:null,int:null,isinstance:null,issubclass:null,iter:null,len:null,license:null,list:null,locals:null,map:null,max:null,memoryview:null,min:null,next:null,object:null,oct:null,open:null,ord:null,pow:null,print:null,property:null,quit:null,range:null,repr:null,reversed:null,round:null,set:null,setattr:null,slice:null,sorted:null,staticmethod:null,str:null,sum:null,super:null,tuple:null,type:null,vars:null}[e]:r[e]}}(ts||(ts={})),function(e){var t,r;t=e.pxtc||(e.pxtc={}),r=function(){function e(e){this.p=e}return e.prototype.getCompilationSettings=function(){var e=this.p.getCompilerOptions();return e.noLib=!0,e},e.prototype.getNewLine=function(){return"\n"},e.prototype.getScriptFileNames=function(){return this.p.getSourceFiles().map(function(e){return e.fileName})},e.prototype.getScriptVersion=function(e){return"0"},e.prototype.getScriptSnapshot=function(e){var t=this.p.getSourceFile(e);return{getLength:function(){return t.getFullText().length},getText:function(){return t.getFullText()},getChangeRange:function(){}}},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return""},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}(),t.LSHost=r}(ts||(ts={})),function(Se){var Te;(function(ae){var se=0,oe=1,le=5,ue=10;function ce(e){var t,r,n,i=null===(n=null===(r=null===(t=e)||void 0===t?void 0:t.pxt)||void 0===r?void 0:r.callInfo)||void 0===n?void 0:n.qName;return ae.lastApiInfo.apis.byQName[i]}function pe(e,t,r){if(e&&!(t<0)){var n=e.parameters[t].type;if(e.attributes._def){var i=e.attributes._def.parameters[t].shadowBlockId;if(i){var a=r.blocksById[i],s=ae.lastApiInfo.apis.byQName[a.qName];"TD_ID"===s.attributes.shim&&1===s.parameters.length&&(n=s.parameters[0].type)}}return n}}function fe(e,t,r,n){var i={};n.forEach(function(e){i[e.symbol.retType]=__spreadArrays(i[e.symbol.retType]||[],[e])});for(var a=i[e],s=[],o=0,l=a;o<l.length;o++){var u=f(l[o].symbol,t,Se.SymbolFlags.Enum);if(u){var c=r.getTypeOfSymbolAtLocation(u,t),p=Te.getEnumMembers(r,c).map(function(e){return Te.enumMemberToQName(r,e)}).map(function(e){return ae.lastApiInfo.apis.byQName[e]});s=__spreadArrays(s,p)}}return __spreadArrays(a,be(s,oe))}function u(e){return e.flags&Se.SymbolFlags.Variable?4:e.flags&Se.SymbolFlags.Class?8:e.flags&Se.SymbolFlags.Enum?6:e.flags&Se.SymbolFlags.EnumMember?7:e.flags&Se.SymbolFlags.Method?1:e.flags&Se.SymbolFlags.Module?5:e.flags&Se.SymbolFlags.Property?2:0}function de(e){return{kind:0,name:e,pyName:e,qName:e,pyQName:e,namespace:"",attributes:{callingConvention:0,paramDefl:{}},fileName:"main.ts",parameters:[],retType:"any"}}function me(e,t){var r,n,i=e.getName(),a=/(.*)\.(.*)/.exec(i),s=a?a[2]:i,o=a?a[1]:"",l=null!=(n=null===(r=t.getSymbol())||void 0===r?void 0:r.getName())?n:"any";return{kind:u(e),name:s,pyName:s,qName:i,pyQName:i,namespace:o,attributes:{callingConvention:0,paramDefl:{}},fileName:"main.ts",parameters:[],retType:l}}function he(e,t,r){if(e)return t.byQName[r.getFullyQualifiedName(e)]}function ge(e,t){return e.weight!==t.weight?t.weight-e.weight:Te.compareSymbols(e.symbol,t.symbol)}function ve(e,t){return{symbol:e,weight:t}}function be(e,t){return e.map(function(e){return ve(e,t)})}function ye(e,t){var r;if(e.flags&Se.TypeFlags.NumberLiteral)return"Number";if(e.flags&Se.TypeFlags.StringLiteral)return"String";if(e.flags&Se.TypeFlags.BooleanLiteral)return"Boolean";var n=t.typeToString(e);return null!=(r={number:"Number",string:"String",boolean:"Boolean"}[n])?r:n}function xe(e,t){return"."===t.charAt(0)&&(t=t.substr(1)),e.substr(0,e.lastIndexOf(".")+1)+t}function f(e,t,r){var n=ae.service&&ae.service.getProgram().getTypeChecker();if(!n)return null;for(var i=0,a=n.getSymbolsInScope(t,r);i<a.length;i++){var s=a[i];if(s.escapedName.toString()===e.qName)return s}return null}function ke(e){var t=e.symbol;return!(/^__/.test(t.name)||/^__/.test(t.namespace)||t.attributes.hidden||t.attributes.deprecated||"TD_ID"==t.attributes.shim||t.attributes.blockAliasFor)}ae.getCallSymbol=ce,ae.getParameterTsType=pe,ae.getApisForTsType=fe,ae.getBasicKindDefault=function(e,t){switch(e){case Te.SK.StringKeyword:return'""';case Te.SK.NumberKeyword:return"0";case Te.SK.BooleanKeyword:return t?"False":"false";case Te.SK.ArrayType:return"[]";case Te.SK.NullKeyword:return t?"None":"null";default:return}},ae.tsSymbolToPxtSymbolKind=u,ae.makePxtSymbolFromKeyword=de,ae.makePxtSymbolFromTsSymbol=me,ae.getPxtSymbolFromTsSymbol=he,ae.compareCompletionSymbols=ge,ae.completionSymbol=ve,ae.completionSymbols=be,ae.getNodeAndSymbolAtLocation=function(e,t,r,n){var i=e.getSourceFile(t),a=e.getTypeChecker(),s=Te.findInnerMostNodeAtPosition(i,r);if(s){var o=a.getSymbolAtLocation(s);if(o)return[s,he(o,n,a)]}return null},ae.tsTypeToPxtTypeString=ye,ae.filenameWithExtension=xe,ae.getWordAtPosition=function(r,e){for(var t=e,n=e;0<t&&i(t);)--t;for(;n<r.length-1&&i(n);)++n;return t!=n?{text:r.substring(t+1,n),start:t+1,end:n}:null;function i(e){var t=r.charCodeAt(e);return 65<=t&&t<=90||97<=t&&t<=122}},ae.getTsSymbolFromPxtSymbol=f,ae.getDefaultEnumValue=function(e,t){for(var r=ae.service&&ae.service.getProgram().getTypeChecker(),n=0,i=Te.getEnumMembers(r,e);n<i.length;n++){var a=i[n];if(a.name.kind===Te.SK.Identifier){var s=Te.enumMemberToQName(r,a),o=ae.lastApiInfo.apis.byQName[s];return o?o.attributes.alias?t&&o.attributes.pyAlias||o.attributes.alias:t?o.pyQName:o.qName:s}}return"0"},ae.getCompletions=function(e){var t,r,n,i,a=e.fileName,s=e.fileContent,o=e.position,l=e.wordStartPos,u=e.wordEndPos,c=e.runtime,p=s;s&&ae.host.setFile(a,s);var f=xe(a,"ts"),d={startPos:l,endPos:u},m=/\.py$/.test(a),h={entries:[],isMemberCompletion:!1,isNewIdentifierLocation:!0,isTypeLocation:!1,namespace:[]},g=p.lastIndexOf("\n",o-1);g=Math.max(0,g);var v=p.substring(g+1,o),b=m?"#":"//";if(v.trim().startsWith(b))return h;for(var y=-1,x=-1,k=o-1;0<=k;--k){if("."==p[k]){y=k;break}if(!/\w/.test(p[k]))break;-1==x&&(x=k)}y==o-1?p=p.slice(0,o)+"_"+p.slice(o):-1==x&&(p=p.slice(0,o)+"_"+p.slice(o),x=o);var S=-1!==y,T=(h.isMemberCompletion=S)?p.slice(y+1,u):p.slice(l,u);S&&(x=y);var w={},I=ae.cloneCompileOpts(ae.host.opts);I.fileSystem[a]=p,ae.addApiInfo(I),I.syntaxInfo={position:x,type:h.isMemberCompletion?"memberCompletion":"identifierCompletion"};var E,N=[];if(m){var _=Te.transpile.pyToTs(I);if(_.syntaxInfo&&_.syntaxInfo.symbols&&(N=be(_.syntaxInfo.symbols,oe)),_.globalNames&&(ae.lastGlobalNames=_.globalNames),!N.length&&_.globalNames&&(N=be(pxt.U.values(_.globalNames),oe)),Object.keys(_.outfiles).forEach(function(e){e===f&&ae.host.setFile(e,_.outfiles[e])}),_.sourceMap){var K=p,A=_.outfiles[f]||"",C=Te.BuildSourceMapHelpers(_.sourceMap,A,K).py.smallestOverlap(d);C&&(E=C.ts.startPos)}!S&&50<N.length&&(N=N.filter(function(e){return 0<=(m?e.symbol.pyQName:e.symbol.qName).indexOf(T)}))}else E=o,I.ast=!0,ae.host.setOpts(I),ae.runConversionsAndCompileUsingService();var U=ae.service.getProgram(),P=U.getSourceFile(f),L=U.getTypeChecker(),F=Te.findInnerMostNodeAtPosition(P,E);if(Te.decompiler.buildCommentMap(P).some(function(e){return e.start<=o&&o<=e.end}))return h;if(F&&[Te.SK.StringLiteral,Te.SK.FirstTemplateToken,Te.SK.NoSubstitutionTemplateLiteral].some(function(e){return F.kind===e}))return h;h.namespace=Te.getCurrentNamespaces(F);var O=!1;if(S){var D=Te.findInnerMostNodeAtPosition(P,m?E:y-1);if(D){var M=void 0,B=L.getSymbolAtLocation(D);if(M=0<(null===(r=null===(t=B)||void 0===t?void 0:t.members)||void 0===r?void 0:r.size)?L.getDeclaredTypeOfSymbol(B):B?L.getTypeOfSymbolAtLocation(B,D):L.getTypeAtLocation(D)){var R=M.symbol?L.getFullyQualifiedName(M.symbol):ye(M,L);R&&(N=M.getApparentProperties().map(function(e){return R+"."+e.getName()}).map(function(e){return ae.lastApiInfo.apis.byQName[e]}).filter(function(e){return!!e}).map(function(e){return ve(e,oe)}),O=!0)}}}var $=pxt.U.values(ae.lastApiInfo.apis.byQName);0===N.length&&(N=be($.filter(function(e){return 0<=(m?e.pyQName:e.qName).indexOf(T)}),oe));var q=Te.getParentCallExpression(F);if(q){var j=Te.findCurrentCallArgIdx(q,F,E);if(0<=j){var z=ae.blocksInfoOp(ae.lastApiInfo.apis,c.bannedCategories),V=ce(q);if(V){j>=V.parameters.length&&(j=V.parameters.length-1);var G=pe(V,j,z);G&&fe(G,q,L,N).forEach(function(e){return e.weight=ue})}}}if(!m&&!O){(F=Te.findInnerMostNodeAtPosition(P,l))||(F=P.getSourceFile());var J=Se.SymbolFlags.Variable,H=L.getSymbolsInScope(F,J),Q=F.getText();"_"!==Q&&(H=H.filter(function(e){return 0<=e.name.indexOf(Q)}));var W=H.map(function(e){var t=he(e,ae.lastApiInfo.apis,L);return t||(t=me(e,L.getTypeOfSymbolAtLocation(e,F))),t}).filter(function(e){return!!e}).map(function(e){return ve(e,oe)});W.forEach(function(e){return e.weight+=le}),N=__spreadArrays(N,W)}if(!S){var Y=void 0;if(m){var Z=pxt.py.keywords;Y=Object.keys(Z)}else Y=__spreadArrays(ts.pxtc.reservedWords,ts.pxtc.keywordTypes);var X=Y.filter(function(e){return 0<=e.indexOf(T)}).map(de).map(function(e){return ve(e,se)});N=__spreadArrays(N,X)}var ee={};ee=m&&ae.lastGlobalNames?ae.lastGlobalNames:ae.lastApiInfo.apis.byQName,N.map(function(e){return e.symbol.attributes.alias?ve(ae.lastApiInfo.apis.byQName[e.symbol.attributes.alias],e.weight):e}).filter(ke).forEach(function(e){w[e.symbol.qName]=e}),(N=pxt.Util.values(w).filter(function(e){return!!e&&!!e.symbol})).sort(ge),100<N.length&&(N=N.splice(0,100));var te=e.runtime,re=te.bannedCategories,ne=te.screenSize,ie={takenNames:ee,blocksInfo:ae.blocksInfoOp(ae.lastApiInfo.apis,re),screenSize:ne,apis:ae.lastApiInfo.apis,checker:null===(i=null===(n=ae.service)||void 0===n?void 0:n.getProgram())||void 0===i?void 0:i.getTypeChecker()};return N.forEach(function(e){return function(e,t,r){var n=ae.lastApiInfo.decls[e.qName];if(Se.isFunctionLike(n)&&(e.snippetAddsDefinitions||t&&!e.pySnippet||!t&&!e.snippet)){var i=ae.getSnippet(r,e,n,t),a=ae.snippetStringify(i),s=ae.snippetStringify(i,!0),o=ae.snippetAddsDefinitions(i);t?(e.pySnippet=a,e.pySnippetWithMarkers=s):(e.snippet=a,e.snippetWithMarkers=s),e.snippetAddsDefinitions=o}}(e.symbol,m,ie)}),h.entries=N.map(function(e){return e.symbol}),h}})((Te=Se.pxtc||(Se.pxtc={})).service||(Te.service={}))}(ts||(ts={})),function(p){!function(o){var l=function(e){var t=r(e);p.sys.write(t)};function u(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];l(n)}}function r(e){var t;if(void 0!==e.file){var r=e,n=p.getLineAndCharacterOfPosition(r.file,r.start),i=n.line,a=n.character,s=r.file.fileName;t=Object.assign({fileName:s,line:i,column:a},r)}else t=Object.assign({fileName:void 0,line:void 0,column:void 0},e);return function(e){var t="";e.fileName&&(t+=e.fileName+"("+(e.line+1)+","+(e.column+1)+"): ");var r=p.sys?p.sys.newLine:"\n",n=o.DiagnosticCategory[e.category].toLowerCase();return t+=n+" TS"+e.code+": "+o.flattenDiagnosticMessageText(e.messageText,r)+r}(t)}function n(e,t){var r=p.createCompilerHost(t);return r.getDefaultLibFileName=function(){return"node_modules/typescript/lib/lib.d.ts"},p.createProgram(e,t,r)}function c(e){var t=e.getSyntacticDiagnostics();return 0===t.length&&0===(t=e.getOptionsDiagnostics().concat(o.Util.toArray(e.getGlobalDiagnostics()))).length&&(t=e.getSemanticDiagnostics()),t.slice(0)}o.getDiagnosticString=r,o.plainTscCompileDir=function(i){var a=p.parseCommandLine([]),s=p.findConfigFile(i,p.sys.fileExists),e=function(){var e=p.sys.readFile(s),t=p.parseConfigFileTextToJson(s,e),r=t.config;if(!r)return u([t.error]),void p.sys.exit(p.ExitStatus.DiagnosticsPresent_OutputsSkipped);var n=p.parseJsonConfigFileContent(r,p.sys,i,a.options,s);return 0<n.errors.length?(u(n.errors),void p.sys.exit(p.ExitStatus.DiagnosticsPresent_OutputsSkipped)):n}(),t=n(e.fileNames,e.options);return c(t).forEach(l),t},o.plainTscCompileFiles=n,o.getProgramDiagnostics=c}(p.pxtc||(p.pxtc={}))}(ts||(ts={})),function(E){!function(k){function S(t){var e=t.toUpperCase(),r=t.toLowerCase();if(t==e||t==r)return t;if(0<t.lastIndexOf("_"))return t;for(var n,i=function(e){return t[e]!=r[e]},a="",s=0;s<t.length;){for(var o=i(s),l=s;l<t.length;){if(o&&t[n=l]!=e[n]){if(2<l-s){l--;break}o=!1}if(!o&&i(l))break;l++}a&&(a+="_"),a+=t.slice(s,l),s=l}return a.toUpperCase()===a?a:a.toLowerCase()}function T(e){if(!e||!e.kind)return null;switch(e.kind){case E.SyntaxKind.StringKeyword:return"str";case E.SyntaxKind.NumberKeyword:return"number";case E.SyntaxKind.BooleanKeyword:return"bool";case E.SyntaxKind.VoidKeyword:return"None";case E.SyntaxKind.FunctionType:return n=T((r=e).type),"("+r.parameters.map(function(e){return e.type}).map(T).join(", ")+") -> "+n;case E.SyntaxKind.ArrayType:return"List["+T((t=e).elementType)+"]";case E.SyntaxKind.TypeReference:var t;return(t=e).typeName&&t.typeName.getText?t.typeName.getText():"";case E.SyntaxKind.AnyKeyword:return"any";default:return pxt.tickEvent("depython.todo",{kind:e.kind}),""}var r,n}function w(e){if(!e||!e.flags)return null;switch(e.flags){case E.TypeFlags.String:return"str";case E.TypeFlags.Number:return"number";case E.TypeFlags.Boolean:return"bool";case E.TypeFlags.Void:return"None";case E.TypeFlags.Any:return"any";default:return pxt.tickEvent("depython.todo",{kind:e.flags}),""}}function b(h,e,t){function g(e,t,r){void 0===r&&(r=!1);var n=h.getTypeAtLocation(t);if(!n)return"None";r&&(n=n.getCallSignatures()[0].getReturnType());var i=h.typeToString(n,void 0,E.TypeFormatFlags.UseFullyQualifiedType);return/^\d/.test(i)?"number":"this"==i?I(h,n.symbol):i}var r=function(e){switch(e.kind){case k.SK.MethodDeclaration:case k.SK.MethodSignature:return 1;case k.SK.PropertyDeclaration:case k.SK.PropertySignature:case k.SK.GetAccessor:case k.SK.SetAccessor:return 2;case k.SK.Constructor:case k.SK.FunctionDeclaration:return 3;case k.SK.VariableDeclaration:return 4;case k.SK.ModuleDeclaration:return 5;case k.SK.EnumDeclaration:return 6;case k.SK.EnumMember:return 7;case k.SK.ClassDeclaration:return 8;case k.SK.InterfaceDeclaration:return 9;default:return 0}}(t);if(0!=r){var n=t,v=k.parseComments(n);if(v.weight<0)return null;var i=/^(.*)\.(.*)/.exec(e),a=3==r||1==r,s=null,o=E.getSourceFileOfNode(t);if(o){var l=/^pxt_modules\/([^\/]+)/.exec(o.fileName);l&&(s=l[1])}var u=void 0;if(8==r||9==r){var c=t;if(u=[],c.heritageClauses)for(var p=0,f=c.heritageClauses;p<f.length;p++){var d=f[p];if(d.types)for(var m=0,b=d.types;m<b.length;m++){var y=b[m];u.push(g(0,y))}}}6!=r&&7!==r||(u||(u=[])).push("Number");var x={kind:r,qName:e,namespace:i?i[1]:"",name:i?i[2]:e,fileName:t.getSourceFile().fileName,attributes:v,pkg:s,extendsTypes:u,retType:t.kind==E.SyntaxKind.Constructor?"void":5==r?"":g(n.type,n,a),parameters:a?k.Util.toArray(n.parameters).map(function(r,e){var t,n,i=k.getName(r),a=v.paramHelp[i]||"",s=v.paramMin&&v.paramMin[i],o=v.paramMax&&v.paramMax[i];/\beg\.?:\s*(.+)/.exec(a);if(r.type&&r.type.kind===k.SK.FunctionType){var l=h.getSignatureFromDeclaration(r.type).getParameters();"objectdestructuring"===v.mutate?(k.assert(0<l.length),t=h.getTypeAtLocation(l[0].valueDeclaration).getProperties().map(function(e){return{name:e.getName(),type:h.typeToString(h.getTypeOfSymbolAtLocation(e,l[0].valueDeclaration))}})):n=l.map(function(e,t){return{name:e.getName(),type:h.typeToString(h.getTypeOfSymbolAtLocation(e,r),void 0,E.TypeFormatFlags.UseFullyQualifiedType)}})}var u={},c=h.getTypeAtLocation(r),p=c&&!!(c.flags&(E.TypeFlags.Enum|E.TypeFlags.EnumLiteral));if(v.block&&v.paramShadowOptions){var f=[];v.block.replace(/%(\w+)/g,function(e,t){return f.push(t),""}),v.paramShadowOptions[f[e]]&&(u.fieldEditorOptions={value:v.paramShadowOptions[f[e]]})}s&&(u.min={value:s}),o&&(u.max={value:o});var d=r.type&&T(r.type)||c&&w(c)||"unknown",m=r.initializer?r.initializer.getText():k.getExplicitDefault(v,i)||(r.questionToken?"undefined":void 0);return{name:i,description:a,type:g(r.type,r),pyTypeString:d,initializer:m,default:v.paramDefl[i],properties:t,handlerParameters:n,options:u,isEnum:p}}):null,snippet:E.isFunctionLike(t)?null:void 0};switch(x.kind){case 7:x.pyName=S(x.name).toUpperCase();break;case 4:case 1:case 2:case 3:x.pyName=S(x.name);break;case 6:case 8:case 9:case 5:default:x.pyName=x.name}return(t.kind===k.SK.GetAccessor||(t.kind===k.SK.PropertyDeclaration||t.kind===k.SK.PropertySignature)&&k.isReadonly(t))&&(x.isReadOnly=!0),x}return null}function i(e){return!!e.attributes.block&&!!e.attributes.blockId}var a;function d(t,r){function e(e){return-e(t)+e(r)}var n=e(function(e){return i(e)?1:-1});return n||((n=e(function(e){return e.namespace?-1:1}))?n:(a||(a={4:100,5:101,3:99,2:98,1:97,8:89,6:81,7:80}),(n=e(function(e){return a[e.kind]||0}))?n:(n=e(function(e){return e.attributes.weight||50}))||k.U.strcmp(t.name,r.name)))}function n(e,t,r){void 0===r&&(r=!1);for(var f={byQName:{},jres:t},d={},m=e.getTypeChecker(),h=function(e){var t,r,n,i;if(e.kind!=k.SK.VariableStatement){if(k.isExported(e)){if(!e.symbol)return void console.warn("no symbol",e);var a=I(m,e.symbol);e.kind==k.SK.SetAccessor&&(a+="@set"),d[a]=e;var s=b(m,a,e);if(s){var o=k.U.lookup(f.byQName,a);if(o)if(9==o.kind&&9!=s.kind)f.byQName[a+"@type"]=o;else if(9!=o.kind&&9==s.kind)f.byQName[a+"@type"]=s,s=o;else{var l=null===(t=o.attributes._source)||void 0===t?void 0:t.trim(),u=null===(r=s.attributes._source)||void 0===r?void 0:r.trim(),c=l+"\n"+u;l&&0<=(null===(n=u)||void 0===n?void 0:n.indexOf(l))?c=u:u&&0<=(null===(i=l)||void 0===i?void 0:i.indexOf(u))&&(c=l),s.attributes=k.parseCommentString(c),o.extendsTypes&&(s.extendsTypes=s.extendsTypes||[],o.extendsTypes.forEach(function(e){-1===s.extendsTypes.indexOf(e)&&s.extendsTypes.push(e)}))}!e.parent||e.parent.kind!=k.SK.ClassDeclaration&&e.parent.kind!=k.SK.InterfaceDeclaration||k.isStatic(e)||(s.isInstance=!0),f.byQName[a]=s}}if(e.kind==k.SK.ModuleDeclaration){var p=e;if(p.body.kind==k.SK.ModuleBlock)p.body.statements.forEach(h);else p.body.kind==k.SK.ModuleDeclaration&&h(p.body)}else if(e.kind==k.SK.InterfaceDeclaration){e.members.forEach(h)}else if(e.kind==k.SK.ClassDeclaration){e.members.forEach(h)}else if(e.kind==k.SK.EnumDeclaration){e.members.forEach(h)}}else{e.declarationList.declarations.forEach(h)}},n=0,i=e.getSourceFiles();n<i.length;n++){i[n].statements.forEach(h)}var a=[];for(var s in f.byQName){var o=f.byQName[s];o.qName=s,o.attributes._source=null,o.extendsTypes&&o.extendsTypes.length&&a.push(o);var l=o.attributes.jres;if(l){"true"==l&&(l=s);var u=k.U.lookup(t||{},l);u&&u.icon&&!o.attributes.iconURL&&(o.attributes.iconURL=u.icon),u&&u.data&&!o.attributes.jresURL&&(o.attributes.jresURL="data:"+u.mimeType+";base64,"+u.data)}if(o.pyName){var c=k.U.lookup(k.ts2PyFunNameMap,o.qName);if(c&&c.n)o.pyQName=c.n,o.pySnippet=c.snippet,o.pySnippetName=c.n,o.pySnippetWithMarkers=void 0;else if(o.namespace){var p=f.byQName[o.namespace];p?o.pyQName=p.pyQName+"."+o.pyName:(pxt.log("namespace missing: "+o.namespace),o.pyQName=o.namespace+"."+o.pyName)}else o.pyQName=o.pyName}}var g={},v=function(e){if(!k.U.lookup(g,e.qName)){g[e.qName]=!0;var t={};t[e.qName]=!0;for(var r=0,n=e.extendsTypes||[];r<n.length;r++){var i=n[r];t[i]=!0;var a=f.byQName[i];if(a){v(a);for(var s=0,o=a.extendsTypes;s<o.length;s++){t[o[s]]=!0}}}e.extendsTypes=Object.keys(t)}};return a.forEach(v),r&&delete f.byQName["Array.map"],{apis:f,decls:d}}function I(e,t){return t.isBogusSymbol?t.name:e.getFullyQualifiedName(t)}k.placeholderChar="◊",k.ts2PyFunNameMap={"Math.trunc":{n:"int",t:E.SyntaxKind.NumberKeyword,snippet:"int(0)"},"Math.min":{n:"min",t:E.SyntaxKind.NumberKeyword,snippet:"min(0, 0)"},"Math.max":{n:"max",t:E.SyntaxKind.NumberKeyword,snippet:"max(0, 0)"},"Math.abs":{n:"abs",t:E.SyntaxKind.NumberKeyword,snippet:"abs(0)"},"console.log":{n:"print",t:E.SyntaxKind.VoidKeyword,snippet:'print(":)")'},".length":{n:"len",t:E.SyntaxKind.NumberKeyword},".toLowerCase()":{n:"string.lower",t:E.SyntaxKind.StringKeyword},".toUpperCase()":{n:"string.upper",t:E.SyntaxKind.StringKeyword},".charCodeAt(0)":{n:"ord",t:E.SyntaxKind.NumberKeyword},"pins.createBuffer":{n:"bytearray",t:E.SyntaxKind.Unknown},"pins.createBufferFromArray":{n:"bytes",t:E.SyntaxKind.Unknown},"control.createBuffer":{n:"bytearray",t:E.SyntaxKind.Unknown},"control.createBufferFromArray":{n:"bytes",t:E.SyntaxKind.Unknown},"!!":{n:"bool",t:E.SyntaxKind.BooleanKeyword},"Array.indexOf":{n:"Array.index",t:E.SyntaxKind.Unknown},"Array.push":{n:"Array.append",t:E.SyntaxKind.Unknown},parseInt:{n:"int",t:E.SyntaxKind.NumberKeyword,snippet:'int("0")'},"_py.range":{n:"range",t:E.SyntaxKind.Unknown,snippet:"range(4)"}},k.snakify=S,k.emitPyTypeFromTypeNode=T,k.emitPyTypeFromTsType=w,k.genDocs=function(n,e,i){void 0===i&&(i={}),pxt.debug("generating docs for "+n),pxt.debug(JSON.stringify(Object.keys(e.byQName),null,2));for(var a={},r=k.Util.values(e.byQName),t=r.filter(function(e){return 7==e.kind}).sort(d),s={},o={},l={},u=function(t,e){if(i.locs){var r={};Object.keys(t).sort().forEach(function(e){return r[e]=t[e]}),a[n+e+"-strings.json"]=JSON.stringify(r,null,2)}},c=function(t){if(5==t.kind){if(!r.filter(function(e){return e.namespace==t.name&&!!e.attributes.jsDoc})[0])return"continue";t.attributes.block||(t.attributes.block=t.name)}!function(t){if(i.locs&&t.qName&&!/^__/.test(t.name)){if(pxt.debug("loc: "+t.qName),7!=t.kind){var e=E.pxtc.blocksCategory(t);e&&(o["{id:category}"+e]=e)}t.attributes.jsDoc&&(l[t.qName]=t.attributes.jsDoc),t.attributes.block&&(o[t.qName+"|block"]=t.attributes.block),t.attributes.group&&(o["{id:group}"+t.attributes.group]=t.attributes.group),t.attributes.subcategory&&(o["{id:subcategory}"+t.attributes.subcategory]=t.attributes.subcategory),t.parameters&&t.parameters.filter(function(e){return!!e.description}).forEach(function(e){l[t.qName+"|param|"+e.name]=e.description})}}(t)},p=0,f=r;p<f.length;p++)c(f[p]);return i.locs&&t.forEach(function(e){e.attributes.block&&(o[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(o[e.qName]=e.attributes.jsDoc)}),u(o,""),u(l,"-jsdoc"),i.pxtsnippet&&(i.pxtsnippet.forEach(function(e){return n=["label","title","hint","errorMessage"],(r=s)[(t=e).label]=t.label,void t.questions.forEach(function(t){n.forEach(function(e){t[e]&&(r[t[e]]=t[e])})});var t,r,n}),u(s,"-snippet")),a},k.hasBlock=i,k.compareSymbols=d,k.getApiInfo=function(e,t,r){return void 0===r&&(r=!1),n(e,t,r).apis},k.internalGetApiInfo=n,k.getFullName=I}(E.pxtc||(E.pxtc={}))}(ts||(ts={})),function(f){var K;(function(w){var t={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1,switches:{}}},n=function(){function e(){this.opts=t,this.fileVersions={},this.projectVer=0,this.pxtModulesOK=null}return e.prototype.getProjectVersion=function(){return this.projectVer+""},e.prototype.setFile=function(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)},e.prototype.reset=function(){this.setOpts(t),this.pxtModulesOK=null},e.prototype.setOpts=function(e){var r=this;K.Util.iterMap(e.fileSystem,function(e,t){r.opts.fileSystem[e]!=t&&(r.fileVersions[e]=(r.fileVersions[e]||0)+1)}),this.opts=e,this.projectVer++},e.prototype.getCompilationSettings=function(){return K.getTsCompilerOptions(this.opts)},e.prototype.getScriptFileNames=function(){return this.opts.sourceFiles.filter(function(e){return K.U.endsWith(e,".ts")})},e.prototype.getScriptVersion=function(e){return(this.fileVersions[e]||0).toString()},e.prototype.getScriptSnapshot=function(e){var t=this.opts.fileSystem[e];return null!=t?f.ScriptSnapshot.fromString(t):null},e.prototype.getNewLine=function(){return"\n"},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return"no-default-lib.d.ts"},e.prototype.log=function(e){console.log("LOG",e)},e.prototype.trace=function(e){console.log("TRACE",e)},e.prototype.error=function(e){console.error("ERROR",e)},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}();function d(e,t){return e?(w.lastLocBlocksInfo||(w.lastLocBlocksInfo=K.getBlocksInfo(e,t)),w.lastLocBlocksInfo):(w.lastBlocksInfo||(w.lastBlocksInfo=K.getBlocksInfo(w.lastApiInfo.apis,t)),w.lastBlocksInfo)}function I(e){return w.lastApiInfo||(w.lastApiInfo=K.internalGetApiInfo(w.service.getProgram(),e.jres)),w.lastApiInfo}function E(e){if(!e.apisInfo){var t=I(e);e.apisInfo=K.U.clone(t.apis)}}function N(e){var t=pxt.U.flatClone(e);return t.fileSystem=pxt.U.flatClone(t.fileSystem),t}w.blocksInfoOp=d,w.getLastApiInfo=I,w.addApiInfo=E,w.cloneCompileOpts=N,w.IsOpErr=function(e){return!!e.errorMessage};var i={reset:function(){w.service.cleanupSemanticCache(),w.lastApiInfo=void 0,w.lastGlobalNames=void 0,w.host.reset()},setOptions:function(e){w.host.setOpts(e.options)},syntaxInfo:function(e){var t,r,n,i,a=e.fileContent;e.fileContent&&w.host.setFile(e.fileName,e.fileContent);var s=N(w.host.opts);s.fileSystem[e.fileName]=a,E(s),s.syntaxInfo={position:e.position,type:e.infoType};var o=s.target.preferredEditor==pxt.PYTHON_PROJECT_NAME,l="symbol"===s.syntaxInfo.type,u="signature"===s.syntaxInfo.type;if(o)(c=K.transpile.pyToTs(s)).globalNames&&(w.lastGlobalNames=c.globalNames);else{s.ast=!0,w.host.setOpts(s);var c=_(),p=w.service.getProgram(),f=p.getSourceFile(e.fileName),d=p.getTypeChecker();if(l||u){var m=K.findInnerMostNodeAtPosition(f,e.position);if(m)if(l){var h=d.getSymbolAtLocation(m);if(h){var g=w.getPxtSymbolFromTsSymbol(h,s.apisInfo,d);s.syntaxInfo.symbols=[g],s.syntaxInfo.beginPos=m.getStart(),s.syntaxInfo.endPos=m.getEnd()}}else if(u){var v=null===(r=null===(t=m)||void 0===t?void 0:t.pxt)||void 0===r?void 0:r.callInfo;if(v){g=s.apisInfo.byQName[v.qName],s.syntaxInfo.symbols=[g],s.syntaxInfo.beginPos=m.getStart(),s.syntaxInfo.endPos=m.getEnd();var b=K.getParentCallExpression(m);if(b){var y=K.findCurrentCallArgIdx(b,m,e.position);s.syntaxInfo.auxResult=y}}}}}if(l&&!(null===(n=s.syntaxInfo.symbols)||void 0===n?void 0:n.length)){var x=w.getWordAtPosition(e.fileContent,e.position);if(x)if(o&&"range"===x.text){var k=I(s).apis;k.byQName["_py.range"]&&(s.syntaxInfo.symbols=[k.byQName["_py.range"]],s.syntaxInfo.beginPos=x.start,s.syntaxInfo.endPos=x.end)}else{var S=K.getHelpForKeyword(x.text,o);S&&(s.syntaxInfo.auxResult={documentation:S,displayString:w.displayStringForKeyword(x.text,o)},s.syntaxInfo.beginPos=x.start,s.syntaxInfo.endPos=x.end)}}if(null===(i=s.syntaxInfo.symbols)||void 0===i?void 0:i.length){var T=I(s).apis;o&&(s.syntaxInfo.symbols=s.syntaxInfo.symbols.map(function(e){return T.byQName[e.qName]||e})),l&&(s.syntaxInfo.auxResult=s.syntaxInfo.symbols.map(function(e){return w.displayStringForSymbol(e,o,T)}))}return s.syntaxInfo},getCompletions:function(e){return w.getCompletions(e)},compile:function(e){w.host.setOpts(e.options);var t=_();return K.timesToMs(t),t},decompile:function(e){return w.host.setOpts(e.options),K.decompile(w.service.getProgram(),e.options,e.fileName,!1)},pydecompile:function(e){return w.host.setOpts(e.options),K.transpile.tsToPy(w.service.getProgram(),e.fileName)},assemble:function(e){return{words:K.processorInlineAssemble(w.host.opts.target,e.fileContent)}},py2ts:function(e){return E(e.options),K.transpile.pyToTs(e.options)},fileDiags:function(e){return K.patchUpDiagnostics(function(e){if(!/\.ts$/.test(e))return[];var t=w.service.getSyntacticDiagnostics(e);return t&&t.length||(t=w.service.getSemanticDiagnostics(e)),t||(t=[]),t}(e.fileName))},allDiags:function(){var e=_();return K.timesToMs(e),w.host.opts.target.switches.time&&console.log("DIAG-TIME",e.times),e},format:function(e){var t=e.format;return K.format(t.input,t.pos)},apiInfo:function(){if(w.lastBlocksInfo=void 0,w.lastFuse=void 0,w.host.opts!==t)return w.lastApiInfo=K.internalGetApiInfo(w.service.getProgram(),w.host.opts.jres),w.lastApiInfo.apis},snippet:function(e){var t=e.snippet;if(w.lastApiInfo){var r=w.lastApiInfo.apis.byQName[t.qName],n=w.lastApiInfo.decls[t.qName];if(r&&n&&f.isFunctionLike(n)){var i=!!t.python,a={};a=i&&w.lastGlobalNames?w.lastGlobalNames:w.lastApiInfo.apis.byQName;var s=e.runtime,o=s.bannedCategories,l=s.screenSize,u=w.lastApiInfo.apis,c={apis:u,blocksInfo:d(u,o),takenNames:a,bannedCategories:o,screenSize:l,checker:w.service&&w.service.getProgram().getTypeChecker()},p=w.getSnippet(c,r,n,i);return w.snippetStringify(p)}}},blocksInfo:function(e){return d(e,e.blocks&&e.blocks.bannedCategories)},apiSearch:function(e){var t=e.search,a=d(t.localizedApis,e.blocks&&e.blocks.bannedCategories);t.localizedStrings&&pxt.Util.setLocalizedStrings(t.localizedStrings);var r,i=function(t,e,r){if(t)return"string"==typeof t?t:e?t[e]:Object.keys(t).map(function(e){return t[e]}).join(" ")};if(!w.builtinItems){w.builtinItems=[],w.blockDefinitions=pxt.blocks.blockDefinitions();var n=function(r){var n=w.blockDefinitions[r];if(n.operators){var e=function(t){n.operators[t].forEach(function(e){return w.builtinItems.push({id:r,name:n.name,jsdoc:"string"==typeof n.tooltip?n.tooltip:n.tooltip[e],block:e,field:[t,e],builtinBlock:!0})})};for(var t in n.operators)e(t)}else w.builtinItems.push({id:r,name:n.name,jsdoc:i(n.tooltip,n.tooltipSearch),block:i(n.block,n.blockTextSearch),builtinBlock:!0})};for(var s in w.blockDefinitions)n(s)}if(!w.lastFuse||t.subset){var o={},l=[];t.subset&&(w.tbSubset=t.subset,l=w.builtinItems.filter(function(e){return!!w.tbSubset[e.id]})),w.tbSubset?r=a.blocks.filter(function(e){return!!w.tbSubset[e.attributes.blockId]}):(r=a.blocks,l=w.builtinItems);var u=r.map(function(e){var t,r,n;return{id:e.attributes.blockId,qName:e.qName,name:e.name,namespace:e.namespace,block:function(e){var t,r,n;if(null===(t=e.attributes)||void 0===t?void 0:t._def){for(var i=[],a=e.attributes._def,s=pxt.blocks.compileInfo(e),o=0,l=a.parts;o<l.length;o++){var u=l[o];switch(u.kind){case"label":i.push(u.text);break;case"param":var c=s.definitionNameToParam[u.name];i.push((null===(r=c)||void 0===r?void 0:r.defaultValue)||u.varName||(null===(n=c)||void 0===n?void 0:n.actualName)||u.name)}}return i.join(" ")}return e.attributes.block}(e),params:(t=e,n=null===(r=t.attributes)||void 0===r?void 0:r.paramHelp,n&&Object.keys(n).map(function(e){return n[e]}).join(" "),""),jsdoc:e.attributes.jsDoc,localizedCategory:w.tbSubset&&"string"==typeof w.tbSubset[e.attributes.blockId]?w.tbSubset[e.attributes.blockId]:void 0}}),c={};l.forEach(function(e){return c[e.id]=!0}),u=u.filter(function(e){return!(e.id in c)});var p=0;r.forEach(function(e){var t,r,n,i=o[e.qName]=(r=(t=e).attributes.weight||50,(1e3*((n=a.apis.byQName[t.namespace])&&n.attributes.weight||50)+r)*(n&&n.attributes.advanced||t.attributes.advanced?1:1e6));p=Math.max(p,i)}),u=u.concat(l);var f={shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3},{name:"namespace",weight:.1},{name:"localizedCategory",weight:.1},{name:"block",weight:.4375},{name:"params",weight:.0625},{name:"jsdoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-o[e.item.qName]/p:1,n=t.qName?1-o[t.item.qName]/p:1;return e.score*(1+r/10)-t.score*(1+n/10)}};w.lastFuse=new Fuse(u,f)}return w.lastFuse.search(t.term).slice(0,7)},projectSearch:function(e){var t=e.projectSearch,r=t.headers;return w.lastProjectFuse||(w.lastProjectFuse=new Fuse(r,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3}]})),w.lastProjectFuse.search(t.term)},projectSearchClear:function(){w.lastProjectFuse=void 0}};function _(){E(w.host.opts);var e=K.U.flatClone(w.host.opts.fileSystem),t=K.runConversionsAndStoreResults(w.host.opts);t&&t.globalNames&&(w.lastGlobalNames=t.globalNames);var r=w.host.opts.fileSystem;w.host.opts.fileSystem=e;for(var n=0,i=Object.keys(r);n<i.length;n++){var a=i[n];w.host.setFile(a,r[a])}if(0==t.diagnostics.length){w.host.opts.skipPxtModulesEmit=!1,w.host.opts.skipPxtModulesTSC=!1;var s=w.host.opts.target.isNative?"native":"js";!w.host.opts.target.switches.noIncr&&w.host.pxtModulesOK&&(w.host.opts.skipPxtModulesTSC=!0,w.host.opts.noEmit?w.host.opts.skipPxtModulesEmit=!0:w.host.opts.target.isNative?w.host.opts.skipPxtModulesEmit=!1:"js"!=w.host.pxtModulesOK||w.host.opts.breakpoints&&!w.host.opts.justMyCode||(w.host.opts.skipPxtModulesEmit=!0));var o=K.compile(w.host.opts,w.service);if((t=__assign({sourceMap:t.sourceMap},o)).needsFullRecompile&&(pxt.log("trigering full recompile"),pxt.tickEvent("compile.fullrecompile"),w.host.opts.skipPxtModulesEmit=!1,o=K.compile(w.host.opts,w.service),t=__assign({sourceMap:t.sourceMap},o)),t.diagnostics.every(function(e){return!K.isPxtModulesFilename(e.fileName)})&&(w.host.pxtModulesOK=s),t.ast){var l=K.internalGetApiInfo(t.ast);l&&(w.lastApiInfo=l)}}return t}w.runConversionsAndCompileUsingService=_,w.performOperation=function(e,t){w.service||(w.host=new n,w.service=f.createLanguageService(w.host));var r=null;if(i.hasOwnProperty(e))try{r=(0,i[e])(t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r}})((K=f.pxtc||(f.pxtc={})).service||(K.service={}))}(ts||(ts={})),function(Q){var W;(function(V){var G="`\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n`",J='"""\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n"""';function l(e){return"object"==typeof e&&void 0!==e.default}function u(e){return"object"==typeof e&&"number"==typeof e.length}function H(e,a){void 0===a&&(a=!1);var s={},o=1;return function t(e){if(l(e)){if(a){if(c(e.default))return t(e.default);var r=H(e.default,!1),n=s[r];if(n&&!e.isLiteral||(n=o,o++,s[r]=n),0<=r.indexOf(".")&&r.indexOf(" ")<0){var i=r.split(".");return i[i.length-1]="${"+n+":"+i[i.length-1]+"}",i.join(".")}return"${"+n+":"+r+"}"}return t(e.default)}return u(e)?e.map(function(e){return t(e)}).join(""):e}(e)}function c(e){return!!l(e)||!!u(e)&&e.map(c).reduce(function(e,t){return e||t},!1)}V.snippetStringify=H,V.snippetHasReplacementPoints=c,V.snippetAddsDefinitions=function e(t){return l(t)?t.isDefinition||e(t.default):!!u(t)&&t.map(e).reduce(function(e,t){return e||t},!1)},V.getSnippet=function b(y,x,e,k,S){var t;void 0===S&&(S=0);var T=y.apis,r=y.takenNames,n=y.blocksInfo,w=y.screenSize,I=y.checker,u=pxt.py.INDENT,E=k?"python":"typescript",c=[],p="";p=e.kind==W.SK.Constructor?$(e.symbol)||e.parent.name.getText():$(e.symbol)||e.name.getText(),k&&(p=W.snakify(p));var N=x.attributes;if("TD_ID"===N.shim&&S&&e.parameters.length)return B(e.parameters[0]);var _=n.blocksById,f=e.parameters?e.parameters.filter(function(e){return!e.initializer&&!e.questionToken}):[],i=f.map(B).map(function(e){return{default:e,isLiteral:!0}}),a=x.namespace,s=!1,o="",d=0,l=x;if(l.attributes.block)if(l.attributes.defaultInstance)a=l.attributes.defaultInstance,k&&a&&(a=W.snakify(a));else if(l.namespace){var m=T.byQName[l.namespace];if(m.attributes.fixedInstances){var h=W.Util.values(T.byQName),g=h.filter(function(e){return 4===e.kind&&e.attributes.fixedInstance}),v=void 0,K=g.filter(function(e){return e.retType==m.qName}).sort(function(e,t){return e.name.localeCompare(t.name)});(v=K.length?K[0]:g.filter(function(e){return-1!==(r=m.qName,h.filter(function(e){return e.extendsTypes}).filter(function(e){return e.extendsTypes.reduce(function(e,t){return e||-1!=t.indexOf(r)},!1)}).reduce(function(e,t){return e.concat(t.extendsTypes)},[])).indexOf(e.retType);var r}).sort(function(e,t){return e.name.localeCompare(t.name)})[0])?(a=""+q(v),o=v.namespace):o=m.namespace,o&&(s=!0)}else if(1==l.kind||2==l.kind){var A=pxt.blocks.compileInfo(l);if(A.thisParameter){var C=void 0;A.thisParameter.definitionName&&(C="my"+(C=(C=A.thisParameter.definitionName)[0].toUpperCase()+C.substring(1))),a=A.thisParameter.defaultValue||C,k&&a&&(a=W.snakify(a))}}else if(8===m.kind)return}var U,P=N&&(k?N.pySnippet:N.snippet);if(P)U=[P];else if(U=[p],(null===(t=i)||void 0===t?void 0:t.length)||1==l.kind||3==l.kind||8==l.kind){var L=i.reduce(function(e,t){return __spreadArrays(e,[e.length?", ":"",t])},[]);U=U.concat(__spreadArrays(["("],L,[")"]))}var F,O,D=a?__spreadArrays([a,"."],U):U;return D=s?__spreadArrays([(F=o,O=F.indexOf("."),O<0?F:F.substring(0,O)),"."],D):D,N&&N.blockSetVariable&&(k?(C=M(W.snakify(N.blockSetVariable)),D=__spreadArrays([{default:C,isDefinition:!0}," = "],D)):(C=M(N.blockSetVariable),D=__spreadArrays(["let ",{default:C,isDefinition:!0}," = "],D))),[c,D];function M(e){return r[e]?Q.pxtc.decompiler.getNewName(e,r,!1):e}function B(e){var t=e.type;if(!t)return k?"None":"null";var r=e.name.kind===W.SK.Identifier?e.name.text:void 0;if(N&&N.paramDefl&&N.paramDefl[r]){if(t.kind==W.SK.AnyKeyword){var n=N.paramDefl[r].toUpperCase();Number.isNaN(+n)?"FALSE"==n||"TRUE"==n?t.kind=W.SK.BooleanKeyword:n.includes(".")?t.kind=W.SK.EnumKeyword:t.kind=W.SK.StringKeyword:t.kind=W.SK.NumberKeyword}return t.kind==W.SK.StringKeyword?(n=N.paramDefl[r],t.kind==W.SK.StringKeyword&&0!=n.indexOf('"')?'"'+n+'"':n):N.paramDefl[r]}var i=function(t){var e,r,n,i=pxt.blocks.compileInfo(x),a=null===(e=i.parameters)||void 0===e?void 0:e.find(function(e){return e.actualName===t});if(!(null===(r=a)||void 0===r?void 0:r.shadowBlockId))return null;var s=_[a.shadowBlockId];if(!s)return null;var o=null===(n=s.attributes)||void 0===n?void 0:n.paramFieldEditor;if(!o)return null;var l=o[t];if(!l)return null;var u=s.attributes.paramFieldEditorOptions||{};switch(l){case"sprite":return function(e){var t,r,n,i,a={initColor:0,initWidth:16,initHeight:16};if(null===(t=e)||void 0===t?void 0:t.sizes){for(var s=e.sizes.split(";"),o=[],l=0;l<s.length;l++){var u=s[l].split(",");if(2===u.length){var c=parseInt(u[0]),p=parseInt(u[1]);isNaN(c)||isNaN(p)||(c<0&&w&&(c=w.width),p<0&&w&&(p=w.height),o.push([c,p]))}}0<o.length&&(a.initWidth=o[0][0],a.initHeight=o[0][1])}return a.initColor=f(null===(r=e)||void 0===r?void 0:r.initColor,a.initColor),a.initWidth=f(null===(n=e)||void 0===n?void 0:n.initWidth,a.initWidth),a.initHeight=f(null===(i=e)||void 0===i?void 0:i.initHeight,a.initHeight),pxt.sprite.imageLiteralFromDimensions(a.initWidth,a.initHeight,a.initColor,E);function f(e,t){var r=parseInt(e);return isNaN(r)?t:r}}(u[t])}return null}(r);if(i)return i;var a=function(e){var t=(N._shadowOverrides||{})[e];if(!t)for(var r=pxt.blocks.compileInfo(x),n=0,i=r.parameters;n<i.length;n++){var a=i[n];if(a.actualName===e){t=a.shadowBlockId;break}}if(!t)return null;var s=_[t];if(!s)return null;if("TD_ID"===s.attributes.shim&&s.parameters.length){var o=s.parameters[0].type,l=T.byQName[o];s=l||s}return s}(r);if(a){var s=V.getTsSymbolFromPxtSymbol(a,e,Q.SymbolFlags.Enum);if(s){var o=I.getTypeOfSymbolAtLocation(s,e);if(o){var l=R(o);if(l)return l}}var u=a.attributes;if("KIND_GET"===u.shim&&u.blockId){var c=u.kindNamespace||x.namespace,p=W.Util.values(T.byQName).find(function(e){return e.namespace===c&&e.attributes.isKind});if(p)return k?p.pyQName:p.qName}if(S<3&&V.lastApiInfo.decls[a.qName]){var f=b(y,a,V.lastApiInfo.decls[a.qName],k,S+1);if(f)return f}}if(t.kind===W.SK.StringKeyword&&"leds"===r)return k?J:G;if(t.kind===W.SK.FunctionType){var d=t,m=I?I.getSignatureFromDeclaration(d):void 0;return m?j(m,!0):z(r)}var h=V.getBasicKindDefault(t.kind,k);if(void 0!==h)return h;var g=I&&I.getTypeAtLocation(e);if(g){var v=R(g);if(v)return v}return k?"None":"null"}function R(e){if(e.symbol&&e.symbol.flags&Q.SymbolFlags.Enum)return s=V.getDefaultEnumValue(e,k);var t,r=V.getPxtSymbolFromTsSymbol(e.symbol,T,I);if(W.isObjectType(e)){var n=r&&r.attributes&&(k?r.attributes.pySnippet:r.attributes.snippet);if(n)return n;if(e.objectFlags&Q.ObjectFlags.Anonymous){var i=I.getSignaturesOfType(e,Q.SignatureKind.Call);return i&&i.length?j(i[0],!1):z(name)}}if(e.flags&Q.TypeFlags.NumberLike)return"0";if(r&&r.attributes.fixedInstances){var a=(t=r,pxt.Util.values(T.byQName).filter(function(e){return 4===e.kind&&e.attributes.fixedInstance&&function(e,t,r){if(t==r)return!0;var n=e.byQName[t];return!(!n||!n.extendsTypes)&&0<=n.extendsTypes.indexOf(r)}(T,e.retType,t.qName)}));if(a.length){var s=a[0];return k?s.pyQName:s.qName}}}function $(e){if(I){var t=W.getFullName(I,e),r=T.byQName[t];if(r)return q(r)}}function q(e){return k?e.pyName:e.name}function j(t,e){var r="",n=I.getReturnTypeOfSignature(t);if(n.flags&Q.TypeFlags.NumberLike?r="return 0":n.flags&Q.TypeFlags.StringLike?r='return ""':n.flags&(Q.TypeFlags.Boolean|Q.TypeFlags.BooleanLiteral)&&(r=k?"return False":"return false"),k){var i=void 0;i=N.optionalVariableArgs?"()":"("+t.parameters.map(function(e){return e.name}).join(", ")+")";var a=p||"fn";0<d++&&(a+=d),e&&!/^on/i.test(a)&&(a="on"+pxt.Util.capitalize(a));var s=f.filter(function(e){var t=I&&I.getTypeAtLocation(e);return!!(t&&t.symbol&&t.symbol.flags&Q.SymbolFlags.Enum)}).map(function(e){var t=H(B(e)).toLowerCase(),r=t.lastIndexOf(".");return-1!==r?t.substr(r+1):t}).join("_");return s&&(a+="_"+s),a=M(a=W.snakify(a)),c=__spreadArrays(c,[c.length?"\n":"","def ",{default:a,isDefinition:!0},i,":\n"+u,{default:r||"pass"},"\n"]),{default:a}}if(i="()",!N.optionalVariableArgs){var o=Q.mapToDisplayParts(function(e){I.getSymbolDisplayBuilder().buildSignatureDisplay(t,e,void 0,Q.TypeFormatFlags.UseFullyQualifiedType)}),l=Q.displayPartsToString(o);i=l.substr(0,l.lastIndexOf(":"))}return["function",i," {\n"+u,{default:r},"\n}"]}function z(e){return k?(e=e||"fn",e=M(e=W.snakify(e)),c=__spreadArrays(c,[c.length?"\n":"","def ",{default:e,isDefinition:!0},"():\n"+u,{default:"pass"},"\n"]),{default:e}):"function () {}"}}})((W=Q.pxtc||(Q.pxtc={})).service||(W.service={}))}(ts||(ts={})),function(e){var t,r,n;t=e.pxtc||(e.pxtc={}),r=t.transpile||(t.transpile={}),n=function(e){return"main."+e},r.pyToTs=function(e,t){return void 0===t&&(t=n("py")),pxt.py.py2ts(e)},r.tsToPy=function(e,t){return void 0===t&&(t=n("ts")),pxt.py.decompileToPython(e,t)}}(ts||(ts={})),function(u){!function(l){var n,e;function i(e,t){if(e){var r=t(e);if(r===n.Continue)return i(e.parent,t);if(r!==n.Abort){if(r===n.Found)return e;return r}}}function a(e){return i(e,function(e){return u.isModuleDeclaration(e)?n.Found:n.Continue})}l.getParentCallExpression=function(e){return i(e,function(e){return u.isCallExpression(e)?n.Found:u.isBlock(e)?n.Abort:n.Continue})},l.findCurrentCallArgIdx=function(e,t,r){var n=e.arguments.map(function(e){return e===t}).indexOf(!0);if(0<=n)return n;if(!(e.arguments.pos<=r&&r<e.end))return-1;if(0===e.arguments.length)return 0;for(var i=n=0,a=e.arguments;i<a.length&&a[i].end<=r;i++)n++;return e.arguments.hasTrailingComma||(n=Math.max(0,n-1)),n},(e=n=l.TraverseCheck||(l.TraverseCheck={}))[e.Found=0]="Found",e[e.Continue=1]="Continue",e[e.Abort=2]="Abort",l.traverseUp=i,l.enumMemberToQName=function(e,t){if(t.name.kind===l.SK.Identifier)return e.getFullyQualifiedName(e.getSymbolAtLocation(t.name))},l.findInnerMostNodeAtPosition=function e(t,r){for(var n=0,i=t.getChildren();n<i.length;n++){var a=i[n];if(!(a.kind>=u.SyntaxKind.FirstPunctuation&&a.kind<=u.SyntaxKind.LastPunctuation)){var s=a.getStart(),o=a.getEnd();if(s<=r&&r<o)return e(a,r)}}return t&&t.kind===l.SK.SourceFile?null:t},l.getParentNamespace=a,l.getCurrentNamespaces=function e(t){if(!t)return[];var r=a(t);if(!r)return[];var n=r.name.getText();return __spreadArrays(e(r.parent),[n])},l.getEnumMembers=function(e,t){if(e&&t.symbol&&t.symbol.declarations&&t.symbol.declarations.length)for(var r=0;r<t.symbol.declarations.length;r++){var n=t.symbol.declarations[r];if(n.kind===l.SK.EnumDeclaration)return n.members}},l.isExported=function(e){if(e.modifiers&&e.modifiers.some(function(e){return e.kind==l.SK.PrivateKeyword||e.kind==l.SK.ProtectedKeyword}))return!1;var t=e.symbol;if(!t)return!1;for(;;){var r=t.parent;if(!r)break;t=r}var n=t.valueDeclaration||t.declarations[0];return n.kind==l.SK.VariableDeclaration&&(n=n.parent.parent),!(!n.parent||n.parent.kind!=l.SK.SourceFile)},l.isReadonly=function(e){return e.modifiers&&e.modifiers.some(function(e){return e.kind==l.SK.ReadonlyKeyword})}}(u.pxtc||(u.pxtc={}))}(ts||(ts={})),function(e){var m;(function(u){var f=m.assembler.emitErr,d=f("opcode name doesn't match","<name>"),c=function(n){function e(e,t,r){return n.call(this,e,t,r,r,!1)||this}return __extends(e,n),e.prototype.emit=function(e){var t=e.words;if(t[0]!=this.name)return d;for(var r=this.opcode,n=1,i=[],a=null,s=null,o=0;o<this.args.length;++o){var l=this.args[o],u=t[n++];if("$"==l[0]){var c=this.ei.encoders[l],p=null;if(c.isImmediate||c.isLabel){if(!u)return f("expecting number",u);if(u=u.replace(/^#/,""),null==(p=e.bin.parseOneInt(u)))return f("expecting number",u)}else m.oops();if(null==p)return f("didn't understand it",u);if(m.U.assert(0<=p),11111!=p&&"$lbl"==l&&(p-=e.bin.location()+2,p>>=1),i.push(p),null==(p=c.encode(p)))return f("argument out of range or mis-aligned",u);"$i3"==l?p=s|p<<6:"$i5"==l&&(p=s|p<<8),"$i2"==l||"$i4"==l?s=p:"$rt"==l?(11111!=p&&4096<p&&m.U.oops("label: "+u+" v="+p),r=32768|p,"callrt.p"==this.name&&(r|=8192)):e.isLong||p<0||255<p?(e.isLong=!0,"$lbl"==l&&(p-=1),r=p>>9&65535|49152,a=this.opcode+(p<<7)&65535):r=this.opcode+(p<<7)&65535}else if(l!=u)return f("expecting "+l,u)}return t[n]?f("trailing tokens",t[n]):{stack:0,opcode:r,opcode2:a,numArgs:i,labelName:e.bin.normalizeExternalLabel(null)}},e}(m.assembler.Instruction);u.VmInstruction=c,u.withPush={},u.opcodes=["stloc     $i1","ldloc     $i1","stfld     $i4, $i5","ldfld     $i4, $i5","newobj    $i1","ldcap     $i1","stglb     $i1","ldglb     $i1","ldint     $i1","ldintneg  $i1","ldspecial $i1","ldnumber  $i1","ldlit     $i1","checkinst $i1","mapget","mapset","ret       $i2, $i3","popmany   $i1","pushmany  $i1","callind   $i1","callproc  $i1","calliface $i2, $i3","callget   $i1","callset   $i1","jmp       $lbl","jmpnz     $lbl","jmpz      $lbl","try       $lbl","push","pop"];var e=function(l){function e(e){var t=l.call(this)||this;t.addEnc("$i1","#0-8388607",function(e){return t.inrange(8388607,e,e)}),t.addEnc("$i2","#0-31",function(e){return t.inrange(31,e,e)}),t.addEnc("$i3","#0-262143",function(e){return t.inrange(262143,e,e)}),t.addEnc("$i4","#0-255",function(e){return t.inrange(255,e,e)}),t.addEnc("$i5","#0-32767",function(e){return t.inrange(32767,e,e)}),t.addEnc("$lbl","LABEL",function(e){return t.inminmax(-4194304,4194303,e,e)}).isLabel=!0;for(var r=1,n=t.addEnc("$rt","SHIM",function(e){return t.inrange(8388607,e,e)}).isLabel=!0,i=0,a=u.opcodes.concat(["callrt $rt"]);i<a.length;i++){var s=a[i],o=new c(t,s,r);t.instructions[o.name]=[o],(n||"callrt"==o.name)&&(u.withPush[o.name]=!0,o=new c(t,s.replace(/\w+/,function(e){return e+".p"}),64|r),t.instructions[o.name]=[o]),"mapset.p"==o.name&&(n=!1),r++}return t}return __extends(e,l),e.prototype.testAssembler=function(){},e.prototype.postProcessRelAddress=function(e,t){return t},e.prototype.postProcessAbsAddress=function(e,t){return t},e.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);return null==i?null:t.is32bit?i:i-(e.pc()+2)},e.prototype.toFnPtr=function(e,t){return e},e.prototype.wordSize=function(){return 8},e.prototype.peephole=function(e,t,r){var n=e.getOp(),i="";if(t){var a=n+";"+(i=t.getOp()),s=this.file.peepCounts;s[a]=(s[a]||0)+1}"stloc"==n&&"ldloc"==i&&e.numArgs[0]==t.numArgs[0]?(/LAST/.test(t.text)&&e.update(""),t.update("")):u.withPush[n]&&"push"==i&&(e.update(e.text.replace(/\w+/,function(e){return e+".p"})),t.update(""))},e}(m.assembler.AbstractProcessor);u.VmProcessor=e})((m=e.pxtc||(e.pxtc={})).vm||(m.vm={}))}(ts||(ts={}));